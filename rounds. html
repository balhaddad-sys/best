<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0f1a">
  <title>MedWard Rounds | Clinical Presentation</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0a0f1a;--bg2:#0d1424;--bg3:#111b2e;--bg4:#162035;
      --text:#f8fafc;--text2:#cbd5e1;--muted:#64748b;
      --gold:#d4a437;--gold2:#fbbf24;--teal:#14b8a6;--teal2:#2dd4bf;
      --red:#ef4444;--red-bg:rgba(239,68,68,0.12);
      --orange:#f97316;--orange-bg:rgba(249,115,22,0.12);
      --yellow:#eab308;--yellow-bg:rgba(234,179,8,0.12);
      --green:#22c55e;--green-bg:rgba(34,197,94,0.12);
      --blue:#3b82f6;--blue-bg:rgba(59,130,246,0.12);
      --purple:#8b5cf6;
      --border:rgba(148,163,184,0.1);
      --radius:12px;--radius-lg:16px;
    }
    html{font-size:16px;-webkit-font-smoothing:antialiased}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    
    /* Header */
    .header{background:linear-gradient(135deg,var(--bg2),var(--bg3));border-bottom:1px solid var(--border);padding:16px 20px;position:sticky;top:0;z-index:100}
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold2));border-radius:10px;display:grid;place-items:center}
    .logo-icon svg{width:20px;height:20px;stroke:#0a0f1a;stroke-width:2.5;fill:none}
    .logo-text{font-size:1.1rem;font-weight:700;color:var(--gold)}
    .header-actions{display:flex;gap:8px}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:inherit;font-size:0.8rem;font-weight:600;cursor:pointer;transition:0.2s;display:flex;align-items:center;gap:6px}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0a0f1a}
    .btn-secondary{background:var(--bg4);color:var(--text2);border:1px solid var(--border)}
    .btn svg{width:16px;height:16px}
    
    /* Patient Banner */
    .patient-banner{background:var(--bg3);border-radius:var(--radius);padding:16px;display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:center}
    .patient-avatar{width:56px;height:56px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:14px;display:grid;place-items:center;font-size:1.25rem;font-weight:800;color:#0a0f1a}
    .patient-info h1{font-size:1.2rem;font-weight:700;margin-bottom:2px}
    .patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text2)}
    .patient-meta span{display:flex;align-items:center;gap:4px}
    .patient-badges{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .badge{padding:4px 10px;border-radius:100px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
    .badge-critical{background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3)}
    .badge-warning{background:var(--orange-bg);color:var(--orange);border:1px solid rgba(249,115,22,0.3)}
    .badge-stable{background:var(--green-bg);color:var(--green);border:1px solid rgba(34,197,94,0.3)}
    
    /* Main Content */
    .main{padding:20px;max-width:1400px;margin:0 auto}
    
    /* Section */
    .section{margin-bottom:24px}
    .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .section-title{font-size:0.9rem;font-weight:700;color:var(--gold);display:flex;align-items:center;gap:8px}
    .section-title svg{width:18px;height:18px}
    
    /* Quick Stats */
    .quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .quick-stat{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative;overflow:hidden}
    .quick-stat::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--stat-color,var(--teal))}
    .quick-stat.critical::before{--stat-color:var(--red)}
    .quick-stat.warning::before{--stat-color:var(--orange)}
    .quick-stat.normal::before{--stat-color:var(--green)}
    .quick-stat-label{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px}
    .quick-stat-value{font-size:1.5rem;font-weight:700;font-family:'JetBrains Mono',monospace}
    .quick-stat-unit{font-size:0.75rem;color:var(--muted);margin-left:4px}
    .quick-stat-trend{font-size:0.7rem;margin-top:4px;display:flex;align-items:center;gap:4px}
    .trend-up{color:var(--red)}
    .trend-down{color:var(--green)}
    .trend-stable{color:var(--muted)}
    
    /* Diagnosis Cards */
    .diagnosis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .diagnosis-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    .diagnosis-card h4{font-size:0.85rem;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .diagnosis-card h4 .emoji{font-size:1.1rem}
    .diagnosis-list{list-style:none}
    .diagnosis-list li{font-size:0.8rem;color:var(--text2);padding:4px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
    .diagnosis-list li:last-child{border-bottom:none}
    .diagnosis-list .value{font-family:'JetBrains Mono',monospace;font-weight:500}
    .diagnosis-list .critical{color:var(--red)}
    .diagnosis-list .warning{color:var(--orange)}
    .diagnosis-list .normal{color:var(--green)}
    
    /* Labs Table */
    .labs-container{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .labs-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--bg3)}
    .labs-header h3{font-size:0.9rem;font-weight:600;display:flex;align-items:center;gap:8px}
    .labs-tabs{display:flex;gap:4px}
    .labs-tab{padding:6px 12px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:0.75rem;font-weight:500;cursor:pointer}
    .labs-tab.active{background:var(--gold);border-color:var(--gold);color:#0a0f1a}
    .labs-table{width:100%;border-collapse:collapse}
    .labs-table th{text-align:left;padding:10px 12px;font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);background:var(--bg3);border-bottom:1px solid var(--border)}
    .labs-table td{padding:10px 12px;font-size:0.8rem;border-bottom:1px solid var(--border)}
    .labs-table tr:hover{background:rgba(212,164,55,0.03)}
    .lab-name{font-weight:500}
    .lab-value{font-family:'JetBrains Mono',monospace;font-weight:600}
    .lab-value.critical{color:var(--red);background:var(--red-bg);padding:2px 8px;border-radius:4px}
    .lab-value.high{color:var(--orange)}
    .lab-value.low{color:var(--blue)}
    .lab-value.normal{color:var(--green)}
    .lab-ref{color:var(--muted);font-size:0.75rem}
    .lab-trend{display:flex;align-items:center;gap:6px;font-size:0.75rem}
    .lab-trend svg{width:12px;height:12px}
    .lab-history{display:flex;gap:8px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--muted)}
    .lab-history span{padding:2px 6px;background:var(--bg4);border-radius:4px}
    
    /* Timeline */
    .timeline{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    .timeline-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
    .timeline-item:last-child{border-bottom:none}
    .timeline-time{min-width:60px;font-size:0.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .timeline-dot{width:10px;height:10px;background:var(--gold);border-radius:50%;margin-top:4px;flex-shrink:0}
    .timeline-content{flex:1}
    .timeline-title{font-size:0.85rem;font-weight:600;margin-bottom:4px}
    .timeline-desc{font-size:0.8rem;color:var(--text2)}
    
    /* Problems List */
    .problems-list{display:flex;flex-direction:column;gap:8px}
    .problem-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;align-items:flex-start;gap:12px}
    .problem-num{width:28px;height:28px;background:var(--gold);border-radius:8px;display:grid;place-items:center;font-size:0.8rem;font-weight:700;color:#0a0f1a;flex-shrink:0}
    .problem-content h4{font-size:0.9rem;font-weight:600;margin-bottom:4px}
    .problem-content p{font-size:0.8rem;color:var(--text2)}
    .problem-status{margin-left:auto;padding:4px 10px;border-radius:100px;font-size:0.65rem;font-weight:600;text-transform:uppercase}
    .status-active{background:var(--red-bg);color:var(--red)}
    .status-improving{background:var(--yellow-bg);color:var(--yellow)}
    .status-stable{background:var(--green-bg);color:var(--green)}
    
    /* Plan Section */
    .plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
    .plan-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    .plan-card h4{font-size:0.85rem;font-weight:600;margin-bottom:12px;color:var(--gold);display:flex;align-items:center;gap:8px}
    .plan-card ul{list-style:none}
    .plan-card li{font-size:0.8rem;color:var(--text2);padding:6px 0;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:8px}
    .plan-card li:last-child{border-bottom:none}
    .plan-card li::before{content:'‚Ä¢';color:var(--gold);font-weight:bold}
    
    /* Medications */
    .med-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .med-item{background:var(--bg3);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px}
    .med-icon{width:32px;height:32px;background:var(--bg4);border-radius:8px;display:grid;place-items:center;font-size:0.9rem}
    .med-info{flex:1}
    .med-name{font-size:0.8rem;font-weight:600}
    .med-dose{font-size:0.7rem;color:var(--muted)}
    .med-status{width:8px;height:8px;border-radius:50%;background:var(--green)}
    .med-status.held{background:var(--orange)}
    .med-status.stopped{background:var(--red)}
    
    /* Print Styles */
    @media print{
      body{background:#fff;color:#000}
      .header{position:relative;background:#fff;border-bottom:2px solid #000}
      .btn{display:none}
      .section{page-break-inside:avoid}
    }
    
    /* Mobile */
    @media(max-width:640px){
      .patient-banner{grid-template-columns:1fr;text-align:center}
      .patient-badges{align-items:center}
      .quick-stats{grid-template-columns:repeat(2,1fr)}
      .labs-table th:nth-child(n+4),.labs-table td:nth-child(n+4){display:none}
    }

    /* Upload Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;z-index:200}
    .modal.active{display:flex}
    .modal-box{width:100%;max-width:600px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-weight:600}
    .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
    .modal-body{padding:20px;max-height:70vh;overflow-y:auto}
    .upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px;text-align:center;cursor:pointer}
    .upload-zone:hover{border-color:var(--gold);background:rgba(212,164,55,0.05)}
    .upload-zone h4{margin-bottom:8px}
    .upload-zone p{font-size:0.8rem;color:var(--muted)}
    .processing{text-align:center;padding:40px}
    .processing .spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <header class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
        <span class="logo-text">Ward Rounds</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="clearData()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Clear</button>
        <button class="btn btn-secondary" onclick="openUpload()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Add Data</button>
        <button class="btn btn-primary" onclick="window.print()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button>
      </div>
    </div>
    
    <div class="patient-banner">
      <div class="patient-avatar">FS</div>
      <div class="patient-info">
        <h1>Fayez Saeed Al Raheem</h1>
        <div class="patient-meta">
          <span>üéÇ 71 yo Male</span>
          <span>üìã M694087</span>
          <span>üè• Ward 21 ‚Ä¢ Room 14 ‚Ä¢ Bed 1</span>
          <span>üë®‚Äç‚öïÔ∏è Dr. Mohamed Fathy</span>
          <span>üìÖ Admitted: 15/01/2026</span>
        </div>
      </div>
      <div class="patient-badges">
        <span class="badge badge-critical">Critical</span>
        <span class="badge badge-warning">ICU Stepdown</span>
      </div>
    </div>
  </header>

  <main class="main">
    
    <!-- Quick Vitals -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Current Status</h2>
      </div>
      <div class="quick-stats">
        <div class="quick-stat normal">
          <div class="quick-stat-label">GCS</div>
          <div class="quick-stat-value">15<span class="quick-stat-unit">/15</span></div>
          <div class="quick-stat-trend trend-stable">‚Üí Stable</div>
        </div>
        <div class="quick-stat warning">
          <div class="quick-stat-label">BP</div>
          <div class="quick-stat-value">105/52</div>
          <div class="quick-stat-trend trend-up">‚Üë from 94/64</div>
        </div>
        <div class="quick-stat normal">
          <div class="quick-stat-label">HR</div>
          <div class="quick-stat-value">97<span class="quick-stat-unit">bpm</span></div>
          <div class="quick-stat-trend trend-stable">‚Üí Stable</div>
        </div>
        <div class="quick-stat normal">
          <div class="quick-stat-label">SpO2</div>
          <div class="quick-stat-value">94<span class="quick-stat-unit">%</span></div>
          <div class="quick-stat-trend trend-up">‚Üë from 79%</div>
        </div>
        <div class="quick-stat normal">
          <div class="quick-stat-label">Temp</div>
          <div class="quick-stat-value">36.8<span class="quick-stat-unit">¬∞C</span></div>
          <div class="quick-stat-trend trend-stable">‚Üí Afebrile</div>
        </div>
        <div class="quick-stat warning">
          <div class="quick-stat-label">RR</div>
          <div class="quick-stat-value">14-16<span class="quick-stat-unit">/min</span></div>
          <div class="quick-stat-trend trend-stable">‚Üí On RA</div>
        </div>
      </div>
    </section>

    <!-- Primary Diagnosis -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>Working Diagnosis</h2>
      </div>
      <div class="diagnosis-grid">
        <div class="diagnosis-card">
          <h4><span class="emoji">‚ù§Ô∏è</span> Cardiac</h4>
          <ul class="diagnosis-list">
            <li>Acute decompensated HF (NYHA IV)<span class="value critical">EF 20-25%</span></li>
            <li>IHD - PCI 2y ago, no stents<span class="value">CAG refused</span></li>
            <li>Grade 1 diastolic dysfunction<span class="value warning">Echo 3/10</span></li>
            <li>Aortic valve sclerosis<span class="value">Mild</span></li>
          </ul>
        </div>
        <div class="diagnosis-card">
          <h4><span class="emoji">ü´ò</span> Renal</h4>
          <ul class="diagnosis-list">
            <li>AKI on CKD<span class="value critical">Cr 160-186</span></li>
            <li>Hyperkalemia (drug-induced)<span class="value critical">K+ 7.15‚Üí5.83</span></li>
            <li>Cardiorenal Syndrome Type 1<span class="value warning">Active</span></li>
            <li>eGFR<span class="value warning">35-39</span></li>
          </ul>
        </div>
        <div class="diagnosis-card">
          <h4><span class="emoji">ü´Å</span> Respiratory</h4>
          <ul class="diagnosis-list">
            <li>Pulmonary edema (resolved)<span class="value normal">Improved</span></li>
            <li>Bilateral creps<span class="value warning">Mild</span></li>
            <li>Mild L pleural effusion<span class="value warning">US 16/1</span></li>
            <li>SpO2 on Room Air<span class="value normal">94%</span></li>
          </ul>
        </div>
        <div class="diagnosis-card">
          <h4><span class="emoji">ü´Ä</span> Hepatic</h4>
          <ul class="diagnosis-list">
            <li>Congestive hepatopathy<span class="value critical">Likely</span></li>
            <li>AST<span class="value critical">>1000 (966)</span></li>
            <li>ALT<span class="value critical">>500</span></li>
            <li>T. Bilirubin<span class="value critical">24.5</span></li>
            <li>Fatty liver<span class="value warning">US noted</span></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Critical Labs -->
    <section class="section">
      <div class="labs-container">
        <div class="labs-header">
          <h3>üß™ Laboratory Results</h3>
          <div class="labs-tabs">
            <button class="labs-tab active" onclick="showLabs('all')">All</button>
            <button class="labs-tab" onclick="showLabs('renal')">Renal</button>
            <button class="labs-tab" onclick="showLabs('lft')">LFTs</button>
            <button class="labs-tab" onclick="showLabs('cardiac')">Cardiac</button>
          </div>
        </div>
        <table class="labs-table">
          <thead>
            <tr>
              <th>Test</th>
              <th>Current</th>
              <th>Previous</th>
              <th>Trend</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="lab-name">Creatinine</td>
              <td><span class="lab-value critical">160 H</span></td>
              <td class="lab-history"><span>186</span><span>175</span></td>
              <td class="lab-trend trend-down">‚Üì Improving</td>
              <td class="lab-ref">64-104 Œºmol/L</td>
            </tr>
            <tr>
              <td class="lab-name">Potassium</td>
              <td><span class="lab-value high">5.83 H</span></td>
              <td class="lab-history"><span>7.15</span><span>5.57</span></td>
              <td class="lab-trend trend-down">‚Üì Post correction</td>
              <td class="lab-ref">3.5-5.1 mmol/L</td>
            </tr>
            <tr>
              <td class="lab-name">Sodium</td>
              <td><span class="lab-value low">132 L</span></td>
              <td class="lab-history"><span>130</span><span>133</span></td>
              <td class="lab-trend trend-stable">‚Üí Stable</td>
              <td class="lab-ref">136-146 mmol/L</td>
            </tr>
            <tr>
              <td class="lab-name">Urea</td>
              <td><span class="lab-value critical">21.4 H</span></td>
              <td class="lab-history"><span>19.7</span><span>18.8</span></td>
              <td class="lab-trend trend-up">‚Üë Rising</td>
              <td class="lab-ref">2.8-7.2 mmol/L</td>
            </tr>
            <tr>
              <td class="lab-name">NT-proBNP</td>
              <td><span class="lab-value critical">3781</span></td>
              <td class="lab-history"><span>3703</span><span>4151</span></td>
              <td class="lab-trend trend-stable">‚Üí Still elevated</td>
              <td class="lab-ref"><300 pg/ml</td>
            </tr>
            <tr>
              <td class="lab-name">HS Troponin I</td>
              <td><span class="lab-value critical">42.20 HH</span></td>
              <td class="lab-history"><span>27.20</span><span>30.70</span></td>
              <td class="lab-trend trend-up">‚Üë Type 2 MI pattern</td>
              <td class="lab-ref">0-19.8 ng/L</td>
            </tr>
            <tr>
              <td class="lab-name">AST</td>
              <td><span class="lab-value critical">966 HH</span></td>
              <td class="lab-history"><span>>1000</span></td>
              <td class="lab-trend trend-down">‚Üì Peak passed</td>
              <td class="lab-ref">1-50 IU/L</td>
            </tr>
            <tr>
              <td class="lab-name">ALT</td>
              <td><span class="lab-value critical">>500 H</span></td>
              <td class="lab-history"><span>>500</span></td>
              <td class="lab-trend trend-stable">‚Üí Persistently high</td>
              <td class="lab-ref">3-50 IU/L</td>
            </tr>
            <tr>
              <td class="lab-name">T. Bilirubin</td>
              <td><span class="lab-value critical">24.5 H</span></td>
              <td class="lab-history"><span>24.6</span></td>
              <td class="lab-trend trend-stable">‚Üí Stable</td>
              <td class="lab-ref">5-21 Œºmol/L</td>
            </tr>
            <tr>
              <td class="lab-name">Albumin</td>
              <td><span class="lab-value low">34 L</span></td>
              <td class="lab-history"><span>38</span><span>43</span></td>
              <td class="lab-trend trend-down">‚Üì Declining</td>
              <td class="lab-ref">35-52 g/L</td>
            </tr>
            <tr>
              <td class="lab-name">PT/INR</td>
              <td><span class="lab-value high">17.4 / 1.55</span></td>
              <td class="lab-history"><span>18.7/1.61</span><span>22.4/1.78</span></td>
              <td class="lab-trend trend-down">‚Üì Improving</td>
              <td class="lab-ref">9.6-13.6 / 0.85-1.15</td>
            </tr>
            <tr>
              <td class="lab-name">Lactate</td>
              <td><span class="lab-value normal">5.9</span></td>
              <td class="lab-history"><span>9</span></td>
              <td class="lab-trend trend-down">‚Üì Improving</td>
              <td class="lab-ref"><2 mmol/L</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VBG Trend -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>VBG Trend</h2>
      </div>
      <div class="diagnosis-grid">
        <div class="diagnosis-card">
          <h4>Initial VBG (Pre-correction)</h4>
          <ul class="diagnosis-list">
            <li>pH<span class="value critical">7.26</span></li>
            <li>pCO2<span class="value">30 mmHg</span></li>
            <li>HCO3<span class="value warning">13.5</span></li>
            <li>Lactate<span class="value critical">9</span></li>
            <li>K+<span class="value critical">7</span></li>
          </ul>
        </div>
        <div class="diagnosis-card">
          <h4>Post K+ Correction</h4>
          <ul class="diagnosis-list">
            <li>pH<span class="value normal">7.31</span></li>
            <li>pCO2<span class="value">30.6 mmHg</span></li>
            <li>HCO3<span class="value warning">15.6</span></li>
            <li>Lactate<span class="value warning">5.9</span></li>
            <li>K+<span class="value warning">7.4‚Üí5.9</span></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Problem List -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>Active Problems</h2>
      </div>
      <div class="problems-list">
        <div class="problem-item">
          <div class="problem-num">1</div>
          <div class="problem-content">
            <h4>Cardiorenal Syndrome Type 1</h4>
            <p>AKI/CKD with hyperkalemia secondary to volume overload and drug-induced (Aldactone). Cleared from ACS by cardiology.</p>
          </div>
          <span class="problem-status status-improving">Improving</span>
        </div>
        <div class="problem-item">
          <div class="problem-num">2</div>
          <div class="problem-content">
            <h4>Congestive Hepatopathy</h4>
            <p>Severely deranged LFTs (AST >1000, ALT >500, T.Bil 24.5) secondary to hepatic congestion from heart failure.</p>
          </div>
          <span class="problem-status status-active">Active</span>
        </div>
        <div class="problem-item">
          <div class="problem-num">3</div>
          <div class="problem-content">
            <h4>Acute Decompensated Heart Failure</h4>
            <p>NYHA Class IV with EF 20-25%, responded to Lasix. Now on Clexane and ASA.</p>
          </div>
          <span class="problem-status status-improving">Improving</span>
        </div>
        <div class="problem-item">
          <div class="problem-num">4</div>
          <div class="problem-content">
            <h4>Type 2 MI (Demand Ischemia)</h4>
            <p>Elevated troponin (42.20) in setting of demand ischemia, not ACS. Trending up but pattern consistent with Type 2.</p>
          </div>
          <span class="problem-status status-active">Monitoring</span>
        </div>
      </div>
    </section>

    <!-- Medications -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>Current Medications</h2>
      </div>
      <div class="med-grid">
        <div class="med-item">
          <div class="med-icon">üíä</div>
          <div class="med-info">
            <div class="med-name">Aspirin</div>
            <div class="med-dose">100mg OD</div>
          </div>
          <div class="med-status"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">üíâ</div>
          <div class="med-info">
            <div class="med-name">Clexane</div>
            <div class="med-dose">DVT prophylaxis</div>
          </div>
          <div class="med-status"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">üíä</div>
          <div class="med-info">
            <div class="med-name">Glucophage</div>
            <div class="med-dose">Diabetes</div>
          </div>
          <div class="med-status"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">üíä</div>
          <div class="med-info">
            <div class="med-name">Lasix</div>
            <div class="med-dose">40mg PO OD</div>
          </div>
          <div class="med-status"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">‚ö†Ô∏è</div>
          <div class="med-info">
            <div class="med-name">Aldactone</div>
            <div class="med-dose">HELD - hyperK</div>
          </div>
          <div class="med-status held"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">üíä</div>
          <div class="med-info">
            <div class="med-name">Concor</div>
            <div class="med-dose">2.5mg OD</div>
          </div>
          <div class="med-status"></div>
        </div>
        <div class="med-item">
          <div class="med-icon">üíä</div>
          <div class="med-info">
            <div class="med-name">Zocor</div>
            <div class="med-dose">20mg OD</div>
          </div>
          <div class="med-status"></div>
        </div>
      </div>
    </section>

    <!-- Plan -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>Management Plan</h2>
      </div>
      <div class="plan-grid">
        <div class="plan-card">
          <h4>ü´Ä Cardiac</h4>
          <ul>
            <li>Continue Clexane + ASA</li>
            <li>Hold Aldactone (hyperkalemia)</li>
            <li>Continue Concor 2.5mg if BP allows</li>
            <li>Serial troponins for Type 2 MI monitoring</li>
            <li>Repeat Echo if clinical deterioration</li>
          </ul>
        </div>
        <div class="plan-card">
          <h4>ü´ò Renal/Metabolic</h4>
          <ul>
            <li>RFT to be repeated at 6 PM</li>
            <li>Monitor for rebound hyperkalemia</li>
            <li>Continue nephro plan</li>
            <li>Avoid nephrotoxins</li>
            <li>Consider renal referral if no improvement</li>
          </ul>
        </div>
        <div class="plan-card">
          <h4>ü©∫ Monitoring</h4>
          <ul>
            <li>Close monitoring: BP, HR, SpO2, GCS</li>
            <li>Daily weights</li>
            <li>Strict I/O charting</li>
            <li>Any deterioration ‚Üí call ICU</li>
            <li>Continue ICU F/U plan</li>
          </ul>
        </div>
        <div class="plan-card">
          <h4>üìã Disposition</h4>
          <ul>
            <li>Discharged from ICU for ward management</li>
            <li>Continue same plan per ICU discharge summary</li>
            <li>Next nephro review scheduled</li>
            <li>F/U medical plan ongoing</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Imaging -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>Recent Imaging</h2>
      </div>
      <div class="diagnosis-grid">
        <div class="diagnosis-card">
          <h4><span class="emoji">üì°</span> US Abdomen (16/01/2026)</h4>
          <ul class="diagnosis-list">
            <li>Compared to 6/10/2025<span class="value">Similar</span></li>
            <li>Left pleural effusion<span class="value warning">Mild</span></li>
            <li>Free abdominal fluid<span class="value normal">None</span></li>
            <li>IVC caliber<span class="value warning">2.8 cm</span></li>
            <li>Fatty liver<span class="value warning">Present</span></li>
          </ul>
        </div>
        <div class="diagnosis-card">
          <h4><span class="emoji">‚ù§Ô∏è</span> Echo (03/10/2025)</h4>
          <ul class="diagnosis-list">
            <li>EF<span class="value critical">20-25%</span></li>
            <li>LV size<span class="value">Upper normal</span></li>
            <li>Diastolic dysfunction<span class="value warning">Grade 1</span></li>
            <li>Global hypokinesia<span class="value critical">Present</span></li>
            <li>Aortic valve<span class="value warning">Sclerosis</span></li>
          </ul>
        </div>
      </div>
    </section>

  </main>

  <!-- Upload Modal -->
  <div class="modal" id="uploadModal">
    <div class="modal-box">
      <div class="modal-header">
        <h3 class="modal-title">Add Patient Data</h3>
        <button class="modal-close" onclick="closeUpload()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="upload-zone" id="uploadZone">
          <h4>üì§ Upload Lab Results or Notes</h4>
          <p>Drag & drop images or click to select</p>
          <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
        </div>
        <div class="processing" id="processing" style="display:none">
          <div class="spinner"></div>
          <p id="processingText">Processing with Claude AI...</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  var API = 'https://script.google.com/macros/s/AKfycbxjp-KDUx_eYvavlEHDciE-fR1V8eFM39vJfAcA7btETL-QUmrwuYU-_92_Pl20gl75kg/exec';
  
  var state = {
    patient: null,
    labs: [],
    images: []
  };

  // Load saved patient data
  function loadSavedData() {
    try {
      var saved = localStorage.getItem('rounds_patient');
      if (saved) {
        state.patient = JSON.parse(saved);
        renderPatientData();
      }
    } catch(e) {}
  }

  function saveData() {
    try {
      localStorage.setItem('rounds_patient', JSON.stringify(state.patient));
    } catch(e) {}
  }

  // Upload handling
  function openUpload() {
    document.getElementById('uploadModal').classList.add('active');
  }
  
  function closeUpload() {
    document.getElementById('uploadModal').classList.remove('active');
    document.getElementById('processing').style.display = 'none';
    document.getElementById('uploadZone').style.display = 'block';
  }

  var uploadZone = document.getElementById('uploadZone');
  var fileInput = document.getElementById('fileInput');

  uploadZone.onclick = function() { fileInput.click(); };
  
  uploadZone.ondragover = function(e) { 
    e.preventDefault(); 
    uploadZone.style.borderColor = 'var(--gold)';
    uploadZone.style.background = 'rgba(212,164,55,0.1)';
  };
  
  uploadZone.ondragleave = function() { 
    uploadZone.style.borderColor = '';
    uploadZone.style.background = '';
  };
  
  uploadZone.ondrop = function(e) {
    e.preventDefault();
    uploadZone.style.borderColor = '';
    uploadZone.style.background = '';
    if (e.dataTransfer.files.length) {
      handleFiles(e.dataTransfer.files);
    }
  };

  fileInput.onchange = function() {
    if (this.files.length) {
      handleFiles(this.files);
    }
  };

  function handleFiles(files) {
    var fileArray = Array.from(files);
    var processedCount = 0;
    
    document.getElementById('uploadZone').style.display = 'none';
    document.getElementById('processing').style.display = 'block';
    document.getElementById('processingText').textContent = 'Processing ' + files.length + ' file(s) with Claude AI...';

    fileArray.forEach(function(file, index) {
      if (file.type.startsWith('image/')) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var base64 = e.target.result;
          analyzeImage(base64, file.name, file.type, function() {
            processedCount++;
            document.getElementById('processingText').textContent = 'Processed ' + processedCount + '/' + files.length + ' files...';
            if (processedCount === fileArray.length) {
              setTimeout(function() {
                closeUpload();
                toast('‚úì All files processed!');
              }, 1000);
            }
          });
        };
        reader.readAsDataURL(file);
      }
    });
  }

  function analyzeImage(base64Data, filename, mimeType, callback) {
    var payload = {
      action: 'extractMedicalData',
      imageData: base64Data.split(',')[1],
      mimeType: mimeType,
      filename: filename,
      extractionType: 'ward_rounds',
      prompt: `You are analyzing a medical document image for ward rounds presentation. 
      
Extract ALL relevant clinical data and return a JSON object with these fields (include only what you find):

{
  "patient": {
    "name": "string",
    "mrn": "string", 
    "dob": "string",
    "age": "number",
    "gender": "string",
    "ward": "string",
    "room": "string",
    "bed": "string",
    "admitDate": "string",
    "doctor": "string"
  },
  "vitals": {
    "bp": "string",
    "hr": "string",
    "rr": "string",
    "spo2": "string",
    "temp": "string",
    "gcs": "string"
  },
  "labs": [
    {
      "name": "string",
      "value": "string",
      "unit": "string",
      "reference": "string",
      "flag": "critical|high|low|normal",
      "date": "string"
    }
  ],
  "diagnoses": ["string"],
  "problems": ["string"],
  "medications": [
    {
      "name": "string",
      "dose": "string",
      "frequency": "string",
      "status": "active|held|stopped"
    }
  ],
  "notes": "string",
  "plan": ["string"],
  "imaging": [
    {
      "type": "string",
      "date": "string",
      "findings": ["string"]
    }
  ],
  "vbg": {
    "ph": "string",
    "pco2": "string",
    "hco3": "string",
    "lactate": "string",
    "k": "string"
  }
}

Return ONLY valid JSON, no markdown or explanation.`
    };

    fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      console.log('Claude response:', d);
      if (d.success) {
        var extracted = null;
        try {
          // Try to parse the response as JSON
          var content = d.analysis || d.result || d.response || d.text || d.content;
          if (typeof content === 'string') {
            // Clean up markdown if present
            content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            extracted = JSON.parse(content);
          } else {
            extracted = content;
          }
        } catch(e) {
          console.log('Parse error, using raw response');
          extracted = d;
        }
        
        if (extracted) {
          mergePatientData(extracted);
          renderPatientData();
          saveData();
        }
      }
      if (callback) callback();
    })
    .catch(function(e) {
      console.error('Analysis error:', e);
      toast('Error processing file', true);
      if (callback) callback();
    });
  }

  function mergePatientData(newData) {
    if (!state.patient) {
      state.patient = {
        info: {},
        vitals: {},
        labs: [],
        diagnoses: [],
        problems: [],
        medications: [],
        plan: [],
        imaging: [],
        notes: [],
        vbg: []
      };
    }

    // Merge patient info
    if (newData.patient) {
      Object.assign(state.patient.info, newData.patient);
    }

    // Merge vitals
    if (newData.vitals) {
      Object.assign(state.patient.vitals, newData.vitals);
    }

    // Merge labs (add new, update existing)
    if (newData.labs && newData.labs.length) {
      newData.labs.forEach(function(newLab) {
        var existing = state.patient.labs.find(function(l) { 
          return l.name.toLowerCase() === newLab.name.toLowerCase(); 
        });
        if (existing) {
          // Add to history
          if (!existing.history) existing.history = [];
          existing.history.unshift(existing.value);
          existing.value = newLab.value;
          existing.flag = newLab.flag;
          existing.date = newLab.date;
        } else {
          state.patient.labs.push(newLab);
        }
      });
    }

    // Merge diagnoses
    if (newData.diagnoses) {
      newData.diagnoses.forEach(function(d) {
        if (!state.patient.diagnoses.includes(d)) {
          state.patient.diagnoses.push(d);
        }
      });
    }

    // Merge problems
    if (newData.problems) {
      newData.problems.forEach(function(p) {
        if (!state.patient.problems.includes(p)) {
          state.patient.problems.push(p);
        }
      });
    }

    // Merge medications
    if (newData.medications) {
      newData.medications.forEach(function(newMed) {
        var existing = state.patient.medications.find(function(m) {
          return m.name.toLowerCase() === newMed.name.toLowerCase();
        });
        if (existing) {
          Object.assign(existing, newMed);
        } else {
          state.patient.medications.push(newMed);
        }
      });
    }

    // Merge plan
    if (newData.plan) {
      newData.plan.forEach(function(p) {
        if (!state.patient.plan.includes(p)) {
          state.patient.plan.push(p);
        }
      });
    }

    // Merge imaging
    if (newData.imaging) {
      state.patient.imaging = state.patient.imaging.concat(newData.imaging);
    }

    // Merge VBG
    if (newData.vbg) {
      state.patient.vbg.push(newData.vbg);
    }

    // Add notes
    if (newData.notes) {
      state.patient.notes.push({
        text: newData.notes,
        date: new Date().toLocaleString()
      });
    }
  }

  function renderPatientData() {
    if (!state.patient) return;
    var p = state.patient;

    // Patient banner
    if (p.info.name) {
      var initials = p.info.name.split(' ').map(function(n) { return n[0]; }).join('').substring(0,2);
      document.querySelector('.patient-avatar').textContent = initials;
      document.querySelector('.patient-info h1').textContent = p.info.name;
      
      var meta = [];
      if (p.info.age) meta.push('üéÇ ' + p.info.age + ' yo ' + (p.info.gender || ''));
      if (p.info.mrn) meta.push('üìã ' + p.info.mrn);
      if (p.info.ward) meta.push('üè• ' + p.info.ward + (p.info.room ? ' ‚Ä¢ Room ' + p.info.room : '') + (p.info.bed ? ' ‚Ä¢ Bed ' + p.info.bed : ''));
      if (p.info.doctor) meta.push('üë®‚Äç‚öïÔ∏è ' + p.info.doctor);
      if (p.info.admitDate) meta.push('üìÖ Admitted: ' + p.info.admitDate);
      
      document.querySelector('.patient-meta').innerHTML = meta.map(function(m) { 
        return '<span>' + m + '</span>'; 
      }).join('');
    }

    // Vitals
    if (p.vitals) {
      updateVital('GCS', p.vitals.gcs, '/15');
      updateVital('BP', p.vitals.bp, '');
      updateVital('HR', p.vitals.hr, 'bpm');
      updateVital('SpO2', p.vitals.spo2, '%');
      updateVital('Temp', p.vitals.temp, '¬∞C');
      updateVital('RR', p.vitals.rr, '/min');
    }

    // Labs table
    if (p.labs && p.labs.length) {
      renderLabsTable(p.labs);
    }

    // Problems
    if (p.problems && p.problems.length) {
      renderProblems(p.problems);
    }

    // Medications
    if (p.medications && p.medications.length) {
      renderMedications(p.medications);
    }

    // Plan
    if (p.plan && p.plan.length) {
      renderPlan(p.plan);
    }
  }

  function updateVital(label, value, unit) {
    if (!value) return;
    var stats = document.querySelectorAll('.quick-stat');
    stats.forEach(function(stat) {
      var labelEl = stat.querySelector('.quick-stat-label');
      if (labelEl && labelEl.textContent === label) {
        stat.querySelector('.quick-stat-value').innerHTML = value + '<span class="quick-stat-unit">' + unit + '</span>';
      }
    });
  }

  function renderLabsTable(labs) {
    var tbody = document.querySelector('.labs-table tbody');
    if (!tbody) return;
    
    var html = '';
    labs.forEach(function(lab) {
      var flagClass = lab.flag === 'critical' ? 'critical' : lab.flag === 'high' ? 'high' : lab.flag === 'low' ? 'low' : 'normal';
      var history = lab.history ? lab.history.slice(0,3).map(function(h) { return '<span>' + h + '</span>'; }).join('') : '';
      var trend = lab.history && lab.history.length ? (parseFloat(lab.value) > parseFloat(lab.history[0]) ? '‚Üë' : parseFloat(lab.value) < parseFloat(lab.history[0]) ? '‚Üì' : '‚Üí') : '‚Üí';
      
      html += '<tr>';
      html += '<td class="lab-name">' + lab.name + '</td>';
      html += '<td><span class="lab-value ' + flagClass + '">' + lab.value + (lab.unit ? ' ' + lab.unit : '') + '</span></td>';
      html += '<td class="lab-history">' + history + '</td>';
      html += '<td class="lab-trend">' + trend + '</td>';
      html += '<td class="lab-ref">' + (lab.reference || '-') + '</td>';
      html += '</tr>';
    });
    tbody.innerHTML = html;
  }

  function renderProblems(problems) {
    var container = document.querySelector('.problems-list');
    if (!container) return;
    
    var html = '';
    problems.forEach(function(problem, i) {
      html += '<div class="problem-item">';
      html += '<div class="problem-num">' + (i + 1) + '</div>';
      html += '<div class="problem-content"><h4>' + problem + '</h4></div>';
      html += '</div>';
    });
    container.innerHTML = html;
  }

  function renderMedications(meds) {
    var container = document.querySelector('.med-grid');
    if (!container) return;
    
    var html = '';
    meds.forEach(function(med) {
      var statusClass = med.status === 'held' ? 'held' : med.status === 'stopped' ? 'stopped' : '';
      var icon = med.status === 'held' ? '‚ö†Ô∏è' : med.status === 'stopped' ? 'üö´' : 'üíä';
      html += '<div class="med-item">';
      html += '<div class="med-icon">' + icon + '</div>';
      html += '<div class="med-info"><div class="med-name">' + med.name + '</div><div class="med-dose">' + (med.dose || '') + ' ' + (med.frequency || '') + '</div></div>';
      html += '<div class="med-status ' + statusClass + '"></div>';
      html += '</div>';
    });
    container.innerHTML = html;
  }

  function renderPlan(plan) {
    var cards = document.querySelectorAll('.plan-card ul');
    if (cards.length && plan.length) {
      var html = plan.map(function(p) { return '<li>' + p + '</li>'; }).join('');
      cards[0].innerHTML = html;
    }
  }

  function showLabs(type) {
    document.querySelectorAll('.labs-tab').forEach(function(t) { t.classList.remove('active'); });
    event.target.classList.add('active');
    // Filter logic would go here based on type
  }

  function clearData() {
    if (confirm('Clear all patient data?')) {
      state.patient = null;
      localStorage.removeItem('rounds_patient');
      location.reload();
    }
  }

  function toast(msg, err) {
    var t = document.createElement('div');
    t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;background:var(--bg3);border:1px solid ' + (err ? 'var(--red)' : 'var(--teal)') + ';border-radius:8px;font-size:0.9rem;z-index:999;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function() { t.remove(); }, 3000);
  }

  // Initialize
  loadSavedData();

  // Expose functions globally
  window.openUpload = openUpload;
  window.closeUpload = closeUpload;
  window.showLabs = showLabs;
  window.clearData = clearData;
})();
</script>

</body>
</html>
