<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Bug Analysis - MedWard Master</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9rem;
            color: #666;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.critical .stat-value { color: #e74c3c; }
        .stat-card.error .stat-value { color: #e67e22; }
        .stat-card.warning .stat-value { color: #f39c12; }
        .stat-card.info .stat-value { color: #3498db; }
        .stat-card.resolved .stat-value { color: #27ae60; }
        .stat-card.mobile .stat-value { color: #9b59b6; }

        /* Filter Section */
        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .filter-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .filter-btn {
            padding: 8px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .btn-refresh {
            background: #3498db;
            color: white;
        }

        .btn-export {
            background: #27ae60;
            color: white;
        }

        .btn-clear {
            background: #e74c3c;
            color: white;
        }

        .btn-back {
            background: #95a5a6;
            color: white;
        }

        /* Bug List */
        .bug-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 15px;
        }

        .bug-list-header {
            padding: 15px;
            background: #667eea;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bug-list-title {
            font-size: 1rem;
            font-weight: bold;
        }

        .bug-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .bug-items {
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .bug-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation;
        }

        .bug-item:active {
            background: #f8f9fa;
        }

        .bug-item:last-child {
            border-bottom: none;
        }

        .bug-item.resolved {
            opacity: 0.6;
        }

        .bug-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .bug-type {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        .bug-severity {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .severity-critical { background: #e74c3c; color: white; }
        .severity-error { background: #e67e22; color: white; }
        .severity-warning { background: #f39c12; color: white; }
        .severity-info { background: #3498db; color: white; }

        .bug-message {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .bug-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.75rem;
            color: #999;
        }

        .bug-meta span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* Bug Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .close-btn {
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 5px 10px;
            line-height: 1;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-label {
            font-size: 0.85rem;
            font-weight: bold;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 0.95rem;
            color: #333;
            word-break: break-word;
        }

        .detail-value.code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.1rem;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            .action-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üêõ Bug Analysis</h1>
            <p>Post hoc analysis of application errors and events</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading bug data...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Stats Grid -->
            <div class="stats-grid" id="stats-grid">
                <!-- Stats populated by JS -->
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <div class="filter-title">Filter by Severity</div>
                <div class="filter-buttons" id="severity-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="critical">Critical</button>
                    <button class="filter-btn" data-filter="error">Error</button>
                    <button class="filter-btn" data-filter="warning">Warning</button>
                    <button class="filter-btn" data-filter="info">Info</button>
                </div>
                <div class="filter-title">Status</div>
                <div class="filter-buttons" id="status-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="unresolved">Unresolved</button>
                    <button class="filter-btn" data-filter="resolved">Resolved</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn btn-refresh" id="refresh-btn">
                    üîÑ Refresh
                </button>
                <button class="action-btn btn-export" id="export-btn">
                    üì• Export
                </button>
                <button class="action-btn btn-clear" id="clear-btn">
                    üóëÔ∏è Clear All
                </button>
                <button class="action-btn btn-back" id="back-btn">
                    ‚Üê Back
                </button>
            </div>

            <!-- Bug List -->
            <div class="bug-list">
                <div class="bug-list-header">
                    <div class="bug-list-title">Bug History</div>
                    <div class="bug-count" id="bug-count">0</div>
                </div>
                <div class="bug-items" id="bug-items">
                    <!-- Bugs populated by JS -->
                </div>
            </div>
        </div>

        <!-- Bug Detail Modal -->
        <div class="modal" id="bug-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Bug Details</div>
                    <div class="close-btn" id="close-modal">√ó</div>
                </div>
                <div id="bug-detail-content">
                    <!-- Details populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="js/bug-tracker.js"></script>
    <script>
        let allBugs = [];
        let filteredBugs = [];
        let currentFilters = {
            severity: 'all',
            status: 'all'
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadBugs();
            setupEventListeners();
        });

        // Load bugs and display
        async function loadBugs() {
            try {
                await BugTracker.init();
                allBugs = await BugTracker.getAllBugs();
                const analysis = await BugTracker.generateAnalysis();

                displayStats(analysis);
                applyFilters();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load bugs:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #e74c3c;">‚ùå Failed to load bugs</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                `;
            }
        }

        // Display statistics
        function displayStats(analysis) {
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card error">
                    <div class="stat-value">${analysis.total}</div>
                    <div class="stat-label">Total Bugs</div>
                </div>
                <div class="stat-card critical">
                    <div class="stat-value">${analysis.bySeverity.critical || 0}</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${analysis.bySeverity.warning || 0}</div>
                    <div class="stat-label">Warnings</div>
                </div>
                <div class="stat-card resolved">
                    <div class="stat-value">${analysis.resolved}</div>
                    <div class="stat-label">Resolved</div>
                </div>
                <div class="stat-card mobile">
                    <div class="stat-value">${analysis.mobileIssues}</div>
                    <div class="stat-label">Mobile</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value">${analysis.unresolved}</div>
                    <div class="stat-label">Unresolved</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-value">${analysis.recentBugs.length}</div>
                    <div class="stat-label">Last 24h</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${Object.keys(analysis.byType).length}</div>
                    <div class="stat-label">Bug Types</div>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            filteredBugs = allBugs.filter(bug => {
                if (currentFilters.severity !== 'all' && bug.severity !== currentFilters.severity) {
                    return false;
                }
                if (currentFilters.status === 'resolved' && !bug.resolved) {
                    return false;
                }
                if (currentFilters.status === 'unresolved' && bug.resolved) {
                    return false;
                }
                return true;
            });

            displayBugs();
        }

        // Display bug list
        function displayBugs() {
            const bugItems = document.getElementById('bug-items');
            const bugCount = document.getElementById('bug-count');

            bugCount.textContent = filteredBugs.length;

            if (filteredBugs.length === 0) {
                bugItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <p>No bugs found with current filters</p>
                    </div>
                `;
                return;
            }

            bugItems.innerHTML = filteredBugs.map(bug => `
                <div class="bug-item ${bug.resolved ? 'resolved' : ''}" data-bug-id="${bug.id}">
                    <div class="bug-header">
                        <div class="bug-type">${bug.type || 'Unknown'}</div>
                        <div class="bug-severity severity-${bug.severity || 'info'}">${bug.severity || 'info'}</div>
                    </div>
                    <div class="bug-message">${escapeHtml(bug.message || 'No message')}</div>
                    <div class="bug-meta">
                        <span>‚è±Ô∏è ${formatDate(bug.timestamp)}</span>
                        <span>${bug.isMobile ? 'üì± Mobile' : 'üíª Desktop'}</span>
                        ${bug.resolved ? '<span>‚úÖ Resolved</span>' : ''}
                    </div>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.bug-item').forEach(item => {
                item.addEventListener('click', () => {
                    const bugId = parseInt(item.dataset.bugId);
                    showBugDetail(bugId);
                });
            });
        }

        // Show bug detail modal
        function showBugDetail(bugId) {
            const bug = allBugs.find(b => b.id === bugId);
            if (!bug) return;

            const detailContent = document.getElementById('bug-detail-content');
            detailContent.innerHTML = `
                <div class="detail-group">
                    <div class="detail-label">Bug ID</div>
                    <div class="detail-value">#${bug.id}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Type</div>
                    <div class="detail-value">${bug.type || 'Unknown'}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Severity</div>
                    <div class="detail-value">
                        <span class="bug-severity severity-${bug.severity || 'info'}">${bug.severity || 'info'}</span>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Message</div>
                    <div class="detail-value">${escapeHtml(bug.message || 'No message')}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Timestamp</div>
                    <div class="detail-value">${formatDateFull(bug.timestamp)}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Platform</div>
                    <div class="detail-value">${bug.isMobile ? 'üì± Mobile' : 'üíª Desktop'} (${bug.viewport.width}x${bug.viewport.height})</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">URL</div>
                    <div class="detail-value">${escapeHtml(bug.url)}</div>
                </div>
                ${bug.source ? `
                <div class="detail-group">
                    <div class="detail-label">Source</div>
                    <div class="detail-value">${escapeHtml(bug.source)}${bug.line ? `:${bug.line}` : ''}</div>
                </div>
                ` : ''}
                ${bug.stack ? `
                <div class="detail-group">
                    <div class="detail-label">Stack Trace</div>
                    <div class="detail-value code">${escapeHtml(bug.stack)}</div>
                </div>
                ` : ''}
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">${bug.resolved ? '‚úÖ Resolved' : '‚ùå Unresolved'}</div>
                </div>
                <div class="modal-actions">
                    ${!bug.resolved ? `<button class="action-btn btn-refresh" onclick="markBugResolved(${bug.id})">‚úì Mark Resolved</button>` : ''}
                    <button class="action-btn btn-clear" onclick="deleteSingleBug(${bug.id})">üóëÔ∏è Delete</button>
                </div>
            `;

            document.getElementById('bug-modal').classList.add('active');
        }

        // Mark bug as resolved
        async function markBugResolved(bugId) {
            try {
                await BugTracker.markResolved(bugId);
                document.getElementById('bug-modal').classList.remove('active');
                await loadBugs();
            } catch (error) {
                alert('Failed to mark bug as resolved: ' + error.message);
            }
        }

        // Delete single bug
        async function deleteSingleBug(bugId) {
            if (!confirm('Delete this bug?')) return;

            try {
                await BugTracker.deleteBug(bugId);
                document.getElementById('bug-modal').classList.remove('active');
                await loadBugs();
            } catch (error) {
                alert('Failed to delete bug: ' + error.message);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('#severity-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#severity-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.severity = btn.dataset.filter;
                    applyFilters();
                });
            });

            document.querySelectorAll('#status-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#status-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.status = btn.dataset.filter;
                    applyFilters();
                });
            });

            // Action buttons
            document.getElementById('refresh-btn').addEventListener('click', loadBugs);

            document.getElementById('export-btn').addEventListener('click', async () => {
                try {
                    const exportData = await BugTracker.exportBugs();
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `medward-bugs-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Export failed: ' + error.message);
                }
            });

            document.getElementById('clear-btn').addEventListener('click', async () => {
                if (!confirm('Clear all bugs? This cannot be undone.')) return;

                try {
                    await BugTracker.clearAll();
                    await loadBugs();
                } catch (error) {
                    alert('Failed to clear bugs: ' + error.message);
                }
            });

            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // Modal close
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('bug-modal').classList.remove('active');
            });

            document.getElementById('bug-modal').addEventListener('click', (e) => {
                if (e.target.id === 'bug-modal') {
                    document.getElementById('bug-modal').classList.remove('active');
                }
            });
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        }

        function formatDateFull(timestamp) {
            return new Date(timestamp).toLocaleString();
        }
    </script>
</body>
</html>
