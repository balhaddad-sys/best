<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<title>Neural Analytics - MedWard Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#030712;--bg-card:#0a0f1a;--bg-elevated:#111827;--text:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--gold:#f59e0b;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--blue:#3b82f6;--border:rgba(255,255,255,0.08);--border-light:rgba(255,255,255,0.12);--radius:16px;--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
.mono{font-family:'JetBrains Mono',monospace}

/* Header */
.header{background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));border-bottom:1px solid var(--border);padding:20px 24px;position:sticky;top:0;z-index:100}
.header-content{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:16px}
.logo{width:48px;height:48px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:14px;display:grid;place-items:center}
.logo svg{width:28px;height:28px;stroke:#fff;fill:none}
.header-title{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-subtitle{font-size:0.8rem;color:var(--text-muted)}
.header-right{display:flex;align-items:center;gap:16px}
.status-badge{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg);border:1px solid var(--border);border-radius:100px;font-size:0.8rem}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--emerald);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.refresh-btn{padding:10px 20px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
.refresh-btn:hover{border-color:var(--gold);color:var(--gold)}
.refresh-btn.loading{pointer-events:none;opacity:0.7}
.refresh-btn.loading svg{animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Setup */
.setup-container{max-width:500px;margin:100px auto;padding:24px;text-align:center}
.setup-icon{font-size:4rem;margin-bottom:24px}
.setup-title{font-size:1.5rem;font-weight:700;margin-bottom:12px}
.setup-desc{color:var(--text-muted);margin-bottom:32px}
.setup-input{width:100%;padding:16px 20px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.9rem;margin-bottom:16px}
.setup-input:focus{outline:none;border-color:var(--gold)}
.setup-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:var(--radius-sm);color:#fff;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s}
.setup-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(139,92,246,0.3)}

/* Main Content */
.main{max-width:1400px;margin:0 auto;padding:24px}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--stat-color,var(--gold))}
.stat-icon{font-size:2rem;margin-bottom:12px}
.stat-value{font-size:2.5rem;font-weight:800;margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.stat-value.positive{color:var(--emerald)}
.stat-value.negative{color:var(--rose)}
.stat-value.neutral{color:var(--gold)}
.stat-label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
.stat-change{position:absolute;top:20px;right:20px;font-size:0.75rem;padding:4px 10px;border-radius:100px;font-weight:600}
.stat-change.up{background:rgba(16,185,129,0.15);color:var(--emerald)}
.stat-change.down{background:rgba(244,63,94,0.15);color:var(--rose)}

/* Charts Section */
.charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:32px}
@media(max-width:900px){.charts-grid{grid-template-columns:1fr}}
.chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chart-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.chart-title{font-weight:700;display:flex;align-items:center;gap:10px}
.chart-body{padding:24px}
.chart-container{height:280px;position:relative}

/* Learning Progress */
.progress-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:32px}
.progress-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.progress-title{font-weight:700;font-size:1.1rem;display:flex;align-items:center;gap:10px}
.progress-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
.progress-metric{background:var(--bg);border-radius:var(--radius-sm);padding:20px}
.progress-metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.progress-metric-label{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase}
.progress-metric-value{font-size:1.25rem;font-weight:700;font-family:'JetBrains Mono',monospace}
.progress-bar{height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden}
.progress-bar-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.progress-bar-fill.green{background:linear-gradient(90deg,var(--emerald),var(--teal))}
.progress-bar-fill.gold{background:linear-gradient(90deg,var(--gold),var(--orange))}
.progress-bar-fill.purple{background:linear-gradient(90deg,var(--purple),var(--blue))}

/* Interactions Table */
.table-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:32px}
.table-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.table-title{font-weight:700;display:flex;align-items:center;gap:10px}
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:16px 20px;text-align:left;border-bottom:1px solid var(--border)}
th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;background:var(--bg)}
td{font-size:0.85rem}
tr:hover td{background:rgba(255,255,255,0.02)}
.feedback-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:100px;font-size:0.75rem;font-weight:600}
.feedback-badge.positive{background:rgba(16,185,129,0.15);color:var(--emerald)}
.feedback-badge.negative{background:rgba(244,63,94,0.15);color:var(--rose)}
.type-badge{padding:4px 10px;border-radius:6px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
.type-badge.lab{background:rgba(139,92,246,0.15);color:var(--purple)}
.type-badge.imaging{background:rgba(59,130,246,0.15);color:var(--blue)}

/* Pattern Cards */
.patterns-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:32px}
.pattern-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.pattern-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.pattern-name{font-weight:600;display:flex;align-items:center;gap:8px}
.pattern-score{font-size:1.5rem;font-weight:800;font-family:'JetBrains Mono',monospace}
.pattern-score.high{color:var(--emerald)}
.pattern-score.medium{color:var(--gold)}
.pattern-score.low{color:var(--rose)}
.pattern-stats{display:flex;gap:16px;font-size:0.8rem;color:var(--text-secondary)}
.pattern-stat{display:flex;align-items:center;gap:4px}

/* Empty State */
.empty-state{text-align:center;padding:80px 24px;color:var(--text-muted)}
.empty-icon{font-size:4rem;margin-bottom:16px;opacity:0.4}
.empty-title{font-size:1.25rem;font-weight:600;margin-bottom:8px;color:var(--text)}
.empty-desc{font-size:0.9rem}

/* Loading */
.loading-container{display:flex;align-items:center;justify-content:center;padding:60px}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:16px 28px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
</style>
</head>
<body>

<div id="setupPage" style="display:none">
  <div class="setup-container">
    <div class="setup-icon">üß†</div>
    <h1 class="setup-title">Neural Analytics Setup</h1>
    <p class="setup-desc">Enter your MedWard Pro API endpoint to connect to the learning system.</p>
    <input type="text" id="apiUrlInput" class="setup-input" placeholder="https://script.google.com/macros/s/...../exec">
    <button class="setup-btn" onclick="saveApiUrl()">Connect</button>
  </div>
</div>

<div id="mainApp" style="display:none">
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">
          <svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 2a4 4 0 0 1 4 4v1a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M12 11v11"/><path d="M8 15h8"/><circle cx="12" cy="19" r="2"/></svg>
        </div>
        <div>
          <div class="header-title">Neural Analytics</div>
          <div class="header-subtitle">MedWard Pro Learning System Monitor</div>
        </div>
      </div>
      <div class="header-right">
        <div class="status-badge">
          <div class="status-dot"></div>
          <span>System Active</span>
        </div>
        <button class="refresh-btn" id="refreshBtn" onclick="loadAnalytics()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
          Refresh
        </button>
      </div>
    </div>
  </header>

  <main class="main" id="mainContent">
    <div class="loading-container">
      <div class="spinner"></div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
const CONFIG = {
  STORAGE_KEY: 'medward_analytics_api',
  REFRESH_INTERVAL: 60000
};

let state = {
  apiUrl: null,
  data: null,
  charts: {}
};

const $ = id => document.getElementById(id);

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function init() {
  const savedUrl = localStorage.getItem(CONFIG.STORAGE_KEY);
  if (savedUrl) {
    state.apiUrl = savedUrl;
    $('setupPage').style.display = 'none';
    $('mainApp').style.display = 'block';
    loadAnalytics();
    setInterval(loadAnalytics, CONFIG.REFRESH_INTERVAL);
  } else {
    $('setupPage').style.display = 'block';
    $('mainApp').style.display = 'none';
  }
}

function saveApiUrl() {
  const url = $('apiUrlInput').value.trim();
  if (!url || !url.includes('script.google.com')) {
    toast('Please enter a valid Google Apps Script URL', true);
    return;
  }
  localStorage.setItem(CONFIG.STORAGE_KEY, url);
  state.apiUrl = url;
  $('setupPage').style.display = 'none';
  $('mainApp').style.display = 'block';
  loadAnalytics();
}

async function loadAnalytics() {
  const btn = $('refreshBtn');
  btn.classList.add('loading');
  
  try {
    const res = await fetch(state.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'getAnalytics' })
    });
    const data = await res.json();
    
    if (data.success) {
      state.data = data.analytics;
      renderDashboard();
    } else {
      renderEmpty(data.error || 'Failed to load analytics');
    }
  } catch (e) {
    renderEmpty('Connection failed. Check your API URL.');
  }
  
  btn.classList.remove('loading');
}

function renderEmpty(message) {
  $('mainContent').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">üìä</div>
      <div class="empty-title">No Learning Data Yet</div>
      <div class="empty-desc">${message || 'Start using MedWard Pro and provide feedback on AI interpretations to see analytics here.'}</div>
    </div>
  `;
}

function renderDashboard() {
  const d = state.data;
  if (!d || (!d.totalFeedback && !d.totalInteractions)) {
    renderEmpty();
    return;
  }
  
  const positiveRate = d.totalFeedback > 0 ? Math.round((d.positiveFeedback / d.totalFeedback) * 100) : 0;
  const learningScore = Math.min(100, Math.round((d.positiveExamples / 100) * 100));
  const convergenceRate = d.recentTrend || 0;
  
  $('mainContent').innerHTML = `
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card" style="--stat-color:var(--purple)">
        <div class="stat-icon">üìä</div>
        <div class="stat-value neutral">${d.totalFeedback || 0}</div>
        <div class="stat-label">Total Feedback Signals</div>
      </div>
      <div class="stat-card" style="--stat-color:var(--emerald)">
        <div class="stat-icon">üëç</div>
        <div class="stat-value positive">${d.positiveFeedback || 0}</div>
        <div class="stat-label">Positive Feedback</div>
        ${d.totalFeedback > 0 ? `<div class="stat-change up">‚Üë ${positiveRate}%</div>` : ''}
      </div>
      <div class="stat-card" style="--stat-color:var(--rose)">
        <div class="stat-icon">üëé</div>
        <div class="stat-value negative">${d.negativeFeedback || 0}</div>
        <div class="stat-label">Negative Feedback</div>
      </div>
      <div class="stat-card" style="--stat-color:var(--teal)">
        <div class="stat-icon">üß†</div>
        <div class="stat-value neutral">${d.positiveExamples || 0}</div>
        <div class="stat-label">Learning Examples</div>
      </div>
      <div class="stat-card" style="--stat-color:var(--gold)">
        <div class="stat-icon">‚ö°</div>
        <div class="stat-value neutral">${d.totalInteractions || 0}</div>
        <div class="stat-label">Total Interactions</div>
      </div>
    </div>
    
    <!-- Learning Progress -->
    <div class="progress-section">
      <div class="progress-header">
        <div class="progress-title">üéØ Learning Progress</div>
      </div>
      <div class="progress-metrics">
        <div class="progress-metric">
          <div class="progress-metric-header">
            <span class="progress-metric-label">Feedback Quality</span>
            <span class="progress-metric-value">${positiveRate}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill green" style="width:${positiveRate}%"></div>
          </div>
        </div>
        <div class="progress-metric">
          <div class="progress-metric-header">
            <span class="progress-metric-label">Learning Examples</span>
            <span class="progress-metric-value">${d.positiveExamples || 0}/100</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill purple" style="width:${learningScore}%"></div>
          </div>
        </div>
        <div class="progress-metric">
          <div class="progress-metric-header">
            <span class="progress-metric-label">RAG Coverage</span>
            <span class="progress-metric-value">${d.ragCoverage || 0}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill gold" style="width:${d.ragCoverage || 0}%"></div>
          </div>
        </div>
        <div class="progress-metric">
          <div class="progress-metric-header">
            <span class="progress-metric-label">Model Confidence</span>
            <span class="progress-metric-value">${Math.round(positiveRate * 0.9 + 10)}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill green" style="width:${Math.round(positiveRate * 0.9 + 10)}%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">üìà Feedback Over Time</div>
        </div>
        <div class="chart-body">
          <div class="chart-container"><canvas id="feedbackChart"></canvas></div>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">üéØ Feedback Distribution</div>
        </div>
        <div class="chart-body">
          <div class="chart-container"><canvas id="distributionChart"></canvas></div>
        </div>
      </div>
    </div>
    
    <!-- Pattern Performance -->
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">üîç Interpretation Type Performance</div>
      </div>
      <div class="patterns-grid" style="padding:20px">
        ${Object.entries(d.patterns || {}).map(([type, stats]) => {
          const score = stats.total > 0 ? Math.round((stats.positive / stats.total) * 100) : 0;
          const scoreClass = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';
          return `
            <div class="pattern-card">
              <div class="pattern-header">
                <div class="pattern-name">
                  <span class="type-badge ${type}">${type}</span>
                </div>
                <div class="pattern-score ${scoreClass}">${score}%</div>
              </div>
              <div class="pattern-stats">
                <div class="pattern-stat">üëç ${stats.positive || 0}</div>
                <div class="pattern-stat">üëé ${stats.negative || 0}</div>
                <div class="pattern-stat">üìä ${stats.total || 0} total</div>
              </div>
            </div>
          `;
        }).join('') || '<div style="color:var(--text-muted);padding:20px">No patterns recorded yet</div>'}
      </div>
    </div>
    
    <!-- Recent Interactions -->
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">üïê Recent Feedback</div>
      </div>
      ${d.recentFeedback?.length ? `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Feedback</th>
                <th>Patient ID</th>
              </tr>
            </thead>
            <tbody>
              ${d.recentFeedback.slice(0, 10).map(fb => `
                <tr>
                  <td class="mono" style="font-size:0.8rem">${formatTime(fb.timestamp)}</td>
                  <td><span class="type-badge ${fb.interpretationType || 'lab'}">${fb.interpretationType || 'lab'}</span></td>
                  <td><span class="feedback-badge ${fb.rating > 0 ? 'positive' : 'negative'}">${fb.rating > 0 ? 'üëç Helpful' : 'üëé Not helpful'}</span></td>
                  <td class="mono" style="font-size:0.8rem;color:var(--text-muted)">${fb.patientId || '‚Äî'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : '<div class="empty-state" style="padding:40px"><div class="empty-icon">üìù</div><div>No recent feedback</div></div>'}
    </div>
    
    <!-- System Info -->
    <div class="stats-grid" style="margin-top:32px">
      <div class="stat-card" style="--stat-color:var(--blue)">
        <div class="stat-icon">üóÑÔ∏è</div>
        <div class="stat-value neutral" style="font-size:1.5rem">${d.storageUsed || '0 KB'}</div>
        <div class="stat-label">Storage Used</div>
      </div>
      <div class="stat-card" style="--stat-color:var(--teal)">
        <div class="stat-icon">‚è±Ô∏è</div>
        <div class="stat-value neutral" style="font-size:1.5rem">${d.avgLatency || '‚Äî'}ms</div>
        <div class="stat-label">Avg Response Time</div>
      </div>
      <div class="stat-card" style="--stat-color:var(--purple)">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value neutral" style="font-size:1rem">${formatTime(d.lastUpdated) || 'Never'}</div>
        <div class="stat-label">Last Updated</div>
      </div>
    </div>
  `;
  
  // Render Charts
  setTimeout(() => {
    renderFeedbackChart(d);
    renderDistributionChart(d);
  }, 100);
}

function renderFeedbackChart(d) {
  const ctx = document.getElementById('feedbackChart');
  if (!ctx) return;
  
  if (state.charts.feedback) state.charts.feedback.destroy();
  
  const timeline = d.feedbackTimeline || [];
  const labels = timeline.map(t => t.date);
  const positive = timeline.map(t => t.positive || 0);
  const negative = timeline.map(t => t.negative || 0);
  
  state.charts.feedback = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.length ? labels : ['No data'],
      datasets: [
        {
          label: 'Positive',
          data: positive.length ? positive : [0],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16,185,129,0.1)',
          fill: true,
          tension: 0.4
        },
        {
          label: 'Negative',
          data: negative.length ? negative : [0],
          borderColor: '#f43f5e',
          backgroundColor: 'rgba(244,63,94,0.1)',
          fill: true,
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#9ca3af' } }
      },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' }, beginAtZero: true }
      }
    }
  });
}

function renderDistributionChart(d) {
  const ctx = document.getElementById('distributionChart');
  if (!ctx) return;
  
  if (state.charts.distribution) state.charts.distribution.destroy();
  
  state.charts.distribution = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Positive', 'Negative'],
      datasets: [{
        data: [d.positiveFeedback || 0, d.negativeFeedback || 0],
        backgroundColor: ['#10b981', '#f43f5e'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          position: 'bottom',
          labels: { color: '#9ca3af', padding: 20 }
        }
      },
      cutout: '70%'
    }
  });
}

function formatTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

// Initialize
init();
</script>
</body>
</html>
