<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neural Learning Assessment - MedWard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 5px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      color: #667eea;
      font-size: 20px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }

    .status-badge.active {
      background: #10b981;
      color: white;
    }

    .status-badge.inactive {
      background: #ef4444;
      color: white;
    }

    .status-badge.learning {
      background: #f59e0b;
      color: white;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .metric {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .metric-label {
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }

    .metric-value.good {
      color: #10b981;
    }

    .metric-value.warning {
      color: #f59e0b;
    }

    .metric-value.bad {
      color: #ef4444;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      transition: border-color 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button.primary {
      background: #667eea;
      color: white;
    }

    button.primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    button.secondary {
      background: #64748b;
      color: white;
    }

    button.secondary:hover {
      background: #475569;
    }

    button.danger {
      background: #ef4444;
      color: white;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    .response-box {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .response-source {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .response-source.local {
      background: #dcfce7;
      color: #166534;
    }

    .response-source.api {
      background: #fef3c7;
      color: #92400e;
    }

    .response-source.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .response-source::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .pattern-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .pattern-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #667eea;
    }

    .pattern-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .pattern-id {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #64748b;
    }

    .pattern-stats {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #64748b;
    }

    .pattern-signature {
      font-size: 12px;
      color: #334155;
      margin-top: 5px;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }

    .timeline {
      position: relative;
      padding-left: 30px;
      max-height: 400px;
      overflow-y: auto;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e2e8f0;
    }

    .timeline-item {
      position: relative;
      padding: 12px;
      margin-bottom: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -26px;
      top: 16px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: white;
      border: 3px solid #667eea;
    }

    .timeline-item.local::before {
      border-color: #10b981;
    }

    .timeline-item.api::before {
      border-color: #f59e0b;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .timeline-time {
      font-size: 11px;
      color: #64748b;
    }

    .timeline-content {
      font-size: 13px;
      color: #334155;
    }

    .example-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .example-btn {
      padding: 10px 15px;
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .example-btn:hover {
      background: #e2e8f0;
      border-color: #667eea;
    }

    .example-title {
      font-weight: 600;
      color: #334155;
      margin-bottom: 3px;
    }

    .example-desc {
      font-size: 11px;
      color: #64748b;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #1e40af;
    }

    .progress-bar {
      background: #e2e8f0;
      border-radius: 10px;
      height: 8px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: width 0.3s;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß† Neural Learning Assessment</h1>
      <p class="subtitle">Monitor and test the MedWard Neural learning system in real-time</p>
    </header>

    <div class="info-box">
      <strong>How it works:</strong> The first time you analyze similar lab data, the system uses Claude API (slower, costs $).
      After learning the pattern, subsequent similar analyses use local inference (instant, free). This page helps you verify that learning is happening.
    </div>

    <div class="grid">
      <!-- Input Section -->
      <div class="card">
        <h2>üìã Test Input</h2>
        <textarea id="testInput" placeholder="Paste lab report text here or use an example below..."></textarea>

        <div class="example-buttons">
          <button class="example-btn" onclick="loadExample('anemia')">
            <div class="example-title">Anemia Case</div>
            <div class="example-desc">Low Hb, microcytic</div>
          </button>
          <button class="example-btn" onclick="loadExample('infection')">
            <div class="example-title">Infection Case</div>
            <div class="example-desc">High WBC, elevated CRP</div>
          </button>
          <button class="example-btn" onclick="loadExample('aki')">
            <div class="example-title">AKI Case</div>
            <div class="example-desc">Elevated Cr, low eGFR</div>
          </button>
          <button class="example-btn" onclick="loadExample('hyperkalemia')">
            <div class="example-title">Hyperkalemia</div>
            <div class="example-desc">Critical K+ level</div>
          </button>
        </div>

        <div class="button-group">
          <button class="primary" id="analyzeBtn" onclick="analyzeData()">
            Analyze with Neural System
          </button>
          <button class="secondary" onclick="clearInput()">Clear Input</button>
        </div>

        <div id="responseContainer"></div>
      </div>

      <!-- Metrics Section -->
      <div class="card">
        <h2>üìä Learning Metrics <span class="status-badge" id="systemStatus">Initializing...</span></h2>
        <div class="metrics-grid" id="metricsGrid">
          <div class="metric">
            <div class="metric-label">Total Analyses</div>
            <div class="metric-value" id="metricTotal">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Local Inferences</div>
            <div class="metric-value good" id="metricLocal">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">API Calls</div>
            <div class="metric-value warning" id="metricAPI">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Cache Hit Rate</div>
            <div class="metric-value" id="metricCacheRate">0%</div>
          </div>
          <div class="metric">
            <div class="metric-label">Patterns Learned</div>
            <div class="metric-value" id="metricPatterns">0</div>
          </div>
          <div class="metric">
            <div class="metric-label">Avg Local Time</div>
            <div class="metric-value good" id="metricLocalTime">0ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">Avg API Time</div>
            <div class="metric-value" id="metricAPITime">0ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">Est. Savings</div>
            <div class="metric-value good" id="metricSavings">$0.00</div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <strong style="color: #334155;">Learning Progress</strong>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #64748b;">
            <span id="progressText">No patterns learned yet</span>
          </div>
        </div>

        <div class="button-group" style="margin-top: 20px;">
          <button class="secondary" onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
          <button class="danger" onclick="resetLearning()">üóëÔ∏è Reset Learning</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Analysis Timeline -->
      <div class="card">
        <h2>üìà Analysis Timeline</h2>
        <div class="timeline" id="timeline">
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div>No analyses yet. Try analyzing some lab data above!</div>
          </div>
        </div>
      </div>

      <!-- Learned Patterns -->
      <div class="card">
        <h2>üéì Learned Patterns</h2>
        <div class="pattern-list" id="patternList">
          <div class="empty-state">
            <div class="empty-state-icon">üß©</div>
            <div>No patterns learned yet. Analyze data to start learning!</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/medward-neural.js"></script>
  <script>
    let neuralSystem = null;
    let analysisHistory = [];

    // Example lab data
    const examples = {
      anemia: `WBC 7.2 √ó10‚Åπ/L
RBC 3.2 L √ó10¬π¬≤/L
Hb 85 L g/L
Hct 0.28 L L/L
MCV 72 L fL
MCH 24 L pg
Plt 245 √ó10‚Åπ/L
Ferritin 8 L Œºg/L`,

      infection: `WBC 18.5 H √ó10‚Åπ/L
Neutrophils 14.2 H √ó10‚Åπ/L
Lymphocytes 2.1 √ó10‚Åπ/L
CRP 85 H mg/L
ESR 42 H mm/hr
Procalcitonin 2.8 H ng/mL`,

      aki: `Cr 285 H Œºmol/L
BUN 18.5 H mmol/L
eGFR 22 L mL/min/1.73m¬≤
K 5.8 H mmol/L
Na 132 L mmol/L
Urea 18.5 H mmol/L`,

      hyperkalemia: `K 6.8 H mmol/L
Na 138 mmol/L
Cl 102 mmol/L
CO2 18 L mmol/L
Cr 245 H Œºmol/L
BUN 15.2 H mmol/L`
    };

    // Initialize neural system
    async function initializeSystem() {
      try {
        neuralSystem = new MedWardNeural({
          debug: true,
          confidenceThreshold: 0.75,
          criticalThreshold: 0.90
        });

        await neuralSystem.initialize();
        updateSystemStatus('active');
        refreshMetrics();
        refreshPatterns();

        console.log('Neural system initialized successfully');
      } catch (error) {
        console.error('Failed to initialize neural system:', error);
        updateSystemStatus('inactive');
      }
    }

    // Update system status badge
    function updateSystemStatus(status) {
      const badge = document.getElementById('systemStatus');
      badge.className = 'status-badge ' + status;
      badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }

    // Load example data
    function loadExample(type) {
      document.getElementById('testInput').value = examples[type];
    }

    // Clear input
    function clearInput() {
      document.getElementById('testInput').value = '';
      document.getElementById('responseContainer').innerHTML = '';
    }

    // Analyze data
    async function analyzeData() {
      const input = document.getElementById('testInput').value.trim();
      if (!input) {
        alert('Please enter some lab data or select an example');
        return;
      }

      if (!neuralSystem) {
        alert('Neural system not initialized yet. Please wait...');
        return;
      }

      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Analyzing...';

      updateSystemStatus('learning');

      try {
        const startTime = performance.now();
        const result = await neuralSystem.process(input, 'lab');
        const elapsed = Math.round(performance.now() - startTime);

        // Display result
        displayResult(result, elapsed);

        // Add to timeline
        addToTimeline(result, elapsed);

        // Refresh metrics and patterns
        refreshMetrics();
        refreshPatterns();

        updateSystemStatus('active');

      } catch (error) {
        console.error('Analysis error:', error);
        document.getElementById('responseContainer').innerHTML = `
          <div class="response-box">
            <div class="response-source error">Error</div>
            <div style="color: #dc2626; font-size: 14px;">${error.message}</div>
          </div>
        `;
        updateSystemStatus('active');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analyze with Neural System';
      }
    }

    // Display analysis result
    function displayResult(result, elapsed) {
      const source = result.meta?.source || 'unknown';
      const confidence = result.meta?.confidence || 0;

      let sourceClass = source === 'local' ? 'local' : source === 'api' ? 'api' : 'error';
      let sourceText = source === 'local'
        ? `LOCAL INFERENCE (Cached Pattern) - ${elapsed}ms`
        : source === 'api'
        ? `API INFERENCE (Learning New Pattern) - ${elapsed}ms`
        : 'ERROR';

      let html = `
        <div class="response-box">
          <div class="response-source ${sourceClass}">${sourceText}</div>
      `;

      if (result.meta) {
        html += `<div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">`;
        if (result.meta.confidence !== undefined) {
          html += `Confidence: ${(confidence * 100).toFixed(1)}% | `;
        }
        if (result.meta.signature) {
          html += `Signature: <code style="font-size: 10px;">${result.meta.signature.substring(0, 50)}...</code>`;
        }
        html += `</div>`;
      }

      if (result.parsed?.summary) {
        const s = result.parsed.summary;
        html += `
          <div style="background: white; padding: 12px; border-radius: 6px; margin: 10px 0;">
            <strong>Summary:</strong> ${s.total} tests -
            <span style="color: #10b981;">${s.normal} normal</span>,
            <span style="color: #f59e0b;">${s.abnormal} abnormal</span>,
            <span style="color: #ef4444;">${s.critical} critical</span>
          </div>
        `;
      }

      if (result.result?.problems?.length > 0) {
        html += `<div style="margin-top: 10px;"><strong>Problems Found:</strong><ul style="margin-left: 20px; margin-top: 5px;">`;
        result.result.problems.slice(0, 5).forEach(prob => {
          html += `<li style="margin: 5px 0; font-size: 13px;">${prob.title || prob.issue || 'Unknown problem'}</li>`;
        });
        html += `</ul></div>`;
      }

      html += `</div>`;
      document.getElementById('responseContainer').innerHTML = html;
    }

    // Add to timeline
    function addToTimeline(result, elapsed) {
      const source = result.meta?.source || 'unknown';
      const now = new Date().toLocaleTimeString();

      analysisHistory.unshift({
        source,
        time: now,
        elapsed,
        confidence: result.meta?.confidence || 0,
        testCount: result.parsed?.summary?.total || 0
      });

      // Keep only last 20
      if (analysisHistory.length > 20) {
        analysisHistory = analysisHistory.slice(0, 20);
      }

      updateTimeline();
    }

    // Update timeline display
    function updateTimeline() {
      const timeline = document.getElementById('timeline');

      if (analysisHistory.length === 0) {
        timeline.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div>No analyses yet. Try analyzing some lab data above!</div>
          </div>
        `;
        return;
      }

      let html = '';
      analysisHistory.forEach((item, idx) => {
        const sourceClass = item.source === 'local' ? 'local' : 'api';
        const sourceText = item.source === 'local' ? '‚ö° Local' : 'üåê API';
        const confidenceText = item.confidence > 0 ? ` (${(item.confidence * 100).toFixed(0)}%)` : '';

        html += `
          <div class="timeline-item ${sourceClass}">
            <div class="timeline-header">
              <strong style="font-size: 14px;">${sourceText}${confidenceText}</strong>
              <span class="timeline-time">${item.time}</span>
            </div>
            <div class="timeline-content">
              ${item.testCount} tests analyzed in ${item.elapsed}ms
            </div>
          </div>
        `;
      });

      timeline.innerHTML = html;
    }

    // Refresh metrics
    function refreshMetrics() {
      if (!neuralSystem) return;

      const metrics = neuralSystem.getMetrics();

      document.getElementById('metricTotal').textContent = metrics.total || 0;
      document.getElementById('metricLocal').textContent = metrics.local || 0;
      document.getElementById('metricAPI').textContent = metrics.api || 0;
      document.getElementById('metricCacheRate').textContent = metrics.cacheHitRate || '0%';
      document.getElementById('metricPatterns').textContent = metrics.patterns || 0;
      document.getElementById('metricLocalTime').textContent = (metrics.avgLocalMs || 0) + 'ms';
      document.getElementById('metricAPITime').textContent = (metrics.avgApiMs || 0) + 'ms';
      document.getElementById('metricSavings').textContent = metrics.estimatedSavings || '$0.00';

      // Update progress bar
      const maxPatterns = 10000;
      const currentPatterns = metrics.patterns || 0;
      const progressPct = Math.min((currentPatterns / maxPatterns) * 100, 100);

      document.getElementById('progressFill').style.width = progressPct + '%';
      document.getElementById('progressText').textContent =
        currentPatterns > 0
          ? `${currentPatterns} patterns stored (${progressPct.toFixed(1)}% of capacity)`
          : 'No patterns learned yet';

      // Update cache rate color
      const cacheRateEl = document.getElementById('metricCacheRate');
      const cacheRate = parseFloat(metrics.cacheHitRate) || 0;
      cacheRateEl.className = 'metric-value ' + (cacheRate >= 50 ? 'good' : cacheRate >= 20 ? 'warning' : '');
    }

    // Refresh patterns list
    function refreshPatterns() {
      if (!neuralSystem) return;

      const patterns = neuralSystem.patternStore.getAll().slice(0, 20);
      const listEl = document.getElementById('patternList');

      if (patterns.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üß©</div>
            <div>No patterns learned yet. Analyze data to start learning!</div>
          </div>
        `;
        return;
      }

      let html = '';
      patterns.forEach(pattern => {
        const age = Math.round((Date.now() - pattern.createdAt) / 1000);
        const ageText = age < 60 ? `${age}s ago` : `${Math.round(age / 60)}m ago`;

        html += `
          <div class="pattern-item">
            <div class="pattern-header">
              <span class="pattern-id">${pattern.id}</span>
            </div>
            <div class="pattern-stats">
              <span>‚úì ${(pattern.successRate * 100).toFixed(0)}%</span>
              <span>üîÑ ${pattern.usageCount || 0} uses</span>
              <span>‚è±Ô∏è ${ageText}</span>
            </div>
            <div class="pattern-signature">${pattern.signature?.substring(0, 100) || 'No signature'}...</div>
          </div>
        `;
      });

      listEl.innerHTML = html;
    }

    // Reset learning
    async function resetLearning() {
      if (!confirm('This will clear all learned patterns and reset metrics. Continue?')) {
        return;
      }

      if (neuralSystem) {
        await neuralSystem.clearKnowledge();
        analysisHistory = [];
        refreshMetrics();
        refreshPatterns();
        updateTimeline();
        alert('Learning data reset successfully!');
      }
    }

    // Initialize on load
    window.addEventListener('load', () => {
      initializeSystem();

      // Auto-refresh metrics every 5 seconds
      setInterval(refreshMetrics, 5000);
    });
  </script>
</body>
</html>
