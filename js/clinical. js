/**
 * MedWard Clinical Module
 * Handles clinical data parsing, lab value analysis, and results rendering
 * @version 2.0.0
 */

// ============================================
// LAB REFERENCE RANGES
// ============================================
const LAB_RANGES = {
  // Electrolytes
  sodium: { name: 'Sodium', min: 136, max: 146, unit: 'mmol/L', category: 'Electrolytes', aliases: ['na'] },
  potassium: { name: 'Potassium', min: 3.5, max: 5.1, unit: 'mmol/L', category: 'Electrolytes', aliases: ['k'] },
  chloride: { name: 'Chloride', min: 98, max: 107, unit: 'mmol/L', category: 'Electrolytes', aliases: ['cl'] },
  calcium: { name: 'Calcium', min: 2.1, max: 2.6, unit: 'mmol/L', category: 'Electrolytes', aliases: ['ca'] },
  magnesium: { name: 'Magnesium', min: 0.73, max: 1.06, unit: 'mmol/L', category: 'Electrolytes', aliases: ['mg'] },
  phosphate: { name: 'Phosphate', min: 0.81, max: 1.45, unit: 'mmol/L', category: 'Electrolytes', aliases: ['phos'] },
  
  // Renal Function
  urea: { name: 'Urea', min: 2.8, max: 7.2, unit: 'mmol/L', category: 'Renal', aliases: ['bun'] },
  creatinine: { name: 'Creatinine', min: 64, max: 104, unit: 'Œºmol/L', category: 'Renal', aliases: ['cr', 'crea'] },
  egfr: { name: 'eGFR', min: 60, max: 999, unit: 'mL/min', category: 'Renal', aliases: ['gfr'] },
  
  // Liver Function
  alt: { name: 'ALT', min: 0, max: 41, unit: 'IU/L', category: 'Liver', critical: 500, aliases: ['sgpt'] },
  ast: { name: 'AST', min: 0, max: 40, unit: 'IU/L', category: 'Liver', critical: 500, aliases: ['sgot'] },
  ggt: { name: 'GGT', min: 8, max: 61, unit: 'IU/L', category: 'Liver', aliases: [] },
  alkphos: { name: 'ALP', min: 40, max: 129, unit: 'IU/L', category: 'Liver', aliases: ['alp', 'alkaline phosphatase'] },
  bilirubin: { name: 'Bilirubin', min: 5, max: 21, unit: 'Œºmol/L', category: 'Liver', aliases: ['tbili', 'total bilirubin'] },
  albumin: { name: 'Albumin', min: 35, max: 52, unit: 'g/L', category: 'Liver', aliases: ['alb'] },
  
  // Hematology
  wbc: { name: 'WBC', min: 4.5, max: 11.0, unit: '√ó10‚Åπ/L', category: 'Hematology', aliases: ['white blood cells', 'leukocytes'] },
  hemoglobin: { name: 'Hemoglobin', min: 130, max: 170, unit: 'g/L', category: 'Hematology', aliases: ['hgb', 'hb'] },
  hematocrit: { name: 'Hematocrit', min: 38, max: 50, unit: '%', category: 'Hematology', aliases: ['hct'] },
  platelets: { name: 'Platelets', min: 150, max: 400, unit: '√ó10‚Åπ/L', category: 'Hematology', aliases: ['plt'] },
  
  // Coagulation
  pt: { name: 'PT', min: 9.6, max: 13.6, unit: 'sec', category: 'Coagulation', aliases: ['prothrombin time'] },
  inr: { name: 'INR', min: 0.85, max: 1.15, unit: '', category: 'Coagulation', aliases: [] },
  aptt: { name: 'APTT', min: 25, max: 37, unit: 'sec', category: 'Coagulation', aliases: ['ptt'] },
  
  // Cardiac
  troponin: { name: 'Troponin', min: 0, max: 19.8, unit: 'ng/L', category: 'Cardiac', critical: 50, aliases: ['tni', 'tnt', 'hs-troponin'] },
  bnp: { name: 'BNP', min: 0, max: 100, unit: 'pg/mL', category: 'Cardiac', aliases: ['nt-probnp'] },
  
  // Blood Gas
  ph: { name: 'pH', min: 7.35, max: 7.45, unit: '', category: 'Blood Gas', aliases: [] },
  pco2: { name: 'pCO2', min: 35, max: 45, unit: 'mmHg', category: 'Blood Gas', aliases: [] },
  po2: { name: 'pO2', min: 80, max: 100, unit: 'mmHg', category: 'Blood Gas', aliases: [] },
  hco3: { name: 'HCO3', min: 22, max: 26, unit: 'mmol/L', category: 'Blood Gas', aliases: ['bicarbonate'] },
  lactate: { name: 'Lactate', min: 0.5, max: 2.2, unit: 'mmol/L', category: 'Blood Gas', critical: 4, aliases: [] },
  
  // Metabolic
  glucose: { name: 'Glucose', min: 4.1, max: 5.6, unit: 'mmol/L', category: 'Metabolic', aliases: ['blood sugar', 'bs'] },
  hba1c: { name: 'HbA1c', min: 4, max: 5.6, unit: '%', category: 'Metabolic', aliases: ['a1c', 'glycated hemoglobin'] },
  
  // Inflammatory
  crp: { name: 'CRP', min: 0, max: 5, unit: 'mg/L', category: 'Inflammatory', aliases: ['c-reactive protein'] },
  esr: { name: 'ESR', min: 0, max: 20, unit: 'mm/hr', category: 'Inflammatory', aliases: ['sed rate'] },
  procalcitonin: { name: 'Procalcitonin', min: 0, max: 0.5, unit: 'ng/mL', category: 'Inflammatory', aliases: ['pct'] }
};

// ============================================
// CLINICAL PARSER
// ============================================
const ClinicalParser = {
  /**
   * Extract lab values from text using regex patterns
   */
  extractLabs(text) {
    if (!text) return [];
    
    const labs = [];
    const foundLabs = new Set();
    const textLower = text.toLowerCase();
    
    // Build patterns for each lab
    for (const [key, ref] of Object.entries(LAB_RANGES)) {
      const names = [key, ref.name.toLowerCase(), ...(ref.aliases || [])];
      
      for (const name of names) {
        if (foundLabs.has(key)) break;
        
        // Pattern: name followed by value with optional flag
        const pattern = new RegExp(
          `\\b${this.escapeRegex(name)}[:\\s]*([><=]?\\d+\\.?\\d*)\\s*([a-zA-Z/%¬≤¬≥√ó‚Åπ]*)\\s*(?:\\(?([HhLl]|high|low|normal)\\)?)?`,
          'gi'
        );
        
        const matches = [...text.matchAll(pattern)];
        for (const match of matches) {
          if (foundLabs.has(key)) break;
          
          const value = parseFloat(match[1]);
          if (isNaN(value)) continue;
          
          const flag = match[3]?.toUpperCase() || '';
          let status = 'normal';
          
          if (flag === 'H' || flag === 'HIGH' || value > ref.max) {
            status = ref.critical && value >= ref.critical ? 'critical' : 'high';
          } else if (flag === 'L' || flag === 'LOW' || value < ref.min) {
            status = 'low';
          }
          
          foundLabs.add(key);
          labs.push({
            name: ref.name,
            value: value,
            valueDisplay: `${value} ${ref.unit}`,
            reference: `${ref.min}-${ref.max}`,
            referenceDisplay: `${ref.min}-${ref.max} ${ref.unit}`,
            unit: ref.unit,
            status,
            category: ref.category,
            isAbnormal: status !== 'normal',
            isCritical: status === 'critical'
          });
        }
      }
    }
    
    return labs;
  },
  
  /**
   * Extract vital signs from text
   */
  extractVitals(text) {
    if (!text) return {};
    
    const vitals = {};
    const patterns = {
      bp: /(?:bp|blood pressure)[:\s]*(\d{2,3})[\/\\](\d{2,3})/i,
      hr: /(?:hr|heart rate|pulse)[:\s]*(\d{2,3})/i,
      rr: /(?:rr|respiratory rate|resp)[:\s]*(\d{1,2})/i,
      temp: /(?:temp|temperature)[:\s]*(\d{2}(?:\.\d)?)/i,
      spo2: /(?:spo2|sao2|o2 sat|oxygen)[:\s]*(\d{2,3})%?/i
    };
    
    for (const [key, pattern] of Object.entries(patterns)) {
      const match = text.match(pattern);
      if (match) {
        if (key === 'bp') {
          const sys = parseInt(match[1]);
          const dia = parseInt(match[2]);
          vitals.bp = {
            value: `${sys}/${dia}`,
            systolic: sys,
            diastolic: dia,
            status: (sys < 90 || sys > 180 || dia < 60 || dia > 110) ? 'abnormal' : 'normal'
          };
        } else {
          const value = parseFloat(match[1]);
          let status = 'normal';
          
          if (key === 'hr' && (value < 50 || value > 120)) status = 'abnormal';
          if (key === 'rr' && (value < 12 || value > 25)) status = 'abnormal';
          if (key === 'temp' && (value < 36 || value > 38.5)) status = 'abnormal';
          if (key === 'spo2' && value < 92) status = 'abnormal';
          
          vitals[key] = { value, status };
        }
      }
    }
    
    return vitals;
  },
  
  /**
   * Parse complete clinical text
   */
  parse(text) {
    if (!text) return null;
    
    return {
      labs: this.extractLabs(text),
      vitals: this.extractVitals(text),
      rawText: text
    };
  },
  
  escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
};

// ============================================
// CLINICAL RENDERER
// ============================================
const ClinicalRenderer = {
  currentLabs: [],
  
  /**
   * Render detailed analysis view
   */
  renderDetailedView(results) {
    const container = document.getElementById('detailed-view');
    if (!container) return;
    
    const interp = this.getInterpretation(results);
    const extractedText = results.extractedText || '';
    const labs = ClinicalParser.extractLabs(extractedText);
    this.currentLabs = labs;
    
    // Determine severity
    const severity = this.determineSeverity(results, labs, interp);
    
    let html = '<div class="analysis-report">';
    
    // Severity header
    html += this.renderSeverityHeader(severity, interp.summary || 'Clinical Analysis');
    
    // Summary
    if (interp.summary) {
      html += this.renderSection('Summary', interp.summary, 'summary');
    }
    
    // Key findings
    if (interp.keyFindings?.length > 0) {
      html += this.renderFindings(interp.keyFindings);
    }
    
    // Abnormalities
    if (interp.abnormalities?.length > 0) {
      html += this.renderAlerts(interp.abnormalities);
    }
    
    // Lab summary
    if (labs.length > 0) {
      html += this.renderLabSummary(labs);
    }
    
    // Recommendations
    const recs = interp.presentation?.recommendations || results.recommendations || [];
    if (recs.length > 0) {
      html += this.renderRecommendations(recs);
    }
    
    // Patient explanation
    if (interp.presentation?.patientFriendly) {
      html += this.renderSection('Patient Explanation', interp.presentation.patientFriendly, 'patient');
    }
    
    // Clinical pearls
    if (results.clinicalPearls?.length > 0) {
      html += this.renderPearls(results.clinicalPearls);
    }
    
    html += '</div>';
    container.innerHTML = html;
    
    this.injectStyles();
  },
  
  /**
   * Render labs view
   */
  renderLabsView(results) {
    const container = document.getElementById('labs-view');
    if (!container) return;
    
    const labs = this.currentLabs.length > 0 
      ? this.currentLabs 
      : ClinicalParser.extractLabs(results.extractedText || '');
    
    if (labs.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <h3>No Lab Values Detected</h3>
          <p>Upload a lab report to see analysis</p>
        </div>
      `;
      return;
    }
    
    // Group by category
    const grouped = {};
    labs.forEach(lab => {
      const cat = lab.category || 'Other';
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(lab);
    });
    
    // Stats
    const stats = {
      total: labs.length,
      normal: labs.filter(l => !l.isAbnormal).length,
      abnormal: labs.filter(l => l.isAbnormal && !l.isCritical).length,
      critical: labs.filter(l => l.isCritical).length
    };
    
    let html = '<div class="labs-panel">';
    
    // Summary stats
    html += `
      <div class="labs-stats">
        <div class="labs-stat"><span class="stat-value">${stats.total}</span><span class="stat-label">Total</span></div>
        <div class="labs-stat critical"><span class="stat-value">${stats.critical}</span><span class="stat-label">Critical</span></div>
        <div class="labs-stat abnormal"><span class="stat-value">${stats.abnormal}</span><span class="stat-label">Abnormal</span></div>
        <div class="labs-stat normal"><span class="stat-value">${stats.normal}</span><span class="stat-label">Normal</span></div>
      </div>
    `;
    
    // Categories
    const categoryOrder = ['Electrolytes', 'Renal', 'Liver', 'Hematology', 'Cardiac', 'Coagulation', 'Blood Gas', 'Metabolic', 'Inflammatory', 'Other'];
    const sortedCategories = Object.keys(grouped).sort((a, b) => 
      (categoryOrder.indexOf(a) || 99) - (categoryOrder.indexOf(b) || 99)
    );
    
    for (const category of sortedCategories) {
      const categoryLabs = grouped[category];
      const abnormalCount = categoryLabs.filter(l => l.isAbnormal).length;
      
      html += `
        <div class="labs-category">
          <div class="labs-category-header">
            <span class="category-name">${this.esc(category)}</span>
            <span class="category-count">${categoryLabs.length} tests${abnormalCount > 0 ? ` ¬∑ <span class="abnormal">${abnormalCount} abnormal</span>` : ''}</span>
          </div>
          <table class="labs-table">
            <thead>
              <tr>
                <th>Parameter</th>
                <th>Result</th>
                <th>Reference</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${categoryLabs.map(lab => `
                <tr class="${lab.isAbnormal ? 'abnormal-row' : ''}">
                  <td class="lab-name">${this.esc(lab.name)}</td>
                  <td class="lab-value ${lab.status}">${this.esc(lab.valueDisplay)}</td>
                  <td class="lab-ref">${this.esc(lab.referenceDisplay)}</td>
                  <td>${this.renderStatusBadge(lab.status)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    html += '</div>';
    container.innerHTML = html;
  },
  
  /**
   * Render ward view
   */
  renderWardView(results) {
    const container = document.getElementById('ward-view');
    if (!container) return;
    
    const interp = this.getInterpretation(results);
    const labs = this.currentLabs;
    const recs = interp.presentation?.recommendations || results.recommendations || [];
    
    let html = '<div class="ward-view">';
    
    // Assessment card
    html += `
      <div class="ward-card">
        <div class="ward-card-header">Assessment</div>
        <div class="ward-card-body">
          <div class="ward-row">
            <span class="ward-label">Diagnosis</span>
            <span class="ward-value">${this.esc(results.diagnosis || interp.summary || 'Pending')}</span>
          </div>
          ${results.severity ? `
          <div class="ward-row">
            <span class="ward-label">Severity</span>
            <span class="ward-value">${this.esc(results.severity)}</span>
          </div>
          ` : ''}
        </div>
      </div>
    `;
    
    // Abnormal values card
    const abnormalLabs = labs.filter(l => l.isAbnormal);
    if (abnormalLabs.length > 0) {
      html += `
        <div class="ward-card">
          <div class="ward-card-header">Abnormal Values</div>
          <div class="ward-card-body">
            ${abnormalLabs.slice(0, 6).map(lab => `
              <div class="ward-row">
                <span class="ward-label">${this.esc(lab.name)}</span>
                <span class="ward-value ${lab.status}">${this.esc(lab.valueDisplay)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // Plan card
    if (recs.length > 0) {
      html += `
        <div class="ward-card">
          <div class="ward-card-header">Plan</div>
          <div class="ward-card-body">
            ${recs.slice(0, 5).map((rec, i) => `
              <div class="ward-row">
                <span class="ward-num">${i + 1}</span>
                <span class="ward-value">${this.esc(typeof rec === 'string' ? rec : rec.text)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    html += '</div>';
    container.innerHTML = html;
  },
  
  // Helper methods
  getInterpretation(results) {
    if (results.interpretation && typeof results.interpretation === 'object') return results.interpretation;
    if (results.rawResponse?.interpretation) return results.rawResponse.interpretation;
    try { return JSON.parse(results.interpretation); } catch { return {}; }
  },
  
  determineSeverity(results, labs, interp) {
    if (labs.some(l => l.isCritical)) return 'critical';
    const summary = (interp.summary || '').toLowerCase();
    if (summary.includes('critical') || summary.includes('emergency')) return 'critical';
    if (labs.some(l => l.isAbnormal)) return 'abnormal';
    if (summary.includes('abnormal') || summary.includes('elevated')) return 'abnormal';
    return 'normal';
  },
  
  renderSeverityHeader(severity, title) {
    const config = {
      critical: { icon: 'üî¥', label: 'CRITICAL', color: '#ef4444' },
      abnormal: { icon: 'üü°', label: 'ABNORMAL', color: '#f59e0b' },
      normal: { icon: 'üü¢', label: 'NORMAL', color: '#10b981' }
    };
    const cfg = config[severity] || config.normal;
    
    return `
      <div class="severity-header ${severity}">
        <div class="severity-badge">${cfg.icon} ${cfg.label}</div>
        <h2 class="severity-title">${this.esc(title.substring(0, 100))}</h2>
      </div>
    `;
  },
  
  renderSection(label, content, type = 'default') {
    return `
      <div class="section ${type}">
        <div class="section-label">${this.esc(label)}</div>
        <div class="section-content">${this.esc(content)}</div>
      </div>
    `;
  },
  
  renderFindings(findings) {
    return `
      <div class="section findings">
        <div class="section-label">Key Findings</div>
        <ul class="findings-list">
          ${findings.map(f => `<li>${this.esc(typeof f === 'string' ? f : f.finding || f.text)}</li>`).join('')}
        </ul>
      </div>
    `;
  },
  
  renderAlerts(abnormalities) {
    return `
      <div class="alerts-section">
        ${abnormalities.map(a => `
          <div class="alert-item">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span class="alert-text">${this.esc(typeof a === 'string' ? a : a.text)}</span>
          </div>
        `).join('')}
      </div>
    `;
  },
  
  renderLabSummary(labs) {
    const abnormal = labs.filter(l => l.isAbnormal);
    if (abnormal.length === 0) {
      return `
        <div class="section labs-summary normal">
          <div class="section-label">Lab Values</div>
          <div class="section-content">‚úì All ${labs.length} values within normal limits</div>
        </div>
      `;
    }
    
    return `
      <div class="section labs-summary">
        <div class="section-label">Lab Values (${abnormal.length} abnormal)</div>
        <div class="labs-quick">
          ${abnormal.slice(0, 5).map(lab => `
            <div class="lab-quick-item ${lab.status}">
              <span class="lab-quick-name">${this.esc(lab.name)}</span>
              <span class="lab-quick-value">${this.esc(lab.valueDisplay)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  },
  
  renderRecommendations(recs) {
    return `
      <div class="section recommendations">
        <div class="section-label">Recommendations</div>
        <ol class="recs-list">
          ${recs.map((r, i) => `
            <li class="${i === 0 ? 'priority' : ''}">${this.esc(typeof r === 'string' ? r : r.text)}</li>
          `).join('')}
        </ol>
      </div>
    `;
  },
  
  renderPearls(pearls) {
    return `
      <div class="section pearls">
        <div class="section-label">üí° Clinical Pearls</div>
        <div class="pearls-list">
          ${pearls.map(p => `<div class="pearl">${this.esc(typeof p === 'string' ? p : p.text)}</div>`).join('')}
        </div>
      </div>
    `;
  },
  
  renderStatusBadge(status) {
    const badges = {
      critical: '<span class="status-badge critical">‚ö† Critical</span>',
      high: '<span class="status-badge high">‚Üë High</span>',
      low: '<span class="status-badge low">‚Üì Low</span>',
      normal: '<span class="status-badge normal">‚úì Normal</span>'
    };
    return badges[status] || badges.normal;
  },
  
  esc(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },
  
  injectStyles() {
    if (document.getElementById('clinical-styles')) return;
    
    const styles = document.createElement('style');
    styles.id = 'clinical-styles';
    styles.textContent = `
      .analysis-report { padding: 0.5rem; }
      
      .severity-header {
        padding: 1rem 1.25rem;
        border-radius: 12px;
        margin-bottom: 1.25rem;
      }
      .severity-header.critical { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
      .severity-header.abnormal { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); }
      .severity-header.normal { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); }
      
      .severity-badge {
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }
      .severity-header.critical .severity-badge { color: #fca5a5; }
      .severity-header.abnormal .severity-badge { color: #fcd34d; }
      .severity-header.normal .severity-badge { color: #6ee7b7; }
      
      .severity-title {
        font-size: 1.125rem;
        font-weight: 600;
        line-height: 1.4;
      }
      
      .section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .section-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 0.75rem;
      }
      
      .section-content {
        font-size: 0.9rem;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.85);
      }
      
      .section.patient {
        background: rgba(78, 205, 196, 0.05);
        border-color: rgba(78, 205, 196, 0.2);
      }
      .section.patient .section-label { color: #4ecdc4; }
      
      .section.pearls {
        background: rgba(240, 198, 116, 0.05);
        border-color: rgba(240, 198, 116, 0.2);
      }
      .section.pearls .section-label { color: #f0c674; }
      
      .findings-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .findings-list li {
        padding: 0.5rem 0;
        padding-left: 1.5rem;
        position: relative;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }
      .findings-list li:last-child { border-bottom: none; }
      .findings-list li::before {
        content: '‚Ä¢';
        position: absolute;
        left: 0;
        color: var(--accent-primary);
      }
      
      .alerts-section { margin-bottom: 1rem; }
      .alert-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(239, 68, 68, 0.05);
        border-left: 3px solid #ef4444;
        border-radius: 0 8px 8px 0;
        margin-bottom: 0.5rem;
      }
      .alert-icon { font-size: 1rem; }
      .alert-text { font-size: 0.875rem; color: #fca5a5; }
      
      .labs-quick {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .lab-quick-item {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.5rem 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        border-left: 2px solid;
        font-size: 0.8rem;
      }
      .lab-quick-item.high, .lab-quick-item.critical { border-color: #ef4444; }
      .lab-quick-item.low { border-color: #3b82f6; }
      .lab-quick-name { color: rgba(255, 255, 255, 0.7); }
      .lab-quick-value { font-weight: 600; font-family: var(--font-mono); }
      .lab-quick-item.high .lab-quick-value, .lab-quick-item.critical .lab-quick-value { color: #fca5a5; }
      .lab-quick-item.low .lab-quick-value { color: #93c5fd; }
      
      .recs-list {
        margin: 0;
        padding-left: 1.25rem;
      }
      .recs-list li {
        padding: 0.5rem 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .recs-list li.priority {
        font-weight: 600;
        color: #fca5a5;
      }
      
      .pearl {
        padding: 0.75rem;
        background: rgba(240, 198, 116, 0.1);
        border-radius: 8px;
        font-size: 0.875rem;
        font-style: italic;
        color: rgba(255, 255, 255, 0.85);
      }
      
      /* Labs Panel */
      .labs-panel { padding: 0.5rem; }
      
      .labs-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.25rem;
      }
      .labs-stat {
        flex: 1;
        text-align: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
      }
      .labs-stat .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        font-family: var(--font-mono);
        color: var(--accent-primary);
      }
      .labs-stat.critical .stat-value { color: #ef4444; }
      .labs-stat.abnormal .stat-value { color: #f59e0b; }
      .labs-stat.normal .stat-value { color: #10b981; }
      .labs-stat .stat-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
      }
      
      .labs-category {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        margin-bottom: 1rem;
        overflow: hidden;
      }
      
      .labs-category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .category-name { font-weight: 600; font-size: 0.9rem; }
      .category-count { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); }
      .category-count .abnormal { color: #fcd34d; }
      
      .labs-table {
        width: 100%;
        border-collapse: collapse;
      }
      .labs-table th {
        padding: 0.5rem 0.75rem;
        text-align: left;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.4);
        background: rgba(0, 0, 0, 0.2);
      }
      .labs-table td {
        padding: 0.6rem 0.75rem;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }
      .labs-table tr.abnormal-row { background: rgba(239, 68, 68, 0.03); }
      
      .lab-name { color: rgba(255, 255, 255, 0.85); }
      .lab-value { font-family: var(--font-mono); font-weight: 600; }
      .lab-value.high, .lab-value.critical { color: #fca5a5; }
      .lab-value.low { color: #93c5fd; }
      .lab-value.normal { color: #6ee7b7; }
      .lab-ref { font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); font-family: var(--font-mono); }
      
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.5rem;
        border-radius: 100px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-badge.critical { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
      .status-badge.high { background: rgba(239, 68, 68, 0.1); color: #fca5a5; }
      .status-badge.low { background: rgba(59, 130, 246, 0.1); color: #93c5fd; }
      .status-badge.normal { background: rgba(16, 185, 129, 0.1); color: #6ee7b7; }
      
      /* Ward View */
      .ward-view {
        display: grid;
        gap: 1rem;
        padding: 0.5rem;
      }
      
      .ward-card {
        border: 2px solid var(--accent-primary);
        border-radius: 12px;
        overflow: hidden;
      }
      
      .ward-card-header {
        background: var(--accent-primary);
        color: var(--bg-primary);
        padding: 0.75rem 1rem;
        font-weight: 600;
      }
      
      .ward-card-body { padding: 1rem; }
      
      .ward-row {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .ward-row:last-child { border-bottom: none; }
      
      .ward-label {
        min-width: 100px;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
      }
      
      .ward-num {
        width: 24px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.5);
      }
      
      .ward-value { flex: 1; font-size: 0.9rem; }
      .ward-value.high, .ward-value.critical { color: #fca5a5; }
      .ward-value.low { color: #93c5fd; }
    `;
    document.head.appendChild(styles);
  }
};

// ============================================
// EXPORTS
// ============================================
if (typeof window !== 'undefined') {
  window.LAB_RANGES = LAB_RANGES;
  window.ClinicalParser = ClinicalParser;
  window.ClinicalRenderer = ClinicalRenderer;
}
