/**
 * MedWard Patient Presentation System v2.0
 * Parses diagnosis field and renders organized clinical presentation
 * Optimized for Kuwait MOH EMR format
 */

const PatientPresentation = {

  // ==================== PARSER ====================

  /**
   * Main parsing function - takes diagnosis text and returns structured data
   */
  parse(text) {
    if (!text || typeof text !== 'string') return null;
    
    const normalized = text.replace(/\r\n/g, '\n').replace(/\t+/g, ' ').replace(/[ ]+/g, ' ').trim();
    
    return {
      demographics: this.extractDemographics(normalized),
      chiefComplaint: this.extractChiefComplaint(normalized),
      hpi: this.extractHPI(normalized),
      pmh: this.extractPMH(normalized),
      medications: this.extractMedications(normalized),
      vitals: this.extractVitals(normalized),
      labs: this.extractLabs(normalized),
      abg: this.extractABG(normalized),
      imaging: this.extractImaging(normalized),
      examination: this.extractExamination(normalized),
      assessment: this.extractAssessment(normalized),
      plan: this.extractPlan(normalized),
      rawText: text
    };
  },

  /**
   * Extract demographics
   */
  extractDemographics(text) {
    const demo = {};
    
    // Age
    const ageMatch = text.match(/(\d{1,3})\s*(?:yo|y\.?o\.?|yrs?|years?\s*old)/i);
    if (ageMatch) demo.age = parseInt(ageMatch[1]);
    
    // Gender
    if (/\b(male|gentleman|man)\b/i.test(text) && !/female/i.test(text)) demo.gender = 'Male';
    else if (/\b(female|lady|woman)\b/i.test(text)) demo.gender = 'Female';
    
    // Smoking
    if (/smoker|smoking/i.test(text)) demo.smoker = true;
    
    return demo;
  },

  /**
   * Extract chief complaint
   */
  extractChiefComplaint(text) {
    const patterns = [
      /(?:c\/c|cc|chief complaint|presented? (?:with|to er|for))[:\s]+([^\n.]+)/i,
      /(?:admitted (?:for|with)|came with)[:\s]+([^\n.]+)/i
    ];
    for (const p of patterns) {
      const m = text.match(p);
      if (m) return m[1].trim();
    }
    return null;
  },

  /**
   * Extract HPI
   */
  extractHPI(text) {
    const hpi = { duration: null, symptoms: [], negatives: [] };
    
    // Duration
    const durMatch = text.match(/(?:for (?:the )?(?:last|past)\s*)?(\d+)\s*(days?|weeks?|months?|hours?)/i);
    if (durMatch) hpi.duration = `${durMatch[1]} ${durMatch[2]}`;
    
    // Symptoms
    const symptoms = ['sob', 'shortness of breath', 'dyspnea', 'chest pain', 'fever', 'cough', 
      'vomiting', 'nausea', 'diarrhea', 'constipation', 'abdominal pain', 'headache', 
      'dizziness', 'weakness', 'fatigue', 'swelling', 'edema', 'palpitations', 'syncope',
      'orthopnea', 'pnd', 'decreased oral intake', 'weight loss', 'jaundice', 'confusion'];
    
    const textLower = text.toLowerCase();
    symptoms.forEach(s => {
      if (textLower.includes(s) && !new RegExp(`no\\s+${s}`, 'i').test(text)) {
        hpi.symptoms.push(this.capitalize(s));
      }
    });
    
    // Negatives
    const negMatch = text.match(/no\s+(chest pain|fever|vomiting|nausea|sweating|cough|abdominal pain)/gi);
    if (negMatch) {
      negMatch.forEach(n => hpi.negatives.push(n.replace(/^no\s+/i, '')));
    }
    
    return hpi;
  },

  /**
   * Extract PMH
   */
  extractPMH(text) {
    const pmh = { conditions: [], surgeries: [] };
    
    const conditions = {
      'DM': ['\\bdm\\b', 'diabetes', 'diabetic', 't2dm', 't1dm'],
      'HTN': ['\\bhtn\\b', 'hypertension', 'hypertensive'],
      'IHD': ['\\bihd\\b', 'ischemic heart', '\\bcad\\b', 'coronary artery'],
      'HF': ['\\bhf\\b', 'heart failure', '\\bchf\\b', '\\blvf\\b'],
      'CKD': ['\\bckd\\b', 'chronic kidney', 'renal failure'],
      'AF': ['\\baf\\b', 'a-fib', 'atrial fibrillation'],
      'CVA': ['\\bcva\\b', 'stroke', 'cerebrovascular'],
      'COPD': ['\\bcopd\\b', 'chronic obstructive'],
      'Asthma': ['asthma'],
      'Dyslipidemia': ['dyslipidemia', 'hyperlipidemia'],
      'Hypothyroid': ['hypothyroid'],
      'GERD': ['\\bgerd\\b', 'reflux'],
      'Cirrhosis': ['cirrhosis', 'chronic liver'],
      'Epilepsy': ['epilepsy', 'seizure disorder'],
      'PCI': ['\\bpci\\b', 'angioplasty'],
      'CABG': ['\\bcabg\\b', 'bypass']
    };
    
    for (const [cond, patterns] of Object.entries(conditions)) {
      for (const p of patterns) {
        if (new RegExp(p, 'i').test(text)) {
          if (!pmh.conditions.includes(cond)) pmh.conditions.push(cond);
          break;
        }
      }
    }
    
    // Surgeries
    const surgeryMatch = text.match(/(spinal|disc|prostate|cardiac|abdominal|hip|knee)\s*(surgery|operation|replacement)/gi);
    if (surgeryMatch) pmh.surgeries = surgeryMatch;
    
    // Stent info
    if (/no stent/i.test(text)) pmh.noStent = true;
    if (/with stent/i.test(text)) pmh.hasStent = true;
    
    return pmh;
  },

  /**
   * Extract medications
   */
  extractMedications(text) {
    const meds = [];
    
    // Medication database
    const medDb = {
      cardiac: ['aspirin', 'clopidogrel', 'plavix', 'warfarin', 'rivaroxaban', 'xarelto', 'apixaban', 'eliquis',
        'metoprolol', 'bisoprolol', 'carvedilol', 'concor', 'atenolol', 'amlodipine', 'norvasc',
        'lisinopril', 'enalapril', 'ramipril', 'tritace', 'losartan', 'valsartan', 'telmisartan',
        'furosemide', 'lasix', 'spironolactone', 'aldactone', 'hydrochlorothiazide',
        'atorvastatin', 'rosuvastatin', 'simvastatin', 'zocor', 'lipitor', 'crestor',
        'digoxin', 'amiodarone', 'isosorbide', 'nitroglycerin', 'clexane', 'enoxaparin', 'heparin'],
      diabetes: ['metformin', 'glucophage', 'gliclazide', 'glimepiride', 'sitagliptin', 'januvia',
        'empagliflozin', 'jardiance', 'dapagliflozin', 'insulin', 'lantus', 'novorapid', 'actrapid'],
      gi: ['omeprazole', 'pantoprazole', 'esomeprazole', 'nexium', 'ranitidine', 'famotidine',
        'metoclopramide', 'ondansetron', 'lactulose'],
      respiratory: ['salbutamol', 'ventolin', 'ipratropium', 'tiotropium', 'budesonide', 'symbicort',
        'montelukast', 'prednisolone', 'hydrocortisone'],
      neuro: ['levetiracetam', 'keppra', 'phenytoin', 'carbamazepine', 'valproate', 'gabapentin',
        'pregabalin', 'amitriptyline'],
      antibiotics: ['ceftriaxone', 'meropenem', 'vancomycin', 'piperacillin', 'tazobactam', 'tazocin',
        'ciprofloxacin', 'levofloxacin', 'azithromycin', 'metronidazole', 'amoxicillin', 'augmentin'],
      other: ['paracetamol', 'tramadol', 'morphine', 'levothyroxine', 'allopurinol', 'colchicine']
    };
    
    for (const [category, names] of Object.entries(medDb)) {
      for (const med of names) {
        const regex = new RegExp(`\\b${med}\\b[\\s]*(\\d+(?:\\.\\d+)?)?\\s*(mg|g|mcg|units?|ml)?\\s*(od|bd|tds|qid|daily|prn|po|iv|sc)?`, 'gi');
        const matches = [...text.matchAll(regex)];
        matches.forEach(m => {
          if (!meds.find(x => x.name.toLowerCase() === med.toLowerCase())) {
            meds.push({
              name: this.capitalize(med),
              dose: m[1] || '',
              unit: m[2] || 'mg',
              freq: (m[3] || '').toUpperCase(),
              category
            });
          }
        });
      }
    }
    
    return meds;
  },

  /**
   * Extract vitals
   */
  extractVitals(text) {
    const vitals = {};
    
    // BP
    const bp = text.match(/bp\s*[:\s]*(\d{2,3})\s*[\/\\]\s*(\d{2,3})/i);
    if (bp) {
      const sys = parseInt(bp[1]), dia = parseInt(bp[2]);
      vitals.bp = { 
        value: `${sys}/${dia}`, 
        status: sys < 90 ? 'critical' : sys < 100 ? 'low' : sys > 140 ? 'high' : 'normal'
      };
    }
    
    // HR
    const hr = text.match(/(?:hr|heart rate|pulse)\s*[:\s]*(\d{2,3})/i);
    if (hr) {
      const v = parseInt(hr[1]);
      vitals.hr = { value: v, status: v < 60 ? 'low' : v > 100 ? 'high' : 'normal' };
    }
    
    // RR
    const rr = text.match(/(?:rr|resp(?:iratory)?\s*rate)\s*[:\s]*(\d{1,2})(?:\s*-\s*(\d{1,2}))?/i);
    if (rr) {
      const v = rr[2] ? `${rr[1]}-${rr[2]}` : rr[1];
      const val = parseInt(rr[1]);
      vitals.rr = { value: v, status: val < 12 ? 'low' : val > 20 ? 'high' : 'normal' };
    }
    
    // Temp
    const temp = text.match(/(?:temp|temperature)\s*[:\s]*(\d{2}(?:\.\d)?)/i);
    if (temp) {
      const v = parseFloat(temp[1]);
      vitals.temp = { value: v, status: v < 36 ? 'low' : v > 37.5 ? 'high' : 'normal' };
    }
    
    // SpO2
    const spo2 = text.match(/(?:spo2|sao2|o2\s*sat)\s*[:\s]*(\d{2,3})\s*%?(?:\s*(?:on|\/)\s*(ra|room air|\d+l?|nc|fm|nrb))?/i);
    if (spo2) {
      const v = parseInt(spo2[1]);
      vitals.spo2 = { 
        value: v, 
        supplement: spo2[2] || '',
        status: v < 90 ? 'critical' : v < 94 ? 'low' : 'normal'
      };
    }
    
    // GCS
    const gcs = text.match(/gcs\s*[:\s]*(\d{1,2})\s*(?:\/\s*15)?/i);
    if (gcs) {
      const v = parseInt(gcs[1]);
      vitals.gcs = { value: v, status: v < 8 ? 'critical' : v < 15 ? 'low' : 'normal' };
    }
    
    return vitals;
  },

  /**
   * Extract labs - comprehensive
   */
  extractLabs(text) {
    const labs = {};
    
    const labDefs = {
      // CBC
      wbc: { pattern: /\bwbc\s*[:\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'cbc', unit: 'Ã—10â¹/L', ref: [4, 11] },
      hb: { pattern: /\b(?:hb|hgb|hemoglobin)\s*[:\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'cbc', unit: 'g/L', ref: [120, 160] },
      plt: { pattern: /\b(?:plt|platelets?)\s*[:\s]*(\d+)\s*([HL])?/i, cat: 'cbc', unit: 'Ã—10â¹/L', ref: [150, 400] },
      neutrophils: { pattern: /neutrophils?\.?#?\s*[:\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'cbc', unit: 'Ã—10â¹/L', ref: [2, 7.5] },
      
      // Metabolic
      na: { pattern: /\bna\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [136, 145] },
      k: { pattern: /\bk\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [3.5, 5.0] },
      cl: { pattern: /\bcl\s*[:\*\s]*(\d+)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [98, 106] },
      co2: { pattern: /\bco2\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [22, 29] },
      bun: { pattern: /\b(?:bun|urea)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [2.5, 7.1] },
      creat: { pattern: /\b(?:creat?|cr)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'Î¼mol/L', ref: [60, 110] },
      glucose: { pattern: /\b(?:gluc(?:ose)?|fbs|rbs)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [3.9, 5.6] },
      ca: { pattern: /\bca\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [2.1, 2.6] },
      mg: { pattern: /\bmg\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [0.7, 1.0] },
      phos: { pattern: /\b(?:phos|phosphate)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'metabolic', unit: 'mmol/L', ref: [0.8, 1.5] },
      egfr: { pattern: /\begfr\s*[:\*\s]*(\d+)/i, cat: 'metabolic', unit: 'mL/min', ref: [90, 999] },
      
      // LFT
      alt: { pattern: /\balt\s*[:\*\s]*[>]?(\d+)\s*([HL])?/i, cat: 'lft', unit: 'IU/L', ref: [0, 40] },
      ast: { pattern: /\bast\s*[:\*\s]*[>]?(\d+)\s*([HL])?/i, cat: 'lft', unit: 'IU/L', ref: [0, 40] },
      alp: { pattern: /\b(?:alp|alk\.?\s*phos)\s*[:\*\s]*(\d+)\s*([HL])?/i, cat: 'lft', unit: 'IU/L', ref: [40, 130] },
      ggt: { pattern: /\bggt\s*[:\*\s]*(\d+)\s*([HL])?/i, cat: 'lft', unit: 'IU/L', ref: [0, 60] },
      tbil: { pattern: /\b(?:t\.?\s*bil|total\s*bilirubin)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'lft', unit: 'Î¼mol/L', ref: [0, 21] },
      dbil: { pattern: /\b(?:d\.?\s*bil|direct\s*bil)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'lft', unit: 'Î¼mol/L', ref: [0, 5] },
      albumin: { pattern: /\balbumin\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'lft', unit: 'g/L', ref: [35, 50] },
      protein: { pattern: /\b(?:t\.?\s*protein|total\s*protein)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'lft', unit: 'g/L', ref: [60, 80] },
      
      // Cardiac
      troponin: { pattern: /\b(?:troponin|trop|tni|hs[\s-]?trop)\s*[i]?\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'cardiac', unit: 'ng/L', ref: [0, 19.8] },
      bnp: { pattern: /\b(?:bnp|nt[\s-]?probnp)\s*[:\*\s]*(\d+)\s*([HL])?/i, cat: 'cardiac', unit: 'pg/mL', ref: [0, 300] },
      
      // Coag
      pt: { pattern: /\bpt\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'coag', unit: 'sec', ref: [9.6, 13.6] },
      inr: { pattern: /\binr\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'coag', unit: '', ref: [0.85, 1.15] },
      aptt: { pattern: /\b(?:aptt|ptt)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'coag', unit: 'sec', ref: [25, 37] },
      
      // Inflammatory
      crp: { pattern: /\bcrp\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'inflammatory', unit: 'mg/L', ref: [0, 5] },
      pct: { pattern: /\b(?:pct|procalcitonin)\s*[:\*\s]*(\d+(?:\.\d+)?)\s*([HL])?/i, cat: 'inflammatory', unit: 'ng/mL', ref: [0, 0.5] },
      
      // Other
      urate: { pattern: /\burate?\s*[:\*\s]*(\d+)\s*([HL])?/i, cat: 'other', unit: 'Î¼mol/L', ref: [200, 420] },
      anionGap: { pattern: /\banion\s*gap\s*[:\*\s]*(\d+(?:\.\d+)?)/i, cat: 'other', unit: 'mmol/L', ref: [8, 12] }
    };
    
    for (const [name, def] of Object.entries(labDefs)) {
      const match = text.match(def.pattern);
      if (match) {
        const val = parseFloat(match[1]);
        const flag = match[2] || '';
        let status = 'normal';
        
        if (flag === 'H' || flag === 'HH' || val > def.ref[1]) status = 'high';
        else if (flag === 'L' || val < def.ref[0]) status = 'low';
        
        if (!labs[def.cat]) labs[def.cat] = {};
        labs[def.cat][name] = { name: name.toUpperCase(), value: val, flag, unit: def.unit, status };
      }
    }
    
    // Handle ">500" type values
    const gtPatterns = [
      { pattern: /alt\s*[:\*\s]*>(\d+)/i, name: 'ALT', cat: 'lft' },
      { pattern: /ast\s*[:\*\s]*>(\d+)/i, name: 'AST', cat: 'lft' }
    ];
    gtPatterns.forEach(p => {
      const m = text.match(p.pattern);
      if (m) {
        if (!labs[p.cat]) labs[p.cat] = {};
        labs[p.cat][p.name.toLowerCase()] = { name: p.name, value: `>${m[1]}`, flag: 'HH', unit: 'IU/L', status: 'high' };
      }
    });
    
    return labs;
  },

  /**
   * Extract ABG
   */
  extractABG(text) {
    const abg = {};
    
    const patterns = {
      ph: /\bph\s*[:\s]*(\d+\.\d+)/i,
      pco2: /\bpco2\s*[:\s]*(\d+(?:\.\d+)?)/i,
      po2: /\bpo2\s*[:\s]*(\d+(?:\.\d+)?)/i,
      hco3: /\bhco3\s*[:\s]*(\d+(?:\.\d+)?)/i,
      lactate: /\b(?:lac(?:tate)?|lactic)\s*[:\s]*(\d+(?:\.\d+)?)/i,
      be: /\b(?:be|base\s*excess)\s*[:\s]*([-]?\d+(?:\.\d+)?)/i
    };
    
    for (const [name, pattern] of Object.entries(patterns)) {
      const m = text.match(pattern);
      if (m) abg[name] = parseFloat(m[1]);
    }
    
    // Interpret
    if (abg.ph && abg.pco2 && abg.hco3) {
      if (abg.ph < 7.35) {
        if (abg.pco2 > 45) abg.interpretation = 'Respiratory Acidosis';
        else if (abg.hco3 < 22) abg.interpretation = 'Metabolic Acidosis';
        else abg.interpretation = 'Mixed Acidosis';
      } else if (abg.ph > 7.45) {
        if (abg.pco2 < 35) abg.interpretation = 'Respiratory Alkalosis';
        else if (abg.hco3 > 26) abg.interpretation = 'Metabolic Alkalosis';
      } else {
        abg.interpretation = 'Normal/Compensated';
      }
      
      // Add compensation note
      if (abg.ph < 7.35 && abg.pco2 < 35) abg.interpretation += ' with respiratory compensation';
      if (abg.ph < 7.35 && abg.hco3 > 26) abg.interpretation += ' with metabolic compensation';
    }
    
    return Object.keys(abg).length > 0 ? abg : null;
  },

  /**
   * Extract imaging
   */
  extractImaging(text) {
    const imaging = [];
    
    // Echo
    const echoMatch = text.match(/(?:echo|echocardiogram)[:\s]*([^]*?)(?=(?:\n\n|u\/s|ct |cxr|mri|assessment|impression|plan))/i);
    if (echoMatch || /\bef\s*[:\s]*\d/i.test(text)) {
      const echo = { type: 'Echo', findings: [] };
      
      // EF
      const ef = text.match(/\bef\s*[:\s]*(\d+)[\s-]*(\d+)?%?/i);
      if (ef) echo.ef = ef[2] ? `${ef[1]}-${ef[2]}%` : `${ef[1]}%`;
      
      // Findings
      const findings = ['diastolic dysfunction', 'systolic dysfunction', 'hypokinesia', 'akinesia',
        'valve sclerosis', 'stenosis', 'regurgitation', 'dilated', 'lvh', 'pericardial effusion',
        'normal lv', 'mr', 'ar', 'tr', 'ms', 'as'];
      findings.forEach(f => {
        if (text.toLowerCase().includes(f)) echo.findings.push(this.capitalize(f));
      });
      
      if (echo.ef || echo.findings.length > 0) imaging.push(echo);
    }
    
    // Ultrasound
    const usMatch = text.match(/(?:u\/s|ultrasound)[:\s]+([^\n]+)/i);
    if (usMatch || /\bivc\b/i.test(text)) {
      const us = { type: 'Ultrasound', findings: [] };
      
      const ivc = text.match(/ivc\s*(?:measures?)?\s*[~]?(\d+(?:\.\d+)?)\s*cm/i);
      if (ivc) us.findings.push(`IVC ${ivc[1]} cm`);
      
      const usFindings = ['pleural effusion', 'ascites', 'free fluid', 'fatty liver', 'hepatomegaly'];
      usFindings.forEach(f => {
        if (text.toLowerCase().includes(f)) us.findings.push(this.capitalize(f));
      });
      
      if (us.findings.length > 0) imaging.push(us);
    }
    
    // CXR
    const cxr = text.match(/(?:cxr|chest\s*x[\s-]?ray)[:\s]+([^\n]+)/i);
    if (cxr) {
      imaging.push({ type: 'CXR', findings: [cxr[1].trim()] });
    }
    
    return imaging;
  },

  /**
   * Extract examination
   */
  extractExamination(text) {
    const exam = {};
    
    // Patterns
    const patterns = {
      general: /(?:general|examination)[:\s]+([^\n]+)/i,
      cvs: /(?:cvs|cardiovascular|cardiac)[:\s]+([^\n]+)/i,
      resp: /(?:resp|respiratory|chest)[:\s]+([^\n]+)/i,
      abd: /(?:abd(?:omen)?|gi)[:\s]+([^\n]+)/i,
      neuro: /(?:neuro|cns)[:\s]+([^\n]+)/i
    };
    
    for (const [sys, pattern] of Object.entries(patterns)) {
      const m = text.match(pattern);
      if (m) exam[sys] = m[1].trim();
    }
    
    // Common findings
    if (/bilateral.*(crep|crackle)/i.test(text)) exam.resp = (exam.resp || '') + ' Bilateral creps';
    if (/pitting edema/i.test(text)) exam.ext = 'Pitting edema';
    if (/distended abdomen/i.test(text)) exam.abd = (exam.abd || '') + ' Distended';
    
    return Object.keys(exam).length > 0 ? exam : null;
  },

  /**
   * Extract assessment
   */
  extractAssessment(text) {
    const assessment = { primary: null, secondary: [] };
    
    // Case of pattern
    const caseMatch = text.match(/(?:a case of|impression|assessment|diagnosis)[:\s]+([^]*?)(?=(?:\n\s*plan|\n\n\n))/i);
    if (caseMatch) {
      const lines = caseMatch[1].split(/[,\n]/).map(l => l.trim()).filter(l => l && l.length > 3);
      if (lines.length > 0) {
        assessment.primary = lines[0].replace(/^a case of\s*/i, '');
        assessment.secondary = lines.slice(1);
      }
    }
    
    return assessment.primary ? assessment : null;
  },

  /**
   * Extract plan
   */
  extractPlan(text) {
    const plan = [];
    
    const planMatch = text.match(/plan[:\s]+([^]*?)(?=(?:\n\n\n|$))/i);
    if (planMatch) {
      const lines = planMatch[1].split(/\n/).map(l => l.trim().replace(/^[-â€¢*\d.]+\s*/, '')).filter(l => l && l.length > 3);
      lines.forEach(l => {
        if (!/^(save|exit|print|co[\s-]?sign|doctor)/i.test(l)) plan.push(l);
      });
    }
    
    return plan;
  },

  capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  },

  // ==================== RENDERER ====================

  /**
   * Render full presentation
   */
  render(data, container) {
    if (!container) return;
    if (!data) {
      container.innerHTML = '<p class="pres-empty">No clinical data to display</p>';
      return;
    }

    let html = '<div class="pres-container">';
    
    // Header
    html += this.renderHeader(data);
    
    // Grid layout
    html += '<div class="pres-grid">';
    
    // Left column
    html += '<div class="pres-col">';
    if (data.chiefComplaint) html += this.renderBox('ğŸ¯', 'Chief Complaint', `<p class="pres-cc">${data.chiefComplaint}</p>`);
    html += this.renderHPI(data.hpi);
    html += this.renderPMH(data.pmh);
    html += this.renderMeds(data.medications);
    if (data.assessment) html += this.renderAssessment(data.assessment);
    if (data.plan.length > 0) html += this.renderPlan(data.plan);
    html += '</div>';
    
    // Right column
    html += '<div class="pres-col">';
    html += this.renderVitals(data.vitals);
    html += this.renderLabs(data.labs);
    if (data.abg) html += this.renderABG(data.abg);
    if (data.imaging.length > 0) html += this.renderImaging(data.imaging);
    if (data.examination) html += this.renderExam(data.examination);
    html += '</div>';
    
    html += '</div></div>';
    
    container.innerHTML = html;
  },

  renderHeader(data) {
    const d = data.demographics || {};
    return `
      <div class="pres-header">
        <div class="pres-patient-info">
          <span class="pres-avatar">${d.gender === 'Female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
          <div>
            ${d.age ? `<span class="pres-age">${d.age} yo</span>` : ''}
            ${d.gender ? `<span class="pres-gender">${d.gender}</span>` : ''}
            ${d.smoker ? `<span class="pres-tag warn">ğŸš¬ Smoker</span>` : ''}
          </div>
        </div>
        <span class="pres-time">${new Date().toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
      </div>
    `;
  },

  renderBox(icon, title, content) {
    return `
      <div class="pres-box">
        <div class="pres-box-header"><span class="pres-icon">${icon}</span><span class="pres-title">${title}</span></div>
        <div class="pres-box-content">${content}</div>
      </div>
    `;
  },

  renderHPI(hpi) {
    if (!hpi || (hpi.symptoms.length === 0 && !hpi.duration)) return '';
    
    let content = '';
    if (hpi.duration) content += `<div class="pres-duration">Duration: <strong>${hpi.duration}</strong></div>`;
    if (hpi.symptoms.length > 0) {
      content += '<div class="pres-symptoms">';
      hpi.symptoms.forEach(s => content += `<span class="pres-symptom">${s}</span>`);
      content += '</div>';
    }
    if (hpi.negatives.length > 0) {
      content += `<div class="pres-negatives">Denies: ${hpi.negatives.join(', ')}</div>`;
    }
    
    return this.renderBox('ğŸ“‹', 'History', content);
  },

  renderPMH(pmh) {
    if (!pmh || (pmh.conditions.length === 0 && pmh.surgeries.length === 0)) return '';
    
    const icons = { DM: 'ğŸ©¸', HTN: 'ğŸ’‰', IHD: 'â¤ï¸', HF: 'ğŸ’”', CKD: 'ğŸ«˜', AF: 'ğŸ’—', CVA: 'ğŸ§ ', COPD: 'ğŸ«', Asthma: 'ğŸŒ¬ï¸', PCI: 'ğŸ©¹', CABG: 'ğŸ«€' };
    
    let content = '<div class="pres-conditions">';
    pmh.conditions.forEach(c => content += `<span class="pres-condition">${icons[c] || 'â€¢'} ${c}</span>`);
    content += '</div>';
    
    if (pmh.surgeries.length > 0) {
      content += '<div class="pres-surgeries">';
      pmh.surgeries.forEach(s => content += `<span class="pres-surgery">ğŸ”ª ${s}</span>`);
      content += '</div>';
    }
    
    return this.renderBox('ğŸ“œ', 'Past Medical History', content);
  },

  renderMeds(meds) {
    if (!meds || meds.length === 0) return '';
    
    const catIcons = { cardiac: 'â¤ï¸', diabetes: 'ğŸ©¸', gi: 'ğŸ’Š', respiratory: 'ğŸŒ¬ï¸', neuro: 'ğŸ§ ', antibiotics: 'ğŸ’‰', other: 'ğŸ’Š' };
    const byCategory = {};
    meds.forEach(m => {
      if (!byCategory[m.category]) byCategory[m.category] = [];
      byCategory[m.category].push(m);
    });
    
    let content = '';
    for (const [cat, items] of Object.entries(byCategory)) {
      content += `<div class="pres-med-cat"><span class="pres-med-cat-label">${catIcons[cat] || 'ğŸ’Š'} ${this.capitalize(cat)}</span><div class="pres-med-list">`;
      items.forEach(m => {
        content += `<span class="pres-med">${m.name}${m.dose ? ` <em>${m.dose}${m.unit}</em>` : ''}${m.freq ? ` <small>${m.freq}</small>` : ''}</span>`;
      });
      content += '</div></div>';
    }
    
    return this.renderBox('ğŸ’Š', 'Medications', content);
  },

  renderVitals(vitals) {
    if (!vitals || Object.keys(vitals).length === 0) return '';
    
    const config = {
      bp: { icon: 'ğŸ©¸', label: 'BP', unit: 'mmHg' },
      hr: { icon: 'ğŸ’“', label: 'HR', unit: 'bpm' },
      rr: { icon: 'ğŸŒ¬ï¸', label: 'RR', unit: '/min' },
      temp: { icon: 'ğŸŒ¡ï¸', label: 'Temp', unit: 'Â°C' },
      spo2: { icon: 'ğŸ’¨', label: 'SpO2', unit: '%' },
      gcs: { icon: 'ğŸ§ ', label: 'GCS', unit: '/15' }
    };
    
    let content = '<div class="pres-vitals-grid">';
    for (const [key, cfg] of Object.entries(config)) {
      if (vitals[key]) {
        const v = vitals[key];
        const val = typeof v.value === 'object' ? v.value : v.value;
        content += `
          <div class="pres-vital ${v.status}">
            <span class="pres-vital-icon">${cfg.icon}</span>
            <span class="pres-vital-label">${cfg.label}</span>
            <span class="pres-vital-value">${val}${key === 'spo2' && v.supplement ? ` ${v.supplement}` : ''}</span>
          </div>
        `;
      }
    }
    content += '</div>';
    
    return this.renderBox('ğŸ“Š', 'Vital Signs', content);
  },

  renderLabs(labs) {
    if (!labs || Object.keys(labs).length === 0) return '';
    
    const catConfig = {
      cbc: { name: 'CBC', icon: 'ğŸ”´', color: '#ef4444' },
      metabolic: { name: 'Metabolic', icon: 'âš—ï¸', color: '#8b5cf6' },
      lft: { name: 'LFT', icon: 'ğŸ«', color: '#f59e0b' },
      cardiac: { name: 'Cardiac', icon: 'â¤ï¸', color: '#ec4899' },
      coag: { name: 'Coag', icon: 'ğŸ©¸', color: '#dc2626' },
      inflammatory: { name: 'Inflam', icon: 'ğŸ”¥', color: '#f97316' },
      other: { name: 'Other', icon: 'ğŸ“‹', color: '#64748b' }
    };
    
    let content = '<div class="pres-labs-container">';
    
    for (const [cat, results] of Object.entries(labs)) {
      const cfg = catConfig[cat] || { name: cat, icon: 'ğŸ“‹', color: '#64748b' };
      
      content += `<div class="pres-lab-cat" style="--cat-color: ${cfg.color}">`;
      content += `<div class="pres-lab-cat-header">${cfg.icon} ${cfg.name}</div>`;
      content += '<div class="pres-lab-rows">';
      
      for (const [name, lab] of Object.entries(results)) {
        content += `
          <div class="pres-lab-row ${lab.status}">
            <span class="pres-lab-name">${lab.name}</span>
            <span class="pres-lab-value">${lab.value}${lab.flag ? ` <span class="pres-lab-flag">${lab.flag}</span>` : ''}</span>
            <span class="pres-lab-unit">${lab.unit}</span>
          </div>
        `;
      }
      
      content += '</div></div>';
    }
    
    content += '</div>';
    return this.renderBox('ğŸ”¬', 'Laboratory Results', content);
  },

  renderABG(abg) {
    if (!abg) return '';
    
    let content = '<div class="pres-abg-values">';
    const params = ['ph', 'pco2', 'po2', 'hco3', 'lactate', 'be'];
    params.forEach(p => {
      if (abg[p] !== undefined) {
        content += `<div class="pres-abg-item"><span class="pres-abg-label">${p.toUpperCase()}</span><span class="pres-abg-val">${abg[p]}</span></div>`;
      }
    });
    content += '</div>';
    
    if (abg.interpretation) {
      content += `<div class="pres-abg-interp">ğŸ’¡ ${abg.interpretation}</div>`;
    }
    
    return this.renderBox('ğŸ’¨', 'ABG', content);
  },

  renderImaging(imaging) {
    if (!imaging || imaging.length === 0) return '';
    
    let content = '';
    imaging.forEach(study => {
      content += `<div class="pres-imaging-study">`;
      content += `<div class="pres-imaging-header">${study.type === 'Echo' ? 'â¤ï¸' : study.type === 'CXR' ? 'ğŸ«' : 'ğŸ“¡'} ${study.type}`;
      if (study.ef) content += ` <span class="pres-ef-badge">EF ${study.ef}</span>`;
      content += '</div>';
      if (study.findings.length > 0) {
        content += '<div class="pres-imaging-findings">';
        study.findings.forEach(f => content += `<div>â€¢ ${f}</div>`);
        content += '</div>';
      }
      content += '</div>';
    });
    
    return this.renderBox('ğŸ“·', 'Imaging', content);
  },

  renderExam(exam) {
    if (!exam) return '';
    
    const icons = { general: 'ğŸ‘¤', cvs: 'â¤ï¸', resp: 'ğŸŒ¬ï¸', abd: 'ğŸ«ƒ', neuro: 'ğŸ§ ', ext: 'ğŸ¦µ' };
    
    let content = '<div class="pres-exam-items">';
    for (const [sys, finding] of Object.entries(exam)) {
      content += `<div class="pres-exam-item"><span class="pres-exam-icon">${icons[sys] || 'â€¢'}</span><span class="pres-exam-sys">${this.capitalize(sys)}:</span><span>${finding}</span></div>`;
    }
    content += '</div>';
    
    return this.renderBox('ğŸ©º', 'Examination', content);
  },

  renderAssessment(assessment) {
    if (!assessment || !assessment.primary) return '';
    
    let content = `<div class="pres-dx-primary"><span class="pres-dx-badge">1</span>${assessment.primary}</div>`;
    
    if (assessment.secondary.length > 0) {
      content += '<div class="pres-dx-secondary">';
      assessment.secondary.forEach((dx, i) => {
        content += `<div class="pres-dx-item"><span class="pres-dx-badge sec">${i + 2}</span>${dx}</div>`;
      });
      content += '</div>';
    }
    
    return this.renderBox('ğŸ¯', 'Assessment', content);
  },

  renderPlan(plan) {
    if (!plan || plan.length === 0) return '';
    
    let content = '<div class="pres-plan-items">';
    plan.forEach((item, i) => {
      content += `<div class="pres-plan-item"><span class="pres-plan-num">${i + 1}</span>${item}</div>`;
    });
    content += '</div>';
    
    return this.renderBox('ğŸ“', 'Plan', content);
  }
};

// Export
if (typeof window !== 'undefined') {
  window.PatientPresentation = PatientPresentation;
}
