/**
 * MedWard Data Classifier v1.0
 * Intelligent differentiation between lab values (images) and clinical text data
 */

const MedWardDataClassifier = {
  
  DATA_TYPES: {
    LAB: 'lab',
    CLINICAL: 'clinical',
    IMAGING: 'imaging',
    MIXED: 'mixed',
    UNKNOWN: 'unknown'
  },

  labPatterns: {
    electrolytes: /\b(Na|Sodium|K|Potassium|Cl|Chloride|CO2|Bicarbonate|HCO3|Mg|Magnesium|Ca|Calcium|Phosphate|PO4)\s*[:=]?\s*[\d.]+\s*(mmol\/L|mEq\/L|mg\/dL)?/gi,
    renal: /\b(Cr|Creatinine|BUN|Urea|eGFR|GFR)\s*[:=]?\s*[\d.]+\s*(μmol\/L|umol\/L|mmol\/L|mg\/dL|mL\/min)?/gi,
    cbc: /\b(WBC|RBC|Hb|HGB|Hemoglobin|Hct|Hematocrit|Plt|Platelets|MCV|MCH|MCHC|RDW)\s*[:=]?\s*[\d.]+/gi,
    differential: /\b(Neutrophils|Lymphocytes|Monocytes|Eosinophils|Basophils|Bands)\s*[:=]?\s*[\d.]+\s*(%|×10⁹\/L)?/gi,
    liver: /\b(ALT|AST|SGPT|SGOT|GGT|Alk\s*Phos|ALP|Bilirubin|T\.?\s*Bili|D\.?\s*Bili|Albumin|T\.?\s*Protein)\s*[:=]?\s*[\d.]+/gi,
    cardiac: /\b(Troponin|TnI|TnT|BNP|NT-proBNP|CK|CK-MB|LDH|Myoglobin)\s*[:=]?\s*[\d.]+/gi,
    coag: /\b(PT|INR|PTT|aPTT|Fibrinogen|D-Dimer)\s*[:=]?\s*[\d.]+/gi,
    abg: /\b(pH|pCO2|pO2|HCO3|Base\s*Excess|BE|Lactate|SaO2)\s*[:=]?\s*[\d.]+/gi,
    metabolic: /\b(Glucose|FBS|RBS|HbA1c|A1c|Cholesterol|LDL|HDL|Triglycerides|TSH|T3|T4|FT4|Uric\s*Acid)\s*[:=]?\s*[\d.]+/gi,
    inflammatory: /\b(CRP|ESR|Ferritin|Procalcitonin|PCT)\s*[:=]?\s*[\d.]+/gi,
    flags: /\b[\d.]+\s*(H|HH|L|LL|↑|↓|\*)\b/gi,
    referenceRanges: /\([\d.]+-[\d.]+\s*[a-zA-Z\/]*\)/gi,
    units: /\b(mmol\/L|mEq\/L|mg\/dL|μmol\/L|umol\/L|g\/L|g\/dL|×10⁹\/L|fL|pg|%|IU\/L|U\/L|ng\/mL|pg\/mL|pmol\/L|sec)\b/gi
  },

  clinicalPatterns: {
    history: /\b(presents?\s*with|complains?\s*of|history\s*of|c\/o|h\/o|PMH|past\s*medical|surgical\s*history|social\s*history|family\s*history|HPI|chief\s*complaint|CC)\b/gi,
    exam: /\b(on\s*examination|O\/E|physical\s*exam|vital\s*signs|BP|HR|RR|SpO2|temperature|GCS|pupils|lung\s*sounds|heart\s*sounds|abdomen|extremities|neurological)\b/gi,
    assessment: /\b(impression|assessment|diagnosis|differential|A\/P|plan|management|disposition|admit|discharge)\b/gi,
    symptoms: /\b(pain|fever|cough|dyspnea|shortness\s*of\s*breath|SOB|nausea|vomiting|diarrhea|weakness|fatigue|dizziness|headache|chest\s*pain|abdominal\s*pain)\b/gi,
    timeline: /\b(\d+\s*(day|week|month|hour|year)s?\s*(ago|history|duration)|acute|chronic|progressive|sudden|gradual)\b/gi,
    medications: /\b(medication|taking|prescribed|started|on)\s+\w+\s*(mg|mcg|g|ml)?\s*(daily|BD|TDS|QID|PRN|OD)?/gi
  },

  imagingPatterns: {
    radiology: /\b(X-ray|XR|CT|MRI|ultrasound|US|PET|SPECT|angiography|mammography|scan)\b/gi,
    findings: /\b(opacity|consolidation|effusion|mass|nodule|lesion|fracture|stenosis|occlusion|enhancement)\b/gi,
    pathology: /\b(biopsy|histology|cytology|immunohistochemistry|malignant|benign|carcinoma|adenoma)\b/gi
  },

  // Reference ranges database
  referenceRanges: {
    'Sodium': { min: 136, max: 145, unit: 'mmol/L', critLow: 120, critHigh: 160 },
    'Potassium': { min: 3.5, max: 5.0, unit: 'mmol/L', critLow: 2.5, critHigh: 6.5 },
    'Chloride': { min: 98, max: 106, unit: 'mmol/L' },
    'CO2': { min: 22, max: 29, unit: 'mmol/L' },
    'Creatinine': { min: 60, max: 110, unit: 'μmol/L', critHigh: 500 },
    'BUN': { min: 2.5, max: 7.1, unit: 'mmol/L' },
    'Urea': { min: 2.5, max: 7.1, unit: 'mmol/L' },
    'eGFR': { min: 90, max: 999, unit: 'mL/min', critLow: 15 },
    'Glucose': { min: 3.9, max: 5.6, unit: 'mmol/L', critLow: 2.2, critHigh: 25 },
    'WBC': { min: 4.0, max: 11.0, unit: '×10⁹/L', critLow: 1.0, critHigh: 30 },
    'Hemoglobin': { min: 120, max: 170, unit: 'g/L', critLow: 70, critHigh: 200 },
    'Hb': { min: 120, max: 170, unit: 'g/L', critLow: 70, critHigh: 200 },
    'Platelets': { min: 150, max: 400, unit: '×10⁹/L', critLow: 20, critHigh: 1000 },
    'ALT': { min: 0, max: 40, unit: 'U/L', critHigh: 1000 },
    'AST': { min: 0, max: 40, unit: 'U/L', critHigh: 1000 },
    'ALP': { min: 40, max: 130, unit: 'U/L' },
    'GGT': { min: 0, max: 60, unit: 'U/L' },
    'Bilirubin': { min: 0, max: 21, unit: 'μmol/L', critHigh: 300 },
    'Albumin': { min: 35, max: 50, unit: 'g/L', critLow: 15 },
    'Calcium': { min: 2.1, max: 2.6, unit: 'mmol/L', critLow: 1.5, critHigh: 3.5 },
    'Magnesium': { min: 0.7, max: 1.0, unit: 'mmol/L' },
    'Phosphate': { min: 0.8, max: 1.5, unit: 'mmol/L' },
    'Troponin': { min: 0, max: 0.04, unit: 'ng/mL', critHigh: 0.1 },
    'BNP': { min: 0, max: 100, unit: 'pg/mL', critHigh: 500 },
    'PT': { min: 11, max: 13.5, unit: 'sec', critHigh: 30 },
    'INR': { min: 0.8, max: 1.2, unit: '', critHigh: 5.0 },
    'aPTT': { min: 25, max: 35, unit: 'sec', critHigh: 100 },
    'pH': { min: 7.35, max: 7.45, unit: '', critLow: 7.1, critHigh: 7.6 },
    'pCO2': { min: 35, max: 45, unit: 'mmHg' },
    'HCO3': { min: 22, max: 26, unit: 'mmol/L' },
    'Lactate': { min: 0.5, max: 2.2, unit: 'mmol/L', critHigh: 4 },
    'CRP': { min: 0, max: 5, unit: 'mg/L', critHigh: 200 },
    'ESR': { min: 0, max: 20, unit: 'mm/hr' },
    'TSH': { min: 0.4, max: 4.0, unit: 'mIU/L' },
    'HbA1c': { min: 4.0, max: 5.6, unit: '%' }
  },

  classify(text, isImage = false) {
    if (!text || typeof text !== 'string') {
      return { type: this.DATA_TYPES.UNKNOWN, confidence: 0, details: { reason: 'No text provided' } };
    }

    const scores = {
      lab: this.calculateLabScore(text),
      clinical: this.calculateClinicalScore(text),
      imaging: this.calculateImagingScore(text)
    };

    const totalMatches = scores.lab.matches + scores.clinical.matches + scores.imaging.matches;
    
    if (totalMatches === 0) {
      return { type: this.DATA_TYPES.UNKNOWN, confidence: 0, scores, details: { reason: 'No recognizable medical patterns' } };
    }

    if (isImage) scores.lab.score += 20;

    let primaryType = this.DATA_TYPES.UNKNOWN;
    let confidence = 0;
    const totalScore = scores.lab.score + scores.clinical.score + scores.imaging.score;

    if (scores.lab.score >= scores.clinical.score * 1.5 && scores.lab.score > scores.imaging.score) {
      primaryType = this.DATA_TYPES.LAB;
      confidence = Math.min(95, (scores.lab.score / totalScore) * 100);
    } else if (scores.clinical.score >= scores.lab.score * 1.5 && scores.clinical.score > scores.imaging.score) {
      primaryType = this.DATA_TYPES.CLINICAL;
      confidence = Math.min(95, (scores.clinical.score / totalScore) * 100);
    } else if (scores.imaging.score >= scores.lab.score && scores.imaging.score >= scores.clinical.score) {
      primaryType = this.DATA_TYPES.IMAGING;
      confidence = Math.min(95, (scores.imaging.score / totalScore) * 100);
    } else if (scores.lab.score > 0 && scores.clinical.score > 0) {
      primaryType = this.DATA_TYPES.MIXED;
      confidence = 70;
    }

    return {
      type: primaryType,
      confidence: Math.round(confidence),
      scores,
      isImage,
      details: {
        labValues: scores.lab.foundTests,
        clinicalElements: scores.clinical.foundElements,
        imagingElements: scores.imaging.foundElements
      }
    };
  },

  calculateLabScore(text) {
    let score = 0, matches = 0;
    const foundTests = [];

    for (const [category, pattern] of Object.entries(this.labPatterns)) {
      const categoryMatches = text.match(pattern);
      if (categoryMatches) {
        matches += categoryMatches.length;
        const weight = category === 'flags' ? 15 : category === 'referenceRanges' ? 12 : category === 'units' ? 8 : 10;
        score += categoryMatches.length * weight;
        if (!['flags', 'referenceRanges', 'units'].includes(category)) {
          foundTests.push(...categoryMatches.map(m => m.trim().split(/\s+/)[0]));
        }
      }
    }

    const numericLines = (text.match(/^\s*\S+\s+[\d.]+.*$/gm) || []).length;
    if (numericLines > 3) score += numericLines * 3;

    return { score, matches, foundTests: [...new Set(foundTests)] };
  },

  calculateClinicalScore(text) {
    let score = 0, matches = 0;
    const foundElements = [];

    for (const [category, pattern] of Object.entries(this.clinicalPatterns)) {
      const categoryMatches = text.match(pattern);
      if (categoryMatches) {
        matches += categoryMatches.length;
        const weight = ['history', 'assessment'].includes(category) ? 15 : category === 'exam' ? 12 : 10;
        score += categoryMatches.length * weight;
        foundElements.push(...categoryMatches.slice(0, 5));
      }
    }

    const sentences = (text.match(/[.!?]+/g) || []).length;
    if (sentences > 5) score += Math.min(sentences * 2, 30);

    return { score, matches, foundElements: [...new Set(foundElements)] };
  },

  calculateImagingScore(text) {
    let score = 0, matches = 0;
    const foundElements = [];

    for (const [, pattern] of Object.entries(this.imagingPatterns)) {
      const categoryMatches = text.match(pattern);
      if (categoryMatches) {
        matches += categoryMatches.length;
        score += categoryMatches.length * 12;
        foundElements.push(...categoryMatches.slice(0, 5));
      }
    }

    return { score, matches, foundElements: [...new Set(foundElements)] };
  },

  /**
   * Extract structured lab values from text with comprehensive parsing
   */
  extractLabValues(text) {
    if (!text) return [];
    
    const labValues = [];
    const seenTests = new Set();
    const normalized = text.replace(/\s+/g, ' ');

    // Comprehensive extraction patterns
    const patterns = [
      { regex: /\b(Na|Sodium)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Sodium', key: 'Sodium' },
      { regex: /\b(K|Potassium)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Potassium', key: 'Potassium' },
      { regex: /\b(Cl|Chloride)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Chloride', key: 'Chloride' },
      { regex: /\b(CO2|Bicarbonate|HCO3)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'CO2', key: 'CO2' },
      { regex: /\b(Cr|Creatinine)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Creatinine', key: 'Creatinine' },
      { regex: /\b(BUN|Urea)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Urea', key: 'Urea' },
      { regex: /\beGFR\s*[:=]?\s*([\d.]+)/gi, name: 'eGFR', key: 'eGFR', valueGroup: 1 },
      { regex: /\b(Glucose|FBS|RBS)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Glucose', key: 'Glucose' },
      { regex: /\bWBC\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'WBC', key: 'WBC', valueGroup: 1 },
      { regex: /\b(Hb|HGB|Hemoglobin)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Hemoglobin', key: 'Hemoglobin' },
      { regex: /\b(Plt|Platelets)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Platelets', key: 'Platelets' },
      { regex: /\bALT\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'ALT', key: 'ALT', valueGroup: 1 },
      { regex: /\bAST\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'AST', key: 'AST', valueGroup: 1 },
      { regex: /\b(ALP|Alk\s*Phos)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'ALP', key: 'ALP' },
      { regex: /\bGGT\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'GGT', key: 'GGT', valueGroup: 1 },
      { regex: /\b(T\.?\s*Bili|Bilirubin)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Bilirubin', key: 'Bilirubin' },
      { regex: /\bAlbumin\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Albumin', key: 'Albumin', valueGroup: 1 },
      { regex: /\b(Ca|Calcium)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Calcium', key: 'Calcium' },
      { regex: /\b(Mg|Magnesium)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Magnesium', key: 'Magnesium' },
      { regex: /\bPhosphate\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Phosphate', key: 'Phosphate', valueGroup: 1 },
      { regex: /\bTroponin\s*[IT]?\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Troponin', key: 'Troponin', valueGroup: 1 },
      { regex: /\b(BNP|NT-proBNP)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'BNP', key: 'BNP' },
      { regex: /\bPT\s+[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'PT', key: 'PT', valueGroup: 1 },
      { regex: /\bINR\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'INR', key: 'INR', valueGroup: 1 },
      { regex: /\b(aPTT|PTT)\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'aPTT', key: 'aPTT' },
      { regex: /\bpH\s*[:=]?\s*([\d.]+)/gi, name: 'pH', key: 'pH', valueGroup: 1 },
      { regex: /\bpCO2\s*[:=]?\s*([\d.]+)/gi, name: 'pCO2', key: 'pCO2', valueGroup: 1 },
      { regex: /\bLactate\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'Lactate', key: 'Lactate', valueGroup: 1 },
      { regex: /\bCRP\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'CRP', key: 'CRP', valueGroup: 1 },
      { regex: /\bESR\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'ESR', key: 'ESR', valueGroup: 1 },
      { regex: /\bTSH\s*[:=]?\s*([\d.]+)\s*(H|L|HH|LL)?/gi, name: 'TSH', key: 'TSH', valueGroup: 1 },
      { regex: /\bHbA1c\s*[:=]?\s*([\d.]+)\s*%?\s*(H|L|HH|LL)?/gi, name: 'HbA1c', key: 'HbA1c', valueGroup: 1 }
    ];

    patterns.forEach(p => {
      let match;
      while ((match = p.regex.exec(normalized)) !== null) {
        if (seenTests.has(p.key)) continue;
        
        const valueGroup = p.valueGroup || 2;
        const flagGroup = p.valueGroup ? p.valueGroup + 1 : 3;
        const value = parseFloat(match[valueGroup]);
        const flag = match[flagGroup]?.toUpperCase();
        
        if (isNaN(value)) continue;
        
        const ref = this.referenceRanges[p.key];
        if (!ref) continue;

        let status = 'normal';
        if (flag === 'HH' || (ref.critHigh && value >= ref.critHigh)) status = 'critical';
        else if (flag === 'LL' || (ref.critLow && value <= ref.critLow)) status = 'critical';
        else if (flag === 'H' || value > ref.max) status = 'high';
        else if (flag === 'L' || value < ref.min) status = 'low';

        seenTests.add(p.key);
        labValues.push({
          name: p.name,
          value: value,
          valueDisplay: `${value} ${ref.unit}`,
          unit: ref.unit,
          reference: `${ref.min}-${ref.max}`,
          referenceDisplay: `${ref.min}-${ref.max} ${ref.unit}`,
          status,
          isAbnormal: status !== 'normal',
          isCritical: status === 'critical',
          category: this.getLabCategory(p.key),
          flag: flag || null,
          timestamp: new Date().toISOString()
        });
      }
    });

    return labValues;
  },

  /**
   * Get category for a lab test
   */
  getLabCategory(testName) {
    const categories = {
      'Electrolytes': ['Sodium', 'Potassium', 'Chloride', 'CO2', 'Calcium', 'Magnesium', 'Phosphate'],
      'Renal Function': ['Creatinine', 'Urea', 'BUN', 'eGFR'],
      'Liver Function': ['ALT', 'AST', 'ALP', 'GGT', 'Bilirubin', 'Albumin'],
      'Hematology': ['WBC', 'Hemoglobin', 'Hb', 'Platelets', 'RBC', 'Hct', 'MCV'],
      'Cardiac Markers': ['Troponin', 'BNP', 'CK', 'CK-MB'],
      'Coagulation': ['PT', 'INR', 'aPTT', 'Fibrinogen', 'D-Dimer'],
      'Blood Gas': ['pH', 'pCO2', 'pO2', 'HCO3', 'Lactate'],
      'Metabolic': ['Glucose', 'HbA1c', 'Cholesterol', 'LDL', 'HDL', 'Triglycerides'],
      'Inflammatory': ['CRP', 'ESR', 'Ferritin', 'Procalcitonin'],
      'Thyroid': ['TSH', 'T3', 'T4', 'FT4']
    };

    for (const [category, tests] of Object.entries(categories)) {
      if (tests.includes(testName)) return category;
    }
    return 'Other';
  },

  /**
   * Get badge HTML for data type
   */
  getTypeBadge(type) {
    const badges = {
      [this.DATA_TYPES.LAB]: '<span class="data-type-badge lab"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/><path d="M10 12.5l2 2 4-4"/></svg> Lab Data</span>',
      [this.DATA_TYPES.CLINICAL]: '<span class="data-type-badge clinical"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M16 13H8M16 17H8M10 9H8"/></svg> Clinical Note</span>',
      [this.DATA_TYPES.IMAGING]: '<span class="data-type-badge imaging"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg> Imaging</span>',
      [this.DATA_TYPES.MIXED]: '<span class="data-type-badge lab"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg> Mixed Data</span>'
    };
    return badges[type] || '';
  }
};

// Export
if (typeof window !== 'undefined') window.MedWardDataClassifier = MedWardDataClassifier;
if (typeof module !== 'undefined') module.exports = MedWardDataClassifier;
