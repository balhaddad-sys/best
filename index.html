<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Medical Wards</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#030712;
  --bg-card:#0a0f1a;
  --bg-elevated:#111827;
  --bg-hover:#1f2937;
  --text:#f9fafb;
  --text-secondary:#9ca3af;
  --text-muted:#6b7280;
  --gold:#f59e0b;
  --gold-light:#fbbf24;
  --teal:#14b8a6;
  --purple:#8b5cf6;
  --rose:#f43f5e;
  --emerald:#10b981;
  --blue:#3b82f6;
  --orange:#f97316;
  --border:rgba(255,255,255,0.08);
  --border-light:rgba(255,255,255,0.12);
  --glass:rgba(10,15,26,0.9);
  --radius:16px;
  --radius-sm:10px;
  --font:'Outfit',system-ui,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}
::-webkit-scrollbar{display:none}
*{-ms-overflow-style:none;scrollbar-width:none}
.mono{font-family:'JetBrains Mono',monospace}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOPHISTICATED LANDING PAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#landing{
  height:100%;
  display:flex;
  flex-direction:column;
  position:relative;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}

/* Animated Background */
.landing-bg{
  position:absolute;
  inset:0;
  overflow:hidden;
  z-index:0;
}
.landing-bg::before{
  content:'';
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:conic-gradient(from 0deg at 50% 50%,
    transparent 0deg,
    rgba(245,158,11,0.03) 60deg,
    transparent 120deg,
    rgba(20,184,166,0.03) 180deg,
    transparent 240deg,
    rgba(139,92,246,0.03) 300deg,
    transparent 360deg
  );
  animation:slowSpin 60s linear infinite;
}
@keyframes slowSpin{to{transform:rotate(360deg)}}
.landing-bg::after{
  content:'';
  position:absolute;
  inset:0;
  background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(245,158,11,0.15),transparent 50%),
              radial-gradient(ellipse 60% 40% at 100% 50%,rgba(20,184,166,0.08),transparent 40%),
              radial-gradient(ellipse 60% 40% at 0% 50%,rgba(139,92,246,0.08),transparent 40%);
}
.grid-overlay{
  position:absolute;
  inset:0;
  background-image:linear-gradient(rgba(255,255,255,0.02) 1px,transparent 1px),
                    linear-gradient(90deg,rgba(255,255,255,0.02) 1px,transparent 1px);
  background-size:60px 60px;
  mask-image:radial-gradient(ellipse 70% 60% at center,black,transparent);
}
.floating-orb{
  position:absolute;
  border-radius:50%;
  filter:blur(80px);
  animation:floatOrb 20s ease-in-out infinite;
  opacity:0.4;
}
.floating-orb.orb-1{
  width:400px;height:400px;
  background:linear-gradient(135deg,var(--gold),var(--orange));
  top:-200px;right:-100px;
  animation-delay:0s;
}
.floating-orb.orb-2{
  width:300px;height:300px;
  background:linear-gradient(135deg,var(--teal),var(--emerald));
  bottom:-150px;left:-100px;
  animation-delay:-7s;
}
.floating-orb.orb-3{
  width:250px;height:250px;
  background:linear-gradient(135deg,var(--purple),var(--blue));
  top:50%;right:-125px;
  animation-delay:-14s;
}
@keyframes floatOrb{
  0%,100%{transform:translate(0,0) scale(1)}
  25%{transform:translate(-30px,20px) scale(1.05)}
  50%{transform:translate(20px,-30px) scale(0.95)}
  75%{transform:translate(-20px,-20px) scale(1.02)}
}

/* Landing Header */
.landing-header{
  padding:24px 32px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
  z-index:10;
}
.landing-brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand-icon{
  width:48px;height:48px;
  background:linear-gradient(135deg,var(--gold),var(--orange));
  border-radius:14px;
  display:grid;place-items:center;
  box-shadow:0 8px 24px rgba(245,158,11,0.3),
              inset 0 1px 0 rgba(255,255,255,0.2);
}
.brand-icon svg{width:28px;height:28px;stroke:#000;fill:none;stroke-width:2.5}
.brand-text{font-size:1.4rem;font-weight:800;letter-spacing:-0.02em}
.landing-header-actions{display:flex;gap:12px}

/* Landing Main Content */
.landing-main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:40px 24px 60px;
  position:relative;
  z-index:10;
}
.landing-hero{
  text-align:center;
  max-width:600px;
  margin-bottom:48px;
  flex-shrink:0;
}
.hero-badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 16px;
  background:rgba(245,158,11,0.1);
  border:1px solid rgba(245,158,11,0.2);
  border-radius:100px;
  font-size:0.75rem;
  font-weight:600;
  color:var(--gold);
  margin-bottom:24px;
  animation:fadeInUp 0.6s ease-out;
}
.hero-badge::before{
  content:'';
  width:6px;height:6px;
  background:var(--gold);
  border-radius:50%;
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.8)}}
.hero-title{
  font-size:clamp(2.5rem,8vw,4rem);
  font-weight:900;
  letter-spacing:-0.03em;
  line-height:1.1;
  margin-bottom:16px;
  animation:fadeInUp 0.6s ease-out 0.1s both;
}
.hero-title .gradient{
  background:linear-gradient(135deg,var(--gold) 0%,var(--teal) 50%,var(--purple) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}
.hero-subtitle{
  font-size:1.1rem;
  color:var(--text-secondary);
  font-weight:400;
  animation:fadeInUp 0.6s ease-out 0.2s both;
}
@keyframes fadeInUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

/* Units Section */
.units-section{
  width:100%;
  max-width:900px;
  animation:fadeInUp 0.6s ease-out 0.3s both;
}
.section-label{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-bottom:24px;
  font-size:0.75rem;
  font-weight:600;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:0.1em;
}
.section-label::before,.section-label::after{
  content:'';
  width:40px;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--border-light));
}
.section-label::after{background:linear-gradient(90deg,var(--border-light),transparent)}
.units-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;
  margin-bottom:32px;
}
.unit-card{
  background:linear-gradient(135deg,var(--bg-card),rgba(17,24,39,0.8));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:28px;
  cursor:pointer;
  transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
  position:relative;
  overflow:hidden;
}
.unit-card::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,var(--unit-color,var(--gold)) 0%,transparent 60%);
  opacity:0;
  transition:opacity 0.4s;
}
.unit-card::after{
  content:'';
  position:absolute;
  top:0;left:0;right:0;
  height:3px;
  background:var(--unit-color,var(--gold));
  transform:scaleX(0);
  transform-origin:left;
  transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);
}
.unit-card:hover{
  transform:translateY(-6px);
  border-color:var(--unit-color,var(--gold));
  box-shadow:0 20px 40px rgba(0,0,0,0.3),
              0 0 60px color-mix(in srgb,var(--unit-color,var(--gold)) 15%,transparent);
}
.unit-card:hover::before{opacity:0.05}
.unit-card:hover::after{transform:scaleX(1)}
.unit-card-content{position:relative;z-index:1}
.unit-card-icon{
  font-size:2.8rem;
  margin-bottom:16px;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}
.unit-card-name{
  font-size:1.15rem;
  font-weight:700;
  margin-bottom:6px;
  letter-spacing:-0.01em;
}
.unit-card-desc{
  color:var(--text-muted);
  font-size:0.85rem;
  line-height:1.5;
}
.unit-card-status{
  position:absolute;
  top:20px;right:20px;
  width:10px;height:10px;
  background:var(--emerald);
  border-radius:50%;
  box-shadow:0 0 12px var(--emerald);
  animation:statusPulse 2s ease-in-out infinite;
}
@keyframes statusPulse{
  0%,100%{box-shadow:0 0 12px var(--emerald)}
  50%{box-shadow:0 0 20px var(--emerald),0 0 30px var(--emerald)}
}

/* Request Unit Card */
.request-unit-card{
  background:transparent;
  border:2px dashed var(--border-light);
  border-radius:var(--radius);
  padding:28px;
  cursor:pointer;
  transition:all 0.4s;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  min-height:180px;
}
.request-unit-card:hover{
  border-color:var(--gold);
  background:rgba(245,158,11,0.03);
  transform:translateY(-4px);
}
.request-unit-card:hover .request-icon{
  transform:scale(1.1) rotate(90deg);
  background:var(--gold);
  color:#000;
}
.request-icon{
  width:56px;height:56px;
  border:2px solid var(--border-light);
  border-radius:50%;
  display:grid;place-items:center;
  margin-bottom:16px;
  transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
}
.request-icon svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2}
.request-title{font-weight:600;color:var(--text-secondary);margin-bottom:4px}
.request-subtitle{font-size:0.8rem;color:var(--text-muted)}

/* FABs */
.fab{
  position:fixed;
  width:56px;height:56px;
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:50%;
  display:grid;place-items:center;
  cursor:pointer;
  color:var(--text-muted);
  z-index:50;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  backdrop-filter:blur(10px);
}
.fab svg{width:24px;height:24px}
.fab:hover{
  border-color:var(--gold);
  color:var(--gold);
  transform:scale(1.05);
  box-shadow:0 8px 24px rgba(0,0,0,0.3);
}
.admin-fab{bottom:24px;right:24px}
.sync-fab{bottom:24px;left:24px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
@keyframes rotate{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REQUEST UNIT MODAL - Sophisticated Design
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  backdrop-filter:blur(12px);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:1000;
  opacity:0;
  transition:opacity 0.3s;
}
.modal.active{display:flex;opacity:1}
.modal-box{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:20px;
  width:100%;
  max-width:560px;
  max-height:90vh;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transform:scale(0.95) translateY(20px);
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
}
.modal.active .modal-box{transform:scale(1) translateY(0)}
.modal-box.wide{max-width:700px}

.request-modal-header{
  padding:32px 32px 24px;
  text-align:center;
  border-bottom:1px solid var(--border);
  position:relative;
  background:linear-gradient(180deg,rgba(245,158,11,0.05),transparent);
}
.request-modal-header::before{
  content:'';
  position:absolute;
  top:0;left:50%;transform:translateX(-50%);
  width:200px;height:3px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  border-radius:0 0 4px 4px;
}
.request-modal-icon{
  width:80px;height:80px;
  background:linear-gradient(135deg,var(--gold),var(--orange));
  border-radius:24px;
  display:grid;place-items:center;
  margin:0 auto 20px;
  font-size:2.5rem;
  box-shadow:0 12px 32px rgba(245,158,11,0.3),
              inset 0 1px 0 rgba(255,255,255,0.2);
  animation:iconFloat 3s ease-in-out infinite;
}
@keyframes iconFloat{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-4px)}
}
.request-modal-title{
  font-size:1.5rem;
  font-weight:800;
  margin-bottom:8px;
  letter-spacing:-0.02em;
}
.request-modal-subtitle{
  color:var(--text-muted);
  font-size:0.9rem;
}

.modal-body{padding:28px 32px;overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1}
.modal-footer{
  padding:20px 32px;
  border-top:1px solid var(--border);
  display:flex;
  gap:12px;
  background:var(--bg-elevated);
}
.modal-footer .btn{flex:1}

/* Form Styling */
.form-section{margin-bottom:28px}
.form-section-title{
  font-size:0.7rem;
  font-weight:700;
  color:var(--gold);
  text-transform:uppercase;
  letter-spacing:0.1em;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:10px;
}
.form-section-title::after{
  content:'';
  flex:1;
  height:1px;
  background:var(--border);
}
.form-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media(max-width:500px){.form-row{grid-template-columns:1fr}}
.form-group{margin-bottom:20px}
.form-label{
  display:block;
  font-size:0.75rem;
  font-weight:600;
  color:var(--text-secondary);
  margin-bottom:8px;
}
.form-label .required{color:var(--rose);margin-left:2px}
.form-input,.form-select,.form-textarea{
  width:100%;
  padding:14px 18px;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-family:inherit;
  font-size:0.9rem;
  transition:all 0.2s;
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  outline:none;
  border-color:var(--gold);
  box-shadow:0 0 0 3px rgba(245,158,11,0.1);
}
.form-input::placeholder{color:var(--text-muted)}
.form-textarea{min-height:100px;resize:vertical}
.form-hint{font-size:0.75rem;color:var(--text-muted);margin-top:6px}

/* Icon Selector */
.icon-selector{
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:8px;
}
.icon-option{
  aspect-ratio:1;
  background:var(--bg);
  border:2px solid var(--border);
  border-radius:var(--radius-sm);
  font-size:1.4rem;
  cursor:pointer;
  transition:all 0.2s;
  display:grid;place-items:center;
}
.icon-option:hover{border-color:var(--text-muted);transform:scale(1.05)}
.icon-option.selected{
  border-color:var(--gold);
  background:rgba(245,158,11,0.1);
  transform:scale(1.05);
}

/* Success State */
.request-success{
  text-align:center;
  padding:48px 32px;
}
.success-animation{
  width:100px;height:100px;
  margin:0 auto 28px;
  position:relative;
}
.success-circle{
  width:100%;height:100%;
  border:3px solid var(--emerald);
  border-radius:50%;
  animation:successCircle 0.5s ease-out forwards;
}
@keyframes successCircle{
  from{transform:scale(0);opacity:0}
  to{transform:scale(1);opacity:1}
}
.success-check{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:50px;height:50px;
  stroke:var(--emerald);
  stroke-width:3;
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
  stroke-dasharray:100;
  stroke-dashoffset:100;
  animation:drawCheck 0.5s ease-out 0.3s forwards;
}
@keyframes drawCheck{to{stroke-dashoffset:0}}
.success-title{
  font-size:1.4rem;
  font-weight:700;
  margin-bottom:12px;
  color:var(--emerald);
}
.success-text{
  color:var(--text-secondary);
  font-size:0.95rem;
  margin-bottom:24px;
  line-height:1.7;
}
.success-id{
  display:inline-block;
  background:var(--bg);
  border:1px solid var(--border);
  padding:14px 24px;
  border-radius:var(--radius-sm);
  font-family:'JetBrains Mono',monospace;
  font-size:0.9rem;
  color:var(--gold);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:14px 24px;
  border:none;
  border-radius:var(--radius-sm);
  font-family:inherit;
  font-size:0.875rem;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
}
.btn:active{transform:scale(0.97)}
.btn-primary{
  background:linear-gradient(135deg,var(--gold),var(--gold-light));
  color:#000;
  box-shadow:0 4px 12px rgba(245,158,11,0.3);
}
.btn-primary:hover{
  box-shadow:0 6px 20px rgba(245,158,11,0.4);
  transform:translateY(-1px);
}
.btn-secondary{
  background:var(--bg-elevated);
  border:1px solid var(--border-light);
  color:var(--text);
}
.btn-secondary:hover{border-color:var(--gold);color:var(--gold)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:10px}
.btn-ghost:hover{color:var(--gold)}
.btn-danger{
  background:rgba(244,63,94,0.15);
  border:1px solid rgba(244,63,94,0.3);
  color:var(--rose);
}
.btn-sm{padding:10px 16px;font-size:0.8rem}
.btn-xs{padding:6px 12px;font-size:0.75rem}
.btn-full{width:100%}
.btn-icon{width:44px;height:44px;padding:0;border-radius:var(--radius-sm)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#adminPanel{background:var(--bg);display:none}
#adminPanel.active{display:flex;flex-direction:column;height:100%;overflow:hidden}
.admin-header{
  background:var(--bg-card);
  border-bottom:1px solid var(--border);
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-shrink:0;
}
.admin-content{max-width:800px;margin:0 auto;padding:24px;width:100%;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.admin-tabs{
  display:flex;
  gap:4px;
  margin-bottom:24px;
  background:var(--bg);
  padding:4px;
  border-radius:var(--radius-sm);
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.admin-tab{
  flex:0 0 auto;
  padding:12px 16px;
  background:transparent;
  border:none;
  border-radius:6px;
  color:var(--text-muted);
  font-family:inherit;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}
.admin-tab:hover{color:var(--text)}
.admin-tab.active{background:var(--bg-elevated);color:var(--gold)}
.admin-tab-panel{display:none}
.admin-tab-panel.active{display:block}
.admin-section{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  margin-bottom:24px;
  overflow:hidden;
}
.section-header{
  padding:18px 20px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:12px;
}
.section-title{font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px}
.section-body{padding:20px}

/* Units Table */
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}
.units-table tr:last-child td{border-bottom:none}

/* Requests */
.requests-list{display:flex;flex-direction:column;gap:12px}
.request-card{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  position:relative;
  border-left:4px solid var(--gold);
}
.request-card.approved{border-left-color:var(--emerald);opacity:0.7}
.request-card.rejected{border-left-color:var(--rose);opacity:0.7}
.request-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.request-card-title{font-weight:700;font-size:1rem}
.request-card-status{
  padding:4px 12px;
  border-radius:100px;
  font-size:0.7rem;
  font-weight:700;
  text-transform:uppercase;
}
.request-card-status.pending{background:rgba(245,158,11,0.15);color:var(--gold)}
.request-card-status.approved{background:rgba(16,185,129,0.15);color:var(--emerald)}
.request-card-status.rejected{background:rgba(244,63,94,0.15);color:var(--rose)}
.request-card-details{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
  font-size:0.85rem;
  color:var(--text-secondary);
  margin-bottom:16px;
}
.request-card-detail{display:flex;align-items:center;gap:6px}
.request-card-message{
  background:var(--bg-card);
  padding:12px;
  border-radius:var(--radius-sm);
  font-size:0.85rem;
  color:var(--text-secondary);
  margin-bottom:16px;
}
.request-card-actions{display:flex;gap:8px}
.request-card-time{font-size:0.75rem;color:var(--text-muted);position:absolute;top:16px;right:16px}
.badge-count{
  background:var(--rose);
  color:#fff;
  padding:2px 8px;
  border-radius:100px;
  font-size:0.7rem;
  margin-left:8px;
}

/* API Endpoints Section */
.endpoint-item{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:16px;
  margin-bottom:12px;
}
.endpoint-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.endpoint-name{font-weight:600;display:flex;align-items:center;gap:8px}
.endpoint-badge{
  padding:3px 8px;
  border-radius:4px;
  font-size:0.65rem;
  font-weight:700;
}
.endpoint-badge.primary{background:rgba(245,158,11,0.15);color:var(--gold)}
.endpoint-badge.active{background:rgba(16,185,129,0.15);color:var(--emerald)}
.endpoint-badge.inactive{background:rgba(244,63,94,0.15);color:var(--rose)}
.endpoint-url{
  font-family:'JetBrains Mono',monospace;
  font-size:0.75rem;
  color:var(--text-muted);
  word-break:break-all;
  background:var(--bg-card);
  padding:8px 12px;
  border-radius:6px;
}
.endpoint-actions{display:flex;gap:8px;margin-top:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.page{display:none;height:100%;overflow:hidden}
.page.active{display:flex;flex-direction:column}
#dashboard{background:var(--bg)}
.dash-header{
  background:var(--glass);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:12px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;
  top:0;
  z-index:100;
}
.dash-logo{display:flex;align-items:center;gap:14px}
.dash-logo-icon{
  width:42px;height:42px;
  background:linear-gradient(135deg,var(--gold),var(--orange));
  border-radius:12px;
  display:grid;place-items:center;
}
.dash-logo-icon svg{width:24px;height:24px;stroke:#000;fill:none}
.dash-badge{
  padding:8px 16px;
  border-radius:100px;
  font-size:0.8rem;
  font-weight:600;
  border:1px solid var(--border);
}
.dash-user{display:flex;align-items:center;gap:12px}
.dash-avatar{
  width:42px;height:42px;
  background:linear-gradient(135deg,var(--teal),var(--emerald));
  border-radius:12px;
  display:grid;place-items:center;
  font-weight:700;
  font-size:0.9rem;
}
.dash-content{flex:1;max-width:1000px;margin:0 auto;padding:20px;width:100%;overflow-y:auto;-webkit-overflow-scrolling:touch}
.date-banner{
  background:linear-gradient(135deg,var(--gold),var(--orange));
  color:#000;
  padding:16px 20px;
  border-radius:var(--radius);
  margin-bottom:20px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:12px;
}
.tabs-container{
  background:var(--bg-card);
  border-radius:var(--radius);
  padding:6px;
  margin-bottom:20px;
  display:flex;
  gap:4px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.tab{
  flex:1 0 auto;
  min-width:fit-content;
  padding:14px 16px;
  background:transparent;
  border:none;
  border-radius:var(--radius-sm);
  color:var(--text-muted);
  font-family:inherit;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg-elevated);color:var(--gold)}
.panel{display:none}
.panel.active{display:block}
.stats-grid{
  display:flex;
  gap:10px;
  margin-bottom:20px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scroll-snap-type:x mandatory;
  padding-bottom:4px;
}
.stat-card{
  flex:0 0 auto;
  min-width:80px;
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:16px 12px;
  text-align:center;
  cursor:pointer;
  transition:all 0.2s;
  scroll-snap-align:start;
}
.stat-card:hover,.stat-card.active{border-color:var(--gold);background:rgba(245,158,11,0.08)}
.stat-value{
  font-size:1.5rem;
  font-weight:800;
  background:linear-gradient(135deg,var(--gold),var(--teal));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.action-buttons .btn-full{grid-column:span 2}
.ward-section{margin-bottom:24px}
.ward-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));
  border-radius:var(--radius-sm);
  margin-bottom:14px;
  border-left:4px solid var(--gold);
}
.ward-title{font-weight:700;font-size:0.95rem;color:var(--gold)}
.ward-count{background:var(--gold);color:#000;padding:4px 14px;border-radius:100px;font-size:0.75rem;font-weight:700}
.patient-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:18px;
  margin-bottom:12px;
  cursor:pointer;
  transition:all 0.2s;
  border-left:4px solid var(--teal);
}
.patient-card:hover{border-color:var(--gold);transform:translateX(4px)}
.patient-card.critical{border-left-color:var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.patient-card.chronic{border-left-color:var(--purple)}
.patient-card.new{border-left-color:var(--emerald);background:linear-gradient(135deg,rgba(16,185,129,0.05),transparent)}
.patient-header{display:flex;align-items:center;gap:16px}
.patient-avatar{
  width:52px;height:52px;
  border-radius:14px;
  display:grid;place-items:center;
  font-weight:700;
  font-size:0.9rem;
  color:#000;
  flex-shrink:0;
  background:linear-gradient(135deg,var(--gold),var(--orange));
}
.patient-card.new .patient-avatar{background:linear-gradient(135deg,var(--emerald),var(--teal))}
.patient-card.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}
.patient-card.critical .patient-avatar{background:linear-gradient(135deg,var(--rose),var(--orange))}
.patient-info{flex:1;min-width:0}
.patient-name{font-weight:700;font-size:1rem;margin-bottom:4px}
.patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text-secondary)}
.patient-diagnosis{
  font-size:0.85rem;
  color:var(--text-secondary);
  margin-top:12px;
  padding:12px 14px;
  background:var(--bg);
  border-radius:var(--radius-sm);
}
.badge{
  display:inline-flex;
  align-items:center;
  padding:4px 10px;
  border-radius:6px;
  font-size:0.65rem;
  font-weight:700;
  text-transform:uppercase;
}
.badge-gold{background:rgba(245,158,11,0.15);color:var(--gold)}
.badge-teal{background:rgba(20,184,166,0.15);color:var(--teal)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-rose{background:rgba(244,63,94,0.15);color:var(--rose)}
.badge-emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}
.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PATIENT PROFILE STYLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#patientProfile{background:var(--bg);overflow:hidden}
.profile-header{
  background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg) 100%);
  padding:20px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.profile-nav{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.back-btn{
  width:44px;height:44px;
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:12px;
  display:grid;place-items:center;
  cursor:pointer;
  color:var(--text-muted);
  transition:all 0.2s;
}
.back-btn:hover{border-color:var(--gold);color:var(--gold)}
.profile-title{font-size:1.25rem;font-weight:700;flex:1}
.profile-actions{display:flex;gap:8px}
.profile-patient{display:flex;align-items:center;gap:20px}
.profile-avatar{
  width:72px;height:72px;
  border-radius:20px;
  display:grid;place-items:center;
  font-size:1.5rem;
  font-weight:800;
  color:#000;
}
.profile-details h2{font-size:1.4rem;font-weight:800;margin-bottom:6px}
.profile-details .meta{display:flex;flex-wrap:wrap;gap:16px;color:var(--text-secondary);font-size:0.85rem}
.profile-tabs{
  display:flex;
  gap:6px;
  padding:0 20px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  flex-shrink:0;
  scroll-snap-type:x mandatory;
}
.profile-tabs::-webkit-scrollbar{display:none}
.profile-tab{
  padding:12px 20px;
  background:transparent;
  border:none;
  border-bottom:2px solid transparent;
  color:var(--text-muted);
  font-family:inherit;
  font-size:0.85rem;
  font-weight:600;
  cursor:pointer;
  white-space:nowrap;
  transition:all 0.2s;
  scroll-snap-align:start;
  flex-shrink:0;
}
.profile-tab:hover{color:var(--text)}
.profile-tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.profile-content{flex:1;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.profile-panel{display:none}
.profile-panel.active{display:block}
.section-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  margin-bottom:20px;
  overflow:hidden;
}

/* Lab Styles */
.lab-upload-area{
  background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(20,184,166,0.08));
  border:2px dashed var(--border-light);
  border-radius:var(--radius);
  padding:32px 24px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s;
  margin-bottom:24px;
}
.lab-upload-area:hover{border-color:var(--gold);background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(20,184,166,0.12))}
.lab-upload-area.analyzing{pointer-events:none;opacity:0.7}
.lab-upload-icon{font-size:2.5rem;margin-bottom:12px}
.lab-upload-title{font-weight:700;font-size:1rem;margin-bottom:4px}
.lab-upload-subtitle{color:var(--text-muted);font-size:0.85rem}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-interpretation{
  background:linear-gradient(135deg,rgba(20,184,166,0.08),rgba(59,130,246,0.08));
  border:1px solid rgba(20,184,166,0.2);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:24px;
}
.ai-interpretation-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ai-interpretation-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--teal)}
.ai-badge{
  background:linear-gradient(135deg,var(--purple),var(--blue));
  color:#fff;
  font-size:0.6rem;
  padding:4px 8px;
  border-radius:4px;
  font-weight:700;
}
.ai-interpretation-text{color:var(--text-secondary);font-size:0.9rem;line-height:1.7;margin-bottom:16px}
.ai-details{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px}
.ai-details-title{font-size:0.75rem;font-weight:600;color:var(--gold);text-transform:uppercase;margin-bottom:12px}
.ai-details-list{list-style:none;padding:0;margin:0}
.ai-details-list li{font-size:0.85rem;color:var(--text-secondary);padding:6px 0;border-bottom:1px solid var(--border)}
.ai-details-list li:last-child{border-bottom:none}
.feedback-section{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid var(--border)}
.feedback-label{font-size:0.75rem;color:var(--text-muted)}
.feedback-buttons{display:flex;gap:8px}
.feedback-btn{
  width:40px;height:40px;
  border-radius:50%;
  border:1px solid var(--border);
  background:var(--bg);
  cursor:pointer;
  display:grid;place-items:center;
  font-size:1.1rem;
  transition:all 0.2s;
}
.feedback-btn:hover{transform:scale(1.1)}
.feedback-btn.positive:hover,.feedback-btn.positive.active{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.feedback-btn.negative:hover,.feedback-btn.negative.active{background:rgba(244,63,94,0.2);border-color:var(--rose)}
.feedback-btn.active{transform:scale(1.1)}
.feedback-sent{font-size:0.75rem;color:var(--emerald);display:none}
.feedback-sent.show{display:block}
.critical-alert{
  background:rgba(244,63,94,0.1);
  border:1px solid rgba(244,63,94,0.3);
  border-radius:var(--radius-sm);
  padding:16px;
  margin-bottom:20px;
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.critical-alert-icon{font-size:1.25rem}
.critical-alert-content{flex:1}
.critical-alert-title{font-weight:700;color:var(--rose);margin-bottom:4px}
.critical-alert-values{font-size:0.85rem;color:var(--text-secondary)}
.lab-category{background:var(--bg);border-radius:var(--radius-sm);margin-bottom:16px;overflow:hidden}
.lab-category-header{
  padding:12px 16px;
  background:rgba(245,158,11,0.08);
  font-weight:600;
  font-size:0.8rem;
  color:var(--gold);
  text-transform:uppercase;
  letter-spacing:0.05em;
  display:flex;
  align-items:center;
  gap:8px;
}
.lab-category-body{padding:16px}
.lab-values-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.lab-value-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:14px;
  transition:all 0.2s;
}
.lab-value-card.high{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.lab-value-card.low{border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05),transparent)}
.lab-value-card.critical{border-left:3px solid var(--rose);background:rgba(244,63,94,0.1)}
.lab-value-card.normal{border-left:3px solid var(--emerald)}
.lab-value-name{font-size:0.75rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.lab-value-status{font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:4px}
.lab-value-status.high,.lab-value-status.critical{background:var(--rose);color:#fff}
.lab-value-status.low{background:var(--blue);color:#fff}
.lab-value-number{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600;margin-bottom:4px}
.lab-value-card.high .lab-value-number{color:var(--rose)}
.lab-value-card.low .lab-value-number{color:var(--blue)}
.lab-value-card.normal .lab-value-number{color:var(--emerald)}
.lab-value-unit{font-size:0.7rem;color:var(--text-muted)}
.lab-value-range{font-size:0.65rem;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.lab-trend-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.lab-trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.lab-trend-select{
  padding:10px 16px;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-family:inherit;
  font-size:0.85rem;
  min-width:180px;
}
.lab-trend-chart{background:var(--bg);border-radius:var(--radius-sm);padding:20px;height:220px}

/* Other Sections */
.vitals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}
.vital-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.vital-icon{font-size:1.5rem;margin-bottom:8px}
.vital-value{font-size:1.25rem;font-weight:700}
.vital-label{font-size:0.7rem;color:var(--text-muted);margin-top:4px}
.fluid-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fluid-stat{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.fluid-stat-value{font-size:1.5rem;font-weight:800}
.fluid-stat-value.intake{color:var(--blue)}
.fluid-stat-value.output{color:var(--orange)}
.fluid-stat-value.balance{color:var(--emerald)}
.fluid-stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.fluid-chart-container{height:200px;margin-top:20px}
.plan-item{
  background:var(--bg);
  border-radius:var(--radius-sm);
  padding:16px;
  margin-bottom:12px;
  border-left:3px solid var(--gold);
}
.plan-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.plan-item-date{font-size:0.7rem;color:var(--text-muted)}
.plan-item-content{font-size:0.9rem;white-space:pre-wrap}
.imaging-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}
.imaging-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.imaging-type{font-weight:600;display:flex;align-items:center;gap:8px}
.imaging-date{font-size:0.75rem;color:var(--text-muted)}
.imaging-summary{font-size:0.85rem;color:var(--text-secondary)}
.toast{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:var(--bg-card);
  border:1px solid var(--emerald);
  padding:16px 28px;
  border-radius:var(--radius);
  font-size:0.9rem;
  opacity:0;
  transition:all 0.3s;
  z-index:2000;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{
  width:48px;height:48px;
  border:3px solid var(--border);
  border-top-color:var(--gold);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto;
}
.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}
.empty-state-icon{font-size:3.5rem;margin-bottom:16px;opacity:0.4}
.upload-zone{
  border:2px dashed var(--border);
  border-radius:var(--radius);
  padding:40px 24px;
  text-align:center;
  cursor:pointer;
  transition:all 0.2s;
}
.upload-zone:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg);border-radius:var(--radius-sm);padding:18px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.8rem;color:var(--text-secondary)}
.import-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px;
  background:var(--bg);
  border-radius:var(--radius-sm);
  margin-bottom:10px;
  border-left:4px solid var(--teal);
}
.import-ward-select{
  padding:8px 12px;
  background:var(--bg-card);
  border:1px solid var(--gold);
  border-radius:8px;
  color:var(--gold);
  font-size:0.75rem;
  font-weight:600;
}

/* Modal Header */
.modal-header{
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.modal-title{font-size:1.1rem;font-weight:700}

/* Code Input */
.code-inputs{display:flex;gap:14px;justify-content:center;margin-bottom:20px}
.code-digit{
  width:56px;height:68px;
  background:var(--bg);
  border:2px solid var(--border);
  border-radius:var(--radius-sm);
  font-family:'JetBrains Mono',monospace;
  font-size:1.75rem;
  font-weight:700;
  text-align:center;
  color:var(--text);
  transition:all 0.2s;
}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none;margin-top:12px}
.code-error.show{display:block}

/* Responsive */
@media(max-width:640px){
  .action-buttons{grid-template-columns:1fr}
  .action-buttons .btn-full{grid-column:span 1}
  .profile-patient{flex-direction:column;text-align:center}
  .profile-details .meta{justify-content:center}
  .lab-values-grid{grid-template-columns:repeat(2,1fr)}
  .landing-header{padding:16px 20px}
  .landing-main{padding:20px 16px 40px}
  .units-grid{grid-template-columns:1fr}
  .icon-selector{grid-template-columns:repeat(6,1fr)}
  .stat-card{min-width:70px;padding:12px 8px}
  .stat-value{font-size:1.25rem}
  .modal-body{padding:20px}
  .form-row{grid-template-columns:1fr}
  .fluid-summary{grid-template-columns:1fr}
  .vitals-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING PAGE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="landing">
<div class="landing-bg">
  <div class="floating-orb orb-1"></div>
  <div class="floating-orb orb-2"></div>
  <div class="floating-orb orb-3"></div>
  <div class="grid-overlay"></div>
</div>

<header class="landing-header">
  <div class="landing-brand">
    <div class="brand-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
    <span class="brand-text">Medical Wards</span>
  </div>
  <div class="landing-header-actions">
    <button class="btn btn-ghost btn-sm" onclick="openAdminLogin()">âš™ï¸ Admin</button>
  </div>
</header>

<main class="landing-main">
  <div class="landing-hero">
    <div class="hero-badge">ğŸ§  AI-Powered Clinical Intelligence</div>
    <h1 class="hero-title">
      <span class="gradient">Medical</span> Wards
    </h1>
    <p class="hero-subtitle">Next-generation clinical workflow system with AI-powered patient extraction, intelligent lab analysis, and seamless team collaboration.</p>
  </div>
  
  <div class="units-section">
    <div class="section-label">Select Your Unit</div>
    <div class="units-grid" id="unitsGrid"></div>
    
    <div class="request-unit-card" onclick="openRequestUnit()">
      <div class="request-icon">
        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
      </div>
      <div class="request-title">Request New Unit Access</div>
      <div class="request-subtitle">Submit a request to the administrator</div>
    </div>
  </div>
</main>

<div class="fab sync-fab" id="syncFab">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/>
  </svg>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="dashboard">
<header class="dash-header">
  <div class="dash-logo">
    <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
    <span class="dash-badge" id="unitBadge">Unit</span>
  </div>
  <div class="dash-user">
    <div class="dash-avatar" id="dashAvatar">DR</div>
    <button class="btn btn-ghost btn-icon" onclick="logout()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
    </button>
  </div>
</header>
<div class="dash-content">
  <div class="date-banner">ğŸ“… <span id="currentDate"></span></div>
  <div class="tabs-container" id="mainTabs">
    <button class="tab active" data-tab="patients">ğŸ‘¥ Patients</button>
    <button class="tab" data-tab="reference">ğŸ“š Reference</button>
  </div>
  <div class="panel active" id="panelPatients">
    <div class="stats-grid" id="statsBar">
      <div class="stat-card active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
      <div class="stat-card" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
      <div class="stat-card" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
      <div class="stat-card" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
      <div class="stat-card" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
    </div>
    <div class="action-buttons">
      <button class="btn btn-primary btn-sm" onclick="openAddPatient()">â• Add Patient</button>
      <button class="btn btn-secondary btn-sm" onclick="openImport()">ğŸ“¥ Import List</button>
      <button class="btn btn-secondary btn-sm btn-full" onclick="exportPDF()">ğŸ“„ Export PDF</button>
    </div>
    <div id="patientsList"></div>
  </div>
  <div class="panel" id="panelReference">
    <div class="section-card">
      <div class="section-header"><div class="section-title">ğŸ“š Clinical Reference</div></div>
      <div class="section-body"><div class="ref-grid" id="refGrid"></div></div>
    </div>
  </div>
</div>
</div>

<!-- PATIENT PROFILE -->
<div class="page" id="patientProfile">
<div class="profile-header">
  <div class="profile-nav">
    <div class="back-btn" onclick="closePatientProfile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>
    <div class="profile-title">Patient Profile</div>
    <div class="profile-actions">
      <button class="btn btn-secondary btn-sm" onclick="editCurrentPatient()">âœï¸</button>
      <button class="btn btn-danger btn-sm" onclick="deleteCurrentPatient()">ğŸ—‘ï¸</button>
    </div>
  </div>
  <div class="profile-patient" id="profilePatientInfo"></div>
</div>
<div class="profile-tabs" id="profileTabs">
  <button class="profile-tab active" data-ptab="overview">Overview</button>
  <button class="profile-tab" data-ptab="labs">Labs</button>
  <button class="profile-tab" data-ptab="imaging">Imaging</button>
  <button class="profile-tab" data-ptab="fluids">Fluids</button>
  <button class="profile-tab" data-ptab="plans">Plans</button>
</div>
<div class="profile-content">
  <div class="profile-panel active" id="profileOverview"></div>
  <div class="profile-panel" id="profileLabs"></div>
  <div class="profile-panel" id="profileImaging"></div>
  <div class="profile-panel" id="profileFluids"></div>
  <div class="profile-panel" id="profilePlans"></div>
</div>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="adminPanel">
<header class="admin-header">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
    <span style="font-weight:700">Admin Dashboard</span>
  </div>
  <button class="btn btn-secondary btn-sm" onclick="exitAdmin()">â† Exit</button>
</header>
<div class="admin-content">
  <div class="admin-tabs" id="adminTabs">
    <button class="admin-tab active" data-atab="units">ğŸ¥ Units</button>
    <button class="admin-tab" data-atab="requests">ğŸ“© Requests <span class="badge-count" id="requestsCount" style="display:none">0</span></button>
    <button class="admin-tab" data-atab="endpoints">ğŸ”— API Endpoints</button>
    <button class="admin-tab" data-atab="settings">âš™ï¸ Settings</button>
  </div>
  
  <!-- Units Tab -->
  <div class="admin-tab-panel active" id="adminUnits">
    <div class="admin-section">
      <div class="section-header">
        <div class="section-title">ğŸ¥ Manage Units</div>
        <button class="btn btn-primary btn-sm" onclick="addUnit()">+ Add Unit</button>
      </div>
      <table class="units-table">
        <thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead>
        <tbody id="unitsTable"></tbody>
      </table>
    </div>
  </div>
  
  <!-- Requests Tab -->
  <div class="admin-tab-panel" id="adminRequests">
    <div class="admin-section">
      <div class="section-header">
        <div class="section-title">ğŸ“© Unit Access Requests</div>
        <button class="btn btn-secondary btn-sm" onclick="refreshRequests()">ğŸ”„ Refresh</button>
      </div>
      <div class="section-body">
        <div class="requests-list" id="requestsList">
          <div style="text-align:center;padding:40px;color:var(--text-muted)">
            <div style="font-size:2rem;margin-bottom:12px">ğŸ“­</div>
            <div>No pending requests</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- API Endpoints Tab -->
  <div class="admin-tab-panel" id="adminEndpoints">
    <div class="admin-section">
      <div class="section-header">
        <div class="section-title">ğŸ”— Google Apps Script Endpoints</div>
        <button class="btn btn-primary btn-sm" onclick="openAddEndpoint()">+ Add Endpoint</button>
      </div>
      <div class="section-body">
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:20px">
          Manage multiple Google Apps Script deployments. The primary endpoint is used for all operations.
        </p>
        <div id="endpointsList"></div>
      </div>
    </div>
  </div>
  
  <!-- Settings Tab -->
  <div class="admin-tab-panel" id="adminSettings">
    <div class="admin-section">
      <div class="section-header"><div class="section-title">âš™ï¸ System Settings</div></div>
      <div class="section-body">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="newAdminPwd" class="form-input" placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label class="form-label">Claude API Key (for AI Patient Extraction)</label>
          <input type="password" id="claudeApiKey" class="form-input" placeholder="sk-ant-...">
          <div class="form-hint">Required for AI-powered patient list extraction from images</div>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Unit Access Modal -->
<div class="modal" id="accessModal">
<div class="modal-box">
  <div class="modal-header" style="text-align:center;display:block;border:none">
    <div id="accessIcon" style="font-size:3rem;margin-bottom:12px">ğŸ¥</div>
    <div class="modal-title" id="accessTitle">Unit Access</div>
    <p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">Enter 4-digit code</p>
  </div>
  <div class="modal-body">
    <div class="code-inputs" id="codeInputs"></div>
    <p class="code-error" id="codeError">Invalid code</p>
    <div id="userSection" style="display:none;margin-top:28px;padding-top:28px;border-top:1px solid var(--border)">
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input type="text" id="userName" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select id="userRole" class="form-select">
          <option value="attending">Attending</option>
          <option value="resident">Resident</option>
          <option value="intern">Intern</option>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
    <button class="btn btn-primary" id="enterBtn" style="display:none" onclick="enterUnit()">Enter</button>
  </div>
</div>
</div>

<!-- Admin Login Modal -->
<div class="modal" id="adminModal">
<div class="modal-box">
  <div class="modal-header" style="text-align:center;display:block;border:none">
    <div style="font-size:3rem;margin-bottom:12px">âš™ï¸</div>
    <div class="modal-title">Admin Access</div>
  </div>
  <div class="modal-body">
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="adminPwd" class="form-input">
    </div>
    <p class="code-error" id="adminError">Invalid password</p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button>
    <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
  </div>
</div>
</div>

<!-- Request Unit Modal - Sophisticated Design -->
<div class="modal" id="requestUnitModal">
<div class="modal-box" style="max-width:580px">
  <div class="request-modal-header">
    <div class="request-modal-icon">ğŸ“‹</div>
    <h2 class="request-modal-title">Request Unit Access</h2>
    <p class="request-modal-subtitle">Submit your request to the system administrator</p>
  </div>
  
  <div class="modal-body" id="requestFormSection">
    <div class="form-section">
      <div class="form-section-title">Your Information</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Full Name <span class="required">*</span></label>
          <input type="text" id="reqName" class="form-input" placeholder="Dr. John Smith">
        </div>
        <div class="form-group">
          <label class="form-label">Email <span class="required">*</span></label>
          <input type="email" id="reqEmail" class="form-input" placeholder="john.smith@hospital.org">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Department <span class="required">*</span></label>
          <input type="text" id="reqDepartment" class="form-input" placeholder="Internal Medicine">
        </div>
        <div class="form-group">
          <label class="form-label">Role <span class="required">*</span></label>
          <select id="reqRole" class="form-select">
            <option value="">Select role...</option>
            <option value="attending">Attending Physician</option>
            <option value="consultant">Consultant</option>
            <option value="resident">Resident</option>
            <option value="intern">Intern</option>
            <option value="nurse_manager">Nurse Manager</option>
            <option value="head_nurse">Head Nurse</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="form-section-title">Unit Details</div>
      <div class="form-group">
        <label class="form-label">Requested Unit Name <span class="required">*</span></label>
        <input type="text" id="reqUnitName" class="form-input" placeholder="e.g., Cardiology Ward, ICU-2, Neurology">
      </div>
      <div class="form-group">
        <label class="form-label">Select Unit Icon</label>
        <div class="icon-selector" id="iconGrid">
          <div class="icon-option selected" data-icon="ğŸ¥">ğŸ¥</div>
          <div class="icon-option" data-icon="â¤ï¸">â¤ï¸</div>
          <div class="icon-option" data-icon="ğŸ§ ">ğŸ§ </div>
          <div class="icon-option" data-icon="ğŸ«">ğŸ«</div>
          <div class="icon-option" data-icon="ğŸ¦´">ğŸ¦´</div>
          <div class="icon-option" data-icon="ğŸ‘¶">ğŸ‘¶</div>
          <div class="icon-option" data-icon="ğŸ©º">ğŸ©º</div>
          <div class="icon-option" data-icon="ğŸ’‰">ğŸ’‰</div>
          <div class="icon-option" data-icon="ğŸ”¬">ğŸ”¬</div>
          <div class="icon-option" data-icon="âš•ï¸">âš•ï¸</div>
          <div class="icon-option" data-icon="ğŸš‘">ğŸš‘</div>
          <div class="icon-option" data-icon="ğŸ’Š">ğŸ’Š</div>
          <div class="icon-option" data-icon="ğŸ©»">ğŸ©»</div>
          <div class="icon-option" data-icon="ğŸ§¬">ğŸ§¬</div>
          <div class="icon-option" data-icon="ğŸ«€">ğŸ«€</div>
          <div class="icon-option" data-icon="ğŸ‘ï¸">ğŸ‘ï¸</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Additional Notes (Optional)</label>
        <textarea id="reqMessage" class="form-textarea" placeholder="Any additional information for the administrator..."></textarea>
      </div>
    </div>
  </div>
  
  <div class="request-success" id="requestSuccessSection" style="display:none">
    <div class="success-animation">
      <div class="success-circle"></div>
      <svg class="success-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <h3 class="success-title">Request Submitted!</h3>
    <p class="success-text">
      Your request has been sent to the administrator for review.<br>
      You will be notified once your unit access is approved.
    </p>
    <div class="success-id" id="requestIdDisplay">Request ID: REQ-XXXXXX</div>
  </div>
  
  <div class="modal-footer" id="requestFormFooter">
    <button class="btn btn-secondary" onclick="closeModal('requestUnitModal')">Cancel</button>
    <button class="btn btn-primary" onclick="submitUnitRequest()">ğŸ“¨ Submit Request</button>
  </div>
  <div class="modal-footer" id="requestSuccessFooter" style="display:none">
    <button class="btn btn-primary btn-full" onclick="closeModal('requestUnitModal')">Done</button>
  </div>
</div>
</div>

<!-- Approve Request Modal -->
<div class="modal" id="approveRequestModal">
<div class="modal-box wide">
  <div class="modal-header">
    <div class="modal-title">âœ… Review & Approve Request</div>
    <button class="btn btn-ghost btn-icon" onclick="closeModal('approveRequestModal')">âœ•</button>
  </div>
  <div class="modal-body">
    <div id="approveRequestDetails"></div>
    <div class="form-section">
      <div class="form-section-title">Create Unit</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Unit Name</label>
          <input type="text" id="approveUnitName" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Icon</label>
          <input type="text" id="approveUnitIcon" class="form-input" style="font-size:1.5rem;text-align:center">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Access Code (4 digits) <span class="required">*</span></label>
          <input type="text" id="approveUnitCode" class="form-input mono" maxlength="4" placeholder="0000">
        </div>
        <div class="form-group">
          <label class="form-label">Color Theme</label>
          <select id="approveUnitColor" class="form-select">
            <option value="#f59e0b">ğŸŸ¡ Gold</option>
            <option value="#14b8a6">ğŸ©µ Teal</option>
            <option value="#3b82f6">ğŸ”µ Blue</option>
            <option value="#8b5cf6">ğŸŸ£ Purple</option>
            <option value="#10b981">ğŸŸ¢ Emerald</option>
            <option value="#f43f5e">ğŸ”´ Rose</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" id="approveUnitDesc" class="form-input" placeholder="Brief description">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-danger" onclick="rejectRequest()">âŒ Reject</button>
    <button class="btn btn-primary" onclick="approveRequest()">âœ… Approve & Create Unit</button>
  </div>
</div>
</div>

<!-- Add/Edit Unit Modal -->
<div class="modal" id="unitModal">
<div class="modal-box">
  <div class="modal-header">
    <div class="modal-title" id="unitModalTitle">Add Unit</div>
  </div>
  <div class="modal-body">
    <div class="form-group">
      <label class="form-label">Unit Name</label>
      <input type="text" id="uName" class="form-input" placeholder="e.g., Cardiology">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Icon</label>
        <input type="text" id="uIcon" class="form-input" style="font-size:1.5rem;text-align:center" value="ğŸ¥">
      </div>
      <div class="form-group">
        <label class="form-label">Access Code (4 digits)</label>
        <input type="text" id="uCode" class="form-input mono" maxlength="4" placeholder="0000">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input type="text" id="uDesc" class="form-input" placeholder="Brief description">
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveUnit()">Save</button>
  </div>
</div>
</div>

<!-- Add Endpoint Modal -->
<div class="modal" id="endpointModal">
<div class="modal-box">
  <div class="modal-header">
    <div class="modal-title" id="endpointModalTitle">Add API Endpoint</div>
  </div>
  <div class="modal-body">
    <div class="form-group">
      <label class="form-label">Endpoint Name</label>
      <input type="text" id="epName" class="form-input" placeholder="e.g., Main API, Backup API">
    </div>
    <div class="form-group">
      <label class="form-label">Google Apps Script URL</label>
      <input type="text" id="epUrl" class="form-input mono" placeholder="https://script.google.com/macros/s/.../exec">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input type="text" id="epDesc" class="form-input" placeholder="What this endpoint is used for">
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('endpointModal')">Cancel</button>
    <button class="btn btn-primary" onclick="saveEndpoint()">Save Endpoint</button>
  </div>
</div>
</div>

<!-- Patient Modal -->
<div class="modal" id="patientModal">
<div class="modal-box" style="max-width:540px">
  <div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div>
  <div class="modal-body">
    <input type="hidden" id="ptId">
    <div class="form-group">
      <label class="form-label">Patient Name</label>
      <input type="text" id="ptName" class="form-input">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Ward</label>
        <select id="ptWard" class="form-select">
          <option value="Ward 14">Ward 14</option>
          <option value="Ward 22">Ward 22</option>
          <option value="Ward 27">Ward 27</option>
          <option value="ICU">ICU</option>
          <option value="ER/Unassigned">ER/Unassigned</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Room</label>
        <input type="text" id="ptRoom" class="form-input">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Diagnosis</label>
      <textarea id="ptDx" class="form-textarea"></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Doctor</label>
        <input type="text" id="ptDoctor" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select id="ptStatus" class="form-select">
          <option value="new">ğŸ†• New</option>
          <option value="active">âœ… Active</option>
          <option value="critical">ğŸš¨ Critical</option>
          <option value="chronic">ğŸ’œ Chronic</option>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
    <button class="btn btn-primary" onclick="savePatient()">Save</button>
  </div>
</div>
</div>

<!-- Import Modal -->
<div class="modal" id="importModal">
<div class="modal-box wide">
  <div class="modal-header">
    <div class="modal-title">ğŸ“¥ Import Patient List</div>
    <button class="btn btn-ghost btn-icon" onclick="closeModal('importModal')">âœ•</button>
  </div>
  <div class="modal-body">
    <div id="importUpload" class="upload-zone" onclick="document.getElementById('importFile').click()">
      <div style="font-size:3rem;margin-bottom:16px">ğŸ“·</div>
      <div style="font-weight:600;margin-bottom:8px">Upload Patient List Image</div>
      <div style="color:var(--text-muted);font-size:0.85rem">Screenshot of your patient list from EMR</div>
      <input type="file" id="importFile" accept="image/*" style="display:none">
    </div>
    <div id="importPreview" style="display:none;text-align:center">
      <img id="importImg" style="max-width:100%;max-height:300px;border-radius:var(--radius);margin-bottom:16px">
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn btn-secondary" onclick="resetImport()">ğŸ”„ Change</button>
        <button class="btn btn-primary" onclick="extractPatients()">ğŸ§  Extract with AI</button>
      </div>
    </div>
    <div id="importLoading" style="display:none;text-align:center;padding:40px">
      <div class="spinner"></div>
      <p style="margin-top:16px;color:var(--text-muted)">AI is analyzing the image...</p>
    </div>
    <div id="importError" style="display:none" class="critical-alert">
      <div class="critical-alert-icon">âš ï¸</div>
      <div class="critical-alert-content">
        <div class="critical-alert-title">Extraction Failed</div>
        <div class="critical-alert-values" id="importErrorMsg"></div>
      </div>
    </div>
    <div id="importResults" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div><span style="font-weight:700;color:var(--emerald)" id="importCount">0</span> patients found</div>
      </div>
      <div id="importList"></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
    <button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>âœ… Import All</button>
  </div>
</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEDWARD PRO - ENHANCED VERSION WITH CLAUDE AI & MULTI-ENDPOINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
'use strict';

const CONFIG = {
  VALID_WARDS: ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned'],
  STORAGE_KEY: 'medward_pro_v11',
  MAX_IMAGE_SIZE: 800
};

const REFERENCE = [
  { title: 'GCS Scale', content: 'Eyes: 1-4, Verbal: 1-5, Motor: 1-6. Total 3-15.' },
  { title: 'CURB-65', content: 'Confusion, Urea>7, RRâ‰¥30, BP<90/60, Ageâ‰¥65. 0-1: outpatient, 2: short stay, 3+: ICU.' },
  { title: 'Wells DVT', content: 'Active cancer +1, Paralysis +1, Bedridden +1, Tenderness +1, Leg swelling +1, Calf>3cm +1, Pitting edema +1, Collaterals +1, Previous DVT +1, Alt diagnosis -2.' },
  { title: 'CHAâ‚‚DSâ‚‚-VASc', content: 'CHF +1, HTN +1, Ageâ‰¥75 +2, DM +1, Stroke +2, Vascular +1, Age 65-74 +1, Female +1.' },
  { title: 'MELD Score', content: '3.78Ã—ln(Bili) + 11.2Ã—ln(INR) + 9.57Ã—ln(Cr) + 6.43' },
  { title: 'Child-Pugh', content: 'Encephalopathy, Ascites, Bili, Albumin, PT. A: 5-6, B: 7-9, C: 10-15.' },
  { title: 'HEART Score', content: 'History 0-2, ECG 0-2, Age 0-2, Risk factors 0-2, Troponin 0-2. 0-3: low risk.' },
  { title: 'qSOFA', content: 'RRâ‰¥22, AMS, SBPâ‰¤100. â‰¥2 = high mortality risk.' }
];

// State
const state = {
  units: [],
  patients: [],
  settings: { adminPassword: 'admin', apiEndpoints: [], claudeApiKey: '' },
  unitRequests: [],
  currentUnit: null,
  currentUser: null,
  currentPatient: null,
  currentFilter: 'all',
  selectedUnitId: null,
  selectedIcon: 'ğŸ¥',
  importImage: null,
  importPatients: [],
  editingUnitId: null,
  editingEndpointId: null,
  selectedRequestId: null
};

// Helpers
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = s => s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])) : '';
const initials = n => n ? n.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase() : '??';
const formatDate = d => (d ? new Date(d) : new Date()).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
const smartWard = w => { const wl = (w || '').toLowerCase(); for (const vw of CONFIG.VALID_WARDS) if (wl.includes(vw.toLowerCase().replace(/[^a-z0-9]/g, ''))) return vw; return 'ER/Unassigned'; };
const getUnit = id => state.units.find(u => u.id === id);
const getPrimaryEndpoint = () => state.settings.apiEndpoints?.find(e => e.isPrimary)?.url || state.settings.apiUrl;

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
function showPage(id) { $$('.page').forEach(p => p.classList.remove('active')); $(id).classList.add('active'); }

// Storage
function saveLocal() {
  localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
    units: state.units,
    patients: state.patients,
    settings: state.settings,
    unitRequests: state.unitRequests
  }));
}

function loadLocal() {
  try {
    const d = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY) || '{}');
    if (d.units) state.units = d.units;
    if (d.patients) state.patients = d.patients;
    if (d.settings) state.settings = { ...state.settings, ...d.settings };
    if (d.unitRequests) state.unitRequests = d.unitRequests;
    // Migrate old apiUrl to endpoints
    if (state.settings.apiUrl && !state.settings.apiEndpoints?.length) {
      state.settings.apiEndpoints = [{
        id: 'ep_' + Date.now(),
        name: 'Main API',
        url: state.settings.apiUrl,
        desc: 'Primary API endpoint',
        isPrimary: true,
        isActive: true
      }];
    }
  } catch (e) { console.error('Load error:', e); }
}

async function saveCloud() {
  saveLocal();
  const endpoint = getPrimaryEndpoint();
  if (!endpoint || endpoint === 'YOUR_API_URL_HERE') return;
  try {
    await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'save',
        units: state.units,
        patients: state.patients.filter(p => p.ward),
        unitRequests: state.unitRequests
      })
    });
  } catch (e) { console.error('Cloud save error:', e); }
}

async function syncCloud() {
  const endpoint = getPrimaryEndpoint();
  if (!endpoint || endpoint === 'YOUR_API_URL_HERE') return;
  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'load' })
    });
    const d = await res.json();
    if (d.units) state.units = d.units;
    if (d.patients) state.patients = d.patients;
    if (d.unitRequests) state.unitRequests = d.unitRequests;
    saveLocal();
    renderUnits();
    if (state.currentUnit) renderPatients();
  } catch (e) { console.error('Sync error:', e); }
}

// Render Functions
function renderUnits() {
  const grid = $('unitsGrid');
  if (!grid) return;
  grid.innerHTML = state.units.map(u => `
    <div class="unit-card" style="--unit-color:${u.color || '#f59e0b'}" onclick="selectUnit('${u.id}')">
      <div class="unit-card-status"></div>
      <div class="unit-card-content">
        <div class="unit-card-icon">${u.icon || 'ğŸ¥'}</div>
        <div class="unit-card-name">${esc(u.name)}</div>
        <div class="unit-card-desc">${esc(u.desc) || 'Clinical Unit'}</div>
      </div>
    </div>
  `).join('');
}

function renderUnitsTable() {
  const tb = $('unitsTable');
  if (!tb) return;
  tb.innerHTML = state.units.map(u => `
    <tr>
      <td><span style="font-size:1.25rem;margin-right:10px">${u.icon || 'ğŸ¥'}</span>${esc(u.name)}</td>
      <td class="mono">${u.code}</td>
      <td>
        <button class="btn btn-secondary btn-xs" onclick="editUnit('${u.id}')">Edit</button>
        <button class="btn btn-danger btn-xs" onclick="deleteUnit('${u.id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

function renderEndpoints() {
  const list = $('endpointsList');
  if (!list) return;
  const endpoints = state.settings.apiEndpoints || [];
  if (!endpoints.length) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:2rem;margin-bottom:12px">ğŸ”—</div><div>No endpoints configured</div></div>';
    return;
  }
  list.innerHTML = endpoints.map(ep => `
    <div class="endpoint-item">
      <div class="endpoint-header">
        <div class="endpoint-name">
          ${esc(ep.name)}
          ${ep.isPrimary ? '<span class="endpoint-badge primary">Primary</span>' : ''}
          <span class="endpoint-badge ${ep.isActive ? 'active' : 'inactive'}">${ep.isActive ? 'Active' : 'Inactive'}</span>
        </div>
      </div>
      <div class="endpoint-url">${esc(ep.url?.substring(0, 70))}...</div>
      ${ep.desc ? `<div style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">${esc(ep.desc)}</div>` : ''}
      <div class="endpoint-actions">
        ${!ep.isPrimary ? `<button class="btn btn-secondary btn-xs" onclick="setPrimaryEndpoint('${ep.id}')">Set Primary</button>` : ''}
        <button class="btn btn-secondary btn-xs" onclick="editEndpoint('${ep.id}')">Edit</button>
        <button class="btn btn-danger btn-xs" onclick="deleteEndpoint('${ep.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

function renderPatients() {
  const pts = state.patients.filter(p => {
    if (!state.currentUnit) return false;
    if (state.currentFilter !== 'all' && p.status !== state.currentFilter) return false;
    return true;
  });
  
  // Update stats
  const all = state.patients;
  $('statTotal').textContent = all.length;
  $('statNew').textContent = all.filter(p => p.status === 'new').length;
  $('statActive').textContent = all.filter(p => p.status === 'active').length;
  $('statCritical').textContent = all.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = all.filter(p => p.status === 'chronic').length;
  
  $$('.stat-card').forEach(c => c.classList.toggle('active', c.dataset.filter === state.currentFilter));
  
  // Group by ward
  const wards = {};
  pts.forEach(p => {
    const w = p.ward || 'Unassigned';
    if (!wards[w]) wards[w] = [];
    wards[w].push(p);
  });
  
  const list = $('patientsList');
  if (!pts.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div>No patients found</div></div>';
    return;
  }
  
  list.innerHTML = Object.entries(wards).map(([ward, patients]) => `
    <div class="ward-section">
      <div class="ward-header">
        <div class="ward-title">${esc(ward)}</div>
        <div class="ward-count">${patients.length}</div>
      </div>
      ${patients.map(p => `
        <div class="patient-card ${p.status}" onclick="openPatient(${p.id})">
          <div class="patient-header">
            <div class="patient-avatar">${initials(p.name)}</div>
            <div class="patient-info">
              <div class="patient-name">${esc(p.name)}</div>
              <div class="patient-meta">
                <span>ğŸ“ ${esc(p.room)}</span>
                <span>ğŸ‘¨â€âš•ï¸ ${esc(p.doctor)}</span>
              </div>
            </div>
          </div>
          <div class="patient-diagnosis">${esc(p.diagnosis)}</div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function renderRef() {
  $('refGrid').innerHTML = REFERENCE.map(r => `
    <div class="ref-card">
      <h4>${r.title}</h4>
      <p>${r.content}</p>
    </div>
  `).join('');
}

// Unit Selection
window.selectUnit = function(id) {
  state.selectedUnitId = id;
  const u = getUnit(id);
  if (!u) return;
  
  $('accessIcon').textContent = u.icon || 'ğŸ¥';
  $('accessTitle').textContent = u.name;
  $('codeError').classList.remove('show');
  $('userSection').style.display = 'none';
  $('enterBtn').style.display = 'none';
  
  const container = $('codeInputs');
  container.innerHTML = '<input type="tel" maxlength="1" class="code-digit" inputmode="numeric"><input type="tel" maxlength="1" class="code-digit" inputmode="numeric"><input type="tel" maxlength="1" class="code-digit" inputmode="numeric"><input type="tel" maxlength="1" class="code-digit" inputmode="numeric">';
  
  const inputs = container.querySelectorAll('.code-digit');
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D/g, '');
      if (inp.value && idx < 3) inputs[idx + 1].focus();
      const code = Array.from(inputs).map(i => i.value).join('');
      if (code.length === 4) {
        if (code === u.code) {
          inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
          $('userSection').style.display = 'block';
          $('enterBtn').style.display = 'flex';
          $('userName').focus();
        } else {
          $('codeError').classList.add('show');
          inputs.forEach(i => i.classList.add('error'));
          setTimeout(() => { inputs.forEach(i => { i.classList.remove('error'); i.value = ''; }); inputs[0].focus(); }, 500);
        }
      }
    });
    inp.addEventListener('keydown', e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); });
  });
  
  openModal('accessModal');
  setTimeout(() => inputs[0].focus(), 100);
};

window.enterUnit = function() {
  const n = $('userName').value.trim();
  if (!n) { toast('Enter name', true); return; }
  state.currentUnit = getUnit(state.selectedUnitId);
  state.currentUser = { name: n, role: $('userRole').value };
  closeModal('accessModal');
  showPage('dashboard');
  $('unitBadge').textContent = state.currentUnit.name;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('currentDate').textContent = formatDate();
  renderPatients();
  renderRef();
  toast(`Welcome, ${state.currentUser.name}!`);
};

window.logout = function() {
  state.currentUnit = null;
  state.currentUser = null;
  state.currentFilter = 'all';
  showPage('landing');
};

function showTab(tabName) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
  $$('.panel').forEach(p => p.classList.remove('active'));
  $('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

function showProfileTab(tabName) {
  $$('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-tab[data-ptab="${tabName}"]`)?.classList.add('active');
  $$('.profile-panel').forEach(p => p.classList.remove('active'));
  $('profile' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

// Admin functions
window.openAdminLogin = function() { 
  $('adminPwd').value = ''; 
  $('adminError').classList.remove('show'); 
  openModal('adminModal'); 
};

window.loginAdmin = function() { 
  if ($('adminPwd').value === state.settings.adminPassword) { 
    closeModal('adminModal'); 
    showPage('adminPanel'); 
    $('claudeApiKey').value = state.settings.claudeApiKey || '';
    renderUnitsTable(); 
    renderEndpoints();
    loadUnitRequests(); 
  } else {
    $('adminError').classList.add('show'); 
  }
};

window.exitAdmin = function() { showPage('landing'); };

window.addUnit = function() { 
  state.editingUnitId = null; 
  $('unitModalTitle').textContent = 'Add Unit'; 
  $('uName').value = ''; 
  $('uIcon').value = 'ğŸ¥'; 
  $('uCode').value = ''; 
  $('uDesc').value = ''; 
  openModal('unitModal'); 
};

window.editUnit = function(id) { 
  const u = getUnit(id); 
  if (!u) return; 
  state.editingUnitId = id; 
  $('unitModalTitle').textContent = 'Edit Unit'; 
  $('uName').value = u.name; 
  $('uIcon').value = u.icon; 
  $('uCode').value = u.code; 
  $('uDesc').value = u.desc || ''; 
  openModal('unitModal'); 
};

window.saveUnit = function() { 
  const name = $('uName').value.trim();
  const icon = $('uIcon').value.trim() || 'ğŸ¥';
  const code = $('uCode').value.trim();
  const desc = $('uDesc').value.trim(); 
  
  if (!name || !/^\d{4}$/.test(code)) { 
    toast('Invalid - need name and 4-digit code', true); 
    return; 
  }
  
  if (state.editingUnitId) { 
    const i = state.units.findIndex(u => u.id === state.editingUnitId); 
    if (i !== -1) state.units[i] = { ...state.units[i], name, icon, code, desc }; 
  } else { 
    state.units.push({ 
      id: 'u' + Date.now(), 
      name, 
      icon, 
      code, 
      desc, 
      color: ['#f59e0b', '#14b8a6', '#3b82f6', '#8b5cf6'][state.units.length % 4] 
    }); 
  } 
  saveCloud(); 
  renderUnitsTable(); 
  renderUnits(); 
  closeModal('unitModal'); 
  toast('Saved!'); 
};

window.deleteUnit = function(id) { 
  if (!confirm('Delete this unit?')) return; 
  state.units = state.units.filter(u => u.id !== id); 
  saveCloud(); 
  renderUnitsTable(); 
  renderUnits(); 
};

window.saveSettings = function() { 
  const p = $('newAdminPwd').value.trim();
  const apiKey = $('claudeApiKey').value.trim();
  
  if (p) state.settings.adminPassword = p; 
  if (apiKey) state.settings.claudeApiKey = apiKey;
  
  saveCloud(); 
  toast('Settings saved!'); 
  $('newAdminPwd').value = ''; 
};

// Endpoint Management
window.openAddEndpoint = function() {
  state.editingEndpointId = null;
  $('endpointModalTitle').textContent = 'Add API Endpoint';
  $('epName').value = '';
  $('epUrl').value = '';
  $('epDesc').value = '';
  openModal('endpointModal');
};

window.editEndpoint = function(id) {
  const ep = state.settings.apiEndpoints?.find(e => e.id === id);
  if (!ep) return;
  state.editingEndpointId = id;
  $('endpointModalTitle').textContent = 'Edit API Endpoint';
  $('epName').value = ep.name;
  $('epUrl').value = ep.url;
  $('epDesc').value = ep.desc || '';
  openModal('endpointModal');
};

window.saveEndpoint = function() {
  const name = $('epName').value.trim();
  const url = $('epUrl').value.trim();
  const desc = $('epDesc').value.trim();
  
  if (!name || !url) {
    toast('Name and URL are required', true);
    return;
  }
  
  if (!state.settings.apiEndpoints) state.settings.apiEndpoints = [];
  
  if (state.editingEndpointId) {
    const idx = state.settings.apiEndpoints.findIndex(e => e.id === state.editingEndpointId);
    if (idx !== -1) {
      state.settings.apiEndpoints[idx] = { ...state.settings.apiEndpoints[idx], name, url, desc };
    }
  } else {
    const isPrimary = state.settings.apiEndpoints.length === 0;
    state.settings.apiEndpoints.push({
      id: 'ep_' + Date.now(),
      name,
      url,
      desc,
      isPrimary,
      isActive: true
    });
  }
  
  saveLocal();
  renderEndpoints();
  closeModal('endpointModal');
  toast('Endpoint saved!');
};

window.deleteEndpoint = function(id) {
  if (!confirm('Delete this endpoint?')) return;
  state.settings.apiEndpoints = state.settings.apiEndpoints.filter(e => e.id !== id);
  // If deleted was primary, make first one primary
  if (state.settings.apiEndpoints.length && !state.settings.apiEndpoints.some(e => e.isPrimary)) {
    state.settings.apiEndpoints[0].isPrimary = true;
  }
  saveLocal();
  renderEndpoints();
  toast('Endpoint deleted');
};

window.setPrimaryEndpoint = function(id) {
  state.settings.apiEndpoints.forEach(e => e.isPrimary = (e.id === id));
  saveLocal();
  renderEndpoints();
  toast('Primary endpoint updated');
};

// Admin Tab Navigation
$('adminTabs')?.addEventListener('click', e => {
  const tab = e.target.closest('.admin-tab');
  if (!tab) return;
  $$('.admin-tab').forEach(t => t.classList.remove('active'));
  $$('.admin-tab-panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  const panelId = 'admin' + tab.dataset.atab.charAt(0).toUpperCase() + tab.dataset.atab.slice(1);
  $(panelId)?.classList.add('active');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIT REQUEST SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.openRequestUnit = function() {
  $('reqName').value = '';
  $('reqEmail').value = '';
  $('reqDepartment').value = '';
  $('reqRole').value = '';
  $('reqUnitName').value = '';
  $('reqMessage').value = '';
  state.selectedIcon = 'ğŸ¥';
  
  $$('.icon-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector('.icon-option[data-icon="ğŸ¥"]')?.classList.add('selected');
  
  $('requestFormSection').style.display = 'block';
  $('requestSuccessSection').style.display = 'none';
  $('requestFormFooter').style.display = 'flex';
  $('requestSuccessFooter').style.display = 'none';
  
  openModal('requestUnitModal');
};

$('iconGrid')?.addEventListener('click', e => {
  const opt = e.target.closest('.icon-option');
  if (!opt) return;
  $$('.icon-option').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  state.selectedIcon = opt.dataset.icon;
});

window.submitUnitRequest = async function() {
  const name = $('reqName').value.trim();
  const email = $('reqEmail').value.trim();
  const department = $('reqDepartment').value.trim();
  const role = $('reqRole').value;
  const unitName = $('reqUnitName').value.trim();
  const message = $('reqMessage').value.trim();
  const icon = state.selectedIcon;
  
  if (!name || !email || !department || !role || !unitName) {
    toast('Please fill all required fields', true);
    return;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    toast('Please enter a valid email', true);
    return;
  }
  
  const requestId = 'REQ-' + Date.now().toString(36).toUpperCase();
  const request = {
    id: requestId,
    timestamp: new Date().toISOString(),
    status: 'pending',
    requesterName: name,
    requesterEmail: email,
    department,
    role,
    unitName,
    icon,
    message
  };
  
  const endpoint = getPrimaryEndpoint();
  if (endpoint && endpoint !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'submitUnitRequest', request })
      });
    } catch (e) {
      console.error('Failed to save request to cloud:', e);
    }
  }
  
  if (!state.unitRequests) state.unitRequests = [];
  state.unitRequests.push(request);
  saveLocal();
  
  $('requestIdDisplay').textContent = 'Request ID: ' + requestId;
  $('requestFormSection').style.display = 'none';
  $('requestSuccessSection').style.display = 'block';
  $('requestFormFooter').style.display = 'none';
  $('requestSuccessFooter').style.display = 'flex';
  
  toast('Request submitted successfully!');
};

async function loadUnitRequests() {
  const endpoint = getPrimaryEndpoint();
  if (endpoint && endpoint !== 'YOUR_API_URL_HERE') {
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getUnitRequests' })
      });
      const d = await res.json();
      if (d.requests) state.unitRequests = d.requests;
    } catch (e) {
      console.error('Failed to load requests:', e);
    }
  }
  renderUnitRequests();
}

window.refreshRequests = loadUnitRequests;

function renderUnitRequests() {
  const list = $('requestsList');
  if (!list) return;
  
  const requests = state.unitRequests || [];
  const pending = requests.filter(r => r.status === 'pending');
  const processed = requests.filter(r => r.status !== 'pending');
  
  // Update badge
  const badge = $('requestsCount');
  if (pending.length > 0) {
    badge.textContent = pending.length;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
  
  if (!requests.length) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:2rem;margin-bottom:12px">ğŸ“­</div><div>No requests</div></div>';
    return;
  }
  
  let html = '';
  const roleLabels = { attending: 'Attending', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  
  pending.forEach(req => {
    html += `
      <div class="request-card">
        <div class="request-card-time">${formatDate(req.timestamp)}</div>
        <div class="request-card-header">
          <div class="request-card-title">${req.icon || 'ğŸ¥'} ${esc(req.unitName)}</div>
          <span class="request-card-status pending">Pending</span>
        </div>
        <div class="request-card-details">
          <div class="request-card-detail">ğŸ‘¤ ${esc(req.requesterName)}</div>
          <div class="request-card-detail">ğŸ“§ ${esc(req.requesterEmail)}</div>
          <div class="request-card-detail">ğŸ¢ ${esc(req.department)}</div>
          <div class="request-card-detail">ğŸ‘” ${roleLabels[req.role] || req.role}</div>
        </div>
        ${req.message ? `<div class="request-card-message">"${esc(req.message)}"</div>` : ''}
        <div class="request-card-actions">
          <button class="btn btn-primary btn-sm" onclick="openApproveRequest('${req.id}')">âœ… Review & Approve</button>
          <button class="btn btn-danger btn-sm" onclick="quickRejectRequest('${req.id}')">âŒ Reject</button>
        </div>
      </div>
    `;
  });
  
  if (processed.length > 0) {
    html += `<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">ğŸ“‹ Previous Requests (${processed.length})</h4>`;
    processed.slice(0, 10).forEach(req => {
      html += `
        <div class="request-card ${req.status}">
          <div class="request-card-time">${formatDate(req.timestamp)}</div>
          <div class="request-card-header">
            <div class="request-card-title">${req.icon || 'ğŸ¥'} ${esc(req.unitName)}</div>
            <span class="request-card-status ${req.status}">${req.status === 'approved' ? 'Approved' : 'Rejected'}</span>
          </div>
          <div class="request-card-details">
            <div class="request-card-detail">ğŸ‘¤ ${esc(req.requesterName)}</div>
            <div class="request-card-detail">ğŸ“§ ${esc(req.requesterEmail)}</div>
          </div>
          ${req.assignedCode ? `<div style="margin-top:8px;font-size:0.85rem;color:var(--emerald)">Access Code: <code style="background:var(--bg-card);padding:4px 8px;border-radius:4px">${req.assignedCode}</code></div>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }
  
  list.innerHTML = html;
}

window.openApproveRequest = function(requestId) {
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  state.selectedRequestId = requestId;
  
  $('approveUnitName').value = req.unitName;
  $('approveUnitIcon').value = req.icon || 'ğŸ¥';
  $('approveUnitCode').value = '';
  $('approveUnitDesc').value = req.department;
  
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  $('approveRequestDetails').innerHTML = `
    <div style="background:var(--bg);padding:20px;border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
        <div style="font-size:2.5rem">${req.icon || 'ğŸ¥'}</div>
        <div>
          <div style="font-weight:700;font-size:1.1rem">${esc(req.unitName)}</div>
          <div style="color:var(--text-muted);font-size:0.85rem">Requested ${new Date(req.timestamp).toLocaleDateString()}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem">
        <div><span style="color:var(--text-muted)">Requester:</span> ${esc(req.requesterName)}</div>
        <div><span style="color:var(--text-muted)">Email:</span> ${esc(req.requesterEmail)}</div>
        <div><span style="color:var(--text-muted)">Department:</span> ${esc(req.department)}</div>
        <div><span style="color:var(--text-muted)">Role:</span> ${roleLabels[req.role] || req.role}</div>
      </div>
      ${req.message ? `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:0.9rem"><span style="color:var(--text-muted)">Message:</span><br>"${esc(req.message)}"</div>` : ''}
    </div>
  `;
  
  openModal('approveRequestModal');
};

window.approveRequest = async function() {
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  const unitName = $('approveUnitName').value.trim();
  const icon = $('approveUnitIcon').value.trim() || 'ğŸ¥';
  const code = $('approveUnitCode').value.trim();
  const color = $('approveUnitColor').value;
  const desc = $('approveUnitDesc').value.trim();
  
  if (!unitName || !/^\d{4}$/.test(code)) {
    toast('Please enter a valid unit name and 4-digit code', true);
    return;
  }
  
  const newUnit = { id: 'u' + Date.now(), name: unitName, icon, code, desc, color };
  state.units.push(newUnit);
  
  req.status = 'approved';
  req.assignedCode = code;
  req.approvedAt = new Date().toISOString();
  
  await saveCloud();
  
  const endpoint = getPrimaryEndpoint();
  if (endpoint && endpoint !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitsTable();
  renderUnits();
  renderUnitRequests();
  closeModal('approveRequestModal');
  
  toast(`Unit "${unitName}" created with code ${code}!`);
};

window.rejectRequest = async function() {
  if (!confirm('Are you sure you want to reject this request?')) return;
  
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  const endpoint = getPrimaryEndpoint();
  if (endpoint && endpoint !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }
  
  saveLocal();
  renderUnitRequests();
  closeModal('approveRequestModal');
  toast('Request rejected');
};

window.quickRejectRequest = async function(requestId) {
  if (!confirm('Reject this request?')) return;
  
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  const endpoint = getPrimaryEndpoint();
  if (endpoint && endpoint !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }
  
  saveLocal();
  renderUnitRequests();
  toast('Request rejected');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATIENT CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.openAddPatient = function() { 
  $('patientModalTitle').textContent = 'Add Patient'; 
  $('ptId').value = ''; 
  $('ptName').value = ''; 
  $('ptWard').value = 'Ward 14'; 
  $('ptRoom').value = ''; 
  $('ptDx').value = ''; 
  $('ptDoctor').value = state.currentUser?.name || ''; 
  $('ptStatus').value = 'new'; 
  openModal('patientModal'); 
};

window.savePatient = function() { 
  const id = $('ptId').value;
  const name = $('ptName').value.trim(); 
  if (!name) { toast('Name required', true); return; } 
  
  const data = { 
    name, 
    ward: $('ptWard').value, 
    room: $('ptRoom').value.trim() || 'â€”', 
    diagnosis: $('ptDx').value.trim() || 'Pending', 
    doctor: $('ptDoctor').value.trim() || 'Unassigned', 
    status: $('ptStatus').value 
  }; 
  
  if (id) { 
    const i = state.patients.findIndex(p => p.id === parseInt(id)); 
    if (i !== -1) { 
      state.patients[i] = { ...state.patients[i], ...data }; 
      if (state.currentPatient?.id === parseInt(id)) { 
        state.currentPatient = state.patients[i]; 
        renderPatientProfile(); 
      } 
    } 
  } else { 
    state.patients.push({ 
      id: Date.now(), 
      ...data, 
      labData: { dates: [], parameters: [] }, 
      imaging: [], 
      fluids: [], 
      plans: [], 
      history: '', 
      vitals: {} 
    }); 
  } 
  saveCloud(); 
  renderPatients(); 
  closeModal('patientModal'); 
  toast('Saved!'); 
};

window.openPatient = function(id) {
  state.currentPatient = state.patients.find(p => p.id === id);
  if (!state.currentPatient) return;
  showPage('patientProfile');
  renderPatientProfile();
};

window.closePatientProfile = function() {
  showPage('dashboard');
  state.currentPatient = null;
};

window.editCurrentPatient = function() {
  if (!state.currentPatient) return;
  const p = state.currentPatient;
  $('patientModalTitle').textContent = 'Edit Patient';
  $('ptId').value = p.id;
  $('ptName').value = p.name;
  $('ptWard').value = p.ward;
  $('ptRoom').value = p.room;
  $('ptDx').value = p.diagnosis;
  $('ptDoctor').value = p.doctor;
  $('ptStatus').value = p.status;
  openModal('patientModal');
};

window.deleteCurrentPatient = function() {
  if (!state.currentPatient) return;
  if (!confirm('Delete this patient?')) return;
  state.patients = state.patients.filter(p => p.id !== state.currentPatient.id);
  saveCloud();
  closePatientProfile();
  renderPatients();
  toast('Patient deleted');
};

function renderPatientProfile() {
  const p = state.currentPatient;
  if (!p) return;
  
  const statusColors = { new: 'var(--emerald)', active: 'var(--gold)', critical: 'var(--rose)', chronic: 'var(--purple)' };
  const statusBg = { new: 'linear-gradient(135deg,var(--emerald),var(--teal))', active: 'linear-gradient(135deg,var(--gold),var(--orange))', critical: 'linear-gradient(135deg,var(--rose),var(--orange))', chronic: 'linear-gradient(135deg,var(--purple),#a855f7)' };
  
  $('profilePatientInfo').innerHTML = `
    <div class="profile-avatar" style="background:${statusBg[p.status]}">${initials(p.name)}</div>
    <div class="profile-details">
      <h2>${esc(p.name)}</h2>
      <div class="meta">
        <span>ğŸ“ ${esc(p.ward)} - ${esc(p.room)}</span>
        <span>ğŸ‘¨â€âš•ï¸ ${esc(p.doctor)}</span>
      </div>
    </div>
  `;
  
  $('profileOverview').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">ğŸ“‹ Diagnosis</div></div>
      <div class="section-body"><p style="font-size:0.95rem;line-height:1.7">${esc(p.diagnosis)}</p></div>
    </div>
    <div class="section-card">
      <div class="section-header"><div class="section-title">ğŸ’Š Vitals</div></div>
      <div class="section-body">
        <div class="vitals-grid">
          <div class="vital-card"><div class="vital-icon">â¤ï¸</div><div class="vital-value">${p.vitals?.hr || 'â€”'}</div><div class="vital-label">Heart Rate</div></div>
          <div class="vital-card"><div class="vital-icon">ğŸ©¸</div><div class="vital-value">${p.vitals?.bp || 'â€”'}</div><div class="vital-label">Blood Pressure</div></div>
          <div class="vital-card"><div class="vital-icon">ğŸŒ¡ï¸</div><div class="vital-value">${p.vitals?.temp || 'â€”'}</div><div class="vital-label">Temperature</div></div>
          <div class="vital-card"><div class="vital-icon">ğŸ’¨</div><div class="vital-value">${p.vitals?.rr || 'â€”'}</div><div class="vital-label">Resp Rate</div></div>
          <div class="vital-card"><div class="vital-icon">ğŸ«</div><div class="vital-value">${p.vitals?.spo2 || 'â€”'}</div><div class="vital-label">SpO2</div></div>
        </div>
      </div>
    </div>
  `;
  
  // Labs panel
  $('profileLabs').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">ğŸ§ª Laboratory Results</div></div>
      <div class="section-body">
        <div class="lab-upload-area" onclick="document.getElementById('labFileInput').click()">
          <div class="lab-upload-icon">ğŸ“·</div>
          <div class="lab-upload-title">Upload Lab Results</div>
          <div class="lab-upload-subtitle">Take a photo or upload an image</div>
        </div>
        <input type="file" id="labFileInput" accept="image/*" style="display:none">
        ${renderLabResults(p)}
      </div>
    </div>
  `;
  
  // Imaging panel
  $('profileImaging').innerHTML = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">ğŸ“¸ Imaging</div>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('imagingFileInput').click()">+ Add</button>
      </div>
      <div class="section-body">
        <input type="file" id="imagingFileInput" accept="image/*" style="display:none">
        ${(p.imaging || []).length ? p.imaging.map(img => `
          <div class="imaging-card">
            <div class="imaging-card-header">
              <div class="imaging-type">ğŸ“· ${esc(img.type || 'Image')}</div>
              <div class="imaging-date">${new Date(img.date).toLocaleDateString()}</div>
            </div>
            <div class="imaging-summary">${esc(img.summary || 'No summary')}</div>
          </div>
        `).join('') : '<div class="empty-state"><div class="empty-state-icon">ğŸ“¸</div><div>No imaging</div></div>'}
      </div>
    </div>
  `;
  
  // Fluids panel
  const totalIntake = (p.fluids || []).filter(f => f.type === 'intake').reduce((s, f) => s + (f.amount || 0), 0);
  const totalOutput = (p.fluids || []).filter(f => f.type === 'output').reduce((s, f) => s + (f.amount || 0), 0);
  const balance = totalIntake - totalOutput;
  
  $('profileFluids').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">ğŸ’§ Fluid Balance</div></div>
      <div class="section-body">
        <div class="fluid-summary">
          <div class="fluid-stat"><div class="fluid-stat-value intake">${totalIntake}</div><div class="fluid-stat-label">Intake (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value output">${totalOutput}</div><div class="fluid-stat-label">Output (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value balance" style="color:${balance >= 0 ? 'var(--emerald)' : 'var(--rose)'}">${balance >= 0 ? '+' : ''}${balance}</div><div class="fluid-stat-label">Balance (mL)</div></div>
        </div>
      </div>
    </div>
  `;
  
  // Plans panel
  $('profilePlans').innerHTML = `
    <div class="section-card">
      <div class="section-header">
        <div class="section-title">ğŸ“ Plans</div>
        <button class="btn btn-primary btn-sm" onclick="addPlan()">+ Add Plan</button>
      </div>
      <div class="section-body">
        ${(p.plans || []).length ? p.plans.map(plan => `
          <div class="plan-item">
            <div class="plan-item-header">
              <span class="badge badge-gold">${plan.type || 'Plan'}</span>
              <span class="plan-item-date">${new Date(plan.date).toLocaleDateString()}</span>
            </div>
            <div class="plan-item-content">${esc(plan.content)}</div>
          </div>
        `).join('') : '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>No plans</div></div>'}
      </div>
    </div>
  `;
}

function renderLabResults(p) {
  if (!p.labData?.parameters?.length) return '';
  // Simplified lab rendering
  return `<div class="ai-interpretation">
    <div class="ai-interpretation-header">
      <div class="ai-interpretation-title">ğŸ§  AI Analysis <span class="ai-badge">Powered by Claude</span></div>
    </div>
    <div class="ai-interpretation-text">Lab results have been analyzed.</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT WITH CLAUDE AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function compress(file, maxSize, callback) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxSize || h > maxSize) {
        if (w > h) { h *= maxSize / w; w = maxSize; }
        else { w *= maxSize / h; h = maxSize; }
      }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      callback(canvas.toDataURL('image/jpeg', 0.8));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

window.openImport = function() { 
  state.importImage = null; 
  state.importPatients = []; 
  $('importUpload').style.display = 'block'; 
  $('importPreview').style.display = 'none'; 
  $('importLoading').style.display = 'none'; 
  $('importResults').style.display = 'none'; 
  $('importError').style.display = 'none'; 
  $('importConfirmBtn').disabled = true; 
  openModal('importModal'); 
};

window.resetImport = function() { 
  state.importImage = null; 
  state.importPatients = []; 
  $('importUpload').style.display = 'block'; 
  $('importPreview').style.display = 'none'; 
  $('importLoading').style.display = 'none'; 
  $('importResults').style.display = 'none'; 
  $('importError').style.display = 'none'; 
  $('importConfirmBtn').disabled = true; 
};

window.extractPatients = async function() {
  if (!state.importImage) { toast('No image selected', true); return; }
  
  // Check for Claude API key first, then fall back to GAS endpoint
  const claudeApiKey = state.settings.claudeApiKey;
  const endpoint = getPrimaryEndpoint();
  
  if (!claudeApiKey && (!endpoint || endpoint === 'YOUR_API_URL_HERE')) { 
    toast('Configure Claude API key or API endpoint in Admin settings', true); 
    return; 
  }
  
  $('importPreview').style.display = 'none';
  $('importLoading').style.display = 'block';
  $('importError').style.display = 'none';
  
  console.log('ğŸ”„ Extracting patients from image with Claude AI...');
  
  try {
    let patients = [];
    
    if (claudeApiKey) {
      // Use Claude API directly
      patients = await extractWithClaudeAPI(state.importImage, claudeApiKey);
    } else {
      // Use Google Apps Script endpoint
      patients = await extractWithGAS(state.importImage, endpoint);
    }
    
    $('importLoading').style.display = 'none';
    
    if (!patients?.length) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = 'No patients found in image. Try a clearer screenshot.';
      return;
    }
    
    state.importPatients = patients.map((p, i) => ({
      id: Date.now() + i, 
      name: p.name, 
      ward: smartWard(p.ward), 
      room: p.room || 'â€”',
      diagnosis: p.diagnosis || 'Pending', 
      doctor: p.doctor || state.currentUser?.name || 'Unassigned',
      status: p.status === 'chronic' ? 'chronic' : 'active',
      labData: { dates: [], parameters: [] }, 
      imaging: [], 
      fluids: [], 
      plans: [], 
      history: '', 
      vitals: {}
    }));
    
    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.map(p => `
      <div class="import-item">
        <div style="flex:1">
          <b>${esc(p.name)}</b>
          <div style="font-size:0.75rem;color:var(--text-muted)">${esc(p.room)} - ${esc(p.diagnosis)}</div>
        </div>
        <select class="import-ward-select" onchange="state.importPatients.find(x=>x.id===${p.id}).ward=this.value">
          ${CONFIG.VALID_WARDS.map(w => `<option value="${w}" ${w === p.ward ? 'selected' : ''}>${w}</option>`).join('')}
        </select>
      </div>
    `).join('');
    $('importConfirmBtn').disabled = false;
    
    console.log('âœ… Found', state.importPatients.length, 'patients');
    toast('Found ' + state.importPatients.length + ' patients!');
    
  } catch (e) {
    console.error('âŒ Extract error:', e);
    $('importLoading').style.display = 'none';
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = e.message || 'Extraction failed';
  }
};

async function extractWithClaudeAPI(imageBase64, apiKey) {
  const base64Data = imageBase64.replace(/^data:image\/\w+;base64,/, '');
  
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4096,
      messages: [{
        role: 'user',
        content: [
          {
            type: 'image',
            source: {
              type: 'base64',
              media_type: 'image/jpeg',
              data: base64Data
            }
          },
          {
            type: 'text',
            text: `Analyze this patient list image and extract all patient information. Return ONLY a JSON array with no additional text or markdown. Each patient object should have these fields:
- name: Full patient name
- room: Room/bed number  
- ward: Ward name if visible
- diagnosis: Primary diagnosis or chief complaint if visible
- doctor: Attending physician if visible
- status: "active", "critical", or "chronic" based on any indicators

Example format:
[{"name":"John Smith","room":"101-A","ward":"Ward 14","diagnosis":"Pneumonia","doctor":"Dr. Jones","status":"active"}]

Extract every patient visible. If a field is not visible, omit it or use reasonable defaults.`
          }
        ]
      }]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || 'Claude API error');
  }
  
  const data = await response.json();
  const text = data.content[0].text;
  
  // Parse JSON from response
  const jsonMatch = text.match(/\[[\s\S]*\]/);
  if (!jsonMatch) throw new Error('Could not parse patient data');
  
  return JSON.parse(jsonMatch[0]);
}

async function extractWithGAS(imageBase64, endpoint) {
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ action: 'extractPatients', image: imageBase64 })
  });
  
  if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
  
  const d = await res.json();
  if (!d.success) throw new Error(d.error || 'API returned an error');
  
  return d.patients;
}

window.confirmImport = function() { 
  if (!state.importPatients.length) return; 
  let added = 0; 
  state.importPatients.forEach(p => { 
    if (!state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase())) { 
      state.patients.push(p); 
      added++; 
    } 
  }); 
  saveCloud(); 
  renderPatients(); 
  closeModal('importModal'); 
  toast(`Imported ${added} patients!`); 
};

window.exportPDF = function() { 
  const { jsPDF } = window.jspdf; 
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); 
  const pts = state.currentFilter === 'all' ? [...state.patients] : state.patients.filter(p => p.status === state.currentFilter); 
  if (!pts.length) { toast('No patients', true); return; } 
  doc.setFillColor(245, 158, 11); 
  doc.rect(0, 0, 297, 18, 'F'); 
  doc.setFontSize(16); 
  doc.setTextColor(0); 
  doc.text(state.currentUnit.name + ' - Patient Report', 14, 12); 
  doc.text(formatDate(), 283, 12, 'right'); 
  let y = 28; 
  const wards = {}; 
  pts.forEach(p => { 
    const w = p.ward || 'Unassigned'; 
    if (!wards[w]) wards[w] = []; 
    wards[w].push(p); 
  }); 
  Object.keys(wards).forEach(ward => { 
    if (y > 185) { doc.addPage(); y = 15; } 
    doc.setFillColor(20, 184, 166); 
    doc.rect(14, y, 269, 7, 'F'); 
    doc.setFontSize(9); 
    doc.setTextColor(255); 
    doc.text(ward + ' (' + wards[ward].length + ')', 16, y + 5); 
    y += 10; 
    wards[ward].forEach(p => { 
      if (y > 190) { doc.addPage(); y = 15; } 
      doc.setFillColor(248, 250, 252); 
      doc.rect(14, y, 269, 10, 'F'); 
      doc.setFontSize(8); 
      doc.setTextColor(30); 
      doc.text(p.room || 'â€”', 16, y + 6); 
      doc.text(p.name, 40, y + 6); 
      doc.text((p.diagnosis || '').substring(0, 60), 100, y + 6); 
      doc.text(p.doctor || '', 220, y + 6); 
      y += 12; 
    }); 
    y += 5; 
  }); 
  doc.save(state.currentUnit.name.replace(/\s+/g, '_') + '_Report.pdf'); 
  toast('PDF exported!'); 
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  loadLocal();
  renderUnits();
  
  $('syncFab').onclick = async () => { 
    $('syncFab').classList.add('syncing'); 
    await syncCloud(); 
    $('syncFab').classList.remove('syncing'); 
    toast('Synced!'); 
  };
  $('adminPwd').onkeydown = e => { if (e.key === 'Enter') loginAdmin(); };
  $('userName').onkeydown = e => { if (e.key === 'Enter') enterUnit(); };
  $('mainTabs').onclick = e => { const t = e.target.closest('.tab'); if (t) showTab(t.dataset.tab); };
  $('profileTabs').onclick = e => { const t = e.target.closest('.profile-tab'); if (t) showProfileTab(t.dataset.ptab); };
  $('statsBar').onclick = e => { const s = e.target.closest('.stat-card'); if (s) { state.currentFilter = s.dataset.filter; renderPatients(); } };
  
  $('importFile').onchange = function() { 
    if (this.files[0]) { 
      compress(this.files[0], CONFIG.MAX_IMAGE_SIZE, url => { 
        state.importImage = url; 
        $('importImg').src = url; 
        $('importUpload').style.display = 'none'; 
        $('importPreview').style.display = 'block'; 
      }); 
    } 
  };
  
  $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });
  
  await syncCloud();
  setInterval(() => syncCloud(), 30000);
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();

})();
</script>
</body>
</html>