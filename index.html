<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>MedWard Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- LANDING -->
<div id="landing">
  <div class="landing-logo">
    <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
  </div>
  <h1 class="landing-title">MedWard Enterprise</h1>
  <p class="landing-subtitle">Select your unit to continue</p>
  <div class="units-grid" id="unitsGrid"></div>
  <div class="admin-fab" onclick="MedWard.App.openAdminLogin()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </div>
</div>

<!-- ACCESS MODAL -->
<div class="modal" id="accessModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div id="accessIcon" style="font-size:2.5rem;margin-bottom:8px">üè•</div>
      <div class="modal-title" id="accessTitle">Unit</div>
      <div style="color:var(--text-muted);font-size:0.8rem;margin-top:4px">Enter 4-digit code</div>
    </div>
    <div class="modal-body">
      <div class="code-inputs" id="codeInputs"></div>
      <p class="code-error" id="codeError">Invalid code</p>
      <div id="userSection" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input type="text" id="userName" class="form-input" placeholder="Dr. Name">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select id="userRole" class="form-select">
            <option value="attending">Attending</option>
            <option value="resident">Resident</option>
            <option value="intern">Intern</option>
            <option value="nurse">Nurse</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="MedWard.Utils.closeModal('accessModal')">Cancel</button>
      <button class="btn btn-primary" id="enterBtn" style="display:none" onclick="MedWard.App.enterUnit()">Enter Unit</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal" id="adminModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div style="font-size:2.5rem;margin-bottom:8px">‚öôÔ∏è</div>
      <div class="modal-title">Admin Access</div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="adminPwd" class="form-input" placeholder="Password">
      </div>
      <p class="code-error" id="adminError">Invalid password</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="MedWard.Utils.closeModal('adminModal')">Cancel</button>
      <button class="btn btn-primary" onclick="MedWard.App.loginAdmin()">Login</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <header class="admin-header">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="dash-logo-icon">
        <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg>
      </div>
      <span style="font-weight:600">MedWard</span>
      <span style="background:var(--purple);padding:2px 8px;border-radius:100px;font-size:0.65rem;font-weight:600;margin-left:8px">ADMIN</span>
    </div>
    <button class="btn btn-secondary btn-sm" onclick="MedWard.App.exitAdmin()">Exit</button>
  </header>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">üè• Units</div>
        <button class="btn btn-primary btn-sm" onclick="MedWard.App.addUnit()">+ Add</button>
      </div>
      <div class="admin-section-body" style="padding:0">
        <table class="units-table">
          <thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead>
          <tbody id="unitsTable"></tbody>
        </table>
      </div>
    </div>
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">‚öôÔ∏è Settings</div>
      </div>
      <div class="admin-section-body">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="newAdminPwd" class="form-input" placeholder="Leave blank to keep current">
        </div>
        <div class="form-group">
          <label class="form-label">Claude API URL (Apps Script)</label>
          <input type="text" id="apiUrl" class="form-input" placeholder="https://script.google.com/...">
        </div>
        <button class="btn btn-primary" onclick="MedWard.App.saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon">
        <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg>
      </div>
      <span class="dash-badge" id="unitBadge">Unit</span>
    </div>
    <div class="dash-user">
      <div class="dash-avatar" id="dashAvatar">DR</div>
      <button class="btn-icon" onclick="MedWard.App.logout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </button>
    </div>
  </header>
  
  <div class="dash-content">
    <div class="tabs">
      <button class="tab active" onclick="MedWard.App.showTab('patients',this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
        </svg>
        <span>Patients</span>
      </button>
      <button class="tab" onclick="MedWard.App.showTab('analysis',this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
          <path d="M14 3v5h5M16 13H8M16 17H8M10 9H8"/>
        </svg>
        <span>AI Analysis</span>
      </button>
      <button class="tab" onclick="MedWard.App.showTab('reference',this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        </svg>
        <span>Reference</span>
      </button>
    </div>
    
    <!-- PATIENTS PANEL -->
    <div class="panel active" id="panelPatients">
      <div class="stats">
        <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
        <div class="stat"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
        <div class="stat"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
        <div class="stat"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div style="font-weight:600;font-size:1rem">Patients</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="MedWard.Import.open()" style="border-color:var(--gold);color:var(--gold)">üì• Import</button>
          <button class="btn btn-primary btn-sm" onclick="MedWard.Patients.openAdd()">+ Add</button>
        </div>
      </div>
      <div class="patients-list" id="patientsList"></div>
    </div>
    
    <!-- ANALYSIS PANEL -->
    <div class="panel" id="panelAnalysis">
      <div class="card">
        <div class="card-header">üî¨ AI Medical Analysis</div>
        <div class="card-body">
          <div class="upload-zone" onclick="document.getElementById('analysisFile').click()">
            <div class="upload-zone-icon">üì§</div>
            <div style="font-weight:600">Upload Medical Images</div>
            <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Labs, X-Rays, CT/MRI, ECG ‚Ä¢ Select multiple</div>
          </div>
          <input type="file" id="analysisFile" accept="image/*" multiple style="display:none">
          <div class="analysis-types">
            <div class="analysis-type active" onclick="MedWard.Analysis.setType('lab',this)">
              <div class="analysis-type-icon">üß™</div>
              <div class="analysis-type-name">Labs</div>
            </div>
            <div class="analysis-type" onclick="MedWard.Analysis.setType('xray',this)">
              <div class="analysis-type-icon">ü©ª</div>
              <div class="analysis-type-name">X-Ray</div>
            </div>
            <div class="analysis-type" onclick="MedWard.Analysis.setType('ct',this)">
              <div class="analysis-type-icon">üß†</div>
              <div class="analysis-type-name">CT/MRI</div>
            </div>
            <div class="analysis-type" onclick="MedWard.Analysis.setType('ecg',this)">
              <div class="analysis-type-icon">üíì</div>
              <div class="analysis-type-name">ECG</div>
            </div>
          </div>
          <div id="analysisPreview" style="display:none;margin-top:16px"></div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="analyzeBtn" onclick="MedWard.Analysis.run()" disabled>ü§ñ Analyze with Claude AI</button>
      <div id="analysisLoading" style="display:none;text-align:center;padding:30px">
        <div class="spinner"></div>
        <div style="margin-top:12px;font-weight:600">Analyzing...</div>
      </div>
      <div id="analysisResults" style="margin-top:16px"></div>
    </div>
    
    <!-- REFERENCE PANEL -->
    <div class="panel" id="panelReference">
      <div class="card">
        <div class="card-header">üìö Quick Reference</div>
        <div class="card-body">
          <div class="ref-grid" id="refGrid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PATIENT MODAL -->
<div class="modal" id="patientModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="patientModalTitle">Add Patient</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ptId">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="ptName" class="form-input" placeholder="Full name">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Room</label>
          <input type="text" id="ptRoom" class="form-input" placeholder="21-A">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select id="ptStatus" class="form-select">
            <option value="active">Active</option>
            <option value="critical">Critical</option>
            <option value="chronic">Chronic</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Diagnosis</label>
        <textarea id="ptDx" class="form-textarea" placeholder="Primary diagnosis"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="MedWard.Utils.closeModal('patientModal')">Cancel</button>
      <button class="btn btn-primary" onclick="MedWard.Patients.save()">Save</button>
    </div>
  </div>
</div>

<!-- UNIT MODAL -->
<div class="modal" id="unitModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="unitModalTitle">Add Unit</div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="uName" class="form-input" placeholder="Neurology">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Icon</label>
          <input type="text" id="uIcon" class="form-input" value="üè•" style="font-size:1.3rem;text-align:center">
        </div>
        <div class="form-group">
          <label class="form-label">Code (4 digits)</label>
          <input type="text" id="uCode" class="form-input" placeholder="1234" maxlength="4">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" id="uDesc" class="form-input" placeholder="Brief description">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="MedWard.Utils.closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" onclick="MedWard.App.saveUnit()">Save</button>
    </div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modal" id="importModal">
  <div class="modal-box" style="max-width:500px">
    <div class="modal-header">
      <div class="modal-title">üì• Import Patients</div>
      <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">AI extracts patient data from screenshots</div>
    </div>
    <div class="modal-body">
      <div id="importUpload">
        <div class="import-dropzone" onclick="document.getElementById('importFile').click()">
          <div style="font-size:2rem;margin-bottom:8px">üì§</div>
          <div style="font-weight:600">Upload Screenshot</div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Excel, Sheets, or EMR screenshot</div>
        </div>
        <input type="file" id="importFile" accept="image/*" style="display:none">
      </div>
      <div id="importPreview" style="display:none">
        <img id="importImg" src="" style="width:100%;max-height:150px;object-fit:contain;border-radius:8px">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-secondary btn-sm" onclick="MedWard.Import.reset()" style="flex:1">Change</button>
          <button class="btn btn-primary btn-sm" onclick="MedWard.Import.analyze()" style="flex:2">ü§ñ Extract Patients</button>
        </div>
      </div>
      <div id="importLoading" style="display:none;text-align:center;padding:30px">
        <div class="spinner"></div>
        <div style="margin-top:12px">Extracting patients...</div>
      </div>
      <div id="importResults" style="display:none">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="font-weight:600">‚úì Found Patients</span>
          <span id="importCount" style="background:var(--emerald);color:white;padding:2px 10px;border-radius:100px;font-size:0.75rem">0</span>
        </div>
        <div id="importList" style="max-height:250px;overflow-y:auto"></div>
      </div>
      <div id="importError" style="display:none;text-align:center;padding:20px;color:var(--rose)">
        <div style="font-size:1.5rem;margin-bottom:8px">‚ö†Ô∏è</div>
        <div id="importErrorMsg">Error</div>
        <button class="btn btn-secondary btn-sm" onclick="MedWard.Import.reset()" style="margin-top:12px">Try Again</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="MedWard.Utils.closeModal('importModal')">Cancel</button>
      <button class="btn btn-primary" id="importBtn" onclick="MedWard.Import.confirm()" disabled>Import</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- JavaScript Modules -->
<script src="js/config.js"></script>
<script>
/**
 * MedWard Enterprise - Utilities (Inline)
 */
var MedWard = MedWard || {};

MedWard.Utils = {
  $(id) { return document.getElementById(id); },
  $$(sel) { return document.querySelectorAll(sel); },
  
  toast(msg, isError) {
    const t = this.$('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => { t.className = 'toast'; }, 3000);
  },
  
  initials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    return parts.length >= 2 
      ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
      : name.substring(0, 2).toUpperCase();
  },
  
  escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  },
  
  openModal(id) { this.$(id).classList.add('active'); },
  closeModal(id) { this.$(id).classList.remove('active'); },
  
  compressImage(file, maxSize, callback) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let width = img.width;
        let height = img.height;
        let quality = MedWard.CONFIG.IMAGE_QUALITY;
        const maxDim = MedWard.CONFIG.MAX_IMAGE_DIMENSION;
        
        if (width > maxDim || height > maxDim) {
          if (width > height) {
            height = Math.round(height * maxDim / width);
            width = maxDim;
          } else {
            width = Math.round(width * maxDim / height);
            height = maxDim;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        
        while (dataUrl.length > maxSize && quality > 0.3) {
          quality -= 0.1;
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        while (dataUrl.length > maxSize && width > 800) {
          width = Math.round(width * 0.8);
          height = Math.round(height * 0.8);
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        
        callback(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
};
</script>
<script>
/**
 * MedWard Enterprise - Storage Module (Inline)
 */
MedWard.Storage = {
  state: {
    units: [],
    settings: {},
    patients: [],
    currentUnit: null,
    currentUser: null,
    selectedUnitId: null,
    editingUnitId: null
  },
  
  load() {
    this.state.units = MedWard.DEFAULT_UNITS.slice();
    this.state.settings = {
      adminPassword: MedWard.CONFIG.ADMIN_PASSWORD,
      apiUrl: MedWard.CONFIG.API_URL
    };
    this.state.patients = [];
    
    try {
      const saved = localStorage.getItem(MedWard.CONFIG.STORAGE_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        if (data.units && Array.isArray(data.units) && data.units.length > 0) {
          const validUnits = data.units.filter(u => u && u.id && u.name && u.code);
          if (validUnits.length > 0) {
            this.state.units = validUnits;
          }
        }
        if (data.settings) {
          this.state.settings.adminPassword = data.settings.adminPassword || MedWard.CONFIG.ADMIN_PASSWORD;
          this.state.settings.apiUrl = data.settings.apiUrl || MedWard.CONFIG.API_URL;
        }
        if (data.patients && Array.isArray(data.patients)) {
          this.state.patients = data.patients;
        }
      }
    } catch (e) {
      console.warn('Storage load failed:', e);
      try { localStorage.removeItem(MedWard.CONFIG.STORAGE_KEY); } catch (ce) {}
    }
    
    if (!this.state.units || this.state.units.length === 0) {
      this.state.units = MedWard.DEFAULT_UNITS.slice();
    }
  },
  
  save() {
    try {
      localStorage.setItem(MedWard.CONFIG.STORAGE_KEY, JSON.stringify({
        units: this.state.units,
        settings: this.state.settings,
        patients: this.state.patients
      }));
    } catch (e) { console.warn('Storage save failed:', e); }
  },
  
  getUnit(id) { return this.state.units.find(u => u.id === id); },
  
  addPatient(patient) {
    patient.id = Date.now();
    this.state.patients.push(patient);
    this.save();
    return patient;
  },
  
  updatePatient(id, updates) {
    const idx = this.state.patients.findIndex(p => p.id === id);
    if (idx !== -1) {
      this.state.patients[idx] = { ...this.state.patients[idx], ...updates };
      this.save();
      return this.state.patients[idx];
    }
    return null;
  },
  
  deletePatient(id) {
    const idx = this.state.patients.findIndex(p => p.id === id);
    if (idx !== -1) {
      this.state.patients.splice(idx, 1);
      this.save();
      return true;
    }
    return false;
  },
  
  addUnit(unit) {
    unit.id = 'u' + Date.now();
    const colors = ['#d4a437', '#14b8a6', '#3b82f6', '#a855f7', '#ef4444', '#f97316'];
    unit.color = unit.color || colors[this.state.units.length % colors.length];
    this.state.units.push(unit);
    this.save();
    return unit;
  },
  
  updateUnit(id, updates) {
    const idx = this.state.units.findIndex(u => u.id === id);
    if (idx !== -1) {
      this.state.units[idx] = { ...this.state.units[idx], ...updates };
      this.save();
      return this.state.units[idx];
    }
    return null;
  },
  
  deleteUnit(id) {
    this.state.units = this.state.units.filter(u => u.id !== id);
    this.save();
  }
};
</script>
<script>
/**
 * MedWard Enterprise - Patients Module (Inline)
 */
MedWard.Patients = {
  render() {
    const { $, escapeHtml, initials } = MedWard.Utils;
    const patients = MedWard.Storage.state.patients;
    const container = $('patientsList');
    
    if (!patients.length) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No patients yet. Click "+ Add" or "üì• Import".</div>';
    } else {
      let html = '';
      patients.forEach((p, idx) => {
        html += '<div class="patient ' + p.status + '" data-id="' + p.id + '">' +
          '<div class="patient-top">' +
          '<div class="patient-avatar">' + initials(p.name) + '</div>' +
          '<div class="patient-info">' +
          '<div class="patient-name">' + escapeHtml(p.name) + '</div>' +
          '<div class="patient-meta">Room ' + escapeHtml(p.room) + ' ‚Ä¢ ' + escapeHtml(p.doctor || 'Unassigned') + '</div>' +
          '</div>' +
          '<span class="patient-status ' + p.status + '">' + p.status + '</span>' +
          '</div>' +
          '<div class="patient-dx">' + escapeHtml(p.diagnosis) + '</div>' +
          '<div class="patient-actions">' +
          '<button class="btn btn-secondary btn-sm" onclick="MedWard.Patients.edit(' + p.id + ')">‚úèÔ∏è Edit</button>' +
          '<button class="btn btn-danger btn-sm" onclick="MedWard.Patients.delete(' + p.id + ')">üóëÔ∏è Delete</button>' +
          '</div></div>';
      });
      container.innerHTML = html;
    }
    this.updateStats();
  },
  
  updateStats() {
    const { $ } = MedWard.Utils;
    const patients = MedWard.Storage.state.patients;
    $('statTotal').textContent = patients.length;
    $('statActive').textContent = patients.filter(p => p.status === 'active').length;
    $('statCritical').textContent = patients.filter(p => p.status === 'critical').length;
    $('statChronic').textContent = patients.filter(p => p.status === 'chronic').length;
  },
  
  openAdd() {
    const { $, openModal } = MedWard.Utils;
    $('patientModalTitle').textContent = 'Add Patient';
    $('ptId').value = '';
    $('ptName').value = '';
    $('ptRoom').value = '';
    $('ptDx').value = '';
    $('ptStatus').value = 'active';
    openModal('patientModal');
  },
  
  edit(id) {
    const { $, openModal } = MedWard.Utils;
    const patient = MedWard.Storage.state.patients.find(p => p.id === id);
    if (!patient) return;
    $('patientModalTitle').textContent = 'Edit Patient';
    $('ptId').value = patient.id;
    $('ptName').value = patient.name;
    $('ptRoom').value = patient.room;
    $('ptDx').value = patient.diagnosis;
    $('ptStatus').value = patient.status;
    openModal('patientModal');
  },
  
  save() {
    const { $, closeModal, toast } = MedWard.Utils;
    const id = $('ptId').value;
    const name = $('ptName').value.trim();
    const room = $('ptRoom').value.trim() || '‚Äî';
    const diagnosis = $('ptDx').value.trim() || 'Pending evaluation';
    const status = $('ptStatus').value;
    
    if (!name) { toast('Name is required', true); return; }
    
    const user = MedWard.Storage.state.currentUser;
    
    if (id) {
      MedWard.Storage.updatePatient(parseInt(id), { name, room, diagnosis, status });
      toast('Patient updated!');
    } else {
      MedWard.Storage.addPatient({ name, room, diagnosis, status, doctor: user ? user.name : 'Unassigned' });
      toast('Patient added!');
    }
    
    this.render();
    closeModal('patientModal');
  },
  
  delete(id) {
    const { toast } = MedWard.Utils;
    if (!confirm('Delete this patient?')) return;
    if (MedWard.Storage.deletePatient(id)) {
      toast('Patient deleted');
      this.render();
    }
  }
};
</script>
<script>
/**
 * MedWard Enterprise - Analysis Module (Inline)
 */
MedWard.Analysis = {
  images: [],
  type: 'lab',
  
  setType(type, el) {
    const { $$ } = MedWard.Utils;
    this.type = type;
    $$('.analysis-type').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  },
  
  addImage(file) {
    const { toast } = MedWard.Utils;
    if (this.images.length >= MedWard.CONFIG.MAX_IMAGES) {
      toast('Maximum ' + MedWard.CONFIG.MAX_IMAGES + ' images allowed', true);
      return;
    }
    MedWard.Utils.compressImage(file, MedWard.CONFIG.MAX_IMAGE_SIZE, (dataUrl) => {
      this.images.push({ id: Date.now(), name: file.name, data: dataUrl });
      this.renderImages();
      MedWard.Utils.$('analyzeBtn').disabled = false;
      toast('Image added (' + this.images.length + '/' + MedWard.CONFIG.MAX_IMAGES + ')');
    });
  },
  
  removeImage(id) {
    this.images = this.images.filter(img => img.id !== id);
    this.renderImages();
    if (this.images.length === 0) MedWard.Utils.$('analyzeBtn').disabled = true;
  },
  
  renderImages() {
    const { $ } = MedWard.Utils;
    const preview = $('analysisPreview');
    if (this.images.length === 0) { preview.style.display = 'none'; return; }
    let html = '<div class="image-gallery">';
    this.images.forEach(img => {
      html += '<div class="image-thumb"><img src="' + img.data + '" alt="Preview">' +
        '<button class="image-thumb-remove" onclick="MedWard.Analysis.removeImage(' + img.id + ')">‚úï</button></div>';
    });
    html += '</div><div style="font-size:0.75rem;color:var(--text-muted)">' + this.images.length + '/' + MedWard.CONFIG.MAX_IMAGES + ' images</div>';
    preview.innerHTML = html;
    preview.style.display = 'block';
  },
  
  clear() {
    const { $ } = MedWard.Utils;
    this.images = [];
    $('analysisPreview').style.display = 'none';
    $('analyzeBtn').disabled = true;
    $('analysisFile').value = '';
    $('analysisResults').innerHTML = '';
  },
  
  async run() {
    const { $, escapeHtml, toast } = MedWard.Utils;
    if (this.images.length === 0) return;
    $('analyzeBtn').disabled = true;
    $('analysisLoading').style.display = 'block';
    $('analysisResults').innerHTML = '';
    const typeNames = { lab: 'Laboratory Results', xray: 'X-Ray', ct: 'CT/MRI Scan', ecg: 'ECG' };
    try {
      const response = await fetch(MedWard.Storage.state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'interpret',
          documentType: this.type,
          images: this.images.map(img => ({ data: img.data })),
          image: this.images[0].data,
          multiImage: this.images.length > 1
        })
      });
      const data = await response.json();
      $('analysisLoading').style.display = 'none';
      $('analyzeBtn').disabled = false;
      if (data.error) {
        $('analysisResults').innerHTML = '<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>' + escapeHtml(data.error) + '</p></div>';
        return;
      }
      let html = '<div class="result-card"><h4>üìã ' + typeNames[this.type] + ' Analysis</h4>';
      if (data.interpretation) {
        const interp = data.interpretation;
        if (interp.summary) html += '<p><b>Summary:</b> ' + escapeHtml(interp.summary) + '</p>';
        if (interp.keyFindings && interp.keyFindings.length) {
          html += '<p><b>Key Findings:</b></p><ul>';
          interp.keyFindings.forEach(f => { html += '<li>' + escapeHtml(f) + '</li>'; });
          html += '</ul>';
        }
        if (interp.abnormalities && interp.abnormalities.length) {
          html += '<p><b class="abnormal">Abnormalities:</b></p><ul>';
          interp.abnormalities.forEach(a => { html += '<li class="abnormal">' + escapeHtml(a) + '</li>'; });
          html += '</ul>';
        }
      }
      html += '</div>';
      $('analysisResults').innerHTML = html;
      toast('Analysis complete!');
    } catch (error) {
      $('analysisLoading').style.display = 'none';
      $('analyzeBtn').disabled = false;
      $('analysisResults').innerHTML = '<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>Connection failed.</p></div>';
    }
  }
};
</script>
<script>
/**
 * MedWard Enterprise - Import Module (Inline)
 */
MedWard.Import = {
  imageBase64: null,
  patients: [],
  processing: false,
  
  open() {
    const { $, openModal } = MedWard.Utils;
    this.imageBase64 = null;
    this.patients = [];
    this.processing = false;
    $('importUpload').style.display = 'block';
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'none';
    $('importResults').style.display = 'none';
    $('importError').style.display = 'none';
    $('importBtn').disabled = true;
    $('importFile').value = '';
    openModal('importModal');
  },
  
  reset() {
    const { $ } = MedWard.Utils;
    this.imageBase64 = null;
    this.patients = [];
    $('importUpload').style.display = 'block';
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'none';
    $('importResults').style.display = 'none';
    $('importError').style.display = 'none';
    $('importBtn').disabled = true;
  },
  
  handleFile(file) {
    const { $ } = MedWard.Utils;
    MedWard.Utils.compressImage(file, MedWard.CONFIG.MAX_IMAGE_SIZE, (dataUrl) => {
      this.imageBase64 = dataUrl;
      $('importImg').src = dataUrl;
      $('importUpload').style.display = 'none';
      $('importPreview').style.display = 'block';
    });
  },
  
  async analyze() {
    const { $, toast } = MedWard.Utils;
    if (!this.imageBase64 || this.processing) return;
    this.processing = true;
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'block';
    try {
      const response = await fetch(MedWard.Storage.state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'extractPatients', image: this.imageBase64 })
      });
      const data = await response.json();
      this.processing = false;
      $('importLoading').style.display = 'none';
      if (data.error) { this.showError(data.error); return; }
      let pts = data.patients || [];
      if (!pts.length && data.extractedText) {
        try { const match = data.extractedText.match(/\[[\s\S]*\]/); if (match) pts = JSON.parse(match[0]); } catch (e) {}
      }
      if (!pts.length) { this.showError('No patients found.'); return; }
      const user = MedWard.Storage.state.currentUser;
      this.patients = pts.map((p, i) => ({
        id: Date.now() + i,
        name: (p.name || 'Unknown').trim(),
        room: (p.room || p.bed || '‚Äî').trim(),
        diagnosis: (p.diagnosis || p.condition || 'Pending').trim(),
        status: this.normalizeStatus(p.status),
        doctor: p.doctor || (user ? user.name : 'Unassigned')
      })).filter(p => p.name && p.name !== 'Unknown');
      if (!this.patients.length) { this.showError('No valid patient data.'); return; }
      this.showResults();
    } catch (error) {
      this.processing = false;
      $('importLoading').style.display = 'none';
      this.showError('Connection failed.');
    }
  },
  
  normalizeStatus(status) {
    if (!status) return 'active';
    const s = String(status).toLowerCase();
    if (s.match(/critical|icu|urgent/)) return 'critical';
    if (s.match(/chronic|stable/)) return 'chronic';
    return 'active';
  },
  
  showError(message) {
    const { $ } = MedWard.Utils;
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = message;
  },
  
  showResults() {
    const { $, initials, escapeHtml, toast } = MedWard.Utils;
    $('importResults').style.display = 'block';
    $('importCount').textContent = this.patients.length;
    let html = '';
    this.patients.slice(0, 8).forEach(p => {
      html += '<div class="import-patient ' + (p.status === 'critical' ? 'critical' : '') + '">' +
        '<div style="width:32px;height:32px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:8px;display:grid;place-items:center;font-weight:600;font-size:0.75rem;color:var(--bg)">' + initials(p.name) + '</div>' +
        '<div style="flex:1"><div style="font-weight:600;font-size:0.85rem">' + escapeHtml(p.name) + '</div>' +
        '<div style="font-size:0.7rem;color:var(--text-muted)">Room ' + escapeHtml(p.room) + '</div></div></div>';
    });
    if (this.patients.length > 8) html += '<div style="text-align:center;padding:8px;font-size:0.8rem;color:var(--text-muted)">+' + (this.patients.length - 8) + ' more</div>';
    $('importList').innerHTML = html;
    $('importBtn').disabled = false;
    toast('Found ' + this.patients.length + ' patients!');
  },
  
  confirm() {
    const { closeModal, toast } = MedWard.Utils;
    if (!this.patients.length) return;
    let added = 0;
    this.patients.forEach(p => {
      const exists = MedWard.Storage.state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase());
      if (!exists) { MedWard.Storage.addPatient(p); added++; }
    });
    MedWard.Patients.render();
    closeModal('importModal');
    toast('Imported ' + added + ' patients!');
  }
};
</script>
<script>
/**
 * MedWard Enterprise - Main Application (Inline)
 */
MedWard.App = {
  init() {
    const { $, $$ } = MedWard.Utils;
    console.log('[MedWard] Initializing...');
    MedWard.Storage.load();
    console.log('[MedWard] Units loaded:', MedWard.Storage.state.units.length);
    this.renderUnits();
    
    $('importFile').onchange = function() { if (this.files[0]) MedWard.Import.handleFile(this.files[0]); };
    $('analysisFile').onchange = function() {
      const files = this.files;
      for (let i = 0; i < files.length; i++) {
        if (files[i].type.startsWith('image/')) MedWard.Analysis.addImage(files[i]);
      }
      this.value = '';
    };
    
    $$('.modal').forEach(m => { m.onclick = e => { if (e.target === m) m.classList.remove('active'); }; });
    $('adminPwd').onkeydown = e => { if (e.key === 'Enter') this.loginAdmin(); };
    $('userName').onkeydown = e => { if (e.key === 'Enter') this.enterUnit(); };
    console.log('[MedWard] Initialized');
  },
  
  renderUnits() {
    const { $ } = MedWard.Utils;
    const units = MedWard.Storage.state.units;
    const container = $('unitsGrid');
    if (!container) return;
    if (!units || units.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No units configured.</div>';
      return;
    }
    let html = '';
    units.forEach(u => {
      html += '<div class="unit-card" style="--unit-color:' + (u.color || '#d4a437') + '" onclick="MedWard.App.openUnit(\'' + u.id + '\')">' +
        '<div class="unit-card-icon">' + (u.icon || 'üè•') + '</div>' +
        '<div class="unit-card-name">' + (u.name || 'Unknown') + '</div>' +
        '<div class="unit-card-desc">' + (u.desc || '') + '</div></div>';
    });
    container.innerHTML = html;
  },
  
  openUnit(id) {
    const { $, $$, openModal } = MedWard.Utils;
    const unit = MedWard.Storage.getUnit(id);
    if (!unit) return;
    MedWard.Storage.state.selectedUnitId = id;
    $('accessIcon').textContent = unit.icon;
    $('accessTitle').textContent = unit.name;
    $('codeError').classList.remove('show');
    $('userSection').style.display = 'none';
    $('enterBtn').style.display = 'none';
    
    let html = '';
    for (let i = 0; i < 4; i++) html += '<input type="tel" class="code-digit" maxlength="1" data-idx="' + i + '" inputmode="numeric">';
    $('codeInputs').innerHTML = html;
    
    const inputs = $$('.code-digit');
    inputs.forEach((inp, idx) => {
      inp.oninput = () => {
        inp.value = inp.value.replace(/\D/g, '');
        if (inp.value && idx < 3) inputs[idx + 1].focus();
        const code = Array.from(inputs).map(i => i.value).join('');
        if (code.length === 4) {
          if (code === unit.code) {
            inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
            $('codeError').classList.remove('show');
            $('userSection').style.display = 'block';
            $('enterBtn').style.display = 'flex';
            $('userName').focus();
          } else {
            $('codeError').classList.add('show');
            inputs.forEach(i => i.classList.add('error'));
            setTimeout(() => { inputs.forEach(i => { i.classList.remove('error'); i.value = ''; }); inputs[0].focus(); }, 500);
          }
        }
      };
      inp.onkeydown = e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); };
    });
    openModal('accessModal');
    setTimeout(() => inputs[0].focus(), 100);
  },
  
  enterUnit() {
    const { $, closeModal, toast } = MedWard.Utils;
    const name = $('userName').value.trim();
    if (!name) { toast('Enter your name', true); return; }
    const unit = MedWard.Storage.getUnit(MedWard.Storage.state.selectedUnitId);
    MedWard.Storage.state.currentUnit = unit;
    MedWard.Storage.state.currentUser = { name, role: $('userRole').value };
    closeModal('accessModal');
    this.showDashboard();
  },
  
  showDashboard() {
    const { $, initials, toast } = MedWard.Utils;
    const unit = MedWard.Storage.state.currentUnit;
    const user = MedWard.Storage.state.currentUser;
    $('landing').classList.add('hidden');
    $('dashboard').classList.add('active');
    $('unitBadge').textContent = unit.name;
    $('unitBadge').style.cssText = 'border:1px solid ' + unit.color + ';color:' + unit.color + ';background:' + unit.color + '20';
    $('dashAvatar').textContent = initials(user.name);
    MedWard.Patients.render();
    this.renderReference();
    toast('Welcome to ' + unit.name);
  },
  
  logout() {
    const { $ } = MedWard.Utils;
    MedWard.Storage.state.currentUnit = null;
    MedWard.Storage.state.currentUser = null;
    $('dashboard').classList.remove('active');
    $('landing').classList.remove('hidden');
  },
  
  showTab(name, btn) {
    const { $, $$ } = MedWard.Utils;
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    $('panel' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
  },
  
  openAdminLogin() {
    const { $, openModal } = MedWard.Utils;
    $('adminPwd').value = '';
    $('adminError').classList.remove('show');
    openModal('adminModal');
    setTimeout(() => $('adminPwd').focus(), 100);
  },
  
  loginAdmin() {
    const { $, closeModal } = MedWard.Utils;
    if ($('adminPwd').value === MedWard.Storage.state.settings.adminPassword) {
      closeModal('adminModal');
      this.showAdmin();
    } else { $('adminError').classList.add('show'); }
  },
  
  showAdmin() {
    const { $ } = MedWard.Utils;
    $('landing').classList.add('hidden');
    $('adminPanel').classList.add('active');
    $('apiUrl').value = MedWard.Storage.state.settings.apiUrl || '';
    this.renderUnitsTable();
  },
  
  exitAdmin() {
    const { $ } = MedWard.Utils;
    $('adminPanel').classList.remove('active');
    $('landing').classList.remove('hidden');
  },
  
  renderUnitsTable() {
    const { $ } = MedWard.Utils;
    const units = MedWard.Storage.state.units;
    let html = '';
    units.forEach(u => {
      html += '<tr><td>' + u.icon + ' <b>' + u.name + '</b></td>' +
        '<td><code style="background:var(--bg-elevated);padding:3px 8px;border-radius:4px">' + u.code + '</code></td>' +
        '<td><button class="btn-icon" onclick="MedWard.App.editUnit(\'' + u.id + '\')">‚úèÔ∏è</button>' +
        '<button class="btn-icon" onclick="MedWard.App.deleteUnit(\'' + u.id + '\')">üóëÔ∏è</button></td></tr>';
    });
    $('unitsTable').innerHTML = html || '<tr><td colspan="3" style="text-align:center;padding:30px;color:var(--text-muted)">No units</td></tr>';
  },
  
  addUnit() {
    const { $, openModal } = MedWard.Utils;
    MedWard.Storage.state.editingUnitId = null;
    $('unitModalTitle').textContent = 'Add Unit';
    $('uName').value = '';
    $('uIcon').value = 'üè•';
    $('uCode').value = '';
    $('uDesc').value = '';
    openModal('unitModal');
  },
  
  editUnit(id) {
    const { $, openModal } = MedWard.Utils;
    const unit = MedWard.Storage.getUnit(id);
    if (!unit) return;
    MedWard.Storage.state.editingUnitId = id;
    $('unitModalTitle').textContent = 'Edit Unit';
    $('uName').value = unit.name;
    $('uIcon').value = unit.icon;
    $('uCode').value = unit.code;
    $('uDesc').value = unit.desc || '';
    openModal('unitModal');
  },
  
  saveUnit() {
    const { $, closeModal, toast } = MedWard.Utils;
    const name = $('uName').value.trim();
    const icon = $('uIcon').value.trim() || 'üè•';
    const code = $('uCode').value.trim();
    const desc = $('uDesc').value.trim();
    if (!name) { toast('Name required', true); return; }
    if (!/^\d{4}$/.test(code)) { toast('Code must be 4 digits', true); return; }
    const editId = MedWard.Storage.state.editingUnitId;
    if (editId) {
      MedWard.Storage.updateUnit(editId, { name, icon, code, desc });
      toast('Unit updated!');
    } else {
      MedWard.Storage.addUnit({ name, icon, code, desc });
      toast('Unit created!');
    }
    this.renderUnitsTable();
    this.renderUnits();
    closeModal('unitModal');
  },
  
  deleteUnit(id) {
    const { toast } = MedWard.Utils;
    if (!confirm('Delete this unit?')) return;
    MedWard.Storage.deleteUnit(id);
    this.renderUnitsTable();
    this.renderUnits();
    toast('Unit deleted');
  },
  
  saveSettings() {
    const { $, toast } = MedWard.Utils;
    const pwd = $('newAdminPwd').value.trim();
    const url = $('apiUrl').value.trim();
    if (pwd) MedWard.Storage.state.settings.adminPassword = pwd;
    if (url) MedWard.Storage.state.settings.apiUrl = url;
    MedWard.Storage.save();
    toast('Settings saved!');
    $('newAdminPwd').value = '';
  },
  
  renderReference() {
    const { $ } = MedWard.Utils;
    let html = '';
    MedWard.REFERENCES.forEach(r => { html += '<div class="ref-card"><h4>' + r.title + '</h4><p>' + r.content + '</p></div>'; });
    $('refGrid').innerHTML = html;
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => MedWard.App.init());
} else {
  MedWard.App.init();
}
</script>

</body>
</html>