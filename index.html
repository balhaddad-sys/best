<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>MedWard Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#060a13;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;--text:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);--teal:#14b8a6;--blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;--border:rgba(148,163,184,0.12);--radius:12px}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;-webkit-tap-highlight-color:transparent}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:none;border-radius:var(--radius);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s}
    .btn:active{transform:scale(0.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg)}
    .btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:rgba(244,63,94,0.15);border:1px solid var(--rose);color:var(--rose)}
    .btn-sm{padding:8px 14px;font-size:0.8rem}
    .btn-full{width:100%}
    .btn-icon{width:40px;height:40px;padding:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer;display:grid;place-items:center}
    .form-group{margin-bottom:18px}
    .form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px}
    .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:inherit;font-size:0.9rem}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--gold)}
    .form-textarea{min-height:80px;resize:vertical}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.active{display:flex}
    .modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
    .modal-header{padding:20px;border-bottom:1px solid var(--border)}
    .modal-title{font-size:1.15rem;font-weight:700}
    .modal-body{padding:20px}
    .modal-footer{padding:16px 20px 20px;display:flex;gap:12px}
    .modal-footer .btn{flex:1}
    #landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
    #landing.hidden{display:none}
    .landing-logo{width:80px;height:80px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:20px;display:grid;place-items:center;margin-bottom:24px;box-shadow:0 8px 32px rgba(212,164,55,0.25)}
    .landing-logo svg{width:44px;height:44px;stroke:var(--bg);stroke-width:2.5;fill:none}
    .landing-title{font-size:1.8rem;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .landing-subtitle{color:var(--text-secondary);margin-bottom:40px}
    .units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;width:100%;max-width:800px}
    .unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
    .unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold))}
    .unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-2px)}
    .unit-card-icon{font-size:2rem;margin-bottom:12px}
    .unit-card-name{font-size:1.05rem;font-weight:600;margin-bottom:2px}
    .unit-card-desc{color:var(--text-muted);font-size:0.75rem}
    .admin-fab{position:fixed;bottom:20px;right:20px;width:50px;height:50px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50}
    .admin-fab svg{width:20px;height:20px}
    .sync-fab{position:fixed;bottom:20px;left:20px;width:50px;height:50px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50;transition:all 0.3s}
    .sync-fab svg{width:20px;height:20px}
    .sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
    @keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .code-inputs{display:flex;gap:10px;justify-content:center;margin-bottom:16px}
    .code-digit{width:48px;height:56px;background:var(--bg-elevated);border:2px solid var(--border);border-radius:var(--radius);font-family:monospace;font-size:1.5rem;font-weight:700;text-align:center;color:var(--text)}
    .code-digit:focus{outline:none;border-color:var(--gold)}
    .code-digit.error{border-color:var(--rose);animation:shake 0.3s}
    .code-digit.success{border-color:var(--emerald)}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .code-error{color:var(--rose);font-size:0.8rem;text-align:center;display:none}
    .code-error.show{display:block}
    #dashboard{display:none;min-height:100vh}
    #dashboard.active{display:block}
    .dash-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .dash-logo{display:flex;align-items:center;gap:10px}
    .dash-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:10px;display:grid;place-items:center}
    .dash-logo-icon svg{width:20px;height:20px;stroke:var(--bg);fill:none}
    .dash-badge{padding:5px 12px;border-radius:100px;font-size:0.75rem;font-weight:600}
    .dash-user{display:flex;align-items:center;gap:10px}
    .dash-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.8rem}
    .dash-content{max-width:1100px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:4px;background:var(--bg-card);border-radius:var(--radius);padding:4px;margin-bottom:20px;overflow-x:auto}
    .tab{flex:1;padding:10px 16px;background:transparent;border:none;border-radius:8px;color:var(--text-muted);font-family:inherit;font-size:0.8rem;font-weight:500;cursor:pointer;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:6px;min-width:80px}
    .tab.active{background:var(--bg-elevated);color:var(--gold)}
    .tab svg{width:16px;height:16px}
    .panel{display:none}
    .panel.active{display:block}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
    .stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
    .stat-value{font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .stat-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-top:2px}
    .patients-list{display:grid;gap:12px}
    .patient{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;border-left:3px solid var(--teal)}
    .patient.critical{border-left-color:var(--rose)}
    .patient.chronic{border-left-color:var(--purple)}
    .patient-top{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .patient-avatar{width:42px;height:42px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.85rem;color:var(--bg);flex-shrink:0}
    .patient-info{flex:1;min-width:0}
    .patient-name{font-weight:600;font-size:0.95rem}
    .patient-meta{font-size:0.7rem;color:var(--text-muted)}
    .patient-status{padding:3px 8px;border-radius:100px;font-size:0.6rem;font-weight:600;text-transform:uppercase}
    .patient-status.active{background:rgba(20,184,166,0.15);color:var(--teal)}
    .patient-status.critical{background:rgba(244,63,94,0.15);color:var(--rose)}
    .patient-status.chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
    .patient-dx{font-size:0.8rem;color:var(--text-secondary);padding:10px;background:var(--bg-elevated);border-radius:8px;margin-bottom:10px}
    .patient-actions{display:flex;gap:8px}
    .patient-actions .btn{flex:1}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px}
    .card-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:0.9rem}
    .card-body{padding:16px}
    .upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:30px 20px;text-align:center;cursor:pointer;transition:all 0.2s}
    .upload-zone:hover{border-color:var(--gold);background:var(--gold-glow)}
    .upload-zone-icon{font-size:2rem;margin-bottom:10px}
    .analysis-types{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px}
    .analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
    .analysis-type:hover,.analysis-type.active{border-color:var(--gold);background:var(--gold-glow)}
    .analysis-type-icon{font-size:1.3rem;margin-bottom:4px}
    .analysis-type-name{font-size:0.7rem;font-weight:600}
    .result-card{background:var(--bg-elevated);border-radius:var(--radius);padding:16px;margin-bottom:12px}
    .result-card h4{font-size:0.85rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .result-card p,.result-card li{font-size:0.8rem;color:var(--text-secondary);margin:4px 0}
    .result-card ul{padding-left:16px}
    .result-card b{color:var(--gold)}
    .abnormal{color:var(--rose)!important}
    .normal{color:var(--emerald)!important}
    .ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .ref-card{background:var(--bg-elevated);border-radius:8px;padding:14px;border-left:3px solid var(--gold)}
    .ref-card h4{font-size:0.85rem;margin-bottom:8px}
    .ref-card p{font-size:0.75rem;color:var(--text-secondary)}
    .ref-card b{color:var(--gold)}
    #adminPanel{display:none;min-height:100vh}
    #adminPanel.active{display:block}
    .admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .admin-content{max-width:800px;margin:0 auto;padding:20px}
    .admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px}
    .admin-section-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .admin-section-title{font-size:0.95rem;font-weight:600}
    .admin-section-body{padding:16px}
    .units-table{width:100%;border-collapse:collapse}
    .units-table th,.units-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    .units-table th{font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase}
    .import-dropzone{border:2px dashed var(--border);border-radius:var(--radius);padding:30px;text-align:center;cursor:pointer}
    .import-dropzone:hover{border-color:var(--gold);background:var(--gold-glow)}
    .import-patient{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-elevated);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--teal)}
    .import-patient.critical{border-left-color:var(--rose)}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg-card);border:1px solid var(--emerald);padding:12px 20px;border-radius:var(--radius);font-size:0.85rem;opacity:0;transition:0.3s;z-index:2000}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{border-color:var(--rose)}
    .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .image-gallery{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .image-thumb{position:relative;width:72px;height:72px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
    .image-thumb img{width:100%;height:100%;object-fit:cover}
    .image-thumb-remove{position:absolute;top:2px;right:2px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,0.7);border:none;color:white;font-size:11px;cursor:pointer;display:grid;place-items:center}
    @media(max-width:600px){.stats{grid-template-columns:repeat(2,1fr)}.analysis-types{grid-template-columns:repeat(2,1fr)}.tab span{display:none}.patient-actions{flex-direction:column}}
  </style>
</head>
<body>

<!-- LANDING PAGE -->
<div id="landing">
  <div class="landing-logo">
    <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
  </div>
  <h1 class="landing-title">MedWard Enterprise</h1>
  <p class="landing-subtitle">Select your unit to continue</p>
  <div class="units-grid" id="unitsGrid"></div>
  <div class="sync-fab" id="syncFab" title="Sync from cloud">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9"/></svg>
  </div>
  <div class="admin-fab" id="adminFab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
  </div>
</div>

<!-- ACCESS MODAL -->
<div class="modal" id="accessModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div id="accessIcon" style="font-size:2.5rem;margin-bottom:8px">üè•</div>
      <div class="modal-title" id="accessTitle">Unit</div>
      <div style="color:var(--text-muted);font-size:0.8rem;margin-top:4px">Enter 4-digit code</div>
    </div>
    <div class="modal-body">
      <div class="code-inputs" id="codeInputs"></div>
      <p class="code-error" id="codeError">Invalid code</p>
      <div id="userSection" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input type="text" id="userName" class="form-input" placeholder="Dr. Name">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select id="userRole" class="form-select">
            <option value="attending">Attending</option>
            <option value="resident">Resident</option>
            <option value="intern">Intern</option>
            <option value="nurse">Nurse</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="accessCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="enterBtn" style="display:none">Enter Unit</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal" id="adminModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:center">
      <div style="font-size:2.5rem;margin-bottom:8px">‚öôÔ∏è</div>
      <div class="modal-title">Admin Access</div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="adminPwd" class="form-input" placeholder="Password">
      </div>
      <p class="code-error" id="adminError">Invalid password</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="adminCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <header class="admin-header">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span style="font-weight:600">MedWard</span>
      <span style="background:var(--purple);padding:2px 8px;border-radius:100px;font-size:0.65rem;font-weight:600;margin-left:8px">ADMIN</span>
    </div>
    <button class="btn btn-secondary btn-sm" id="exitAdminBtn">Exit</button>
  </header>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">üè• Units</div>
        <button class="btn btn-primary btn-sm" id="addUnitBtn">+ Add</button>
      </div>
      <div class="admin-section-body" style="padding:0">
        <table class="units-table">
          <thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead>
          <tbody id="unitsTable"></tbody>
        </table>
      </div>
    </div>
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">‚öôÔ∏è Settings</div>
      </div>
      <div class="admin-section-body">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="newAdminPwd" class="form-input" placeholder="Leave blank to keep current">
        </div>
        <div class="form-group">
          <label class="form-label">Claude API URL (Apps Script)</label>
          <input type="text" id="apiUrl" class="form-input" placeholder="https://script.google.com/...">
        </div>
        <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span class="dash-badge" id="unitBadge">Unit</span>
    </div>
    <div class="dash-user">
      <div class="dash-avatar" id="dashAvatar">DR</div>
      <button class="btn-icon" id="logoutBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </header>
  
  <div class="dash-content">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="patients">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        <span>Patients</span>
      </button>
      <button class="tab" data-tab="analysis">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><path d="M14 3v5h5M16 13H8M16 17H8M10 9H8"/></svg>
        <span>AI Analysis</span>
      </button>
      <button class="tab" data-tab="reference">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        <span>Reference</span>
      </button>
    </div>
    
    <!-- PATIENTS PANEL -->
    <div class="panel active" id="panelPatients">
      <div class="stats">
        <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
        <div class="stat"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
        <div class="stat"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
        <div class="stat"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button class="btn btn-primary btn-sm" id="addPatientBtn" style="flex:1">+ Add Patient</button>
        <button class="btn btn-secondary btn-sm" id="importBtn" style="flex:1">üì• Import</button>
      </div>
      <div class="patients-list" id="patientsList"></div>
    </div>
    
    <!-- ANALYSIS PANEL -->
    <div class="panel" id="panelAnalysis">
      <div class="card">
        <div class="card-header">üî¨ Medical Image Analysis</div>
        <div class="card-body">
          <div class="upload-zone" id="uploadZone">
            <div class="upload-zone-icon">üì§</div>
            <div style="font-weight:600">Upload Medical Images</div>
            <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Labs, X-Rays, CT/MRI, ECG ‚Ä¢ Select multiple</div>
          </div>
          <input type="file" id="analysisFile" accept="image/*" multiple style="display:none">
          <div class="analysis-types" id="analysisTypes">
            <div class="analysis-type active" data-type="lab"><div class="analysis-type-icon">üß™</div><div class="analysis-type-name">Labs</div></div>
            <div class="analysis-type" data-type="xray"><div class="analysis-type-icon">ü©ª</div><div class="analysis-type-name">X-Ray</div></div>
            <div class="analysis-type" data-type="ct"><div class="analysis-type-icon">üß†</div><div class="analysis-type-name">CT/MRI</div></div>
            <div class="analysis-type" data-type="ecg"><div class="analysis-type-icon">üíì</div><div class="analysis-type-name">ECG</div></div>
          </div>
          <div id="analysisPreview" style="display:none;margin-top:16px"></div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="analyzeBtn" disabled>ü§ñ Analyze with Claude AI</button>
      <div id="analysisLoading" style="display:none;text-align:center;padding:30px">
        <div class="spinner"></div>
        <div style="margin-top:12px;font-weight:600">Analyzing...</div>
        <div id="analysisTimer" style="font-size:0.8rem;color:var(--text-muted);margin-top:8px">0s</div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">Usually takes 5-15 seconds</div>
      </div>
      <div id="analysisResults" style="margin-top:16px"></div>
    </div>
    
    <!-- REFERENCE PANEL -->
    <div class="panel" id="panelReference">
      <div class="card">
        <div class="card-header">üìö Quick Reference</div>
        <div class="card-body">
          <div class="ref-grid" id="refGrid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PATIENT MODAL -->
<div class="modal" id="patientModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="patientModalTitle">Add Patient</div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ptId">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="ptName" class="form-input" placeholder="Full name">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Room</label>
          <input type="text" id="ptRoom" class="form-input" placeholder="21-A">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select id="ptStatus" class="form-select">
            <option value="active">Active</option>
            <option value="critical">Critical</option>
            <option value="chronic">Chronic</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Diagnosis</label>
        <textarea id="ptDx" class="form-textarea" placeholder="Primary diagnosis"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="patientCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="patientSaveBtn">Save</button>
    </div>
  </div>
</div>

<!-- UNIT MODAL -->
<div class="modal" id="unitModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="unitModalTitle">Add Unit</div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" id="uName" class="form-input" placeholder="Neurology">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Icon</label>
          <input type="text" id="uIcon" class="form-input" value="üè•" style="font-size:1.3rem;text-align:center">
        </div>
        <div class="form-group">
          <label class="form-label">Code (4 digits)</label>
          <input type="text" id="uCode" class="form-input" placeholder="1234" maxlength="4">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" id="uDesc" class="form-input" placeholder="Brief description">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="unitCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="unitSaveBtn">Save</button>
    </div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modal" id="importModal">
  <div class="modal-box" style="max-width:500px">
    <div class="modal-header">
      <div class="modal-title">üì• Import Patients</div>
      <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">AI extracts patient data from screenshots</div>
    </div>
    <div class="modal-body">
      <div id="importUpload">
        <div class="import-dropzone" id="importDropzone">
          <div style="font-size:2rem;margin-bottom:8px">üì§</div>
          <div style="font-weight:600">Upload Screenshot</div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Excel, Sheets, or EMR screenshot</div>
        </div>
        <input type="file" id="importFile" accept="image/*" style="display:none">
      </div>
      <div id="importPreview" style="display:none">
        <img id="importImg" src="" style="width:100%;max-height:150px;object-fit:contain;border-radius:8px">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-secondary btn-sm" id="importChangeBtn" style="flex:1">Change</button>
          <button class="btn btn-primary btn-sm" id="importExtractBtn" style="flex:2">ü§ñ Extract Patients</button>
        </div>
      </div>
      <div id="importLoading" style="display:none;text-align:center;padding:30px">
        <div class="spinner"></div>
        <div style="margin-top:12px">Extracting patients...</div>
      </div>
      <div id="importResults" style="display:none">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="font-weight:600">‚úì Found Patients</span>
          <span id="importCount" style="background:var(--emerald);color:white;padding:2px 10px;border-radius:100px;font-size:0.75rem">0</span>
        </div>
        <div id="importList" style="max-height:250px;overflow-y:auto"></div>
      </div>
      <div id="importError" style="display:none;text-align:center;padding:20px;color:var(--rose)">
        <div style="font-size:1.5rem;margin-bottom:8px">‚ö†Ô∏è</div>
        <div id="importErrorMsg">Error</div>
        <button class="btn btn-secondary btn-sm" id="importRetryBtn" style="margin-top:12px">Try Again</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="importCancelBtn">Cancel</button>
      <button class="btn btn-primary" id="importConfirmBtn" disabled>Import</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';
  
  // ========== CONFIGURATION ==========
  const CONFIG = {
    STORAGE_KEY: 'medward_enterprise_v2',
    ADMIN_PASSWORD: 'admin123',
    API_URL: 'https://script.google.com/macros/s/AKfycbwnPMayEKM6rHJB2qZ-DDECoVB4Kte1EcoBiea0pmcasfyAeW7RGeADiH5DMXGRJOSJ/exec',
    MAX_IMAGES: 5,
    MAX_IMAGE_SIZE: 1024 * 1024,  // Reduced to 1MB for faster upload
    IMAGE_QUALITY: 0.6,           // More compression for speed
    MAX_IMAGE_DIMENSION: 1200     // Smaller images = faster processing
  };

  const DEFAULT_UNITS = [
    { id: 'neuro', name: 'Neurology', icon: 'üß†', desc: 'Stroke & Neuro Care', code: '1234', color: '#a855f7' },
    { id: 'cardio', name: 'Cardiology', icon: '‚ù§Ô∏è', desc: 'Cardiac Care', code: '5678', color: '#ef4444' },
    { id: 'icu', name: 'ICU', icon: 'üè•', desc: 'Intensive Care', code: '9012', color: '#f97316' }
  ];

  const REFERENCES = [
    { title: 'üö® Critical Labs', content: '<b>K:</b> <2.5 or >6.5 mEq/L<br><b>Na:</b> <120 or >160 mEq/L<br><b>Glucose:</b> <40 or >500 mg/dL<br><b>pH:</b> <7.2 or >7.6' },
    { title: '‚ö° Hyperkalemia', content: '<b>Stabilize:</b> Ca gluconate 10mL IV<br><b>Shift:</b> Insulin 10U + D50, Albuterol<br><b>Remove:</b> Kayexalate, Lasix, HD' },
    { title: '‚ù§Ô∏è ACS Protocol', content: '<b>MONA:</b> Morphine, O‚ÇÇ, Nitrates, Aspirin 325mg<br><b>STEMI:</b> PCI <90min or lytics<br><b>NSTEMI:</b> Anticoag + cath' },
    { title: 'üß† Stroke tPA', content: '<b>Window:</b> ‚â§4.5h from LKW<br><b>Dose:</b> 0.9 mg/kg (max 90mg)<br><b>BP goal:</b> <185/110 pre-tPA' },
    { title: 'ü¶† Sepsis Bundle', content: '<b>Hour-1:</b> Lactate, cultures, antibiotics<br><b>Fluids:</b> 30mL/kg if hypotensive<br><b>Pressors:</b> Norepi first line' },
    { title: 'üíä Seizure Rx', content: '<b>1st:</b> Lorazepam 4mg IV<br><b>2nd:</b> Levetiracetam 60mg/kg<br><b>Refractory:</b> Propofol or midazolam gtt' },
    { title: 'ü´Å PE Treatment', content: '<b>Massive:</b> tPA 100mg over 2h<br><b>Submassive:</b> Anticoag ¬± lytics<br><b>Low-risk:</b> DOAC outpatient' },
    { title: 'üíß DKA Protocol', content: '<b>Fluids:</b> NS 1-2L/h initially<br><b>Insulin:</b> 0.1 U/kg/h gtt<br><b>K:</b> Replace if <5.3' }
  ];

  // ========== STATE ==========
  const state = {
    units: [],
    settings: {},
    patients: [],
    currentUnit: null,
    currentUser: null,
    selectedUnitId: null,
    editingUnitId: null,
    analysisImages: [],
    analysisType: 'lab',
    importImage: null,
    importPatients: []
  };

  // ========== UTILITIES ==========
  const $ = id => document.getElementById(id);
  const $$ = sel => document.querySelectorAll(sel);
  
  function toast(msg, isError = false) {
    const t = $('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => t.className = 'toast', 3000);
  }
  
  function initials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    return parts.length >= 2 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
  }
  
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function openModal(id) { $(id).classList.add('active'); }
  function closeModal(id) { $(id).classList.remove('active'); }
  
  function compressImage(file, maxSize, callback) {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        let quality = CONFIG.IMAGE_QUALITY;
        const maxDim = CONFIG.MAX_IMAGE_DIMENSION;
        if (w > maxDim || h > maxDim) {
          if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
          else { w = Math.round(w * maxDim / h); h = maxDim; }
        }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        let dataUrl = canvas.toDataURL('image/jpeg', quality);
        while (dataUrl.length > maxSize && quality > 0.3) {
          quality -= 0.1;
          dataUrl = canvas.toDataURL('image/jpeg', quality);
        }
        callback(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // ========== STORAGE (Google Drive + localStorage with auto-sync) ==========
  let isSyncing = false;
  let lastSyncTime = 0;
  const SYNC_INTERVAL = 30000; // Check for updates every 30 seconds
  
  async function loadStorage() {
    state.units = DEFAULT_UNITS.slice();
    state.settings = { adminPassword: CONFIG.ADMIN_PASSWORD, apiUrl: CONFIG.API_URL };
    state.patients = [];
    
    // First load from localStorage (instant)
    loadFromLocalStorage();
    
    // Then sync from Google Drive
    await syncFromDrive(true);
    
    // Start periodic sync
    setInterval(() => syncFromDrive(false), SYNC_INTERVAL);
  }
  
  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        if (data.units && Array.isArray(data.units) && data.units.length > 0) {
          const valid = data.units.filter(u => u && u.id && u.name && u.code);
          if (valid.length > 0) state.units = valid;
        }
        if (data.settings) {
          state.settings.adminPassword = data.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
          state.settings.apiUrl = data.settings.apiUrl || CONFIG.API_URL;
        }
        if (data.patients && Array.isArray(data.patients)) state.patients = data.patients;
        lastSyncTime = data.lastUpdated ? new Date(data.lastUpdated).getTime() : 0;
      }
    } catch (e) {
      console.warn('LocalStorage load failed:', e);
    }
    if (!state.units || state.units.length === 0) state.units = DEFAULT_UNITS.slice();
  }
  
  async function syncFromDrive(isInitial = false) {
    if (isSyncing) return;
    isSyncing = true;
    
    try {
      const response = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'loadData' })
      });
      const result = await response.json();
      
      if (result.success && result.data) {
        const driveData = result.data;
        const driveTime = driveData.lastUpdated ? new Date(driveData.lastUpdated).getTime() : 0;
        
        // Only update if Drive data is newer
        if (driveTime > lastSyncTime || isInitial) {
          let hasChanges = false;
          
          // Update units
          if (driveData.units && driveData.units.length > 0) {
            const oldUnitsJson = JSON.stringify(state.units);
            state.units = driveData.units;
            if (JSON.stringify(state.units) !== oldUnitsJson) hasChanges = true;
          }
          
          // Update settings
          if (driveData.settings) {
            state.settings = { ...state.settings, ...driveData.settings };
          }
          
          // Update patients
          if (driveData.patients) {
            const oldPatientsJson = JSON.stringify(state.patients);
            state.patients = driveData.patients;
            if (JSON.stringify(state.patients) !== oldPatientsJson) hasChanges = true;
          }
          
          lastSyncTime = driveTime || Date.now();
          
          // Save to localStorage
          saveToLocalStorage();
          
          // Re-render UI if there were changes
          if (hasChanges && !isInitial) {
            console.log('[MedWard] New data from Drive - refreshing UI');
            if (!state.currentUnit) {
              renderUnits();
              toast('Data synced from cloud');
            } else {
              renderPatients();
            }
          }
          
          console.log('[MedWard] Synced from Google Drive');
        }
      }
    } catch (e) {
      console.warn('Drive sync failed:', e);
    }
    
    isSyncing = false;
  }
  
  function saveToLocalStorage() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
        units: state.units, 
        settings: state.settings, 
        patients: state.patients,
        lastUpdated: new Date().toISOString()
      }));
    } catch (e) { console.warn('LocalStorage save failed:', e); }
  }
  
  async function saveStorage() {
    // Update timestamp
    lastSyncTime = Date.now();
    
    // Save to localStorage immediately
    saveToLocalStorage();
    
    // Save to Google Drive
    await saveToDrive();
  }
  
  async function saveToDrive() {
    try {
      const response = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'saveData',
          payload: {
            units: state.units,
            settings: { adminPassword: state.settings.adminPassword },
            patients: state.patients,
            lastUpdated: new Date().toISOString()
          }
        })
      });
      const result = await response.json();
      if (result.success) {
        console.log('[MedWard] Saved to Google Drive');
      } else {
        console.warn('Drive save failed:', result.error);
        toast('Cloud sync failed', true);
      }
    } catch (e) {
      console.warn('Drive save failed:', e);
      toast('Cloud sync failed', true);
    }
  }
  
  // Force sync from Drive (manual refresh)
  async function forceSync() {
    lastSyncTime = 0;
    await syncFromDrive(true);
    toast('Synced from cloud');
  }
  
  function getUnit(id) { return state.units.find(u => u.id === id); }

  // ========== RENDERING ==========
  function renderUnits() {
    const container = $('unitsGrid');
    if (!state.units || state.units.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No units configured.</div>';
      return;
    }
    container.innerHTML = state.units.map(u => `
      <div class="unit-card" style="--unit-color:${u.color||'#d4a437'}" data-id="${u.id}">
        <div class="unit-card-icon">${u.icon||'üè•'}</div>
        <div class="unit-card-name">${u.name||'Unknown'}</div>
        <div class="unit-card-desc">${u.desc||''}</div>
      </div>
    `).join('');
    
    $$('.unit-card').forEach(card => {
      card.addEventListener('click', () => openUnitAccess(card.dataset.id));
    });
  }
  
  function renderUnitsTable() {
    const tbody = $('unitsTable');
    tbody.innerHTML = state.units.map(u => `
      <tr>
        <td>${u.icon} <b>${u.name}</b></td>
        <td><code style="background:var(--bg-elevated);padding:3px 8px;border-radius:4px">${u.code}</code></td>
        <td>
          <button class="btn-icon edit-unit-btn" data-id="${u.id}">‚úèÔ∏è</button>
          <button class="btn-icon delete-unit-btn" data-id="${u.id}">üóëÔ∏è</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="3" style="text-align:center;padding:30px;color:var(--text-muted)">No units</td></tr>';
    
    $$('.edit-unit-btn').forEach(btn => btn.addEventListener('click', () => editUnit(btn.dataset.id)));
    $$('.delete-unit-btn').forEach(btn => btn.addEventListener('click', () => deleteUnit(btn.dataset.id)));
  }
  
  function renderPatients() {
    const container = $('patientsList');
    if (!state.patients.length) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No patients yet. Click "+ Add" or "üì• Import".</div>';
    } else {
      container.innerHTML = state.patients.map(p => `
        <div class="patient ${p.status}" data-id="${p.id}">
          <div class="patient-top">
            <div class="patient-avatar">${initials(p.name)}</div>
            <div class="patient-info">
              <div class="patient-name">${escapeHtml(p.name)}</div>
              <div class="patient-meta">Room ${escapeHtml(p.room)} ‚Ä¢ ${escapeHtml(p.doctor||'Unassigned')}</div>
            </div>
            <span class="patient-status ${p.status}">${p.status}</span>
          </div>
          <div class="patient-dx">${escapeHtml(p.diagnosis)}</div>
          <div class="patient-actions">
            <button class="btn btn-secondary btn-sm edit-patient-btn" data-id="${p.id}">‚úèÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm delete-patient-btn" data-id="${p.id}">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
      
      $$('.edit-patient-btn').forEach(btn => btn.addEventListener('click', () => editPatient(parseInt(btn.dataset.id))));
      $$('.delete-patient-btn').forEach(btn => btn.addEventListener('click', () => deletePatient(parseInt(btn.dataset.id))));
    }
    updateStats();
  }
  
  function updateStats() {
    $('statTotal').textContent = state.patients.length;
    $('statActive').textContent = state.patients.filter(p => p.status === 'active').length;
    $('statCritical').textContent = state.patients.filter(p => p.status === 'critical').length;
    $('statChronic').textContent = state.patients.filter(p => p.status === 'chronic').length;
  }
  
  function renderReference() {
    $('refGrid').innerHTML = REFERENCES.map(r => `
      <div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>
    `).join('');
  }

  // ========== UNIT ACCESS ==========
  function openUnitAccess(id) {
    const unit = getUnit(id);
    if (!unit) return;
    state.selectedUnitId = id;
    $('accessIcon').textContent = unit.icon;
    $('accessTitle').textContent = unit.name;
    $('codeError').classList.remove('show');
    $('userSection').style.display = 'none';
    $('enterBtn').style.display = 'none';
    
    $('codeInputs').innerHTML = Array(4).fill(0).map((_, i) => 
      `<input type="tel" class="code-digit" maxlength="1" data-idx="${i}" inputmode="numeric">`
    ).join('');
    
    const inputs = $$('.code-digit');
    inputs.forEach((inp, idx) => {
      inp.addEventListener('input', () => {
        inp.value = inp.value.replace(/\D/g, '');
        if (inp.value && idx < 3) inputs[idx + 1].focus();
        const code = Array.from(inputs).map(i => i.value).join('');
        if (code.length === 4) {
          if (code === unit.code) {
            inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
            $('codeError').classList.remove('show');
            $('userSection').style.display = 'block';
            $('enterBtn').style.display = 'flex';
            $('userName').focus();
          } else {
            $('codeError').classList.add('show');
            inputs.forEach(i => i.classList.add('error'));
            setTimeout(() => {
              inputs.forEach(i => { i.classList.remove('error'); i.value = ''; });
              inputs[0].focus();
            }, 500);
          }
        }
      });
      inp.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus();
      });
    });
    
    openModal('accessModal');
    setTimeout(() => inputs[0].focus(), 100);
  }
  
  function enterUnit() {
    const name = $('userName').value.trim();
    if (!name) { toast('Enter your name', true); return; }
    const unit = getUnit(state.selectedUnitId);
    state.currentUnit = unit;
    state.currentUser = { name, role: $('userRole').value };
    closeModal('accessModal');
    showDashboard();
  }

  // ========== DASHBOARD ==========
  function showDashboard() {
    const unit = state.currentUnit;
    const user = state.currentUser;
    $('landing').classList.add('hidden');
    $('dashboard').classList.add('active');
    $('unitBadge').textContent = unit.name;
    $('unitBadge').style.cssText = `border:1px solid ${unit.color};color:${unit.color};background:${unit.color}20`;
    $('dashAvatar').textContent = initials(user.name);
    renderPatients();
    renderReference();
    toast('Welcome to ' + unit.name);
  }
  
  function logout() {
    state.currentUnit = null;
    state.currentUser = null;
    $('dashboard').classList.remove('active');
    $('landing').classList.remove('hidden');
  }
  
  function showTab(name) {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
    $('panel' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
  }

  // ========== ADMIN ==========
  function openAdminLogin() {
    $('adminPwd').value = '';
    $('adminError').classList.remove('show');
    openModal('adminModal');
    setTimeout(() => $('adminPwd').focus(), 100);
  }
  
  function loginAdmin() {
    if ($('adminPwd').value === state.settings.adminPassword) {
      closeModal('adminModal');
      showAdmin();
    } else {
      $('adminError').classList.add('show');
    }
  }
  
  function showAdmin() {
    $('landing').classList.add('hidden');
    $('adminPanel').classList.add('active');
    $('apiUrl').value = state.settings.apiUrl || '';
    renderUnitsTable();
  }
  
  function exitAdmin() {
    $('adminPanel').classList.remove('active');
    $('landing').classList.remove('hidden');
  }
  
  function addUnit() {
    state.editingUnitId = null;
    $('unitModalTitle').textContent = 'Add Unit';
    $('uName').value = '';
    $('uIcon').value = 'üè•';
    $('uCode').value = '';
    $('uDesc').value = '';
    openModal('unitModal');
  }
  
  function editUnit(id) {
    const unit = getUnit(id);
    if (!unit) return;
    state.editingUnitId = id;
    $('unitModalTitle').textContent = 'Edit Unit';
    $('uName').value = unit.name;
    $('uIcon').value = unit.icon;
    $('uCode').value = unit.code;
    $('uDesc').value = unit.desc || '';
    openModal('unitModal');
  }
  
  function saveUnit() {
    const name = $('uName').value.trim();
    const icon = $('uIcon').value.trim() || 'üè•';
    const code = $('uCode').value.trim();
    const desc = $('uDesc').value.trim();
    if (!name) { toast('Name required', true); return; }
    if (!/^\d{4}$/.test(code)) { toast('Code must be 4 digits', true); return; }
    
    if (state.editingUnitId) {
      const idx = state.units.findIndex(u => u.id === state.editingUnitId);
      if (idx !== -1) state.units[idx] = { ...state.units[idx], name, icon, code, desc };
      toast('Unit updated!');
    } else {
      const colors = ['#d4a437', '#14b8a6', '#3b82f6', '#a855f7', '#ef4444', '#f97316'];
      state.units.push({ id: 'u' + Date.now(), name, icon, code, desc, color: colors[state.units.length % colors.length] });
      toast('Unit created!');
    }
    saveStorage();
    renderUnitsTable();
    renderUnits();
    closeModal('unitModal');
  }
  
  function deleteUnit(id) {
    if (!confirm('Delete this unit?')) return;
    state.units = state.units.filter(u => u.id !== id);
    saveStorage();
    renderUnitsTable();
    renderUnits();
    toast('Unit deleted');
  }
  
  function saveSettings() {
    const pwd = $('newAdminPwd').value.trim();
    const url = $('apiUrl').value.trim();
    if (pwd) state.settings.adminPassword = pwd;
    if (url) state.settings.apiUrl = url;
    saveStorage();
    toast('Settings saved!');
    $('newAdminPwd').value = '';
  }

  // ========== PATIENTS ==========
  function openAddPatient() {
    $('patientModalTitle').textContent = 'Add Patient';
    $('ptId').value = '';
    $('ptName').value = '';
    $('ptRoom').value = '';
    $('ptDx').value = '';
    $('ptStatus').value = 'active';
    openModal('patientModal');
  }
  
  function editPatient(id) {
    const patient = state.patients.find(p => p.id === id);
    if (!patient) return;
    $('patientModalTitle').textContent = 'Edit Patient';
    $('ptId').value = patient.id;
    $('ptName').value = patient.name;
    $('ptRoom').value = patient.room;
    $('ptDx').value = patient.diagnosis;
    $('ptStatus').value = patient.status;
    openModal('patientModal');
  }
  
  function savePatient() {
    const id = $('ptId').value;
    const name = $('ptName').value.trim();
    const room = $('ptRoom').value.trim() || '‚Äî';
    const diagnosis = $('ptDx').value.trim() || 'Pending evaluation';
    const status = $('ptStatus').value;
    if (!name) { toast('Name is required', true); return; }
    
    if (id) {
      const idx = state.patients.findIndex(p => p.id === parseInt(id));
      if (idx !== -1) state.patients[idx] = { ...state.patients[idx], name, room, diagnosis, status };
      toast('Patient updated!');
    } else {
      state.patients.push({
        id: Date.now(), name, room, diagnosis, status,
        doctor: state.currentUser ? state.currentUser.name : 'Unassigned'
      });
      toast('Patient added!');
    }
    saveStorage();
    renderPatients();
    closeModal('patientModal');
  }
  
  function deletePatient(id) {
    if (!confirm('Delete this patient?')) return;
    state.patients = state.patients.filter(p => p.id !== id);
    saveStorage();
    renderPatients();
    toast('Patient deleted');
  }

  // ========== ANALYSIS ==========
  let analysisTimer = null;
  let analysisSeconds = 0;
  
  function startAnalysisTimer() {
    analysisSeconds = 0;
    $('analysisTimer').textContent = '0s';
    analysisTimer = setInterval(() => {
      analysisSeconds++;
      $('analysisTimer').textContent = analysisSeconds + 's';
    }, 1000);
  }
  
  function stopAnalysisTimer() {
    if (analysisTimer) {
      clearInterval(analysisTimer);
      analysisTimer = null;
    }
  }
  
  function addAnalysisImage(file) {
    if (state.analysisImages.length >= CONFIG.MAX_IMAGES) {
      toast('Maximum ' + CONFIG.MAX_IMAGES + ' images', true);
      return;
    }
    compressImage(file, CONFIG.MAX_IMAGE_SIZE, dataUrl => {
      state.analysisImages.push({ id: Date.now(), name: file.name, data: dataUrl });
      renderAnalysisImages();
      $('analyzeBtn').disabled = false;
      toast('Image added (' + state.analysisImages.length + '/' + CONFIG.MAX_IMAGES + ')');
    });
  }
  
  function removeAnalysisImage(id) {
    state.analysisImages = state.analysisImages.filter(img => img.id !== id);
    renderAnalysisImages();
    if (state.analysisImages.length === 0) $('analyzeBtn').disabled = true;
  }
  
  function renderAnalysisImages() {
    const preview = $('analysisPreview');
    if (state.analysisImages.length === 0) { preview.style.display = 'none'; return; }
    preview.innerHTML = `
      <div class="image-gallery">
        ${state.analysisImages.map(img => `
          <div class="image-thumb">
            <img src="${img.data}" alt="Preview">
            <button class="image-thumb-remove" data-id="${img.id}">‚úï</button>
          </div>
        `).join('')}
      </div>
      <div style="font-size:0.75rem;color:var(--text-muted)">${state.analysisImages.length}/${CONFIG.MAX_IMAGES} images</div>
    `;
    preview.style.display = 'block';
    $$('.image-thumb-remove').forEach(btn => {
      btn.addEventListener('click', () => removeAnalysisImage(parseInt(btn.dataset.id)));
    });
  }
  
  async function runAnalysis() {
    if (state.analysisImages.length === 0) return;
    $('analyzeBtn').disabled = true;
    $('analysisLoading').style.display = 'block';
    $('analysisResults').innerHTML = '';
    startAnalysisTimer();
    
    const typeNames = { lab: 'Laboratory Results', xray: 'X-Ray', ct: 'CT/MRI Scan', ecg: 'ECG' };
    
    try {
      const response = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          action: 'interpret',
          documentType: state.analysisType,
          images: state.analysisImages.map(img => ({ data: img.data })),
          image: state.analysisImages[0].data,
          multiImage: state.analysisImages.length > 1
        })
      });
      const data = await response.json();
      stopAnalysisTimer();
      $('analysisLoading').style.display = 'none';
      $('analyzeBtn').disabled = false;
      
      if (data.error) {
        $('analysisResults').innerHTML = `<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>${escapeHtml(data.error)}</p></div>`;
        return;
      }
      
      let html = `<div class="result-card"><h4>üìã ${typeNames[state.analysisType]} Analysis</h4>`;
      html += `<div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:10px">Completed in ${analysisSeconds}s</div>`;
      if (data.interpretation) {
        const interp = data.interpretation;
        if (interp.summary) html += `<p><b>Summary:</b> ${escapeHtml(interp.summary)}</p>`;
        if (interp.keyFindings && interp.keyFindings.length) {
          html += '<p><b>Key Findings:</b></p><ul>' + interp.keyFindings.map(f => `<li>${escapeHtml(f)}</li>`).join('') + '</ul>';
        }
        if (interp.abnormalities && interp.abnormalities.length) {
          html += '<p><b class="abnormal">Abnormalities:</b></p><ul>' + interp.abnormalities.map(a => `<li class="abnormal">${escapeHtml(a)}</li>`).join('') + '</ul>';
        }
      }
      html += '</div>';
      $('analysisResults').innerHTML = html;
      toast('Analysis complete in ' + analysisSeconds + 's!');
    } catch (error) {
      stopAnalysisTimer();
      $('analysisLoading').style.display = 'none';
      $('analyzeBtn').disabled = false;
      $('analysisResults').innerHTML = '<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>Connection failed. Try again.</p></div>';
    }
  }

  // ========== IMPORT ==========
  function openImport() {
    state.importImage = null;
    state.importPatients = [];
    $('importUpload').style.display = 'block';
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'none';
    $('importResults').style.display = 'none';
    $('importError').style.display = 'none';
    $('importConfirmBtn').disabled = true;
    $('importFile').value = '';
    openModal('importModal');
  }
  
  function resetImport() {
    state.importImage = null;
    state.importPatients = [];
    $('importUpload').style.display = 'block';
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'none';
    $('importResults').style.display = 'none';
    $('importError').style.display = 'none';
    $('importConfirmBtn').disabled = true;
  }
  
  function handleImportFile(file) {
    compressImage(file, CONFIG.MAX_IMAGE_SIZE, dataUrl => {
      state.importImage = dataUrl;
      $('importImg').src = dataUrl;
      $('importUpload').style.display = 'none';
      $('importPreview').style.display = 'block';
    });
  }
  
  async function extractPatients() {
    if (!state.importImage) return;
    $('importPreview').style.display = 'none';
    $('importLoading').style.display = 'block';
    
    try {
      const response = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'extractPatients', image: state.importImage })
      });
      const data = await response.json();
      $('importLoading').style.display = 'none';
      
      if (data.error) { showImportError(data.error); return; }
      
      let pts = data.patients || [];
      if (!pts.length && data.extractedText) {
        try { const match = data.extractedText.match(/\[[\s\S]*\]/); if (match) pts = JSON.parse(match[0]); } catch (e) {}
      }
      if (!pts.length) { showImportError('No patients found.'); return; }
      
      state.importPatients = pts.map((p, i) => ({
        id: Date.now() + i,
        name: (p.name || 'Unknown').trim(),
        room: (p.room || p.bed || '‚Äî').trim(),
        diagnosis: (p.diagnosis || p.condition || 'Pending').trim(),
        status: normalizeStatus(p.status),
        doctor: p.doctor || (state.currentUser ? state.currentUser.name : 'Unassigned')
      })).filter(p => p.name && p.name !== 'Unknown');
      
      if (!state.importPatients.length) { showImportError('No valid patient data.'); return; }
      showImportResults();
    } catch (error) {
      $('importLoading').style.display = 'none';
      showImportError('Connection failed.');
    }
  }
  
  function normalizeStatus(status) {
    if (!status) return 'active';
    const s = String(status).toLowerCase();
    if (s.match(/critical|icu|urgent/)) return 'critical';
    if (s.match(/chronic|stable/)) return 'chronic';
    return 'active';
  }
  
  function showImportError(msg) {
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = msg;
  }
  
  function showImportResults() {
    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.slice(0, 8).map(p => `
      <div class="import-patient ${p.status === 'critical' ? 'critical' : ''}">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:8px;display:grid;place-items:center;font-weight:600;font-size:0.75rem;color:var(--bg)">${initials(p.name)}</div>
        <div style="flex:1"><div style="font-weight:600;font-size:0.85rem">${escapeHtml(p.name)}</div><div style="font-size:0.7rem;color:var(--text-muted)">Room ${escapeHtml(p.room)}</div></div>
      </div>
    `).join('') + (state.importPatients.length > 8 ? `<div style="text-align:center;padding:8px;font-size:0.8rem;color:var(--text-muted)">+${state.importPatients.length - 8} more</div>` : '');
    $('importConfirmBtn').disabled = false;
    toast('Found ' + state.importPatients.length + ' patients!');
  }
  
  function confirmImport() {
    if (!state.importPatients.length) return;
    let added = 0;
    state.importPatients.forEach(p => {
      const exists = state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase());
      if (!exists) { state.patients.push(p); added++; }
    });
    saveStorage();
    renderPatients();
    closeModal('importModal');
    toast('Imported ' + added + ' patients!');
  }

  // ========== EVENT LISTENERS ==========
  function initEventListeners() {
    // Admin
    $('adminFab').addEventListener('click', openAdminLogin);
    $('adminLoginBtn').addEventListener('click', loginAdmin);
    $('adminCancelBtn').addEventListener('click', () => closeModal('adminModal'));
    $('adminPwd').addEventListener('keydown', e => { if (e.key === 'Enter') loginAdmin(); });
    $('exitAdminBtn').addEventListener('click', exitAdmin);
    $('addUnitBtn').addEventListener('click', addUnit);
    $('unitSaveBtn').addEventListener('click', saveUnit);
    $('unitCancelBtn').addEventListener('click', () => closeModal('unitModal'));
    $('saveSettingsBtn').addEventListener('click', saveSettings);
    
    // Sync button
    $('syncFab').addEventListener('click', async () => {
      $('syncFab').classList.add('syncing');
      await forceSync();
      renderUnits();
      $('syncFab').classList.remove('syncing');
    });
    
    // Unit access
    $('accessCancelBtn').addEventListener('click', () => closeModal('accessModal'));
    $('enterBtn').addEventListener('click', enterUnit);
    $('userName').addEventListener('keydown', e => { if (e.key === 'Enter') enterUnit(); });
    
    // Dashboard
    $('logoutBtn').addEventListener('click', logout);
    $('tabs').addEventListener('click', e => {
      const tab = e.target.closest('.tab');
      if (tab) showTab(tab.dataset.tab);
    });
    
    // Patients
    $('addPatientBtn').addEventListener('click', openAddPatient);
    $('patientSaveBtn').addEventListener('click', savePatient);
    $('patientCancelBtn').addEventListener('click', () => closeModal('patientModal'));
    
    // Import
    $('importBtn').addEventListener('click', openImport);
    $('importDropzone').addEventListener('click', () => $('importFile').click());
    $('importFile').addEventListener('change', function() { if (this.files[0]) handleImportFile(this.files[0]); });
    $('importChangeBtn').addEventListener('click', resetImport);
    $('importExtractBtn').addEventListener('click', extractPatients);
    $('importRetryBtn').addEventListener('click', resetImport);
    $('importCancelBtn').addEventListener('click', () => closeModal('importModal'));
    $('importConfirmBtn').addEventListener('click', confirmImport);
    
    // Analysis
    $('uploadZone').addEventListener('click', () => $('analysisFile').click());
    $('analysisFile').addEventListener('change', function() {
      Array.from(this.files).forEach(f => { if (f.type.startsWith('image/')) addAnalysisImage(f); });
      this.value = '';
    });
    $('analysisTypes').addEventListener('click', e => {
      const type = e.target.closest('.analysis-type');
      if (type) {
        state.analysisType = type.dataset.type;
        $$('.analysis-type').forEach(t => t.classList.remove('active'));
        type.classList.add('active');
      }
    });
    $('analyzeBtn').addEventListener('click', runAnalysis);
    
    // Modal close on background click
    $$('.modal').forEach(m => {
      m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });
  }

  // ========== INITIALIZATION ==========
  async function init() {
    console.log('[MedWard] Initializing...');
    await loadStorage();
    renderUnits();
    initEventListeners();
    console.log('[MedWard] Ready - Units:', state.units.length);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
