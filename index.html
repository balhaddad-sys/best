<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#060a13">
<title>MedWard Enterprise</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#060a13;--bg-card:#0d1424;--bg-elevated:#111b2e;--text:#f8fafc;--text-muted:#64748b;--gold:#d4a437;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--lime:#84cc16;--orange:#f97316;--border:rgba(148,163,184,0.12);--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:none;border-radius:var(--radius);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:active{transform:scale(0.98)}
.btn-primary{background:linear-gradient(135deg,var(--gold),#fbbf24);color:#000}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text)}
.btn-danger{background:rgba(244,63,94,0.15);border:1px solid var(--rose);color:var(--rose)}
.btn-export{background:rgba(16,185,129,0.15);border:1px solid var(--emerald);color:var(--emerald)}
.btn-sm{padding:10px 16px;font-size:0.85rem}
.btn-xs{padding:6px 12px;font-size:0.75rem}
.btn-full{width:100%}
.btn-icon{width:44px;height:44px;padding:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;color:var(--text-muted);cursor:pointer;display:grid;place-items:center}
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px;background:#0f172a;border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:inherit;font-size:0.95rem}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--gold)}
.form-textarea{min-height:90px;resize:vertical}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;border-bottom:1px solid var(--border)}
.modal-title{font-size:1.1rem;font-weight:700}
.modal-body{padding:20px}
.modal-footer{padding:16px 20px;display:flex;gap:12px}
.modal-footer .btn{flex:1}
#landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
#landing.hidden{display:none}
.landing-logo{width:80px;height:80px;background:linear-gradient(135deg,var(--gold),#fbbf24);border-radius:20px;display:grid;place-items:center;margin-bottom:24px}
.landing-logo svg{width:44px;height:44px;stroke:#000;stroke-width:2.5;fill:none}
.landing-title{font-size:1.8rem;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.landing-subtitle{color:var(--text-muted);margin-bottom:40px}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;width:100%;max-width:800px}
.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold))}
.unit-card:hover{border-color:var(--unit-color);transform:translateY(-2px)}
.unit-card-icon{font-size:2rem;margin-bottom:12px}
.unit-card-name{font-size:1.05rem;font-weight:600}
.unit-card-desc{color:var(--text-muted);font-size:0.8rem}
.fab{position:fixed;width:52px;height:52px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50}
.fab svg{width:22px;height:22px}
.fab:hover{border-color:var(--gold);color:var(--gold)}
.admin-fab{bottom:24px;right:24px}
.sync-fab{bottom:24px;left:24px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
@keyframes rotate{to{transform:rotate(360deg)}}
.code-inputs{display:flex;gap:12px;justify-content:center;margin-bottom:16px}
.code-digit{width:52px;height:60px;background:var(--bg-elevated);border:2px solid var(--border);border-radius:var(--radius);font-family:monospace;font-size:1.6rem;font-weight:700;text-align:center;color:var(--text)}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
.code-digit.success{border-color:var(--emerald)}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none}
.code-error.show{display:block}
#dashboard{display:none;min-height:100vh;padding-bottom:80px}
#dashboard.active{display:block}
.dash-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.dash-logo{display:flex;align-items:center;gap:12px}
.dash-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),#fbbf24);border-radius:10px;display:grid;place-items:center}
.dash-logo-icon svg{width:22px;height:22px;stroke:#000;fill:none}
.dash-badge{padding:6px 14px;border-radius:100px;font-size:0.8rem;font-weight:600}
.dash-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.85rem}
.dash-content{max-width:900px;margin:0 auto;padding:16px}
.date-header{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:14px 18px;border-radius:var(--radius);margin-bottom:16px;font-weight:700}
.tabs{display:flex;gap:4px;background:var(--bg-card);border-radius:var(--radius);padding:4px;margin-bottom:16px}
.tab{flex:1;padding:12px;background:transparent;border:none;border-radius:8px;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg-elevated);color:var(--gold)}
.panel{display:none}
.panel.active{display:block}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
.stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 8px;text-align:center;cursor:pointer}
.stat:hover,.stat.active{border-color:var(--gold);background:rgba(212,164,55,0.1)}
.stat-value{font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase}
.action-bar{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.ward-group{margin-bottom:20px}
.ward-header{background:var(--bg-elevated);padding:12px 16px;border-radius:10px;margin-bottom:12px;font-weight:600;font-size:0.9rem;display:flex;justify-content:space-between;color:var(--gold);border-left:4px solid var(--gold)}
.ward-count{background:var(--gold);color:#000;padding:3px 12px;border-radius:100px;font-size:0.75rem}
.patient{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;border-left:4px solid var(--teal);margin-bottom:10px}
.patient.critical{border-left-color:var(--rose);background:rgba(244,63,94,0.05)}
.patient.chronic{border-left-color:var(--purple)}
.patient.new{border-left-color:var(--lime);background:rgba(132,204,22,0.08)}
.patient-header{display:flex;align-items:center;gap:14px;margin-bottom:10px}
.patient-avatar{width:44px;height:44px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:0.85rem;color:#000}
.patient.new .patient-avatar{background:linear-gradient(135deg,var(--lime),var(--emerald))}
.patient.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}
.patient.critical .patient-avatar{background:linear-gradient(135deg,var(--rose),var(--orange))}
.patient-info{flex:1}
.patient-name{font-weight:600;font-size:1rem;display:flex;align-items:center;gap:8px}
.new-badge{background:var(--lime);color:#000;padding:2px 8px;border-radius:4px;font-size:0.6rem;font-weight:700}
.patient-meta{font-size:0.75rem;color:var(--text-muted);display:flex;gap:10px;margin-top:3px}
.patient-status{padding:5px 12px;border-radius:100px;font-size:0.65rem;font-weight:600;text-transform:uppercase}
.patient-status.active{background:rgba(20,184,166,0.15);color:var(--teal)}
.patient-status.critical{background:rgba(244,63,94,0.15);color:var(--rose)}
.patient-status.chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
.patient-status.new{background:rgba(132,204,22,0.15);color:var(--lime)}
.patient-dx{font-size:0.85rem;color:#94a3b8;padding:12px;background:var(--bg-elevated);border-radius:10px;margin:12px 0}
.patient-actions{display:flex;gap:8px}
.patient-actions .btn{flex:1}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px}
.card-header{padding:16px;border-bottom:1px solid var(--border);font-weight:600}
.card-body{padding:16px}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 20px;text-align:center;cursor:pointer}
.upload-zone:hover{border-color:var(--gold);background:rgba(212,164,55,0.1)}
.analysis-types{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:20px}
.analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;cursor:pointer}
.analysis-type.active{border-color:var(--gold);background:rgba(212,164,55,0.15)}
.analysis-type-icon{font-size:1.5rem}
.analysis-type-name{font-size:0.75rem;font-weight:600;margin-top:6px}
.result-card{background:var(--bg-elevated);border-radius:var(--radius);padding:18px;margin-top:16px}
.result-card h4{font-size:0.9rem;margin-bottom:12px;color:var(--gold)}
.result-card p,.result-card li{font-size:0.85rem;color:#94a3b8}
.result-card ul{padding-left:18px}
.abnormal{color:var(--rose)!important}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg-elevated);border-radius:10px;padding:16px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.8rem;color:#94a3b8}
#adminPanel{display:none;min-height:100vh}
#adminPanel.active{display:block}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;justify-content:space-between}
.admin-content{max-width:700px;margin:0 auto;padding:20px}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px}
.admin-section-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.admin-section-body{padding:16px}
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:14px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}
.import-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-elevated);border-radius:10px;margin-bottom:10px;border-left:4px solid var(--teal)}
.import-item.chronic{border-left-color:var(--purple)}
.import-item-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.75rem;color:#000}
.import-item-info{flex:1}
.import-item-name{font-weight:600;font-size:0.85rem}
.import-item-meta{font-size:0.7rem;color:var(--text-muted)}
.import-ward-select{padding:6px 10px;background:var(--bg-card);border:1px solid var(--gold);border-radius:6px;color:var(--gold);font-size:0.7rem;font-weight:600;cursor:pointer}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg-card);border:1px solid var(--emerald);padding:14px 24px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state-icon{font-size:3rem;margin-bottom:16px;opacity:0.5}
.image-gallery{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
.image-thumb{position:relative;width:80px;height:80px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.image-thumb img{width:100%;height:100%;object-fit:cover}
.image-thumb-remove{position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,0.8);border:none;color:white;font-size:12px;cursor:pointer}
@media(max-width:600px){.stats{grid-template-columns:repeat(3,1fr)}.patient-actions{flex-direction:column}}
</style>
</head>
<body>
<div id="landing">
<div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
<h1 class="landing-title">MedWard Enterprise</h1>
<p class="landing-subtitle">Select your unit</p>
<div class="units-grid" id="unitsGrid"></div>
<div class="fab sync-fab" id="syncFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/></svg></div>
<div class="fab admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>
<div class="modal" id="accessModal"><div class="modal-box"><div class="modal-header" style="text-align:center"><div id="accessIcon" style="font-size:2.5rem;margin-bottom:10px">üè•</div><div class="modal-title" id="accessTitle">Unit</div><p style="color:var(--text-muted);font-size:0.85rem;margin-top:6px">Enter 4-digit code</p></div><div class="modal-body"><div class="code-inputs" id="codeInputs"></div><p class="code-error" id="codeError">Invalid code</p><div id="userSection" style="display:none;margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input" placeholder="Dr. Name"></div><div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button><button class="btn btn-primary" id="enterBtn" style="display:none" onclick="enterUnit()">Enter</button></div></div></div>
<div class="modal" id="adminModal"><div class="modal-box"><div class="modal-header" style="text-align:center"><div style="font-size:2.5rem;margin-bottom:10px">‚öôÔ∏è</div><div class="modal-title">Admin</div></div><div class="modal-body"><div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input"></div><p class="code-error" id="adminError">Invalid</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button><button class="btn btn-primary" onclick="loginAdmin()">Login</button></div></div></div>
<div id="adminPanel"><header class="admin-header"><div style="display:flex;align-items:center;gap:10px"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span style="font-weight:700">Admin</span></div><button class="btn btn-secondary btn-sm" onclick="exitAdmin()">Exit</button></header><div class="admin-content"><div class="admin-section"><div class="admin-section-header"><span>üè• Units</span><button class="btn btn-primary btn-sm" onclick="addUnit()">+ Add</button></div><div class="admin-section-body" style="padding:0"><table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTable"></tbody></table></div></div><div class="admin-section"><div class="admin-section-header"><span>‚öôÔ∏è Settings</span></div><div class="admin-section-body"><div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input"></div><div class="form-group"><label class="form-label">API URL</label><input type="text" id="apiUrl" class="form-input"></div><button class="btn btn-primary" onclick="saveSettings()">Save</button></div></div></div></div>
<div id="dashboard"><header class="dash-header"><div class="dash-logo"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span class="dash-badge" id="unitBadge">Unit</span></div><div style="display:flex;gap:12px"><div class="dash-avatar" id="dashAvatar">DR</div><button class="btn-icon" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button></div></header><div class="dash-content"><div class="date-header">üìÖ <span id="currentDate"></span></div><div class="tabs" id="mainTabs"><button class="tab active" data-tab="patients">üë• Patients</button><button class="tab" data-tab="analysis">üî¨ Analysis</button><button class="tab" data-tab="reference">üìö Reference</button></div><div class="panel active" id="panelPatients"><div class="stats" id="statsBar"><div class="stat active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div><div class="stat" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div><div class="stat" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div><div class="stat" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div><div class="stat" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div></div><div class="action-bar"><button class="btn btn-primary btn-sm btn-full" onclick="openAddPatient()">‚ûï Add Patient</button><button class="btn btn-secondary btn-sm btn-full" onclick="openImport()">üì• Import from Screenshot</button><button class="btn btn-export btn-sm btn-full" onclick="exportPDF()">üìÑ Export PDF</button></div><div id="patientsList"></div></div><div class="panel" id="panelAnalysis"><div class="card"><div class="card-header">üî¨ AI Analysis</div><div class="card-body"><div class="upload-zone" onclick="document.getElementById('analysisFile').click()"><div style="font-size:2.5rem;margin-bottom:12px">üì§</div><div style="font-weight:600">Upload Image</div></div><input type="file" id="analysisFile" accept="image/*" style="display:none"><div class="analysis-types"><div class="analysis-type active" data-type="lab"><div class="analysis-type-icon">üß™</div><div class="analysis-type-name">Labs</div></div><div class="analysis-type" data-type="xray"><div class="analysis-type-icon">ü©ª</div><div class="analysis-type-name">X-Ray</div></div><div class="analysis-type" data-type="ct"><div class="analysis-type-icon">üß†</div><div class="analysis-type-name">CT/MRI</div></div><div class="analysis-type" data-type="ecg"><div class="analysis-type-icon">üíì</div><div class="analysis-type-name">ECG</div></div></div><div id="analysisPreview" style="display:none;margin-top:20px"></div></div></div><button class="btn btn-primary btn-full" id="analyzeBtn" onclick="runAnalysis()" disabled>ü§ñ Analyze</button><div id="analysisLoading" style="display:none;text-align:center;padding:40px"><div class="spinner"></div><div style="margin-top:16px;color:var(--text-muted)">Analyzing...</div></div><div id="analysisResults"></div></div><div class="panel" id="panelReference"><div class="card"><div class="card-header">üìö Quick Reference</div><div class="card-body"><div class="ref-grid" id="refGrid"></div></div></div></div></div></div>
<div class="modal" id="patientModal"><div class="modal-box"><div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div><div class="modal-body"><input type="hidden" id="ptId"><div class="form-group"><label class="form-label">Name</label><input type="text" id="ptName" class="form-input"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:14px"><div class="form-group"><label class="form-label">Ward</label><select id="ptWard" class="form-select"><option value="Ward 14">Ward 14</option><option value="Ward 22">Ward 22</option><option value="Ward 27">Ward 27</option><option value="ICU">ICU</option><option value="ER/Unassigned">ER/Unassigned</option></select></div><div class="form-group"><label class="form-label">Room</label><input type="text" id="ptRoom" class="form-input" placeholder="e.g. 11-1"></div></div><div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:14px"><div class="form-group"><label class="form-label">Doctor</label><input type="text" id="ptDoctor" class="form-input"></div><div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">üÜï New</option><option value="active">‚úÖ Active</option><option value="critical">üö® Critical</option><option value="chronic">üíú Chronic</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button><button class="btn btn-primary" onclick="savePatient()">Save</button></div></div></div>
<div class="modal" id="unitModal"><div class="modal-box"><div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div><div class="modal-body"><div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:14px"><div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="üè•" style="font-size:1.5rem;text-align:center"></div><div class="form-group"><label class="form-label">Code</label><input type="text" id="uCode" class="form-input" maxlength="4"></div></div><div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button><button class="btn btn-primary" onclick="saveUnit()">Save</button></div></div></div>
<div class="modal" id="importModal"><div class="modal-box" style="max-width:560px"><div class="modal-header"><div class="modal-title">üì• Import Patients</div><p style="color:var(--text-muted);font-size:0.8rem;margin-top:4px">Tap ward dropdown to correct if needed</p></div><div class="modal-body"><div id="importUpload"><div class="upload-zone" onclick="document.getElementById('importFile').click()"><div style="font-size:2rem;margin-bottom:10px">üì∑</div><div style="font-weight:600">Upload Screenshot</div></div><input type="file" id="importFile" accept="image/*" style="display:none"></div><div id="importPreview" style="display:none"><img id="importImg" style="width:100%;max-height:150px;object-fit:contain;border-radius:10px;margin-bottom:14px"><div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" style="flex:1" onclick="resetImport()">Change</button><button class="btn btn-primary btn-sm" style="flex:2" onclick="extractPatients()">ü§ñ Extract</button></div></div><div id="importLoading" style="display:none;text-align:center;padding:40px"><div class="spinner"></div><div style="margin-top:16px;color:var(--text-muted)">Extracting...</div></div><div id="importResults" style="display:none"><div style="display:flex;justify-content:space-between;margin-bottom:14px"><span style="font-weight:600">‚úì Found</span><span id="importCount" style="background:var(--emerald);color:white;padding:4px 14px;border-radius:100px;font-size:0.8rem">0</span></div><div id="importList" style="max-height:350px;overflow-y:auto"></div></div><div id="importError" style="display:none;text-align:center;padding:30px"><div style="font-size:2rem;margin-bottom:12px">‚ö†Ô∏è</div><div id="importErrorMsg" style="color:var(--rose);margin-bottom:16px">Error</div><button class="btn btn-secondary btn-sm" onclick="resetImport()">Try Again</button></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button><button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>Import All</button></div></div></div>
<div class="toast" id="toast"></div>
<script>
(function(){
'use strict';
const CONFIG={STORAGE_KEY:'medward_v7',ADMIN_PASSWORD:'admin123',API_URL:'https://script.google.com/macros/s/AKfycbwnPMayEKM6rHJB2qZ-DDECoVB4Kte1EcoBiea0pmcasfyAeW7RGeADiH5DMXGRJOSJ/exec',MAX_IMAGE_SIZE:1200000,IMAGE_QUALITY:0.75,MAX_DIM:1600,VALID_WARDS:['Ward 14','Ward 22','Ward 27','ICU','ER/Unassigned']};
const REFS=[{title:'üö® Critical Labs',content:'<b>K:</b> <2.5/>6.5 <b>Na:</b> <120/>160 <b>Gluc:</b> <40/>500'},{title:'‚ö° Hyperkalemia',content:'<b>Stabilize:</b> Ca gluconate<br><b>Shift:</b> Insulin+D50'},{title:'‚ù§Ô∏è ACS',content:'<b>MONA:</b> Morphine,O‚ÇÇ,Nitrates,ASA'},{title:'üß† Stroke',content:'<b>tPA:</b> ‚â§4.5h, 0.9mg/kg'},{title:'ü¶† Sepsis',content:'<b>Hour-1:</b> Lactate,cultures,abx,fluids'},{title:'üíä Seizure',content:'<b>1st:</b> Lorazepam 4mg IV'}];
const state={units:[],settings:{},patients:[],currentUnit:null,currentUser:null,selectedUnitId:null,editingUnitId:null,analysisImages:[],analysisType:'lab',importImage:null,importPatients:[],currentFilter:'all'};
const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel);
function toast(m,e=false){const t=$('toast');t.textContent=m;t.className='toast show'+(e?' error':'');setTimeout(()=>t.className='toast',3000);}
function initials(n){if(!n)return'?';const p=n.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase();}
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function openModal(id){$(id).classList.add('active');}
function closeModal(id){$(id).classList.remove('active');}
window.closeModal=closeModal;
function formatDate(d){const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],months=['January','February','March','April','May','June','July','August','September','October','November','December'];d=d||new Date();const suf=[1,21,31].includes(d.getDate())?'st':[2,22].includes(d.getDate())?'nd':[3,23].includes(d.getDate())?'rd':'th';return`${days[d.getDay()]}, ${d.getDate()}${suf} ${months[d.getMonth()]} ${d.getFullYear()}`;}
function compress(file,max,cb){const r=new FileReader();r.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas'),ctx=c.getContext('2d');let w=img.width,h=img.height,q=CONFIG.IMAGE_QUALITY;if(w>CONFIG.MAX_DIM||h>CONFIG.MAX_DIM){if(w>h){h=Math.round(h*CONFIG.MAX_DIM/w);w=CONFIG.MAX_DIM;}else{w=Math.round(w*CONFIG.MAX_DIM/h);h=CONFIG.MAX_DIM;}}c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);let url=c.toDataURL('image/jpeg',q);while(url.length>max&&q>0.3){q-=0.1;url=c.toDataURL('image/jpeg',q);}cb(url);};img.src=e.target.result;};r.readAsDataURL(file);}
function smartWard(raw){if(!raw)return'Ward 14';const w=String(raw).toLowerCase();if(w.includes('14'))return'Ward 14';if(w.includes('22'))return'Ward 22';if(w.includes('27'))return'Ward 27';if(w.includes('icu'))return'ICU';if(w.includes('er')||w.includes('unassign'))return'ER/Unassigned';if(/^\d+-\d+$/.test(w))return'Ward 14';return'Ward 14';}
let isSyncing=false;
function loadLocal(){try{const s=localStorage.getItem(CONFIG.STORAGE_KEY);if(s){const d=JSON.parse(s);if(d.units?.length)state.units=d.units;if(d.settings)state.settings={...state.settings,...d.settings};if(d.patients)state.patients=d.patients;}}catch(e){}if(!state.units.length)state.units=[{id:'med-e',name:'Medicine Unit E',icon:'üè•',desc:'Internal Medicine',code:'1234',color:'#14b8a6'}];state.settings.adminPassword=state.settings.adminPassword||CONFIG.ADMIN_PASSWORD;state.settings.apiUrl=state.settings.apiUrl||CONFIG.API_URL;}
function saveLocal(){try{localStorage.setItem(CONFIG.STORAGE_KEY,JSON.stringify({units:state.units,settings:state.settings,patients:state.patients,lastUpdated:new Date().toISOString()}));}catch(e){}}
async function syncCloud(){if(isSyncing)return;isSyncing=true;try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'loadData'})});const data=await res.json();if(data.success&&data.data){if(data.data.units?.length)state.units=data.data.units;if(data.data.settings)state.settings={...state.settings,...data.data.settings};if(data.data.patients)state.patients=data.data.patients;saveLocal();if(state.currentUnit)renderPatients();else renderUnits();}}catch(e){}isSyncing=false;}
async function saveCloud(){saveLocal();try{await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'saveData',payload:{units:state.units,settings:{adminPassword:state.settings.adminPassword},patients:state.patients,lastUpdated:new Date().toISOString()}})});}catch(e){}}
function getUnit(id){return state.units.find(u=>u.id===id);}
function renderUnits(){$('unitsGrid').innerHTML=state.units.map(u=>`<div class="unit-card" style="--unit-color:${u.color||'#d4a437'}" data-id="${u.id}"><div class="unit-card-icon">${u.icon||'üè•'}</div><div class="unit-card-name">${esc(u.name)}</div><div class="unit-card-desc">${esc(u.desc||'')}</div></div>`).join('');$$('.unit-card').forEach(c=>c.addEventListener('click',()=>openUnitAccess(c.dataset.id)));}
function renderUnitsTable(){$('unitsTable').innerHTML=state.units.map(u=>`<tr><td>${u.icon} <b>${esc(u.name)}</b></td><td><code style="background:var(--bg-elevated);padding:4px 10px;border-radius:6px">${u.code}</code></td><td><button class="btn-icon" onclick="editUnit('${u.id}')" style="width:36px;height:36px">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteUnit('${u.id}')" style="width:36px;height:36px">üóëÔ∏è</button></td></tr>`).join('')||'<tr><td colspan="3" style="text-align:center;padding:30px">No units</td></tr>';}
function renderPatients(){const c=$('patientsList'),f=state.currentFilter,pts=[...state.patients];let filtered=f==='all'?pts:pts.filter(p=>p.status===f);const wards={};filtered.forEach(p=>{const w=p.ward||'Unassigned';if(!wards[w])wards[w]=[];wards[w].push(p);});if(!filtered.length){c.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üë•</div><div>No patients${f!=='all'?` with "${f}" status`:''}</div></div>`;updateStats();return;}const order=['Ward 14','Ward 22','Ward 27','ICU','ER/Unassigned','Unassigned'];const sorted=Object.keys(wards).sort((a,b)=>{const ai=order.indexOf(a),bi=order.indexOf(b);if(ai===-1&&bi===-1)return a.localeCompare(b);if(ai===-1)return 1;if(bi===-1)return -1;return ai-bi;});let h='';sorted.forEach(ward=>{const ps=wards[ward];h+=`<div class="ward-group"><div class="ward-header"><span>üìç ${esc(ward)}</span><span class="ward-count">${ps.length}</span></div>`;ps.forEach(p=>{h+=`<div class="patient ${p.status}"><div class="patient-header"><div class="patient-avatar">${initials(p.name)}</div><div class="patient-info"><div class="patient-name">${esc(p.name)}${p.status==='new'?' <span class="new-badge">New</span>':''}</div><div class="patient-meta"><span>üõèÔ∏è ${esc(p.room||'‚Äî')}</span><span>üë®‚Äç‚öïÔ∏è ${esc(p.doctor||'‚Äî')}</span></div></div><span class="patient-status ${p.status}">${p.status}</span></div><div class="patient-dx">${esc(p.diagnosis||'Pending')}</div><div class="patient-actions"><button class="btn btn-secondary btn-xs" onclick="editPatient(${p.id})">‚úèÔ∏è Edit</button><button class="btn btn-danger btn-xs" onclick="deletePatient(${p.id})">üóëÔ∏è Delete</button></div></div>`;});h+='</div>';});c.innerHTML=h;updateStats();}
function updateStats(){const a=state.patients;$('statTotal').textContent=a.length;$('statNew').textContent=a.filter(p=>p.status==='new').length;$('statActive').textContent=a.filter(p=>p.status==='active').length;$('statCritical').textContent=a.filter(p=>p.status==='critical').length;$('statChronic').textContent=a.filter(p=>p.status==='chronic').length;$$('.stat').forEach(s=>s.classList.toggle('active',s.dataset.filter===state.currentFilter));}
function renderRef(){$('refGrid').innerHTML=REFS.map(r=>`<div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>`).join('');}
function openUnitAccess(id){const u=getUnit(id);if(!u)return;state.selectedUnitId=id;$('accessIcon').textContent=u.icon;$('accessTitle').textContent=u.name;$('codeError').classList.remove('show');$('userSection').style.display='none';$('enterBtn').style.display='none';$('codeInputs').innerHTML=[0,1,2,3].map(i=>`<input type="tel" class="code-digit" maxlength="1" data-idx="${i}" inputmode="numeric">`).join('');const inputs=$$('.code-digit');inputs.forEach((inp,idx)=>{inp.addEventListener('input',()=>{inp.value=inp.value.replace(/\D/g,'');if(inp.value&&idx<3)inputs[idx+1].focus();const code=Array.from(inputs).map(i=>i.value).join('');if(code.length===4){if(code===u.code){inputs.forEach(i=>{i.classList.add('success');i.disabled=true;});$('userSection').style.display='block';$('enterBtn').style.display='flex';$('userName').focus();}else{$('codeError').classList.add('show');inputs.forEach(i=>i.classList.add('error'));setTimeout(()=>{inputs.forEach(i=>{i.classList.remove('error');i.value='';});inputs[0].focus();},500);}}});inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&idx>0)inputs[idx-1].focus();});});openModal('accessModal');setTimeout(()=>inputs[0].focus(),100);}
window.enterUnit=function(){const n=$('userName').value.trim();if(!n){toast('Enter name',true);return;}state.currentUnit=getUnit(state.selectedUnitId);state.currentUser={name:n,role:$('userRole').value};closeModal('accessModal');showDash();};
function showDash(){const u=state.currentUnit;$('landing').classList.add('hidden');$('dashboard').classList.add('active');$('unitBadge').textContent=u.name;$('unitBadge').style.cssText=`border:1px solid ${u.color};color:${u.color};background:${u.color}20`;$('dashAvatar').textContent=initials(state.currentUser.name);$('currentDate').textContent=formatDate();renderPatients();renderRef();toast(`Welcome!`);}
window.logout=function(){state.currentUnit=null;state.currentUser=null;state.currentFilter='all';$('dashboard').classList.remove('active');$('landing').classList.remove('hidden');};
function showTab(t){$$('.tab').forEach(x=>x.classList.remove('active'));document.querySelector(`.tab[data-tab="${t}"]`).classList.add('active');$$('.panel').forEach(p=>p.classList.remove('active'));$('panel'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');}
window.openAdminLogin=function(){$('adminPwd').value='';$('adminError').classList.remove('show');openModal('adminModal');setTimeout(()=>$('adminPwd').focus(),100);};
window.loginAdmin=function(){if($('adminPwd').value===state.settings.adminPassword){closeModal('adminModal');showAdmin();}else $('adminError').classList.add('show');};
function showAdmin(){$('landing').classList.add('hidden');$('adminPanel').classList.add('active');$('apiUrl').value=state.settings.apiUrl||'';renderUnitsTable();}
window.exitAdmin=function(){$('adminPanel').classList.remove('active');$('landing').classList.remove('hidden');};
window.addUnit=function(){state.editingUnitId=null;$('unitModalTitle').textContent='Add Unit';$('uName').value='';$('uIcon').value='üè•';$('uCode').value='';$('uDesc').value='';openModal('unitModal');};
window.editUnit=function(id){const u=getUnit(id);if(!u)return;state.editingUnitId=id;$('unitModalTitle').textContent='Edit';$('uName').value=u.name;$('uIcon').value=u.icon;$('uCode').value=u.code;$('uDesc').value=u.desc||'';openModal('unitModal');};
window.saveUnit=function(){const name=$('uName').value.trim(),icon=$('uIcon').value.trim()||'üè•',code=$('uCode').value.trim(),desc=$('uDesc').value.trim();if(!name||!/^\d{4}$/.test(code)){toast('Invalid',true);return;}if(state.editingUnitId){const i=state.units.findIndex(u=>u.id===state.editingUnitId);if(i!==-1)state.units[i]={...state.units[i],name,icon,code,desc};}else{state.units.push({id:'u'+Date.now(),name,icon,code,desc,color:['#d4a437','#14b8a6','#3b82f6','#a855f7','#ef4444'][state.units.length%5]});}saveCloud();renderUnitsTable();renderUnits();closeModal('unitModal');toast('Saved!');};
window.deleteUnit=function(id){if(!confirm('Delete?'))return;state.units=state.units.filter(u=>u.id!==id);saveCloud();renderUnitsTable();renderUnits();toast('Deleted');};
window.saveSettings=function(){const p=$('newAdminPwd').value.trim(),u=$('apiUrl').value.trim();if(p)state.settings.adminPassword=p;if(u)state.settings.apiUrl=u;saveCloud();toast('Saved!');$('newAdminPwd').value='';};
window.openAddPatient=function(){$('patientModalTitle').textContent='Add Patient';$('ptId').value='';$('ptName').value='';$('ptWard').value='Ward 14';$('ptRoom').value='';$('ptDx').value='';$('ptDoctor').value=state.currentUser?.name||'';$('ptStatus').value='new';openModal('patientModal');};
window.editPatient=function(id){const p=state.patients.find(x=>x.id===id);if(!p)return;$('patientModalTitle').textContent='Edit';$('ptId').value=p.id;$('ptName').value=p.name;$('ptWard').value=p.ward||'Ward 14';$('ptRoom').value=p.room||'';$('ptDx').value=p.diagnosis||'';$('ptDoctor').value=p.doctor||'';$('ptStatus').value=p.status||'active';openModal('patientModal');};
window.savePatient=function(){const id=$('ptId').value,name=$('ptName').value.trim(),ward=$('ptWard').value,room=$('ptRoom').value.trim()||'‚Äî',diagnosis=$('ptDx').value.trim()||'Pending',doctor=$('ptDoctor').value.trim()||'Unassigned',status=$('ptStatus').value;if(!name){toast('Name required',true);return;}if(id){const i=state.patients.findIndex(p=>p.id===parseInt(id));if(i!==-1)state.patients[i]={...state.patients[i],name,ward,room,diagnosis,doctor,status};}else{state.patients.push({id:Date.now(),name,ward,room,diagnosis,doctor,status});}saveCloud();renderPatients();closeModal('patientModal');toast('Saved!');};
window.deletePatient=function(id){if(!confirm('Delete?'))return;state.patients=state.patients.filter(p=>p.id!==id);saveCloud();renderPatients();toast('Deleted');};
window.exportPDF=function(){const pts=[...state.patients],f=state.currentFilter;let filtered=f==='all'?pts:pts.filter(p=>p.status===f);if(!filtered.length){toast('No patients',true);return;}const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});const u=state.currentUnit;const wards={};filtered.forEach(p=>{const w=p.ward||'Unassigned';if(!wards[w])wards[w]=[];wards[w].push(p);});doc.setFillColor(212,164,55);doc.rect(0,0,297,16,'F');doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(0);doc.text(u.name+' - Patient List',14,11);doc.setFontSize(9);doc.text(formatDate(),283,11,'right');doc.setTextColor(80);doc.text('Total: '+filtered.length,14,22);let y=28;const cols=[22,48,85,40,28],hdrs=['Room','Name','Diagnosis','Doctor','Status'];function drawHdr(yy){doc.setFillColor(255,140,0);doc.rect(14,yy,269,7,'F');doc.setFontSize(7);doc.setFont('helvetica','bold');doc.setTextColor(255);let x=14;hdrs.forEach((h,i)=>{doc.text(h,x+2,yy+5);x+=cols[i];});return yy+7;}function drawWard(yy,name,cnt){doc.setFillColor(0,128,0);doc.rect(14,yy,269,6,'F');doc.setFontSize(7);doc.setFont('helvetica','bold');doc.setTextColor(255);doc.text(name+' ('+cnt+')',16,yy+4.3);return yy+6;}y=drawHdr(y);const order=['Ward 14','Ward 22','Ward 27','ICU','ER/Unassigned','Unassigned'];Object.keys(wards).sort((a,b)=>{const ai=order.indexOf(a),bi=order.indexOf(b);if(ai===-1&&bi===-1)return a.localeCompare(b);if(ai===-1)return 1;if(bi===-1)return-1;return ai-bi;}).forEach(ward=>{const ps=wards[ward];if(y>185){doc.addPage();y=15;y=drawHdr(y);}y=drawWard(y,ward,ps.length);ps.forEach((p,idx)=>{if(y>190){doc.addPage();y=15;y=drawHdr(y);}if(p.status==='chronic')doc.setFillColor(230,220,250);else if(p.status==='new')doc.setFillColor(220,255,220);else if(p.status==='critical')doc.setFillColor(255,220,220);else doc.setFillColor(idx%2?250:255,idx%2?250:255,idx%2?250:255);doc.rect(14,y,269,6,'F');doc.setDrawColor(200);let x=14;cols.forEach(w=>{doc.rect(x,y,w,6);x+=w;});doc.setFontSize(6);doc.setFont('helvetica','normal');doc.setTextColor(30);x=14;const row=[p.room||'‚Äî',p.name||'',p.diagnosis||'',p.doctor||'',p.status.charAt(0).toUpperCase()+p.status.slice(1)];row.forEach((cell,i)=>{let txt=String(cell);const mw=cols[i]-3;if(doc.getTextWidth(txt)>mw)txt=txt.substring(0,Math.floor(mw/1.8))+'...';if(i===4){if(p.status==='chronic')doc.setTextColor(139,92,246);else if(p.status==='new')doc.setTextColor(34,197,94);else if(p.status==='critical')doc.setTextColor(239,68,68);else doc.setTextColor(20,184,166);doc.setFont('helvetica','bold');}doc.text(txt,x+1.5,y+4.2);doc.setTextColor(30);doc.setFont('helvetica','normal');x+=cols[i];});y+=6;});y+=2;});const pc=doc.internal.getNumberOfPages();for(let i=1;i<=pc;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150);doc.text('MedWard Enterprise',14,205);doc.text('Page '+i+'/'+pc,283,205,'right');}doc.save(u.name.replace(/\s+/g,'_')+'_'+new Date().toISOString().split('T')[0]+'.pdf');toast('Exported '+filtered.length+' patients!');};
function addAnalysisImage(file){if(state.analysisImages.length>=5)return;compress(file,CONFIG.MAX_IMAGE_SIZE,url=>{state.analysisImages.push({id:Date.now(),data:url});renderAnalysisImages();$('analyzeBtn').disabled=false;});}
window.removeAnalysisImage=function(id){state.analysisImages=state.analysisImages.filter(i=>i.id!==id);renderAnalysisImages();if(!state.analysisImages.length)$('analyzeBtn').disabled=true;};
function renderAnalysisImages(){const p=$('analysisPreview');if(!state.analysisImages.length){p.style.display='none';return;}p.innerHTML='<div class="image-gallery">'+state.analysisImages.map(i=>`<div class="image-thumb"><img src="${i.data}"><button class="image-thumb-remove" onclick="removeAnalysisImage(${i.id})">‚úï</button></div>`).join('')+'</div>';p.style.display='block';}
window.runAnalysis=async function(){if(!state.analysisImages.length)return;$('analyzeBtn').disabled=true;$('analysisLoading').style.display='block';$('analysisResults').innerHTML='';try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'interpret',documentType:state.analysisType,image:state.analysisImages[0].data})});const d=await res.json();$('analysisLoading').style.display='none';$('analyzeBtn').disabled=false;if(d.error){$('analysisResults').innerHTML=`<div class="result-card"><h4>‚ö†Ô∏è Error</h4><p>${esc(d.error)}</p></div>`;return;}let h='<div class="result-card"><h4>üìã Results</h4>';if(d.interpretation){const i=d.interpretation;if(i.summary)h+=`<p><b>Summary:</b> ${esc(i.summary)}</p>`;if(i.keyFindings?.length)h+='<ul>'+i.keyFindings.map(f=>`<li>${esc(f)}</li>`).join('')+'</ul>';if(i.abnormalities?.length)h+='<p class="abnormal"><b>Abnormal:</b></p><ul>'+i.abnormalities.map(a=>`<li class="abnormal">${esc(a)}</li>`).join('')+'</ul>';}h+='</div>';$('analysisResults').innerHTML=h;toast('Done!');}catch(e){$('analysisLoading').style.display='none';$('analyzeBtn').disabled=false;$('analysisResults').innerHTML='<div class="result-card"><h4>‚ö†Ô∏è</h4><p>Failed</p></div>';}};
window.openImport=function(){state.importImage=null;state.importPatients=[];$('importUpload').style.display='block';$('importPreview').style.display='none';$('importLoading').style.display='none';$('importResults').style.display='none';$('importError').style.display='none';$('importConfirmBtn').disabled=true;$('importFile').value='';openModal('importModal');};
window.resetImport=function(){state.importImage=null;state.importPatients=[];$('importUpload').style.display='block';$('importPreview').style.display='none';$('importLoading').style.display='none';$('importResults').style.display='none';$('importError').style.display='none';$('importConfirmBtn').disabled=true;};
function handleImportFile(file){compress(file,CONFIG.MAX_IMAGE_SIZE,url=>{state.importImage=url;$('importImg').src=url;$('importUpload').style.display='none';$('importPreview').style.display='block';});}
window.extractPatients=async function(){if(!state.importImage)return;$('importPreview').style.display='none';$('importLoading').style.display='block';try{const res=await fetch(state.settings.apiUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'extractPatients',image:state.importImage})});const d=await res.json();$('importLoading').style.display='none';if(!d.success||d.error){$('importError').style.display='block';$('importErrorMsg').textContent=d.error||'Failed';return;}if(!d.patients?.length){$('importError').style.display='block';$('importErrorMsg').textContent='No patients found';return;}state.importPatients=d.patients.map((p,i)=>({id:Date.now()+i,name:p.name,ward:smartWard(p.ward),room:p.room||'‚Äî',diagnosis:p.diagnosis||'Pending',doctor:p.doctor||state.currentUser?.name||'Unassigned',status:p.status==='chronic'?'chronic':'active'}));showImportResults();}catch(e){$('importLoading').style.display='none';$('importError').style.display='block';$('importErrorMsg').textContent='Connection failed';}};
window.changeImportWard=function(id,ward){const p=state.importPatients.find(x=>x.id===id);if(p){p.ward=ward;showImportResults();}};
function showImportResults(){$('importResults').style.display='block';$('importCount').textContent=state.importPatients.length;const wards={};state.importPatients.forEach(p=>{if(!wards[p.ward])wards[p.ward]=[];wards[p.ward].push(p);});const opts=CONFIG.VALID_WARDS.map(w=>`<option value="${w}">${w.replace('Ward ','W')}</option>`).join('');let h='';const order=['Ward 14','Ward 22','Ward 27','ICU','ER/Unassigned'];Object.keys(wards).sort((a,b)=>{const ai=order.indexOf(a),bi=order.indexOf(b);if(ai===-1&&bi===-1)return a.localeCompare(b);if(ai===-1)return 1;if(bi===-1)return-1;return ai-bi;}).forEach(ward=>{h+=`<div style="margin-bottom:14px"><div style="font-size:0.75rem;font-weight:600;color:var(--gold);padding:8px 12px;background:var(--bg-card);border-radius:8px;border-left:3px solid var(--gold);margin-bottom:10px">üìç ${esc(ward)} (${wards[ward].length})</div>`;wards[ward].forEach(p=>{h+=`<div class="import-item ${p.status}"><div class="import-item-avatar">${initials(p.name)}</div><div class="import-item-info"><div class="import-item-name">${esc(p.name)}</div><div class="import-item-meta">üõèÔ∏è ${esc(p.room)} ‚Ä¢ ${esc((p.diagnosis||'').substring(0,25))}${(p.diagnosis||'').length>25?'...':''}</div></div><select class="import-ward-select" onchange="changeImportWard(${p.id},this.value)">${CONFIG.VALID_WARDS.map(w=>`<option value="${w}" ${w===p.ward?'selected':''}>${w.replace('Ward ','W')}</option>`).join('')}</select></div>`;});h+='</div>';});$('importList').innerHTML=h;$('importConfirmBtn').disabled=false;toast(`Found ${state.importPatients.length}! Tap ward to change.`);}
window.confirmImport=function(){if(!state.importPatients.length)return;let added=0;state.importPatients.forEach(p=>{const exists=state.patients.some(ep=>ep.name.toLowerCase()===p.name.toLowerCase()&&ep.ward===p.ward);if(!exists){state.patients.push(p);added++;}});saveCloud();renderPatients();closeModal('importModal');toast(`Imported ${added}!`);};
async function init(){loadLocal();renderUnits();$('adminFab').addEventListener('click',openAdminLogin);$('syncFab').addEventListener('click',async()=>{$('syncFab').classList.add('syncing');await syncCloud();$('syncFab').classList.remove('syncing');toast('Synced!');});$('adminPwd').addEventListener('keydown',e=>{if(e.key==='Enter')loginAdmin();});$('userName').addEventListener('keydown',e=>{if(e.key==='Enter')enterUnit();});$('mainTabs').addEventListener('click',e=>{const t=e.target.closest('.tab');if(t)showTab(t.dataset.tab);});$('statsBar').addEventListener('click',e=>{const s=e.target.closest('.stat');if(s){state.currentFilter=s.dataset.filter;renderPatients();}});$('analysisFile').addEventListener('change',function(){Array.from(this.files).forEach(f=>{if(f.type.startsWith('image/'))addAnalysisImage(f);});this.value='';});document.querySelector('.analysis-types').addEventListener('click',e=>{const t=e.target.closest('.analysis-type');if(t){state.analysisType=t.dataset.type;$$('.analysis-type').forEach(x=>x.classList.remove('active'));t.classList.add('active');}});$('importFile').addEventListener('change',function(){if(this.files[0])handleImportFile(this.files[0]);});$$('.modal').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active');}));await syncCloud();setInterval(()=>syncCloud(),30000);}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
})();
</script>
</body>
</html>
