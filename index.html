<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <title>MedWard Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
:root{--bg-deep:#060a13;--bg-primary:#0a0f1a;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;--gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);--teal:#14b8a6;--teal-light:#2dd4bf;--blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;--border:rgba(148,163,184,0.1);--border-light:rgba(148,163,184,0.15);--shadow-lg:0 12px 40px rgba(0,0,0,0.5);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.5;min-height:100vh}
.ambient{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(ellipse at 20% 20%,var(--gold-glow),transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(20,184,166,0.08),transparent 50%)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-md);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:0.2s}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);box-shadow:0 4px 16px rgba(212,164,55,0.3)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary)}
.btn-sm{padding:8px 14px;font-size:0.8rem}
.btn-lg{padding:16px 28px;font-size:1rem}
.btn-full{width:100%}
.btn-icon{width:40px;height:40px;padding:0;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:grid;place-items:center;transition:0.2s}
.btn-icon:hover{border-color:var(--gold);color:var(--gold)}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:0.95rem;transition:0.2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-glow)}
.form-textarea{min-height:100px;resize:vertical}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);width:100%;max-width:440px;max-height:90vh;overflow-y:auto}
.modal-header{padding:24px;border-bottom:1px solid var(--border);text-align:center}
.modal-icon{width:64px;height:64px;background:var(--bg-elevated);border-radius:16px;display:grid;place-items:center;font-size:2rem;margin:0 auto 16px}
.modal-title{font-size:1.25rem;font-weight:700;margin-bottom:4px}
.modal-subtitle{color:var(--text-muted);font-size:0.85rem}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px 24px;display:flex;gap:12px}
.modal-footer .btn{flex:1}
#landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
#landing.hidden{display:none}
.landing-logo{width:88px;height:88px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:22px;display:grid;place-items:center;margin-bottom:28px;box-shadow:0 12px 40px rgba(212,164,55,0.3)}
.landing-logo svg{width:48px;height:48px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
.landing-title{font-size:2.25rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.landing-subtitle{color:var(--text-secondary);margin-bottom:48px}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;width:100%;max-width:880px}
.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;cursor:pointer;transition:0.3s;position:relative;overflow:hidden}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--unit-color,var(--gold))}
.unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,0.3)}
.unit-card-icon{width:52px;height:52px;background:var(--bg-elevated);border-radius:14px;display:grid;place-items:center;font-size:1.6rem;margin-bottom:14px}
.unit-card-name{font-size:1.15rem;font-weight:600;margin-bottom:4px}
.unit-card-desc{color:var(--text-muted);font-size:0.8rem;margin-bottom:16px}
.unit-card-lock{position:absolute;top:16px;right:16px;width:28px;height:28px;background:var(--bg-elevated);border-radius:8px;display:grid;place-items:center;color:var(--text-muted)}
.unit-card-lock svg{width:14px;height:14px}
.admin-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:0.3s;color:var(--text-muted)}
.admin-fab:hover{border-color:var(--gold);color:var(--gold);transform:scale(1.1)}
.admin-fab svg{width:22px;height:22px}
.code-inputs{display:flex;gap:12px;justify-content:center;margin-bottom:20px}
.code-digit{width:52px;height:60px;background:var(--bg-elevated);border:2px solid var(--border);border-radius:var(--radius-md);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:600;text-align:center;color:var(--text-primary);transition:0.2s}
.code-digit:focus{outline:none;border-color:var(--gold);background:var(--gold-glow)}
.code-digit.error{border-color:var(--rose);animation:shake 0.4s}
.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;margin-top:12px;display:none}
.code-error.show{display:block}
#dashboard{display:none;min-height:100vh;background:var(--bg-primary)}
#dashboard.active{display:block}
.dash-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.dash-logo{display:flex;align-items:center;gap:12px}
.dash-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:10px;display:grid;place-items:center}
.dash-logo-icon svg{width:22px;height:22px;stroke:var(--bg-deep);fill:none}
.dash-unit-badge{padding:6px 14px;border-radius:100px;font-size:0.8rem;font-weight:600}
.dash-user{display:flex;align-items:center;gap:12px}
.dash-user-info{text-align:right}
.dash-user-name{font-weight:600;font-size:0.9rem}
.dash-user-role{font-size:0.7rem;color:var(--text-muted);text-transform:capitalize}
.dash-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:10px;display:grid;place-items:center;font-weight:700;font-size:0.85rem}
.dash-content{max-width:1200px;margin:0 auto;padding:20px}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:24px;overflow-x:auto}
.tab{padding:14px 20px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer;transition:0.2s;white-space:nowrap;display:flex;align-items:center;gap:8px}
.tab:hover{color:var(--text-primary)}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);font-weight:600}
.tab svg{width:18px;height:18px}
.panel{display:none;animation:fadeIn 0.3s}
.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-bottom:24px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;text-align:center}
.stat-value{font-size:1.75rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.patients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
.patient-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;transition:0.2s;position:relative;overflow:hidden}
.patient-card:hover{border-color:var(--gold)}
.patient-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--teal)}
.patient-card.critical::before{background:var(--rose)}
.patient-card.chronic::before{background:var(--purple)}
.patient-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.patient-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:1rem;color:var(--bg-deep)}
.patient-name{font-weight:600}
.patient-meta{font-size:0.75rem;color:var(--text-muted)}
.patient-status{margin-left:auto;padding:4px 10px;border-radius:100px;font-size:0.65rem;font-weight:600;text-transform:uppercase}
.patient-status.active{background:rgba(20,184,166,0.15);color:var(--teal)}
.patient-status.critical{background:rgba(244,63,94,0.15);color:var(--rose)}
.patient-status.chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
.patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);padding:12px;background:var(--bg-card);border-radius:8px;margin-bottom:14px}
.patient-actions{display:flex;gap:8px}
.patient-actions .btn{flex:1;padding:10px;font-size:0.8rem}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:0.95rem;font-weight:600;display:flex;align-items:center;gap:10px}
.card-title svg{width:18px;height:18px;stroke:var(--gold)}
.card-body{padding:20px}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:40px 24px;text-align:center;cursor:pointer;transition:0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--gold);background:var(--gold-glow)}
.upload-zone.has-file{border-style:solid;border-color:var(--teal)}
.upload-icon{width:56px;height:56px;background:var(--bg-elevated);border-radius:14px;display:grid;place-items:center;margin:0 auto 16px}
.upload-icon svg{width:28px;height:28px;stroke:var(--gold)}
.upload-input{display:none}
.preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px;margin-top:16px}
.preview-thumb{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid var(--border)}
.preview-thumb img{width:100%;height:100%;object-fit:cover}
.preview-thumb:hover{border-color:var(--rose)}
.analysis-types{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px 12px;text-align:center;cursor:pointer;transition:0.2s}
.analysis-type:hover{border-color:var(--gold)}
.analysis-type.active{border-color:var(--gold);background:var(--gold-glow)}
.analysis-type-icon{font-size:1.5rem;margin-bottom:6px}
.analysis-type-name{font-size:0.8rem;font-weight:600}
.analysis-progress{display:none;text-align:center;padding:40px}
.analysis-progress.show{display:block}
.progress-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.analysis-results{display:none}
.analysis-results.show{display:block}
.result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.result-title{font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:10px;color:var(--emerald)}
.result-badge{padding:6px 14px;background:var(--gold-glow);border:1px solid var(--gold);border-radius:100px;font-size:0.75rem;font-weight:600;color:var(--gold)}
.result-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:18px;margin-bottom:14px}
.result-section-title{font-size:0.85rem;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.finding-card{background:var(--bg-elevated);border-radius:8px;padding:12px;margin-bottom:8px}
.finding-card.critical{border-left:3px solid var(--rose)}
.scores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.score-tile{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px 16px;text-align:center;cursor:pointer;transition:0.2s}
.score-tile:hover{border-color:var(--gold)}
.score-tile.active{border-color:var(--gold);background:var(--gold-glow)}
.score-icon{font-size:1.75rem;margin-bottom:8px}
.score-name{font-weight:600;font-size:0.9rem}
.score-desc{font-size:0.7rem;color:var(--text-muted)}
.calc-item{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;margin-bottom:12px}
.calc-item-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.calc-item-num{width:28px;height:28px;background:var(--gold);border-radius:8px;display:grid;place-items:center;font-size:0.75rem;font-weight:700;color:var(--bg-deep)}
.calc-item-name{font-weight:600;font-size:0.9rem}
.calc-opts{display:flex;flex-wrap:wrap;gap:8px}
.calc-opt{flex:1;min-width:60px;padding:12px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:0.15s}
.calc-opt:hover{border-color:var(--gold)}
.calc-opt.sel{background:var(--gold-glow);border-color:var(--gold)}
.calc-opt input{display:none}
.calc-opt-score{display:block;font-size:1.1rem;font-weight:700;color:var(--gold)}
.calc-opt-label{font-size:0.65rem;color:var(--text-secondary)}
.calc-result{background:var(--bg-elevated);border-radius:var(--radius-md);padding:24px;text-align:center;margin-top:16px}
.calc-result-score{font-size:3rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.severity-pill{display:inline-block;padding:8px 20px;border-radius:100px;font-size:0.85rem;font-weight:600;margin-top:12px}
.ref-filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.ref-filter{padding:8px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px;color:var(--text-secondary);font-size:0.75rem;font-weight:500;cursor:pointer;transition:0.2s}
.ref-filter:hover{border-color:var(--gold)}
.ref-filter.active{background:var(--gold-glow);border-color:var(--gold);color:var(--gold)}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.78rem;color:var(--text-secondary);margin:5px 0}
.ref-card b{color:var(--gold)}
#adminPanel{display:none;min-height:100vh;background:var(--bg-primary)}
#adminPanel.active{display:block}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.admin-badge{background:var(--purple);padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:600;color:white;margin-left:12px}
.admin-content{max-width:900px;margin:0 auto;padding:24px}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:24px;overflow:hidden}
.admin-section-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.admin-section-title{font-size:1rem;font-weight:600}
.admin-section-body{padding:20px}
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase}
.color-options{display:flex;gap:8px;flex-wrap:wrap}
.color-option{width:32px;height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:0.2s}
.color-option:hover,.color-option.selected{border-color:white;transform:scale(1.15)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:14px 24px;border-radius:var(--radius-md);font-size:0.9rem;opacity:0;transition:0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
@media(max-width:640px){.landing-title{font-size:1.75rem}.units-grid{grid-template-columns:1fr}.code-digit{width:48px;height:54px;font-size:1.5rem}.dash-user-info{display:none}.tab span{display:none}.patients-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="ambient"></div>

<!-- LANDING PAGE -->
<div id="landing">
  <div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
  <h1 class="landing-title">MedWard Enterprise</h1>
  <p class="landing-subtitle">Select your unit to continue</p>
  <div class="units-grid" id="unitsGrid">
    <!-- Units rendered by JS -->
  </div>
  <div class="admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>

<!-- ACCESS MODAL -->
<div class="modal" id="accessModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon" id="accessIcon">üè•</div>
      <h2 class="modal-title" id="accessTitle">Unit Name</h2>
      <p class="modal-subtitle">Enter 4-digit access code</p>
    </div>
    <div class="modal-body">
      <div class="code-inputs">
        <input type="tel" class="code-digit" maxlength="1" data-idx="0" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" data-idx="1" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" data-idx="2" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" data-idx="3" inputmode="numeric">
      </div>
      <p class="code-error" id="codeError">Invalid access code</p>
      <div id="userSection" style="display:none;margin-top:24px;padding-top:24px;border-top:1px solid var(--border)">
        <div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input" placeholder="Dr. John Smith"></div>
        <div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option><option value="nurse">Nurse</option></select></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
      <button class="btn btn-primary" id="enterUnitBtn" style="display:none">Enter Unit</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN -->
<div class="modal" id="adminLoginModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon">‚öôÔ∏è</div>
      <h2 class="modal-title">Admin Access</h2>
      <p class="modal-subtitle">Enter administrator password</p>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPassword" class="form-input" placeholder="Enter password"></div>
      <p class="code-error" id="adminError">Invalid password</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('adminLoginModal')">Cancel</button>
      <button class="btn btn-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<!-- UNIT MODAL -->
<div class="modal" id="unitModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:left">
      <h2 class="modal-title" id="unitModalTitle">Add Unit</h2>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Unit Name</label><input type="text" id="unitName" class="form-input" placeholder="Neurology Ward"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Icon</label><input type="text" id="unitIcon" class="form-input" placeholder="üè•" style="font-size:1.5rem;text-align:center"></div>
        <div class="form-group"><label class="form-label">Code</label><input type="text" id="unitCode" class="form-input" placeholder="1234" maxlength="4" style="text-align:center;letter-spacing:4px"></div>
      </div>
      <div class="form-group"><label class="form-label">Description</label><input type="text" id="unitDesc" class="form-input" placeholder="Brief description"></div>
      <div class="form-group"><label class="form-label">Sheet ID</label><input type="text" id="unitSheetId" class="form-input" placeholder="Google Sheet ID"></div>
      <div class="form-group"><label class="form-label">Color</label><div class="color-options"><div class="color-option selected" data-color="#d4a437" style="background:#d4a437"></div><div class="color-option" data-color="#14b8a6" style="background:#14b8a6"></div><div class="color-option" data-color="#3b82f6" style="background:#3b82f6"></div><div class="color-option" data-color="#a855f7" style="background:#a855f7"></div><div class="color-option" data-color="#ef4444" style="background:#ef4444"></div><div class="color-option" data-color="#f97316" style="background:#f97316"></div><div class="color-option" data-color="#10b981" style="background:#10b981"></div><div class="color-option" data-color="#ec4899" style="background:#ec4899"></div></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
      <button class="btn btn-primary" id="saveUnitBtn">Save</button>
    </div>
  </div>
</div>

<!-- PATIENT MODAL -->
<div class="modal" id="patientModal">
  <div class="modal-box">
    <div class="modal-header" style="text-align:left"><h2 class="modal-title">Add Patient</h2></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="patientName" class="form-input" placeholder="Full name"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Room</label><input type="text" id="patientRoom" class="form-input" placeholder="21-A"></div>
        <div class="form-group"><label class="form-label">Status</label><select id="patientStatus" class="form-select"><option value="active">Active</option><option value="critical">Critical</option><option value="chronic">Chronic</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Diagnosis</label><textarea id="patientDiagnosis" class="form-textarea" placeholder="Primary diagnosis"></textarea></div>
      <div class="form-group"><label class="form-label">Doctor</label><input type="text" id="patientDoctor" class="form-input" placeholder="Dr. Name"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
      <button class="btn btn-primary" id="savePatientBtn">Save</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <header class="admin-header">
    <div class="dash-logo"><div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div><span style="font-weight:600;margin-left:10px">MedWard</span><span class="admin-badge">ADMIN</span></div>
    <button class="btn btn-secondary btn-sm" id="exitAdminBtn">Exit</button>
  </header>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-header"><h2 class="admin-section-title">üè• Units</h2><button class="btn btn-primary btn-sm" id="addUnitBtn">+ Add</button></div>
      <div class="admin-section-body" style="padding:0;overflow-x:auto"><table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTableBody"></tbody></table></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-header"><h2 class="admin-section-title">‚öôÔ∏è Settings</h2></div>
      <div class="admin-section-body">
        <div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="New password"></div>
        <div class="form-group"><label class="form-label">API URL</label><input type="text" id="claudeApiUrl" class="form-input" placeholder="Apps Script URL"></div>
        <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header class="dash-header">
    <div class="dash-logo">
      <div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
      <span class="dash-unit-badge" id="dashUnitBadge">Unit</span>
    </div>
    <div class="dash-user">
      <div class="dash-user-info"><div class="dash-user-name" id="dashUserName">Doctor</div><div class="dash-user-role" id="dashUserRole">Role</div></div>
      <div class="dash-avatar" id="dashAvatar">DR</div>
      <button class="btn-icon" id="logoutBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </header>
  <div class="dash-content">
    <h1 id="dashWelcome" style="font-size:1.5rem;margin-bottom:4px">Welcome back</h1>
    <p id="dashDate" style="color:var(--text-muted);margin-bottom:24px"></p>
    <div class="tabs">
      <button class="tab active" data-tab="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span>Patients</span></button>
      <button class="tab" data-tab="analysis"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg><span>AI Analysis</span></button>
      <button class="tab" data-tab="scores"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Scores</span></button>
      <button class="tab" data-tab="reference"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg><span>Reference</span></button>
    </div>
    <div class="panel active" id="panelPatients">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
        <div class="stat-card"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
        <div class="stat-card"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
        <div class="stat-card"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="font-size:1.1rem">Patients</h2>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" id="refreshPatientsBtn">‚Üª</button>
          <button class="btn btn-primary btn-sm" id="addPatientBtn">+ Add</button>
        </div>
      </div>
      <div class="patients-grid" id="patientsGrid"></div>
    </div>
    <div class="panel" id="panelAnalysis">
      <div class="card">
        <div class="card-header"><h3 class="card-title">Upload Images</h3></div>
        <div class="card-body">
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
            <div style="font-weight:600">Drop files or tap to upload</div>
            <input type="file" class="upload-input" id="uploadInput" accept="image/*" multiple>
          </div>
          <div class="preview-grid" id="previewGrid"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3 class="card-title">Analysis Type</h3></div>
        <div class="card-body">
          <div class="analysis-types">
            <div class="analysis-type active" data-type="lab"><div class="analysis-type-icon">üß™</div><div class="analysis-type-name">Labs</div></div>
            <div class="analysis-type" data-type="xray"><div class="analysis-type-icon">ü©ª</div><div class="analysis-type-name">X-Ray</div></div>
            <div class="analysis-type" data-type="ct"><div class="analysis-type-icon">üß†</div><div class="analysis-type-name">CT/MRI</div></div>
            <div class="analysis-type" data-type="ecg"><div class="analysis-type-icon">üíì</div><div class="analysis-type-name">ECG</div></div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary btn-lg btn-full" id="analyzeBtn" disabled>ü§ñ Analyze</button>
      <div class="analysis-progress" id="analysisProgress"><div class="progress-spinner"></div><div>Analyzing...</div><div id="progressStatus" style="color:var(--text-muted);font-size:0.85rem"></div></div>
      <div class="analysis-results" id="analysisResults">
        <div class="result-header"><h3 class="result-title">‚úì Complete</h3><span class="result-badge" id="resultBadge">AI</span></div>
        <div id="resultsContent"></div>
        <button class="btn btn-secondary btn-full" id="newAnalysisBtn" style="margin-top:16px">New Analysis</button>
      </div>
    </div>
    <div class="panel" id="panelScores">
      <div class="card"><div class="card-header"><h3 class="card-title">Clinical Scores</h3></div><div class="card-body"><div class="scores-grid" id="scoresGrid"></div></div></div>
      <div id="calcArea"></div>
    </div>
    <div class="panel" id="panelReference">
      <div class="card"><div class="card-header"><h3 class="card-title">Quick Reference</h3></div><div class="card-body"><div class="ref-filters" id="refFilters"></div><div class="ref-grid" id="refGrid"></div></div></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEDWARD ENTERPRISE - COMPLETE APPLICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

(function() {
  'use strict';

  // CONFIG
  var CONFIG = {
    STORAGE_KEY: 'medward_v4',
    DEFAULT_ADMIN_PWD: 'admin123',
    DEFAULT_API: 'https://script.google.com/macros/s/AKfycbxjp-KDUx_eYvavlEHDciE-fR1V8eFM39vJfAcA7btETL-QUmrwuYU-_92_Pl20gl75kg/exec'
  };

  // DEFAULT UNITS
  var DEFAULT_UNITS = [
    { id: 'neuro', name: 'Neurology', icon: 'üß†', desc: 'Stroke & Neurological Disorders', code: '1234', color: '#a855f7', sheetId: '' },
    { id: 'cardio', name: 'Cardiology', icon: '‚ù§Ô∏è', desc: 'Cardiac Care Unit', code: '5678', color: '#ef4444', sheetId: '' },
    { id: 'icu', name: 'ICU', icon: 'üè•', desc: 'Intensive Care Unit', code: '9012', color: '#f97316', sheetId: '' }
  ];

  // STATE
  var state = {
    units: [],
    settings: { adminPassword: CONFIG.DEFAULT_ADMIN_PWD, claudeApiUrl: CONFIG.DEFAULT_API },
    currentUnit: null,
    currentUser: null,
    patients: [],
    analysisType: 'lab',
    uploadedFiles: [],
    uploadedBase64s: [],
    activeScore: null,
    scores: {}
  };

  // UTILITIES
  function $(id) { return document.getElementById(id); }
  function $$(sel) { return document.querySelectorAll(sel); }
  
  function toast(msg, isError) {
    var t = $('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(function() { t.className = 'toast'; }, 3000);
  }

  function initials(name) {
    if (!name) return '?';
    var p = name.trim().split(/\s+/);
    return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
  }

  function closeModal(id) { $(id).classList.remove('active'); }
  function openModal(id) { $(id).classList.add('active'); }

  // STORAGE
  function saveState() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({ units: state.units, settings: state.settings }));
    } catch(e) { console.warn('Save failed:', e); }
  }

  function loadState() {
    try {
      var saved = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (saved) {
        var data = JSON.parse(saved);
        state.units = data.units && data.units.length > 0 ? data.units : DEFAULT_UNITS.slice();
        state.settings = Object.assign({}, state.settings, data.settings);
      } else {
        state.units = DEFAULT_UNITS.slice();
      }
    } catch(e) {
      console.warn('Load failed:', e);
      state.units = DEFAULT_UNITS.slice();
    }
    console.log('[MedWard] Loaded ' + state.units.length + ' units');
  }

  // RENDER UNITS
  function renderUnits() {
    var grid = $('unitsGrid');
    if (!grid) { console.error('unitsGrid not found'); return; }
    
    if (!state.units || state.units.length === 0) {
      state.units = DEFAULT_UNITS.slice();
    }
    
    console.log('[MedWard] Rendering ' + state.units.length + ' units');
    
    var html = '';
    for (var i = 0; i < state.units.length; i++) {
      var u = state.units[i];
      html += '<div class="unit-card" data-id="' + u.id + '" style="--unit-color:' + u.color + '">' +
        '<div class="unit-card-lock"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>' +
        '<div class="unit-card-icon">' + u.icon + '</div>' +
        '<div class="unit-card-name">' + u.name + '</div>' +
        '<div class="unit-card-desc">' + (u.desc || 'No description') + '</div>' +
      '</div>';
    }
    grid.innerHTML = html;
    
    var cards = $$('.unit-card');
    for (var j = 0; j < cards.length; j++) {
      (function(card) {
        card.onclick = function() { openAccessModal(card.getAttribute('data-id')); };
      })(cards[j]);
    }
  }

  // ACCESS MODAL
  var selectedUnitId = null;

  function openAccessModal(unitId) {
    var unit = null;
    for (var i = 0; i < state.units.length; i++) {
      if (state.units[i].id === unitId) { unit = state.units[i]; break; }
    }
    if (!unit) return;
    
    selectedUnitId = unitId;
    $('accessIcon').textContent = unit.icon;
    $('accessTitle').textContent = unit.name;
    $('codeError').classList.remove('show');
    $('userSection').style.display = 'none';
    $('enterUnitBtn').style.display = 'none';
    
    var digits = $$('.code-digit');
    for (var i = 0; i < digits.length; i++) {
      digits[i].value = '';
      digits[i].disabled = false;
      digits[i].classList.remove('error', 'success');
    }
    
    openModal('accessModal');
    document.querySelector('.code-digit[data-idx="0"]').focus();
  }

  function setupCodeInputs() {
    var inputs = $$('.code-digit');
    for (var i = 0; i < inputs.length; i++) {
      (function(idx, inp) {
        inp.oninput = function(e) {
          var val = e.target.value.replace(/\D/g, '');
          e.target.value = val;
          if (val && idx < 3) inputs[idx + 1].focus();
          var code = '';
          for (var j = 0; j < inputs.length; j++) code += inputs[j].value;
          if (code.length === 4) validateCode(code);
        };
        inp.onkeydown = function(e) {
          if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus();
        };
      })(i, inputs[i]);
    }
  }

  function validateCode(code) {
    var unit = null;
    for (var i = 0; i < state.units.length; i++) {
      if (state.units[i].id === selectedUnitId) { unit = state.units[i]; break; }
    }
    if (!unit) return;
    
    var digits = $$('.code-digit');
    if (code === unit.code) {
      for (var i = 0; i < digits.length; i++) {
        digits[i].disabled = true;
        digits[i].classList.add('success');
      }
      $('userSection').style.display = 'block';
      $('enterUnitBtn').style.display = 'flex';
      $('userName').focus();
      $('codeError').classList.remove('show');
    } else {
      $('codeError').classList.add('show');
      for (var i = 0; i < digits.length; i++) {
        digits[i].classList.add('error');
        setTimeout(function(d) { return function() { d.classList.remove('error'); }; }(digits[i]), 400);
      }
    }
  }

  function enterUnit() {
    var name = $('userName').value.trim();
    var role = $('userRole').value;
    if (!name) { toast('Please enter your name', true); return; }
    
    for (var i = 0; i < state.units.length; i++) {
      if (state.units[i].id === selectedUnitId) {
        state.currentUnit = state.units[i];
        break;
      }
    }
    state.currentUser = { name: name, role: role };
    closeModal('accessModal');
    showDashboard();
  }

  // Expose closeModal globally
  window.closeModal = closeModal;

  // ADMIN
  function openAdminLogin() {
    $('adminPassword').value = '';
    $('adminError').classList.remove('show');
    openModal('adminLoginModal');
    $('adminPassword').focus();
  }

  function loginAdmin() {
    if ($('adminPassword').value === state.settings.adminPassword) {
      closeModal('adminLoginModal');
      showAdminPanel();
    } else {
      $('adminError').classList.add('show');
    }
  }

  function showAdminPanel() {
    $('landing').classList.add('hidden');
    $('adminPanel').classList.add('active');
    renderUnitsTable();
    $('claudeApiUrl').value = state.settings.claudeApiUrl || '';
  }

  function exitAdmin() {
    $('adminPanel').classList.remove('active');
    $('landing').classList.remove('hidden');
  }

  function renderUnitsTable() {
    var tbody = $('unitsTableBody');
    if (!state.units.length) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);padding:40px">No units</td></tr>';
      return;
    }
    var html = '';
    for (var i = 0; i < state.units.length; i++) {
      var u = state.units[i];
      html += '<tr><td><span style="margin-right:10px;font-size:1.25rem">' + u.icon + '</span><b>' + u.name + '</b></td>' +
        '<td><code style="background:var(--bg-elevated);padding:4px 10px;border-radius:6px">' + u.code + '</code></td>' +
        '<td><div style="display:flex;gap:8px"><button class="btn-icon" onclick="MW.editUnit(\'' + u.id + '\')">‚úèÔ∏è</button><button class="btn-icon" onclick="MW.deleteUnit(\'' + u.id + '\')">üóëÔ∏è</button></div></td></tr>';
    }
    tbody.innerHTML = html;
  }

  var editingUnitId = null;

  function openUnitModal(unitId) {
    editingUnitId = unitId || null;
    if (unitId) {
      var u = null;
      for (var i = 0; i < state.units.length; i++) {
        if (state.units[i].id === unitId) { u = state.units[i]; break; }
      }
      if (!u) return;
      $('unitModalTitle').textContent = 'Edit Unit';
      $('unitName').value = u.name;
      $('unitIcon').value = u.icon;
      $('unitCode').value = u.code;
      $('unitDesc').value = u.desc || '';
      $('unitSheetId').value = u.sheetId || '';
    } else {
      $('unitModalTitle').textContent = 'Add Unit';
      $('unitName').value = '';
      $('unitIcon').value = 'üè•';
      $('unitCode').value = '';
      $('unitDesc').value = '';
      $('unitSheetId').value = '';
    }
    openModal('unitModal');
  }

  function saveUnit() {
    var name = $('unitName').value.trim();
    var icon = $('unitIcon').value.trim() || 'üè•';
    var code = $('unitCode').value.trim();
    var desc = $('unitDesc').value.trim();
    var sheetId = $('unitSheetId').value.trim();
    var colorEl = document.querySelector('.color-option.selected');
    var color = colorEl ? colorEl.getAttribute('data-color') : '#d4a437';
    
    if (!name || !code) { toast('Name and code required', true); return; }
    if (!/^\d{4}$/.test(code)) { toast('Code must be 4 digits', true); return; }
    
    if (editingUnitId) {
      for (var i = 0; i < state.units.length; i++) {
        if (state.units[i].id === editingUnitId) {
          state.units[i] = { id: editingUnitId, name: name, icon: icon, code: code, desc: desc, sheetId: sheetId, color: color };
          break;
        }
      }
    } else {
      var id = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
      state.units.push({ id: id, name: name, icon: icon, code: code, desc: desc, sheetId: sheetId, color: color });
    }
    
    saveState();
    renderUnitsTable();
    renderUnits();
    closeModal('unitModal');
    toast(editingUnitId ? 'Unit updated!' : 'Unit created!');
  }

  function deleteUnit(unitId) {
    if (!confirm('Delete this unit?')) return;
    state.units = state.units.filter(function(u) { return u.id !== unitId; });
    saveState();
    renderUnitsTable();
    renderUnits();
    toast('Unit deleted');
  }

  function saveSettings() {
    var pwd = $('newAdminPwd').value.trim();
    var url = $('claudeApiUrl').value.trim();
    if (pwd) state.settings.adminPassword = pwd;
    if (url) state.settings.claudeApiUrl = url;
    saveState();
    toast('Settings saved!');
    $('newAdminPwd').value = '';
  }

  // DASHBOARD
  function showDashboard() {
    $('landing').classList.add('hidden');
    $('dashboard').classList.add('active');
    var u = state.currentUnit;
    $('dashUnitBadge').textContent = u.name;
    $('dashUnitBadge').style.cssText = 'border:1px solid ' + u.color + ';color:' + u.color + ';background:' + u.color + '20';
    $('dashUserName').textContent = state.currentUser.name;
    $('dashUserRole').textContent = state.currentUser.role;
    $('dashAvatar').textContent = initials(state.currentUser.name);
    $('dashWelcome').textContent = 'Welcome, Dr. ' + state.currentUser.name.split(' ')[0];
    $('dashDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    setupTabs();
    loadPatients();
    renderScores();
    renderRefs();
    setupUpload();
    toast('Entered ' + u.name);
  }

  function logout() {
    state.currentUnit = null;
    state.currentUser = null;
    state.patients = [];
    $('dashboard').classList.remove('active');
    $('landing').classList.remove('hidden');
  }

  function setupTabs() {
    var tabs = $$('.tab');
    for (var i = 0; i < tabs.length; i++) {
      (function(tab) {
        tab.onclick = function() {
          var allTabs = $$('.tab');
          var allPanels = $$('.panel');
          for (var j = 0; j < allTabs.length; j++) allTabs[j].classList.remove('active');
          for (var k = 0; k < allPanels.length; k++) allPanels[k].classList.remove('active');
          tab.classList.add('active');
          var panelId = 'panel' + tab.getAttribute('data-tab').charAt(0).toUpperCase() + tab.getAttribute('data-tab').slice(1);
          $(panelId).classList.add('active');
        };
      })(tabs[i]);
    }
  }

  // PATIENTS
  function loadPatients() {
    state.patients = [
      { id: 1, name: 'Ahmed Al-Rashid', room: '21-A', diagnosis: 'Acute Ischemic Stroke - MCA territory', status: 'critical', doctor: 'Dr. Fathy' },
      { id: 2, name: 'Fatima Hassan', room: '21-B', diagnosis: 'CHF Exacerbation, EF 25%', status: 'active', doctor: 'Dr. Fathy' },
      { id: 3, name: 'Mohammed Saeed', room: '22-A', diagnosis: 'DKA, Type 1 DM', status: 'active', doctor: 'Dr. Ahmed' }
    ];
    renderPatients();
  }

  function renderPatients() {
    var grid = $('patientsGrid');
    if (!state.patients.length) {
      grid.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:60px;grid-column:1/-1">No patients</div>';
    } else {
      var html = '';
      for (var i = 0; i < state.patients.length; i++) {
        var p = state.patients[i];
        html += '<div class="patient-card ' + p.status + '">' +
          '<div class="patient-header"><div class="patient-avatar">' + initials(p.name) + '</div><div><div class="patient-name">' + p.name + '</div><div class="patient-meta">Room ' + p.room + ' ‚Ä¢ ' + p.doctor + '</div></div><span class="patient-status ' + p.status + '">' + p.status + '</span></div>' +
          '<div class="patient-diagnosis">' + p.diagnosis + '</div>' +
          '<div class="patient-actions"><button class="btn btn-secondary">View</button><button class="btn btn-primary">Rounds</button></div></div>';
      }
      grid.innerHTML = html;
    }
    $('statTotal').textContent = state.patients.length;
    $('statActive').textContent = state.patients.filter(function(p) { return p.status === 'active'; }).length;
    $('statCritical').textContent = state.patients.filter(function(p) { return p.status === 'critical'; }).length;
    $('statChronic').textContent = state.patients.filter(function(p) { return p.status === 'chronic'; }).length;
  }

  function openPatientModal() {
    $('patientName').value = '';
    $('patientRoom').value = '';
    $('patientDiagnosis').value = '';
    $('patientDoctor').value = state.currentUser ? state.currentUser.name : '';
    $('patientStatus').value = 'active';
    openModal('patientModal');
  }

  function savePatient() {
    var name = $('patientName').value.trim();
    if (!name) { toast('Patient name required', true); return; }
    state.patients.push({
      id: Date.now(),
      name: name,
      room: $('patientRoom').value.trim() || '‚Äî',
      diagnosis: $('patientDiagnosis').value.trim() || 'No diagnosis',
      status: $('patientStatus').value,
      doctor: $('patientDoctor').value.trim() || 'Unassigned'
    });
    renderPatients();
    closeModal('patientModal');
    toast('Patient added!');
  }

  // UPLOAD & ANALYSIS
  function setupUpload() {
    var zone = $('uploadZone');
    var input = $('uploadInput');
    zone.onclick = function() { input.click(); };
    zone.ondragover = function(e) { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = function() { zone.classList.remove('dragover'); };
    zone.ondrop = function(e) { e.preventDefault(); zone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
    input.onchange = function() { if (input.files.length) handleFiles(input.files); };
    
    var types = $$('.analysis-type');
    for (var i = 0; i < types.length; i++) {
      (function(t) {
        t.onclick = function() {
          var all = $$('.analysis-type');
          for (var j = 0; j < all.length; j++) all[j].classList.remove('active');
          t.classList.add('active');
          state.analysisType = t.getAttribute('data-type');
        };
      })(types[i]);
    }
  }

  function handleFiles(files) {
    for (var i = 0; i < files.length; i++) {
      if (!files[i].type.startsWith('image/')) continue;
      state.uploadedFiles.push(files[i]);
      (function(file) {
        var reader = new FileReader();
        reader.onload = function(e) { state.uploadedBase64s.push(e.target.result); renderPreviews(); };
        reader.readAsDataURL(file);
      })(files[i]);
    }
    $('uploadZone').classList.add('has-file');
    $('analyzeBtn').disabled = false;
  }

  function renderPreviews() {
    var html = '';
    for (var i = 0; i < state.uploadedBase64s.length; i++) {
      html += '<div class="preview-thumb" onclick="MW.removeFile(' + i + ')"><img src="' + state.uploadedBase64s[i] + '"></div>';
    }
    $('previewGrid').innerHTML = html;
  }

  function removeFile(idx) {
    state.uploadedFiles.splice(idx, 1);
    state.uploadedBase64s.splice(idx, 1);
    renderPreviews();
    if (!state.uploadedFiles.length) {
      $('uploadZone').classList.remove('has-file');
      $('analyzeBtn').disabled = true;
    }
  }

  function runAnalysis() {
    if (!state.uploadedBase64s.length) { toast('Upload images first', true); return; }
    $('analysisProgress').classList.add('show');
    $('analysisResults').classList.remove('show');
    $('progressStatus').textContent = 'Sending to Claude...';
    
    var total = state.uploadedBase64s.length;
    var processed = 0;
    var results = [];
    
    function processNext(idx) {
      if (idx >= total) {
        finishAnalysis(results);
        return;
      }
      fetch(state.settings.claudeApiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'interpret', documentType: state.analysisType, image: state.uploadedBase64s[idx], provider: 'claude' })
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        processed++;
        $('progressStatus').textContent = 'Processed ' + processed + '/' + total;
        results.push(d);
        processNext(idx + 1);
      })
      .catch(function() {
        results.push({ success: false });
        processNext(idx + 1);
      });
    }
    processNext(0);
  }

  function finishAnalysis(results) {
    $('analysisProgress').classList.remove('show');
    var analysis = { summary: '', abnormalities: [], normalFindings: [], recommendations: [] };
    
    for (var i = 0; i < results.length; i++) {
      var d = results[i];
      if (d.success && d.interpretation) {
        if (d.interpretation.summary) analysis.summary += d.interpretation.summary + ' ';
        if (d.interpretation.abnormalities) analysis.abnormalities = analysis.abnormalities.concat(d.interpretation.abnormalities);
        if (d.interpretation.normalFindings) analysis.normalFindings = analysis.normalFindings.concat(d.interpretation.normalFindings);
      }
      if (d.presentation && d.presentation.recommendations) analysis.recommendations = analysis.recommendations.concat(d.presentation.recommendations);
    }
    
    showResults(analysis);
  }

  function showResults(analysis) {
    $('analysisResults').classList.add('show');
    var html = '';
    if (analysis.summary) html += '<div class="result-section"><div class="result-section-title">üìã Summary</div><div>' + analysis.summary + '</div></div>';
    if (analysis.abnormalities && analysis.abnormalities.length) {
      html += '<div class="result-section" style="border-left:3px solid var(--rose)"><div class="result-section-title" style="color:var(--rose)">‚ö†Ô∏è Abnormal</div>';
      for (var i = 0; i < analysis.abnormalities.length; i++) {
        var a = analysis.abnormalities[i];
        html += '<div class="finding-card critical">' + (typeof a === 'string' ? a : (a.name || JSON.stringify(a))) + '</div>';
      }
      html += '</div>';
    }
    if (analysis.normalFindings && analysis.normalFindings.length) {
      html += '<div class="result-section" style="border-left:3px solid var(--emerald)"><div class="result-section-title" style="color:var(--emerald)">‚úì Normal</div><div style="display:flex;flex-wrap:wrap;gap:8px">';
      for (var j = 0; j < Math.min(analysis.normalFindings.length, 10); j++) {
        html += '<span style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);padding:4px 10px;border-radius:100px;font-size:0.75rem">' + analysis.normalFindings[j] + '</span>';
      }
      html += '</div></div>';
    }
    if (!html) html = '<div class="result-section"><p style="color:var(--text-muted)">Analysis complete.</p></div>';
    $('resultsContent').innerHTML = html;
  }

  function resetAnalysis() {
    $('analysisResults').classList.remove('show');
    $('uploadZone').classList.remove('has-file');
    $('analyzeBtn').disabled = true;
    state.uploadedFiles = [];
    state.uploadedBase64s = [];
    $('previewGrid').innerHTML = '';
  }
 {
    console.log('[MedWard] Initializing...');
    loadState();
    renderUnits();
    setupCodeInputs();

    // Event listeners
    $('adminFab').onclick = openAdminLogin;
    $('adminLoginBtn').onclick = loginAdmin;
    $('adminPassword').onkeydown = function(e) { if (e.key === 'Enter') loginAdmin(); };
    $('exitAdminBtn').onclick = exitAdmin;
    $('addUnitBtn').onclick = function() { openUnitModal(); };
    $('saveUnitBtn').onclick = saveUnit;
    $('saveSettingsBtn').onclick = saveSettings;
    $('enterUnitBtn').onclick = enterUnit;
    $('userName').onkeydown = function(e) { if (e.key === 'Enter') enterUnit(); };
    $('logoutBtn').onclick = logout;
    $('addPatientBtn').onclick = openPatientModal;
    $('savePatientBtn').onclick = savePatient;
    $('refreshPatientsBtn').onclick = loadPatients;
    $('analyzeBtn').onclick = runAnalysis;
    $('newAnalysisBtn').onclick = resetAnalysis;

    // Color picker
    var colorOpts = $$('.color-option');
    for (var i = 0; i < colorOpts.length; i++) {
      (function(o) {
        o.onclick = function() {
          var all = $$('.color-option');
          for (var j = 0; j < all.length; j++) all[j].classList.remove('selected');
          o.classList.add('selected');
        };
      })(colorOpts[i]);
    }

    // Modal backdrop close
    var modals = $$('.modal');
    for (var k = 0; k < modals.length; k++) {
      (function(m) {
        m.onclick = function(e) { if (e.target === m) m.classList.remove('active'); };
      })(modals[k]);
    }

    console.log('[MedWard] Ready!');
  }

  // GLOBAL ACCESS
  window.MW = {
    editUnit: openUnitModal,
    deleteUnit: deleteUnit,
    removeFile: removeFile,
    setScore: setScore
  };

  // START
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
<script src="lab-engine.js"></script>
</body>
</html>
