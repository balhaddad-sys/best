<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#030712">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MedWard Pro v12</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#030712;--bg-card:#0a0f1a;--bg-elevated:#111827;--bg-hover:#1f2937;--text:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--gold:#f59e0b;--gold-light:#fbbf24;--teal:#14b8a6;--purple:#8b5cf6;--rose:#f43f5e;--emerald:#10b981;--blue:#3b82f6;--orange:#f97316;--border:rgba(255,255,255,0.08);--border-light:rgba(255,255,255,0.12);--glass:rgba(10,15,26,0.9);--radius:16px;--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn:active{transform:scale(0.97)}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:#000}
.btn-secondary{background:var(--bg-elevated);border:1px solid var(--border-light);color:var(--text)}
.btn-secondary:hover{border-color:var(--gold)}
.btn-ghost{background:transparent;color:var(--text-secondary);padding:10px}
.btn-ghost:hover{color:var(--gold)}
.btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
.btn-sm{padding:10px 16px;font-size:0.8rem}
.btn-xs{padding:6px 12px;font-size:0.75rem}
.btn-full{width:100%}
.btn-icon{width:44px;height:44px;padding:0;border-radius:var(--radius-sm)}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:0.7rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
.form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.9rem;transition:all 0.2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold)}
.form-textarea{min-height:100px;resize:vertical}
.form-input-sm{padding:10px 14px;font-size:0.85rem}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:0.65rem;font-weight:700;text-transform:uppercase}
.badge-gold{background:rgba(245,158,11,0.15);color:var(--gold)}
.badge-teal{background:rgba(20,184,166,0.15);color:var(--teal)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--purple)}
.badge-rose{background:rgba(244,63,94,0.15);color:var(--rose)}
.badge-emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}
.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal.active{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-box.wide{max-width:700px}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:1.1rem;font-weight:700}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px}
.modal-footer .btn{flex:1}
.page{display:none;min-height:100vh}
.page.active{display:flex;flex-direction:column}
#landing{align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at top,#111827 0%,var(--bg) 50%)}
.landing-logo{width:88px;height:88px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:24px;display:grid;place-items:center;margin-bottom:28px;box-shadow:0 20px 40px rgba(245,158,11,0.3)}
.landing-logo svg{width:48px;height:48px;stroke:#000;stroke-width:2.5;fill:none}
.landing-title{font-size:2rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.landing-subtitle{color:var(--text-muted);margin-bottom:8px}
.landing-version{color:var(--teal);font-size:0.75rem;font-weight:600;margin-bottom:48px}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;width:100%;max-width:800px}
.unit-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden}
.unit-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--unit-color,var(--gold));transform:scaleX(0);transition:transform 0.3s}
.unit-card:hover::before{transform:scaleX(1)}
.unit-card:hover{border-color:var(--unit-color,var(--gold));transform:translateY(-4px)}
.unit-card-icon{font-size:2.5rem;margin-bottom:16px}
.unit-card-name{font-size:1.1rem;font-weight:700;margin-bottom:4px}
.unit-card-desc{color:var(--text-muted);font-size:0.85rem}
.fab{position:fixed;width:56px;height:56px;background:var(--bg-card);border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);z-index:50;transition:all 0.3s}
.fab svg{width:24px;height:24px}
.fab:hover{border-color:var(--gold);color:var(--gold)}
.admin-fab{bottom:24px;right:24px}
.sync-fab{bottom:24px;left:24px}
.sync-fab.syncing{animation:rotate 1s linear infinite;border-color:var(--gold);color:var(--gold)}
@keyframes rotate{to{transform:rotate(360deg)}}
/* Sync Status Indicator */
.sync-status{position:fixed;top:12px;right:12px;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:100px;font-size:0.75rem;font-weight:600;z-index:1000;transition:all 0.3s;opacity:0;transform:translateY(-10px);pointer-events:none}
.sync-status.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-status.syncing{border-color:var(--gold);color:var(--gold)}
.sync-status.synced{border-color:var(--emerald);color:var(--emerald)}
.sync-status.error{border-color:var(--rose);color:var(--rose)}
.sync-status.pending{border-color:var(--orange);color:var(--orange)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.sync-status.syncing .sync-dot{animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
/* Lab Extraction Confidence */
.extraction-confidence{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.8rem}
.confidence-bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.confidence-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.confidence-fill.high{background:var(--emerald)}
.confidence-fill.medium{background:var(--gold)}
.confidence-fill.low{background:var(--rose)}
.confidence-label{font-weight:600;min-width:40px;text-align:right}
/* Lab Extraction Preview */
.extraction-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin:16px 0}
.extraction-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.extraction-preview-title{font-weight:600;font-size:0.9rem}
.extraction-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.extraction-item:last-child{border-bottom:none}
.extraction-name{color:var(--text-secondary)}
.extraction-value{font-family:'JetBrains Mono',monospace;font-weight:600}
.extraction-value.critical{color:var(--rose)}
.extraction-value.high{color:var(--orange)}
.extraction-value.low{color:var(--blue)}
.extraction-value.normal{color:var(--emerald)}
.code-inputs{display:flex;gap:14px;justify-content:center;margin-bottom:20px}
.code-digit{width:56px;height:68px;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:1.75rem;font-weight:700;text-align:center;color:var(--text);transition:all 0.2s}
.code-digit:focus{outline:none;border-color:var(--gold)}
.code-digit.success{border-color:var(--emerald);background:rgba(16,185,129,0.1)}
.code-digit.error{border-color:var(--rose);animation:shake 0.3s}
@keyframes shake{25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.code-error{color:var(--rose);font-size:0.85rem;text-align:center;display:none;margin-top:12px}
.code-error.show{display:block}
#dashboard{background:var(--bg)}
.dash-header{background:var(--glass);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.dash-logo{display:flex;align-items:center;gap:14px}
.dash-logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:12px;display:grid;place-items:center}
.dash-logo-icon svg{width:24px;height:24px;stroke:#000;fill:none}
.dash-badge{padding:8px 16px;border-radius:100px;font-size:0.8rem;font-weight:600;border:1px solid var(--border)}
.dash-user{display:flex;align-items:center;gap:12px}
.dash-avatar{width:42px;height:42px;background:linear-gradient(135deg,var(--teal),var(--emerald));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:0.9rem}
.dash-content{flex:1;max-width:1000px;margin:0 auto;padding:20px;width:100%}
.date-banner{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:16px 20px;border-radius:var(--radius);margin-bottom:20px;font-weight:700;display:flex;align-items:center;gap:12px}
.tabs-container{background:var(--bg-card);border-radius:var(--radius);padding:6px;margin-bottom:20px;display:flex;gap:4px}
.tab{flex:1;padding:14px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg-elevated);color:var(--gold)}
.panel{display:none}
.panel.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 12px;text-align:center;cursor:pointer;transition:all 0.2s}
.stat-card:hover,.stat-card.active{border-color:var(--gold);background:rgba(245,158,11,0.08)}
.stat-value{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px}
.action-buttons .btn-full{grid-column:span 2}
.ward-section{margin-bottom:24px}
.ward-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(135deg,var(--bg-elevated),var(--bg-card));border-radius:var(--radius-sm);margin-bottom:14px;border-left:4px solid var(--gold)}
.ward-title{font-weight:700;font-size:0.95rem;color:var(--gold)}
.ward-count{background:var(--gold);color:#000;padding:4px 14px;border-radius:100px;font-size:0.75rem;font-weight:700}
.patient-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;cursor:pointer;transition:all 0.2s;border-left:4px solid var(--teal)}
.patient-card:hover{border-color:var(--gold);transform:translateX(4px)}
.patient-card.critical{border-left-color:var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.patient-card.chronic{border-left-color:var(--purple)}
.patient-card.new{border-left-color:var(--emerald);background:linear-gradient(135deg,rgba(16,185,129,0.05),transparent)}
.patient-header{display:flex;align-items:center;gap:16px}
.patient-avatar{width:52px;height:52px;border-radius:14px;display:grid;place-items:center;font-weight:700;font-size:0.9rem;color:#000;flex-shrink:0;background:linear-gradient(135deg,var(--gold),var(--orange))}
.patient-card.new .patient-avatar{background:linear-gradient(135deg,var(--emerald),var(--teal))}
.patient-card.chronic .patient-avatar{background:linear-gradient(135deg,var(--purple),#a855f7)}
.patient-card.critical .patient-avatar{background:linear-gradient(135deg,var(--rose),var(--orange))}
.patient-info{flex:1;min-width:0}
.patient-name{font-weight:700;font-size:1rem;margin-bottom:4px}
.patient-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:0.8rem;color:var(--text-secondary)}
.patient-diagnosis{font-size:0.85rem;color:var(--text-secondary);margin-top:12px;padding:12px 14px;background:var(--bg);border-radius:var(--radius-sm)}
#patientProfile{background:var(--bg)}
.profile-header{background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg) 100%);padding:20px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.profile-nav{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.back-btn{width:44px;height:44px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;cursor:pointer;color:var(--text-muted);transition:all 0.2s}
.back-btn:hover{border-color:var(--gold);color:var(--gold)}
.profile-title{font-size:1.25rem;font-weight:700;flex:1}
.profile-actions{display:flex;gap:8px}
.profile-patient{display:flex;align-items:center;gap:20px}
.profile-avatar{width:72px;height:72px;border-radius:20px;display:grid;place-items:center;font-size:1.5rem;font-weight:800;color:#000}
.profile-details h2{font-size:1.4rem;font-weight:800;margin-bottom:6px}
.profile-details .meta{display:flex;flex-wrap:wrap;gap:16px;color:var(--text-secondary);font-size:0.85rem}
.profile-tabs{display:flex;gap:6px;padding:0 20px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.profile-tabs::-webkit-scrollbar{display:none}
.profile-tab{padding:12px 20px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.2s}
.profile-tab:hover{color:var(--text)}
.profile-tab.active{color:var(--gold);border-bottom-color:var(--gold)}
.profile-content{flex:1;padding:20px;overflow-y:auto}
.profile-panel{display:none}
.profile-panel.active{display:block}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;overflow:hidden}
.section-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.section-title{font-weight:700;font-size:0.95rem;display:flex;align-items:center;gap:10px}
.section-body{padding:20px}
/* Lab Upload Area */
.lab-upload-area{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(20,184,166,0.08));border:2px dashed var(--border-light);border-radius:var(--radius);padding:32px 24px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:24px}
.lab-upload-area:hover{border-color:var(--gold);background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(20,184,166,0.12))}
.lab-upload-area.analyzing{pointer-events:none;opacity:0.7}
.lab-upload-icon{font-size:2.5rem;margin-bottom:12px}
.lab-upload-title{font-weight:700;font-size:1rem;margin-bottom:4px}
.lab-upload-subtitle{color:var(--text-muted);font-size:0.85rem}
@keyframes spin{to{transform:rotate(360deg)}}
/* AI Interpretation Card with Feedback */
.ai-interpretation{background:linear-gradient(135deg,rgba(20,184,166,0.08),rgba(59,130,246,0.08));border:1px solid rgba(20,184,166,0.2);border-radius:var(--radius);padding:20px;margin-bottom:24px}
.ai-interpretation-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ai-interpretation-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--teal)}
.ai-badge{background:linear-gradient(135deg,var(--purple),var(--blue));color:#fff;font-size:0.6rem;padding:4px 8px;border-radius:4px;font-weight:700}
.ai-interpretation-text{color:var(--text-secondary);font-size:0.9rem;line-height:1.7;margin-bottom:16px}
.ai-details{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px}
.ai-details-title{font-size:0.75rem;font-weight:600;color:var(--gold);text-transform:uppercase;margin-bottom:12px}
.ai-details-list{list-style:none;padding:0;margin:0}
.ai-details-list li{font-size:0.85rem;color:var(--text-secondary);padding:6px 0;border-bottom:1px solid var(--border)}
.ai-details-list li:last-child{border-bottom:none}
/* Feedback Buttons */
.feedback-section{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid var(--border)}
.feedback-label{font-size:0.75rem;color:var(--text-muted)}
.feedback-buttons{display:flex;gap:8px}
.feedback-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--bg);cursor:pointer;display:grid;place-items:center;font-size:1.1rem;transition:all 0.2s}
.feedback-btn:hover{transform:scale(1.1)}
.feedback-btn.positive:hover,.feedback-btn.positive.active{background:rgba(16,185,129,0.2);border-color:var(--emerald)}
.feedback-btn.negative:hover,.feedback-btn.negative.active{background:rgba(244,63,94,0.2);border-color:var(--rose)}
.feedback-btn.active{transform:scale(1.1)}
.feedback-sent{font-size:0.75rem;color:var(--emerald);display:none}
.feedback-sent.show{display:block}
/* Critical Alert */
.critical-alert{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;display:flex;align-items:flex-start;gap:12px}
.critical-alert-icon{font-size:1.25rem}
.critical-alert-content{flex:1}
.critical-alert-title{font-weight:700;color:var(--rose);margin-bottom:4px}
.critical-alert-values{font-size:0.85rem;color:var(--text-secondary)}
/* Lab Categories */
.lab-category{background:var(--bg);border-radius:var(--radius-sm);margin-bottom:16px;overflow:hidden}
.lab-category-header{padding:12px 16px;background:rgba(245,158,11,0.08);font-weight:600;font-size:0.8rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px}
.lab-category-body{padding:16px}
.lab-values-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.lab-value-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;transition:all 0.2s}
.lab-value-card.high{border-left:3px solid var(--rose);background:linear-gradient(135deg,rgba(244,63,94,0.05),transparent)}
.lab-value-card.low{border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05),transparent)}
.lab-value-card.critical{border-left:3px solid var(--rose);background:rgba(244,63,94,0.1)}
.lab-value-card.normal{border-left:3px solid var(--emerald)}
.lab-value-name{font-size:0.75rem;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.lab-value-status{font-size:0.55rem;font-weight:700;padding:2px 6px;border-radius:4px}
.lab-value-status.high,.lab-value-status.critical{background:var(--rose);color:#fff}
.lab-value-status.low{background:var(--blue);color:#fff}
.lab-value-number{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600;margin-bottom:4px}
.lab-value-card.high .lab-value-number{color:var(--rose)}
.lab-value-card.low .lab-value-number{color:var(--blue)}
.lab-value-card.normal .lab-value-number{color:var(--emerald)}
.lab-value-unit{font-size:0.7rem;color:var(--text-muted)}
.lab-value-range{font-size:0.65rem;color:var(--text-muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
/* Trend Section */
.lab-trend-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.lab-trend-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.lab-trend-select{padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;min-width:180px}
.lab-trend-chart{background:var(--bg);border-radius:var(--radius-sm);padding:20px;height:220px}
/* Other sections */
.vitals-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px}
.vital-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.vital-icon{font-size:1.5rem;margin-bottom:8px}
.vital-value{font-size:1.25rem;font-weight:700}
.vital-label{font-size:0.7rem;color:var(--text-muted);margin-top:4px}
.fluid-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fluid-stat{background:var(--bg);border-radius:var(--radius-sm);padding:16px;text-align:center}
.fluid-stat-value{font-size:1.5rem;font-weight:800}
.fluid-stat-value.intake{color:var(--blue)}
.fluid-stat-value.output{color:var(--orange)}
.fluid-stat-value.balance{color:var(--emerald)}
.fluid-stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-top:4px}
.fluid-chart-container{height:200px;margin-top:20px}
.plan-item{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;border-left:3px solid var(--gold)}
.plan-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.plan-item-date{font-size:0.7rem;color:var(--text-muted)}
.plan-item-content{font-size:0.9rem;white-space:pre-wrap}
.imaging-card{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}
.imaging-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.imaging-type{font-weight:600;display:flex;align-items:center;gap:8px}
.imaging-date{font-size:0.75rem;color:var(--text-muted)}
.imaging-summary{font-size:0.85rem;color:var(--text-secondary)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--emerald);padding:16px 28px;border-radius:var(--radius);font-size:0.9rem;opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--rose)}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}
.empty-state-icon{font-size:3.5rem;margin-bottom:16px;opacity:0.4}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 24px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}
.ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ref-card{background:var(--bg);border-radius:var(--radius-sm);padding:18px;border-left:3px solid var(--gold)}
.ref-card h4{font-size:0.9rem;margin-bottom:10px}
.ref-card p{font-size:0.8rem;color:var(--text-secondary)}
.import-item{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:10px;border-left:4px solid var(--teal)}
.import-ward-select{padding:8px 12px;background:var(--bg-card);border:1px solid var(--gold);border-radius:8px;color:var(--gold);font-size:0.75rem;font-weight:600}
#adminPanel{background:var(--bg)}
.admin-header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.admin-content{max-width:700px;margin:0 auto;padding:24px}
.admin-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden}
.units-table{width:100%;border-collapse:collapse}
.units-table th,.units-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border)}
.units-table th{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase}
@media(max-width:640px){
.stats-grid{grid-template-columns:repeat(3,1fr)}
.action-buttons{grid-template-columns:1fr}
.action-buttons .btn-full{grid-column:span 1}
.profile-patient{flex-direction:column;text-align:center}
.profile-details .meta{justify-content:center}
.lab-values-grid{grid-template-columns:repeat(2,1fr)}
}
/* Unit Request Styles */
.request-unit-btn{margin-top:32px;padding:16px 32px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-muted);font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}
.request-unit-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(245,158,11,0.05)}
.request-form{display:flex;flex-direction:column;gap:20px}
.request-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:500px){.request-form-row{grid-template-columns:1fr}}
.request-form .form-input,.request-form .form-textarea,.request-form .form-select{background:var(--bg);border:1px solid var(--border)}
.request-form .form-input:focus,.request-form .form-textarea:focus,.request-form .form-select:focus{border-color:var(--gold)}
.request-icon-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.request-icon-option{width:100%;aspect-ratio:1;background:var(--bg);border:2px solid var(--border);border-radius:var(--radius-sm);font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:grid;place-items:center}
.request-icon-option:hover{border-color:var(--text-muted)}
.request-icon-option.selected{border-color:var(--gold);background:rgba(245,158,11,0.1)}
.request-success{text-align:center;padding:40px 20px}
.request-success-icon{font-size:4rem;margin-bottom:20px}
.request-success-title{font-size:1.25rem;font-weight:700;margin-bottom:8px}
.request-success-text{color:var(--text-muted);font-size:0.9rem;margin-bottom:24px}
.request-success-id{background:var(--bg);padding:12px 20px;border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:0.9rem;display:inline-block}
/* Admin Requests */
.requests-list{display:flex;flex-direction:column;gap:12px}
.request-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;border-left:4px solid var(--gold)}
.request-card.approved{border-left-color:var(--emerald);opacity:0.7}
.request-card.rejected{border-left-color:var(--rose);opacity:0.7}
.request-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.request-card-title{font-weight:700;font-size:1rem}
.request-card-status{padding:4px 12px;border-radius:100px;font-size:0.7rem;font-weight:700;text-transform:uppercase}
.request-card-status.pending{background:rgba(245,158,11,0.15);color:var(--gold)}
.request-card-status.approved{background:rgba(16,185,129,0.15);color:var(--emerald)}
.request-card-status.rejected{background:rgba(244,63,94,0.15);color:var(--rose)}
.request-card-details{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-detail{display:flex;align-items:center;gap:6px}
.request-card-message{background:var(--bg-card);padding:12px;border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px}
.request-card-actions{display:flex;gap:8px}
.request-card-time{font-size:0.75rem;color:var(--text-muted);position:absolute;top:16px;right:16px}
.admin-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg);padding:4px;border-radius:var(--radius-sm)}
.admin-tab{flex:1;padding:12px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
.admin-tab:hover{color:var(--text)}
.admin-tab.active{background:var(--bg-elevated);color:var(--gold)}
.admin-tab-panel{display:none}
.admin-tab-panel.active{display:block}
.badge-count{background:var(--rose);color:#fff;padding:2px 8px;border-radius:100px;font-size:0.7rem;margin-left:8px}
.approve-form{background:var(--bg);border-radius:var(--radius-sm);padding:16px;margin-top:12px;display:none}
.approve-form.show{display:block}
.approve-form-row{display:flex;gap:12px;margin-bottom:12px}
.approve-form-row .form-input{flex:1}
</style>
</head>
<body>
<!-- LANDING PAGE -->
<div class="page active" id="landing">

<!-- Sync Status Indicator -->
<div class="sync-status" id="syncStatus">
  <div class="sync-dot"></div>
  <span id="syncStatusText">Synced</span>
</div>
<div class="landing-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
<h1 class="landing-title">MedWard Pro</h1>
<p class="landing-subtitle">Neural Clinical Management System</p>
<p class="landing-version">üß† AI-Powered ‚Ä¢ Auto-Sync ‚Ä¢ Enhanced Lab OCR ‚Ä¢ v12.0</p>
<div class="units-grid" id="unitsGrid"></div>
<button class="request-unit-btn" onclick="openRequestUnit()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 5v14M5 12h14"/></svg>
Request New Unit Access
</button>
<div class="fab sync-fab" id="syncFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/></svg></div>
<div class="fab admin-fab" id="adminFab"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
</div>

<!-- DASHBOARD -->
<div class="page" id="dashboard">
<header class="dash-header">
<div class="dash-logo">
<div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
<span class="dash-badge" id="unitBadge">Unit</span>
</div>
<div class="dash-user">
<div class="dash-avatar" id="dashAvatar">DR</div>
<button class="btn btn-ghost btn-icon" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
</div>
</header>
<div class="dash-content">
<div class="date-banner">üìÖ <span id="currentDate"></span></div>
<div class="tabs-container" id="mainTabs">
<button class="tab active" data-tab="patients">üë• Patients</button>
<button class="tab" data-tab="reference">üìö Reference</button>
</div>
<div class="panel active" id="panelPatients">
<div class="stats-grid" id="statsBar">
<div class="stat-card active" data-filter="all"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
<div class="stat-card" data-filter="new"><div class="stat-value" id="statNew">0</div><div class="stat-label">New</div></div>
<div class="stat-card" data-filter="active"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
<div class="stat-card" data-filter="critical"><div class="stat-value" id="statCritical">0</div><div class="stat-label">Critical</div></div>
<div class="stat-card" data-filter="chronic"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
</div>
<div class="action-buttons">
<button class="btn btn-primary btn-sm" onclick="openAddPatient()">‚ûï Add Patient</button>
<button class="btn btn-secondary btn-sm" onclick="openImport()">üì• Import List</button>
<button class="btn btn-secondary btn-sm btn-full" onclick="exportPDF()">üìÑ Export PDF</button>
</div>
<div id="patientsList"></div>
</div>
<div class="panel" id="panelReference">
<div class="section-card">
<div class="section-header"><div class="section-title">üìö Clinical Reference</div></div>
<div class="section-body"><div class="ref-grid" id="refGrid"></div></div>
</div>
</div>
</div>
</div>

<!-- PATIENT PROFILE -->
<div class="page" id="patientProfile">
<div class="profile-header">
<div class="profile-nav">
<div class="back-btn" onclick="closePatientProfile()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
<div class="profile-title">Patient Profile</div>
<div class="profile-actions">
<button class="btn btn-secondary btn-sm" onclick="editCurrentPatient()">‚úèÔ∏è</button>
<button class="btn btn-danger btn-sm" onclick="deleteCurrentPatient()">üóëÔ∏è</button>
</div>
</div>
<div class="profile-patient" id="profilePatientInfo"></div>
</div>
<div class="profile-tabs" id="profileTabs">
<button class="profile-tab active" data-ptab="overview">Overview</button>
<button class="profile-tab" data-ptab="labs">Labs</button>
<button class="profile-tab" data-ptab="imaging">Imaging</button>
<button class="profile-tab" data-ptab="fluids">Fluids</button>
<button class="profile-tab" data-ptab="plans">Plans</button>
</div>
<div class="profile-content">
<div class="profile-panel active" id="profileOverview"></div>
<div class="profile-panel" id="profileLabs"></div>
<div class="profile-panel" id="profileImaging"></div>
<div class="profile-panel" id="profileFluids"></div>
<div class="profile-panel" id="profilePlans"></div>
</div>
</div>

<!-- ADMIN -->
<div class="page" id="adminPanel">
<header class="admin-header">
<div style="display:flex;align-items:center;gap:12px">
<div class="dash-logo-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke-width="2"/></svg></div>
<span style="font-weight:700">Admin Dashboard</span>
</div>
<button class="btn btn-secondary btn-sm" onclick="exitAdmin()">‚Üê Exit</button>
</header>
<div class="admin-content">
<div class="admin-tabs" id="adminTabs">
<button class="admin-tab active" data-atab="units">üè• Units</button>
<button class="admin-tab" data-atab="requests">üì© Requests <span class="badge-count" id="requestsCount" style="display:none">0</span></button>
<button class="admin-tab" data-atab="settings">‚öôÔ∏è Settings</button>
</div>

<div class="admin-tab-panel active" id="adminUnits">
<div class="admin-section">
<div class="section-header"><div class="section-title">üè• Manage Units</div><button class="btn btn-primary btn-sm" onclick="addUnit()">+ Add Unit</button></div>
<table class="units-table"><thead><tr><th>Unit</th><th>Code</th><th>Actions</th></tr></thead><tbody id="unitsTable"></tbody></table>
</div>
</div>

<div class="admin-tab-panel" id="adminRequests">
<div class="admin-section">
<div class="section-header"><div class="section-title">üì© Unit Access Requests</div><button class="btn btn-secondary btn-sm" onclick="refreshRequests()">üîÑ Refresh</button></div>
<div class="section-body">
<div class="requests-list" id="requestsList">
<div style="text-align:center;padding:40px;color:var(--text-muted)">
<div style="font-size:2rem;margin-bottom:12px">üì≠</div>
<div>No pending requests</div>
</div>
</div>
</div>
</div>
</div>

<div class="admin-tab-panel" id="adminSettings">
<div class="admin-section">
<div class="section-header"><div class="section-title">‚öôÔ∏è System Settings</div></div>
<div class="section-body">
<div class="form-group"><label class="form-label">Admin Password</label><input type="password" id="newAdminPwd" class="form-input" placeholder="Enter new password"></div>
<div class="form-group"><label class="form-label">API Endpoint</label><input type="text" id="apiUrl" class="form-input" placeholder="https://script.google.com/macros/s/.../exec"></div>
<button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
</div>
</div>
</div>
</div>
</div>

<!-- MODALS -->
<div class="modal" id="accessModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div id="accessIcon" style="font-size:3rem;margin-bottom:12px">üè•</div>
<div class="modal-title" id="accessTitle">Unit Access</div>
<p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">Enter 4-digit code</p>
</div>
<div class="modal-body">
<div class="code-inputs" id="codeInputs"></div>
<p class="code-error" id="codeError">Invalid code</p>
<div id="userSection" style="display:none;margin-top:28px;padding-top:28px;border-top:1px solid var(--border)">
<div class="form-group"><label class="form-label">Your Name</label><input type="text" id="userName" class="form-input"></div>
<div class="form-group"><label class="form-label">Role</label><select id="userRole" class="form-select"><option value="attending">Attending</option><option value="resident">Resident</option><option value="intern">Intern</option></select></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('accessModal')">Cancel</button>
<button class="btn btn-primary" id="enterBtn" style="display:none" onclick="enterUnit()">Enter</button>
</div>
</div>
</div>

<div class="modal" id="adminModal">
<div class="modal-box">
<div class="modal-header" style="text-align:center;display:block;border:none">
<div style="font-size:3rem;margin-bottom:12px">‚öôÔ∏è</div>
<div class="modal-title">Admin Access</div>
</div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Password</label><input type="password" id="adminPwd" class="form-input"></div>
<p class="code-error" id="adminError">Invalid</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('adminModal')">Cancel</button>
<button class="btn btn-primary" onclick="loginAdmin()">Login</button>
</div>
</div>
</div>

<div class="modal" id="patientModal">
<div class="modal-box" style="max-width:540px">
<div class="modal-header"><div class="modal-title" id="patientModalTitle">Add Patient</div></div>
<div class="modal-body">
<input type="hidden" id="ptId">
<div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="ptName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Ward</label><select id="ptWard" class="form-select"><option value="Ward 14">Ward 14</option><option value="Ward 22">Ward 22</option><option value="Ward 27">Ward 27</option><option value="ICU">ICU</option><option value="ER/Unassigned">ER/Unassigned</option></select></div>
<div class="form-group"><label class="form-label">Room</label><input type="text" id="ptRoom" class="form-input"></div>
</div>
<div class="form-group"><label class="form-label">Diagnosis</label><textarea id="ptDx" class="form-textarea"></textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Doctor</label><input type="text" id="ptDoctor" class="form-input"></div>
<div class="form-group"><label class="form-label">Status</label><select id="ptStatus" class="form-select"><option value="new">üÜï New</option><option value="active">‚úÖ Active</option><option value="critical">üö® Critical</option><option value="chronic">üíú Chronic</option></select></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
<button class="btn btn-primary" onclick="savePatient()">Save</button>
</div>
</div>
</div>

<div class="modal" id="unitModal">
<div class="modal-box">
<div class="modal-header"><div class="modal-title" id="unitModalTitle">Add Unit</div></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Name</label><input type="text" id="uName" class="form-input"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div class="form-group"><label class="form-label">Icon</label><input type="text" id="uIcon" class="form-input" value="üè•" style="font-size:1.75rem;text-align:center"></div>
<div class="form-group"><label class="form-label">Code</label><input type="text" id="uCode" class="form-input" maxlength="4"></div>
</div>
<div class="form-group"><label class="form-label">Description</label><input type="text" id="uDesc" class="form-input"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('unitModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveUnit()">Save</button>
</div>
</div>
</div>

<div class="modal" id="importModal">
<div class="modal-box" style="max-width:560px">
<div class="modal-header"><div class="modal-title">üì• Import Patients</div></div>
<div class="modal-body">
<div id="importUpload">
<div class="upload-zone" onclick="document.getElementById('importFile').click()">
<div style="font-size:2.5rem;margin-bottom:12px">üì∑</div>
<div style="font-weight:600">Upload Screenshot</div>
</div>
<input type="file" id="importFile" accept="image/*" style="display:none">
</div>
<div id="importPreview" style="display:none">
<img id="importImg" style="width:100%;max-height:160px;object-fit:contain;border-radius:12px;margin-bottom:16px">
<div style="display:flex;gap:12px">
<button class="btn btn-secondary btn-sm" style="flex:1" onclick="resetImport()">Change</button>
<button class="btn btn-primary btn-sm" style="flex:2" onclick="extractPatients()">ü§ñ Extract</button>
</div>
</div>
<div id="importLoading" style="display:none;text-align:center;padding:48px"><div class="spinner"></div></div>
<div id="importResults" style="display:none">
<div style="display:flex;justify-content:space-between;margin-bottom:16px"><span style="font-weight:600">Found</span><span id="importCount" class="badge badge-emerald">0</span></div>
<div id="importList" style="max-height:320px;overflow-y:auto"></div>
</div>
<div id="importError" style="display:none;text-align:center;padding:40px">
<div style="font-size:2.5rem;margin-bottom:16px">‚ö†Ô∏è</div>
<div id="importErrorMsg" style="color:var(--rose)">Error</div>
<button class="btn btn-secondary btn-sm" style="margin-top:16px" onclick="resetImport()">Retry</button>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
<button class="btn btn-primary" id="importConfirmBtn" onclick="confirmImport()" disabled>Import</button>
</div>
</div>
</div>

<div class="modal" id="editTextModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="editTextTitle">Edit</div></div>
<div class="modal-body">
<input type="hidden" id="editTextType">
<textarea id="editTextArea" class="form-textarea" style="min-height:200px"></textarea>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('editTextModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveEditText()">Save</button>
</div>
</div>
</div>

<div class="modal" id="addDataModal">
<div class="modal-box wide">
<div class="modal-header"><div class="modal-title" id="addDataTitle">Add</div></div>
<div class="modal-body" id="addDataBody"></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('addDataModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveAddData()">Save</button>
</div>
</div>
</div>

<!-- REQUEST UNIT MODAL -->
<div class="modal" id="requestUnitModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">üì© Request New Unit Access</div>
<button class="btn btn-ghost" onclick="closeModal('requestUnitModal')">‚úï</button>
</div>
<div class="modal-body" id="requestUnitBody">
<div id="requestFormSection">
<p style="color:var(--text-secondary);margin-bottom:24px;font-size:0.9rem">Fill out this form to request a new unit. Your request will be reviewed by an administrator who will create your unit and provide access credentials.</p>
<div class="request-form">
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Your Full Name *</label>
<input type="text" id="reqName" class="form-input" placeholder="Dr. John Smith">
</div>
<div class="form-group">
<label class="form-label">Email Address *</label>
<input type="email" id="reqEmail" class="form-input" placeholder="john.smith@hospital.com">
</div>
</div>
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Department *</label>
<input type="text" id="reqDepartment" class="form-input" placeholder="e.g., Internal Medicine, Cardiology">
</div>
<div class="form-group">
<label class="form-label">Position/Role *</label>
<select id="reqRole" class="form-input">
<option value="">Select role...</option>
<option value="attending">Attending Physician</option>
<option value="consultant">Consultant</option>
<option value="resident">Resident</option>
<option value="intern">Intern</option>
<option value="nurse_manager">Nurse Manager</option>
<option value="head_nurse">Head Nurse</option>
<option value="other">Other</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Requested Unit Name *</label>
<input type="text" id="reqUnitName" class="form-input" placeholder="e.g., Cardiology Unit A, ICU Team 2">
</div>
<div class="form-group">
<label class="form-label">Unit Icon</label>
<div class="request-icon-grid" id="iconGrid">
<div class="request-icon-option selected" data-icon="üè•">üè•</div>
<div class="request-icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div>
<div class="request-icon-option" data-icon="ü´Ä">ü´Ä</div>
<div class="request-icon-option" data-icon="üß†">üß†</div>
<div class="request-icon-option" data-icon="ü´Å">ü´Å</div>
<div class="request-icon-option" data-icon="ü¶¥">ü¶¥</div>
<div class="request-icon-option" data-icon="üë∂">üë∂</div>
<div class="request-icon-option" data-icon="ü©∫">ü©∫</div>
<div class="request-icon-option" data-icon="üíâ">üíâ</div>
<div class="request-icon-option" data-icon="üî¨">üî¨</div>
<div class="request-icon-option" data-icon="‚öïÔ∏è">‚öïÔ∏è</div>
<div class="request-icon-option" data-icon="üöë">üöë</div>
</div>
</div>
<div class="form-group">
<label class="form-label">Reason for Request / Additional Notes</label>
<textarea id="reqMessage" class="form-textarea" placeholder="Briefly describe why you need this unit and any specific requirements..."></textarea>
</div>
</div>
</div>
<div id="requestSuccessSection" style="display:none">
<div class="request-success">
<div class="request-success-icon">‚úÖ</div>
<div class="request-success-title">Request Submitted Successfully!</div>
<div class="request-success-text">Your request has been sent to the administrator for review. You will receive your unit access code once approved.</div>
<div class="request-success-id" id="requestIdDisplay">Request ID: REQ-XXXXXX</div>
</div>
</div>
</div>
<div class="modal-footer" id="requestFormFooter">
<button class="btn btn-secondary" onclick="closeModal('requestUnitModal')">Cancel</button>
<button class="btn btn-primary" onclick="submitUnitRequest()">üì§ Submit Request</button>
</div>
<div class="modal-footer" id="requestSuccessFooter" style="display:none">
<button class="btn btn-primary btn-full" onclick="closeModal('requestUnitModal')">Done</button>
</div>
</div>
</div>

<!-- APPROVE REQUEST MODAL -->
<div class="modal" id="approveRequestModal">
<div class="modal-box wide">
<div class="modal-header">
<div class="modal-title">‚úÖ Approve Unit Request</div>
<button class="btn btn-ghost" onclick="closeModal('approveRequestModal')">‚úï</button>
</div>
<div class="modal-body">
<div id="approveRequestDetails"></div>
<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)">
<h4 style="margin-bottom:16px;font-size:0.9rem">Create Unit Access</h4>
<div class="request-form">
<div class="request-form-row">
<div class="form-group">
<label class="form-label">Unit Name</label>
<input type="text" id="approveUnitName" class="form-input">
</div>
<div class="form-group">
<label class="form-label">Unit Icon</label>
<input type="text" id="approveUnitIcon" class="form-input" style="font-size:1.5rem;text-align:center">
</div>
</div>
<div class="request-form-row">
<div class="form-group">
<label class="form-label">4-Digit Access Code *</label>
<input type="text" id="approveUnitCode" class="form-input mono" maxlength="4" placeholder="1234" style="font-size:1.5rem;text-align:center;letter-spacing:8px">
</div>
<div class="form-group">
<label class="form-label">Unit Color</label>
<select id="approveUnitColor" class="form-input">
<option value="#14b8a6">üü¢ Teal</option>
<option value="#f59e0b">üü° Gold</option>
<option value="#3b82f6">üîµ Blue</option>
<option value="#8b5cf6">üü£ Purple</option>
<option value="#f43f5e">üî¥ Rose</option>
<option value="#10b981">üü¢ Emerald</option>
</select>
</div>
</div>
<div class="form-group">
<label class="form-label">Unit Description</label>
<input type="text" id="approveUnitDesc" class="form-input" placeholder="Brief description of the unit">
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('approveRequestModal')">Cancel</button>
<button class="btn btn-danger" onclick="rejectRequest()">‚ùå Reject</button>
<button class="btn btn-primary" onclick="approveRequest()">‚úÖ Approve & Create Unit</button>
</div>
</div>
</div>

<!-- Lab Extraction Preview Modal -->
<div class="modal" id="labPreviewModal">
  <div class="modal-box wide">
    <div class="modal-header">
      <div class="modal-title">üß™ Lab Extraction Preview</div>
      <button class="btn btn-ghost" onclick="closeModal('labPreviewModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="labExtractionConfidence"></div>
      <div id="labExtractionPreview"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('labPreviewModal'); resetLabExtraction()">Cancel</button>
      <button class="btn btn-primary" id="confirmLabBtn" onclick="confirmLabExtraction()">‚úì Confirm & Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="labFileInput" accept="image/*" style="display:none">
<input type="file" id="imagingFileInput" accept="image/*" style="display:none">
<script>
(function(){
'use strict';

const CONFIG = {
  STORAGE_KEY: 'medward_pro_v12',
  ADMIN_PASSWORD: 'admin123',
  API_URL: 'YOUR_API_URL_HERE',
  MAX_IMAGE_SIZE: 1500000,
  IMAGE_QUALITY: 0.85,
  MAX_DIM: 2000,
  SYNC_DEBOUNCE_MS: 1500,
  VALID_WARDS: ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned'],
  LAB_CATEGORIES: {
    'Cardiac Markers': { icon: '‚ù§Ô∏è', terms: ['Troponin', 'BNP', 'proBNP', 'NT-proBNP', 'CK-MB', 'Myoglobin'] },
    'Renal Function': { icon: 'ü´ò', terms: ['Urea', 'Creatinine', 'Creat', 'eGFR', 'BUN'] },
    'Electrolytes': { icon: '‚ö°', terms: ['Na', 'Sodium', 'K', 'Potassium', 'Cl', 'Chloride', 'CO2', 'Bicarbonate', 'Mg', 'Magnesium', 'Ca', 'Calcium', 'Phosphate', 'Phos'] },
    'Glucose & Metabolic': { icon: 'üç¨', terms: ['Glucose', 'Gluc', 'FBG', 'RBG', 'HbA1c', 'Lactate'] },
    'Liver Function': { icon: 'ü´Ä', terms: ['ALT', 'AST', 'ALP', 'GGT', 'Bilirubin', 'Albumin', 'Total Protein'] },
    'Complete Blood Count': { icon: 'ü©∏', terms: ['Hgb', 'Hemoglobin', 'WBC', 'Platelets', 'RBC', 'MCV', 'Hct'] },
    'Other': { icon: 'üî¨', terms: ['Urate', 'Uric Acid', 'Anion Gap', 'Osmolality', 'CRP', 'ESR', 'Procalcitonin'] }
  },
  REFS: [
    { title: 'üö® Critical Labs', content: '<b>K:</b> <2.5 or >6.5<br><b>Na:</b> <120 or >160<br><b>Glucose:</b> <40 or >500' },
    { title: '‚ö° Hyperkalemia', content: '<b>Stabilize:</b> Ca gluconate 1g<br><b>Shift:</b> Insulin + D50<br><b>Remove:</b> Kayexalate' },
    { title: '‚ù§Ô∏è ACS', content: '<b>MONA:</b> Morphine, O‚ÇÇ, Nitrates, ASA<br><b>STEMI:</b> PCI <90min' },
    { title: 'üß† Stroke tPA', content: '<b>Window:</b> ‚â§4.5h<br><b>Dose:</b> 0.9mg/kg max 90mg' },
    { title: 'ü¶† Sepsis', content: '<b>Hour-1:</b> Lactate, cultures, abx<br><b>Fluids:</b> 30mL/kg' },
    { title: 'üíä Status Epilepticus', content: '<b>1st:</b> Lorazepam 4mg<br><b>2nd:</b> Levetiracetam 60mg/kg' }
  ]
};

const state = {
  units: [], settings: {}, patients: [], currentUnit: null, currentUser: null, currentPatient: null,
  selectedUnitId: null, editingUnitId: null, importImage: null, importPatients: [], currentFilter: 'all',
  fluidChart: null, trendChart: null, addDataType: null, isAnalyzingLab: false, isAnalyzingImaging: false,
  currentInteractionId: null, sessionId: null, unitRequests: [], selectedRequestId: null, selectedIcon: 'üè•',
  pendingLabData: null, labExtractionConfidence: 0
};

// Generate session ID
state.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

// Sync state tracking for reactive auto-sync
let syncState = {
  status: 'synced',
  lastSyncTime: null,
  pendingChanges: false,
  syncTimeout: null,
  errorCount: 0
};

const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = t => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
const initials = n => { if (!n) return '?'; const p = n.trim().split(/\s+/); return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : n.substring(0, 2).toUpperCase(); };

function toast(msg, isError = false) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
window.closeModal = closeModal;

function showPage(pageId) {
  $$('.page').forEach(p => p.classList.remove('active'));
  $(pageId).classList.add('active');
}

function formatDate(d) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  d = d || new Date();
  return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function formatDateTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatShortDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function compress(file, max, cb) {
  const r = new FileReader();
  r.onload = e => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas'), ctx = c.getContext('2d');
      let w = img.width, h = img.height, q = CONFIG.IMAGE_QUALITY;
      if (w > CONFIG.MAX_DIM || h > CONFIG.MAX_DIM) {
        if (w > h) { h = Math.round(h * CONFIG.MAX_DIM / w); w = CONFIG.MAX_DIM; }
        else { w = Math.round(w * CONFIG.MAX_DIM / h); h = CONFIG.MAX_DIM; }
      }
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      let url = c.toDataURL('image/jpeg', q);
      while (url.length > max && q > 0.3) { q -= 0.1; url = c.toDataURL('image/jpeg', q); }
      cb(url);
    };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

function smartWard(raw) {
  if (!raw) return 'Ward 14';
  const w = String(raw).toLowerCase();
  if (w.includes('14')) return 'Ward 14';
  if (w.includes('22')) return 'Ward 22';
  if (w.includes('27')) return 'Ward 27';
  if (w.includes('icu')) return 'ICU';
  if (w.includes('er') || w.includes('unassign')) return 'ER/Unassigned';
  return 'Ward 14';
}

function getLabCategory(name) {
  const n = (name || '').toLowerCase();
  for (const [cat, data] of Object.entries(CONFIG.LAB_CATEGORIES)) {
    if (data.terms.some(t => n.includes(t.toLowerCase()))) return cat;
  }
  return 'Other';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let isSyncing = false;

function loadLocal() {
  try {
    const s = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (s) {
      const d = JSON.parse(s);
      if (d.units?.length) state.units = d.units;
      if (d.settings) state.settings = { ...state.settings, ...d.settings };
      if (d.patients) state.patients = d.patients;
      if (d.unitRequests) state.unitRequests = d.unitRequests;
    }
  } catch (e) {}
  if (!state.units.length) state.units = [{ id: 'med-e', name: 'Medicine Unit E', icon: 'üè•', desc: 'Internal Medicine', code: '1234', color: '#14b8a6' }];
  state.settings.adminPassword = state.settings.adminPassword || CONFIG.ADMIN_PASSWORD;
  state.settings.apiUrl = state.settings.apiUrl || CONFIG.API_URL;
}

function saveLocal() {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
      units: state.units, settings: state.settings, patients: state.patients, unitRequests: state.unitRequests, lastUpdated: new Date().toISOString()
    }));
  } catch (e) {}
}

async function syncCloud() {
  // Redirect to new system
  await syncFromCloud();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REACTIVE AUTO-SYNC SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateSyncStatus(status, message) {
  syncState.status = status;
  const el = $('syncStatus');
  const textEl = $('syncStatusText');
  
  if (!el || !textEl) return;
  
  el.className = 'sync-status visible ' + status;
  textEl.textContent = message || {
    synced: 'Synced',
    pending: 'Saving...',
    syncing: 'Syncing...',
    error: 'Sync failed'
  }[status];
  
  if (status === 'synced') {
    setTimeout(() => {
      if (syncState.status === 'synced') {
        el.classList.remove('visible');
      }
    }, 2000);
  }
}

function markDirty() {
  syncState.pendingChanges = true;
  updateSyncStatus('pending', 'Saving...');
  
  if (syncState.syncTimeout) {
    clearTimeout(syncState.syncTimeout);
  }
  
  syncState.syncTimeout = setTimeout(() => {
    performSync();
  }, CONFIG.SYNC_DEBOUNCE_MS);
}

async function performSync() {
  if (!syncState.pendingChanges) return;
  
  // Always save locally first
  saveLocal();
  
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') {
    syncState.pendingChanges = false;
    updateSyncStatus('synced', 'Saved locally');
    return;
  }
  
  updateSyncStatus('syncing', 'Syncing to cloud...');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'saveData',
        payload: { 
          units: state.units, 
          settings: { adminPassword: state.settings.adminPassword }, 
          patients: state.patients,
          unitRequests: state.unitRequests
        }
      })
    });
    
    if (!res.ok) throw new Error('HTTP ' + res.status);
    
    syncState.pendingChanges = false;
    syncState.lastSyncTime = Date.now();
    syncState.errorCount = 0;
    updateSyncStatus('synced', 'Synced');
    
  } catch (e) {
    console.error('Sync error:', e);
    syncState.errorCount++;
    
    if (syncState.errorCount >= 3) {
      updateSyncStatus('error', 'Sync failed - check connection');
    } else {
      setTimeout(() => performSync(), 5000);
      updateSyncStatus('pending', 'Retrying...');
    }
  }
}

async function saveCloud() {
  markDirty();
}

async function manualSync() {
  const syncFab = $('syncFab');
  syncFab.classList.add('syncing');
  updateSyncStatus('syncing', 'Syncing...');
  
  try {
    await syncFromCloud();
    syncState.pendingChanges = true;
    await performSync();
    toast('Synced successfully!');
  } catch (e) {
    toast('Sync failed', true);
  }
  
  syncFab.classList.remove('syncing');
}

async function syncFromCloud() {
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') return;
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'loadData' })
    });
    
    const data = await res.json();
    
    if (data.success && data.data) {
      if (data.data.units?.length) state.units = data.data.units;
      if (data.data.settings) state.settings = { ...state.settings, ...data.data.settings };
      if (data.data.patients) state.patients = data.data.patients;
      if (data.data.unitRequests) state.unitRequests = data.data.unitRequests;
      saveLocal();
      if (state.currentUnit) renderPatients();
      else renderUnits();
    }
  } catch (e) {
    console.error('Load from cloud failed:', e);
  }
}

function getUnit(id) { return state.units.find(u => u.id === id); }
function getPatient(id) { return state.patients.find(p => p.id === id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEEDBACK SYSTEM (RLHF)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function sendFeedback(rating, interpretationType = 'lab') {
  if (!state.currentInteractionId || !state.currentPatient) return;
  
  const p = state.currentPatient;
  
  try {
    await fetch(state.settings.apiUrl, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'recordFeedback',
        interactionId: state.currentInteractionId,
        patientId: p.id,
        interpretationType,
        rating,
        interpretation: p.labData?.interpretation?.summary || '',
        labValues: p.labData?.parameters?.map(param => ({
          name: param.name,
          value: param.values?.[0]?.value,
          status: param.values?.[0]?.status
        })) || [],
        sessionId: state.sessionId
      })
    });
    
    // Update UI
    $$('.feedback-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.feedback-btn.${rating > 0 ? 'positive' : 'negative'}`)?.classList.add('active');
    document.querySelector('.feedback-sent')?.classList.add('show');
    
    toast(rating > 0 ? 'Thanks! This helps improve accuracy.' : 'Feedback noted. We\'ll improve.');
  } catch (e) {
    console.error('Feedback error:', e);
  }
}

window.sendFeedback = sendFeedback;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderUnits() {
  $('unitsGrid').innerHTML = state.units.map(u => `
    <div class="unit-card" style="--unit-color:${u.color || '#f59e0b'}" data-id="${u.id}">
      <div class="unit-card-icon">${u.icon || 'üè•'}</div>
      <div class="unit-card-name">${esc(u.name)}</div>
      <div class="unit-card-desc">${esc(u.desc || '')}</div>
    </div>
  `).join('');
  $$('.unit-card').forEach(c => c.onclick = () => openUnitAccess(c.dataset.id));
}

function renderUnitsTable() {
  $('unitsTable').innerHTML = state.units.map(u => `
    <tr>
      <td><span style="font-size:1.25rem;margin-right:10px">${u.icon}</span><b>${esc(u.name)}</b></td>
      <td><code style="background:var(--bg);padding:6px 14px;border-radius:8px">${u.code}</code></td>
      <td><button class="btn btn-ghost btn-xs" onclick="editUnit('${u.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-xs" onclick="deleteUnit('${u.id}')">üóëÔ∏è</button></td>
    </tr>
  `).join('');
}

function renderPatients() {
  const container = $('patientsList');
  const f = state.currentFilter;
  let filtered = f === 'all' ? [...state.patients] : state.patients.filter(p => p.status === f);
  
  const wards = {};
  filtered.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); });
  
  if (!filtered.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><div>No patients</div></div>';
    updateStats();
    return;
  }
  
  const order = ['Ward 14', 'Ward 22', 'Ward 27', 'ICU', 'ER/Unassigned', 'Unassigned'];
  let html = '';
  Object.keys(wards).sort((a, b) => (order.indexOf(a) === -1 ? 99 : order.indexOf(a)) - (order.indexOf(b) === -1 ? 99 : order.indexOf(b))).forEach(ward => {
    const ps = wards[ward];
    html += `<div class="ward-section"><div class="ward-header"><div class="ward-title">üìç ${esc(ward)}</div><div class="ward-count">${ps.length}</div></div>`;
    ps.forEach(p => {
      html += `<div class="patient-card ${p.status}" onclick="openPatientProfile(${p.id})">
        <div class="patient-header">
          <div class="patient-avatar">${initials(p.name)}</div>
          <div class="patient-info">
            <div class="patient-name">${esc(p.name)} ${p.status === 'new' ? '<span class="badge badge-emerald">NEW</span>' : ''} ${p.status === 'critical' ? '<span class="badge badge-rose">CRITICAL</span>' : ''}</div>
            <div class="patient-meta"><span>üõèÔ∏è ${esc(p.room || '‚Äî')}</span><span>üë®‚Äç‚öïÔ∏è ${esc(p.doctor || '‚Äî')}</span></div>
          </div>
        </div>
        <div class="patient-diagnosis">${esc(p.diagnosis || 'Pending')}</div>
      </div>`;
    });
    html += '</div>';
  });
  
  container.innerHTML = html;
  updateStats();
}

function updateStats() {
  const a = state.patients;
  $('statTotal').textContent = a.length;
  $('statNew').textContent = a.filter(p => p.status === 'new').length;
  $('statActive').textContent = a.filter(p => p.status === 'active').length;
  $('statCritical').textContent = a.filter(p => p.status === 'critical').length;
  $('statChronic').textContent = a.filter(p => p.status === 'chronic').length;
  $$('.stat-card').forEach(s => s.classList.toggle('active', s.dataset.filter === state.currentFilter));
}

function renderRef() {
  $('refGrid').innerHTML = CONFIG.REFS.map(r => `<div class="ref-card"><h4>${r.title}</h4><p>${r.content}</p></div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATIENT PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.openPatientProfile = function(id) {
  const p = getPatient(id);
  if (!p) return;
  state.currentPatient = p;
  state.currentInteractionId = null;
  if (!p.labData) p.labData = { dates: [], parameters: [], interpretation: null };
  if (!p.imaging) p.imaging = [];
  if (!p.fluids) p.fluids = [];
  if (!p.plans) p.plans = [];
  if (!p.vitals) p.vitals = {};
  if (!p.history) p.history = '';
  renderPatientProfile();
  showPage('patientProfile');
};

window.closePatientProfile = function() {
  state.currentPatient = null;
  state.currentInteractionId = null;
  if (state.trendChart) { state.trendChart.destroy(); state.trendChart = null; }
  if (state.fluidChart) { state.fluidChart.destroy(); state.fluidChart = null; }
  showPage('dashboard');
  renderPatients();
};

function renderPatientProfile() {
  const p = state.currentPatient;
  if (!p) return;
  
  const avatarBg = p.status === 'critical' ? 'var(--rose),var(--orange)' : 
                   p.status === 'chronic' ? 'var(--purple),#a855f7' :
                   p.status === 'new' ? 'var(--emerald),var(--teal)' : 'var(--gold),var(--orange)';
  
  $('profilePatientInfo').innerHTML = `
    <div class="profile-avatar" style="background:linear-gradient(135deg,${avatarBg})">${initials(p.name)}</div>
    <div class="profile-details">
      <h2>${esc(p.name)}</h2>
      <div class="meta">
        <span>üõèÔ∏è ${esc(p.ward)} ‚Ä¢ ${esc(p.room || '‚Äî')}</span>
        <span>üë®‚Äç‚öïÔ∏è ${esc(p.doctor || 'Unassigned')}</span>
        <span class="badge badge-${p.status === 'critical' ? 'rose' : p.status === 'chronic' ? 'purple' : p.status === 'new' ? 'emerald' : 'teal'}">${p.status}</span>
      </div>
    </div>
  `;
  
  renderProfileOverview();
  renderProfileLabs();
  renderProfileImaging();
  renderProfileFluids();
  renderProfilePlans();
}

function renderProfileOverview() {
  const p = state.currentPatient;
  $('profileOverview').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">üìã Diagnosis</div></div>
      <div class="section-body"><div style="font-size:0.95rem;color:var(--text-secondary)">${esc(p.diagnosis) || 'No diagnosis recorded'}</div></div>
    </div>
    <div class="section-card">
      <div class="section-header"><div class="section-title">ü©∫ Vitals</div><button class="btn btn-secondary btn-xs" onclick="openAddVitals()">Update</button></div>
      <div class="section-body">
        <div class="vitals-grid">
          <div class="vital-card"><div class="vital-icon">‚ù§Ô∏è</div><div class="vital-value">${p.vitals?.hr || '‚Äî'}</div><div class="vital-label">HR</div></div>
          <div class="vital-card"><div class="vital-icon">ü©∏</div><div class="vital-value">${p.vitals?.bp || '‚Äî'}</div><div class="vital-label">BP</div></div>
          <div class="vital-card"><div class="vital-icon">üå°Ô∏è</div><div class="vital-value">${p.vitals?.temp || '‚Äî'}</div><div class="vital-label">Temp</div></div>
          <div class="vital-card"><div class="vital-icon">üí®</div><div class="vital-value">${p.vitals?.rr || '‚Äî'}</div><div class="vital-label">RR</div></div>
          <div class="vital-card"><div class="vital-icon">ü´Å</div><div class="vital-value">${p.vitals?.spo2 || '‚Äî'}</div><div class="vital-label">SpO‚ÇÇ</div></div>
        </div>
      </div>
    </div>
    <div class="section-card">
      <div class="section-header"><div class="section-title">üìù History & Examination</div><button class="btn btn-secondary btn-xs" onclick="openEditText('history', 'History')">Edit</button></div>
      <div class="section-body">
        <div style="font-size:0.9rem;color:var(--text-secondary);white-space:pre-wrap;min-height:60px">${esc(p.history) || 'Tap Edit to add...'}</div>
      </div>
    </div>
  `;
}

function renderProfileLabs() {
  const p = state.currentPatient;
  const labData = p.labData || { dates: [], parameters: [] };
  
  let html = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">üß™ Laboratory Results</div></div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingLab ? 'analyzing' : ''}" onclick="triggerLabUpload()">
          ${state.isAnalyzingLab ? `
            <div class="lab-upload-icon">‚è≥</div>
            <div class="lab-upload-title">Analyzing Lab Report...</div>
            <div class="lab-upload-subtitle">AI is extracting and interpreting values</div>
          ` : `
            <div class="lab-upload-icon">üì∑</div>
            <div class="lab-upload-title">Upload Lab Report</div>
            <div class="lab-upload-subtitle">Smart OCR ‚Ä¢ Kuwait MOH format supported ‚Ä¢ Historical data extraction</div>
          `}
        </div>
  `;
  
  if (!labData.parameters?.length) {
    html += `<div style="text-align:center;padding:20px;color:var(--text-muted)">No lab results yet</div></div></div>`;
    $('profileLabs').innerHTML = html;
    return;
  }
  
  // Critical Alert
  const criticals = [];
  labData.parameters.forEach(param => {
    const latest = param.values?.[0];
    if (latest?.status === 'critical' || latest?.status === 'high') {
      criticals.push(`${param.name}: ${latest.value} ${param.unit || ''}`);
    }
  });
  
  if (criticals.length) {
    html += `
        <div class="critical-alert">
          <div class="critical-alert-icon">‚ö†Ô∏è</div>
          <div class="critical-alert-content">
            <div class="critical-alert-title">Abnormal Values Detected</div>
            <div class="critical-alert-values">${criticals.join(' ‚Ä¢ ')}</div>
          </div>
        </div>
    `;
  }
  
  // AI Interpretation with Feedback
  if (labData.interpretation?.summary) {
    const interp = labData.interpretation;
    html += `
        <div class="ai-interpretation">
          <div class="ai-interpretation-header">
            <div class="ai-interpretation-title">ü§ñ AI Interpretation <span class="ai-badge">NEURAL</span></div>
          </div>
          <div class="ai-interpretation-text">${esc(interp.summary)}</div>
          
          ${interp.clinicalCorrelation ? `
          <div class="ai-details">
            <div class="ai-details-title">Clinical Correlation</div>
            <p style="font-size:0.85rem;color:var(--text-secondary);margin:0">${esc(interp.clinicalCorrelation)}</p>
          </div>
          ` : ''}
          
          ${interp.trends?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">üìà Trends</div>
            <ul class="ai-details-list">
              ${interp.trends.map(t => `<li>${esc(t)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          ${interp.recommendations?.length ? `
          <div class="ai-details">
            <div class="ai-details-title">üí° Recommendations</div>
            <ul class="ai-details-list">
              ${interp.recommendations.map(r => `<li>${esc(r)}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
          
          <div class="feedback-section">
            <div>
              <div class="feedback-label">Was this interpretation helpful?</div>
              <div class="feedback-sent">‚úì Feedback recorded</div>
            </div>
            <div class="feedback-buttons">
              <button class="feedback-btn positive" onclick="sendFeedback(1, 'lab')" title="Helpful">üëç</button>
              <button class="feedback-btn negative" onclick="sendFeedback(-1, 'lab')" title="Not helpful">üëé</button>
            </div>
          </div>
        </div>
    `;
  }
  
  // Lab Values by Category
  const sortedDates = [...(labData.dates || [])].sort((a, b) => new Date(b) - new Date(a));
  const latestDate = sortedDates[0];
  
  if (latestDate) {
    const categories = {};
    labData.parameters.forEach(param => {
      const latestVal = param.values?.find(v => v.date === latestDate);
      if (latestVal) {
        const cat = getLabCategory(param.name);
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ ...param, latestValue: latestVal });
      }
    });
    
    html += `<div style="margin-bottom:8px;font-size:0.75rem;color:var(--text-muted)">üìÖ Results from ${formatShortDate(latestDate)}</div>`;
    
    const catOrder = ['Renal Function', 'Electrolytes', 'Glucose & Metabolic', 'Liver Function', 'Complete Blood Count', 'Other'];
    catOrder.forEach(cat => {
      if (!categories[cat]?.length) return;
      const catData = CONFIG.LAB_CATEGORIES[cat];
      
      html += `
        <div class="lab-category">
          <div class="lab-category-header">${catData?.icon || 'üî¨'} ${cat}</div>
          <div class="lab-category-body">
            <div class="lab-values-grid">
      `;
      
      categories[cat].forEach(param => {
        const v = param.latestValue;
        const status = v.status || 'normal';
        html += `
          <div class="lab-value-card ${status}">
            <div class="lab-value-name">
              ${esc(param.name)}
              ${status !== 'normal' ? `<span class="lab-value-status ${status}">${status === 'high' ? 'HIGH' : status === 'low' ? 'LOW' : '!'}</span>` : ''}
            </div>
            <div class="lab-value-number">${esc(v.value)}</div>
            <div class="lab-value-unit">${esc(param.unit || '')}</div>
            ${param.refMin !== undefined && param.refMax !== undefined ? `<div class="lab-value-range">Reference: ${param.refMin} - ${param.refMax}</div>` : ''}
          </div>
        `;
      });
      
      html += `</div></div></div>`;
    });
  }
  
  // Trend Chart
  if (labData.parameters.length > 0) {
    html += `
      <div class="lab-trend-section">
        <div class="lab-trend-header">
          <div class="section-title">üìà Trends</div>
          <select class="lab-trend-select" id="labTrendSelect" onchange="renderLabTrendChart()">
            ${labData.parameters.map((p, i) => `<option value="${i}">${esc(p.name)}</option>`).join('')}
          </select>
        </div>
        <div class="lab-trend-chart"><canvas id="labTrendChart"></canvas></div>
      </div>
    `;
  }
  
  html += '</div></div>';
  $('profileLabs').innerHTML = html;
  
  if (labData.parameters.length > 0) {
    setTimeout(() => renderLabTrendChart(), 100);
  }
}

window.renderLabTrendChart = function() {
  const p = state.currentPatient;
  const labData = p?.labData;
  if (!labData?.parameters?.length) return;
  
  const idx = parseInt($('labTrendSelect')?.value) || 0;
  const param = labData.parameters[idx];
  if (!param?.values?.length) return;
  
  const ctx = $('labTrendChart');
  if (!ctx) return;
  
  if (state.trendChart) state.trendChart.destroy();
  
  const values = [...param.values].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-10);
  const labels = values.map(v => formatShortDate(v.date));
  const data = values.map(v => parseFloat(v.value) || 0);
  const colors = values.map(v => v.status === 'high' || v.status === 'critical' ? '#f43f5e' : v.status === 'low' ? '#3b82f6' : '#10b981');
  
  state.trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: param.name,
        data,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245,158,11,0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: colors,
        pointBorderColor: colors,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', font: { size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
};

window.triggerLabUpload = function() {
  if (state.isAnalyzingLab) return;
  $('labFileInput').click();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENHANCED LAB EXTRACTION (Kuwait MOH Format Support)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const LAB_EXTRACTION_PROMPT = `You are a medical laboratory report extraction system. Analyze this lab report image with extreme precision.

CRITICAL INSTRUCTIONS:
1. Extract ALL visible lab values, dates, and reference ranges
2. Pay special attention to:
   - Date format: Look for DD/MM/YYYY or MM/DD/YYYY patterns
   - Cumulative/historical data tables showing multiple dates
   - Age-specific reference ranges (e.g., "<50 years: >450 pg/ml")
   - Units (pg/ml, mmol/L, mg/dL, etc.)
   - Patient demographics if visible

3. For each parameter found, extract:
   - Parameter name (standardized: e.g., "NT-proBNP" not "NT pro BNP")
   - Value (numeric only)
   - Unit
   - Reference range (min-max or descriptive)
   - Date of test (convert to ISO format YYYY-MM-DD)
   - Status: "critical", "high", "low", or "normal" based on reference ranges

4. IMPORTANT FOR KUWAIT MOH FORMAT:
   - Look for "PATIENT CUMULATIVE REPORT" section with historical values
   - Parse the table showing multiple dates and sample numbers
   - Extract ALL historical values, not just the latest
   - Note the "Special Range" section for age-specific cutoffs
   - Handle formats like "16/01/2026 04:32:56" for dates

5. NT-proBNP Specific (ICON Criteria for Acute HF):
   - Rule IN HF for <50 years: >450 pg/ml
   - Rule IN HF for 50-75 years: >900 pg/ml  
   - Rule IN HF for >75 years: >1800 pg/ml
   - Rule OUT HF (all ages): <300 pg/ml
   - Chronic HF (ESC): >125 pg/ml

6. Common Lab Mappings:
   - "NT proBNP" / "NT-proBNP" / "ProBNP" ‚Üí standardize to "NT-proBNP"
   - Apply age-based reference interpretation for cardiac markers

Return a JSON object with this exact structure:
{
  "confidence": 0.0-1.0,
  "patientInfo": {
    "name": "string or null",
    "hospitalId": "string or null", 
    "dateOfBirth": "YYYY-MM-DD or null",
    "gender": "Male/Female or null",
    "location": "string or null"
  },
  "labData": {
    "dates": ["YYYY-MM-DD", ...],
    "parameters": [
      {
        "name": "Standard Parameter Name",
        "abbrev": "Abbreviation",
        "unit": "unit string",
        "refMin": number or null,
        "refMax": number or null,
        "refDescription": "Age-specific or contextual reference info",
        "values": [
          {
            "date": "YYYY-MM-DD",
            "value": number,
            "status": "critical|high|low|normal"
          }
        ]
      }
    ],
    "interpretation": {
      "summary": "Brief clinical interpretation",
      "clinicalCorrelation": "Clinical context",
      "trends": ["Notable trends"],
      "recommendations": ["Actionable recommendations"]
    }
  }
}

RESPOND ONLY WITH VALID JSON. No markdown, no explanation.`;

async function handleLabUpload(file) {
  state.isAnalyzingLab = true;
  renderProfileLabs();
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      console.log('üî¨ Starting enhanced lab extraction...');
      console.log('üì° API:', state.settings.apiUrl.substring(0, 50) + '...');
      console.log('üñºÔ∏è Image size:', Math.round(imageData.length / 1024), 'KB');
      
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ 
          action: 'analyzeLabsEnhanced', 
          image: imageData,
          extractionPrompt: LAB_EXTRACTION_PROMPT,
          patientContext: {
            existingLabs: state.currentPatient?.labData?.parameters?.map(p => ({
              name: p.name,
              latestValue: p.values?.[0]?.value,
              latestDate: p.values?.[0]?.date
            })) || []
          }
        })
      });
      
      console.log('üì• Response status:', res.status);
      
      const data = await res.json();
      console.log('üì¶ Extraction result:', data);
      
      state.isAnalyzingLab = false;
      
      if (data.error || !data.labData) {
        console.error('‚ùå Extraction error:', data.error);
        toast(data.error || 'Extraction failed', true);
        renderProfileLabs();
        return;
      }
      
      // Store for preview before confirmation
      state.pendingLabData = data.labData;
      state.labExtractionConfidence = data.confidence || 0.8;
      state.currentInteractionId = data.meta?.interactionId;
      
      console.log('‚úÖ Extraction successful, showing preview...');
      console.log('üìä Parameters found:', data.labData.parameters?.length || 0);
      console.log('üìÖ Dates found:', data.labData.dates?.length || 0);
      
      // Show preview modal for user verification
      showLabExtractionPreview(data);
      
    } catch (e) {
      console.error('‚ùå Lab extraction error:', e);
      state.isAnalyzingLab = false;
      toast('Extraction failed - check connection', true);
      renderProfileLabs();
    }
  });
}

function showLabExtractionPreview(data) {
  const ld = data.labData;
  const confidence = data.confidence || 0.8;
  const confPercent = Math.round(confidence * 100);
  const confClass = confidence >= 0.8 ? 'high' : confidence >= 0.5 ? 'medium' : 'low';
  
  // Build confidence indicator
  $('labExtractionConfidence').innerHTML = `
    <div class="extraction-confidence">
      <span>Extraction Confidence:</span>
      <div class="confidence-bar">
        <div class="confidence-fill ${confClass}" style="width:${confPercent}%"></div>
      </div>
      <span class="confidence-label">${confPercent}%</span>
    </div>
    ${confidence < 0.7 ? '<p style="color:var(--orange);font-size:0.8rem;margin-bottom:12px">‚ö†Ô∏è Low confidence - please verify values manually</p>' : ''}
  `;
  
  // Build preview table
  let previewHtml = '<div class="extraction-preview">';
  previewHtml += `<div class="extraction-preview-header">
    <span class="extraction-preview-title">Extracted Values</span>
    ${ld.dates?.length ? `<span style="font-size:0.75rem;color:var(--text-muted)">${ld.dates.length} date(s) found</span>` : ''}
  </div>`;
  
  (ld.parameters || []).forEach(param => {
    const latestVal = param.values?.[0];
    if (!latestVal) return;
    
    const statusClass = latestVal.status || 'normal';
    previewHtml += `
      <div class="extraction-item">
        <span class="extraction-name">${esc(param.name)} ${param.unit ? '(' + param.unit + ')' : ''}</span>
        <span class="extraction-value ${statusClass}">
          ${latestVal.value}
          ${param.values.length > 1 ? '<span style="font-size:0.7rem;color:var(--text-muted)"> +' + (param.values.length-1) + ' historical</span>' : ''}
        </span>
      </div>
    `;
  });
  
  previewHtml += '</div>';
  
  // Add interpretation preview if available
  if (ld.interpretation?.summary) {
    previewHtml += `
      <div style="margin-top:16px;padding:16px;background:rgba(139,92,246,0.1);border-radius:var(--radius-sm)">
        <div style="font-weight:600;margin-bottom:8px">ü§ñ AI Interpretation</div>
        <p style="font-size:0.85rem;color:var(--text-secondary)">${esc(ld.interpretation.summary)}</p>
      </div>
    `;
  }
  
  $('labExtractionPreview').innerHTML = previewHtml;
  openModal('labPreviewModal');
}

window.confirmLabExtraction = function() {
  if (!state.pendingLabData || !state.currentPatient) return;
  
  const p = state.currentPatient;
  const ld = state.pendingLabData;
  
  // Merge dates
  (ld.dates || []).forEach(d => {
    if (!p.labData.dates.includes(d)) p.labData.dates.push(d);
  });
  p.labData.dates.sort((a, b) => new Date(b) - new Date(a));
  
  // Merge parameters intelligently
  (ld.parameters || []).forEach(newParam => {
    let existing = p.labData.parameters.find(ep => 
      ep.name.toLowerCase() === newParam.name.toLowerCase() ||
      (ep.abbrev && newParam.abbrev && ep.abbrev.toLowerCase() === newParam.abbrev.toLowerCase())
    );
    
    if (existing) {
      // Merge values into existing parameter
      (newParam.values || []).forEach(nv => {
        const ev = existing.values.find(x => x.date === nv.date);
        if (ev) { 
          ev.value = nv.value; 
          ev.status = nv.status; 
        } else {
          existing.values.push(nv);
        }
      });
      // Sort values by date descending
      existing.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Update metadata
      if (newParam.refMin !== undefined) existing.refMin = newParam.refMin;
      if (newParam.refMax !== undefined) existing.refMax = newParam.refMax;
      if (newParam.unit) existing.unit = newParam.unit;
      if (newParam.refDescription) existing.refDescription = newParam.refDescription;
    } else {
      // Add as new parameter
      if (newParam.values) {
        newParam.values.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      p.labData.parameters.push(newParam);
    }
  });
  
  // Update interpretation
  if (ld.interpretation) p.labData.interpretation = ld.interpretation;
  
  saveCloud();
  renderProfileLabs();
  closeModal('labPreviewModal');
  toast('Lab results saved!');
  
  // Clear pending data
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
};

window.resetLabExtraction = function() {
  state.pendingLabData = null;
  state.labExtractionConfidence = 0;
  state.isAnalyzingLab = false;
  renderProfileLabs();
};

function renderProfileImaging() {
  const p = state.currentPatient;
  const imaging = p.imaging || [];
  
  $('profileImaging').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">üì∑ Imaging & Studies</div></div>
      <div class="section-body">
        <div class="lab-upload-area ${state.isAnalyzingImaging ? 'analyzing' : ''}" onclick="triggerImagingUpload()">
          ${state.isAnalyzingImaging ? `
            <div class="lab-upload-icon">‚è≥</div>
            <div class="lab-upload-title">Analyzing...</div>
          ` : `
            <div class="lab-upload-icon">ü©ª</div>
            <div class="lab-upload-title">Upload Study</div>
            <div class="lab-upload-subtitle">Echo ‚Ä¢ ECG ‚Ä¢ X-Ray ‚Ä¢ CT/MRI</div>
          `}
        </div>
        
        ${imaging.length ? imaging.slice().reverse().map((img, idx) => `
          <div class="imaging-card">
            <div class="imaging-card-header">
              <div class="imaging-type">
                ${img.type === 'ecg' ? 'üìà' : img.type === 'echo' ? 'üíì' : img.type === 'xray' ? 'ü©ª' : 'üß†'}
                ${(img.type || 'Study').toUpperCase()}
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="imaging-date">${formatDateTime(img.date)}</span>
                <button class="btn btn-ghost btn-xs" onclick="deleteImaging(${imaging.length - 1 - idx})">üóëÔ∏è</button>
              </div>
            </div>
            <div class="imaging-summary">${esc(img.summary) || 'No findings recorded'}</div>
          </div>
        `).join('') : '<div style="text-align:center;padding:20px;color:var(--text-muted)">No imaging studies</div>'}
      </div>
    </div>
  `;
}

window.triggerImagingUpload = function() {
  if (state.isAnalyzingImaging) return;
  $('imagingFileInput').click();
};

async function handleImagingUpload(file) {
  state.isAnalyzingImaging = true;
  renderProfileImaging();
  
  const type = prompt('Enter study type:\n‚Ä¢ echo\n‚Ä¢ ecg\n‚Ä¢ xray\n‚Ä¢ ct') || 'xray';
  
  compress(file, CONFIG.MAX_IMAGE_SIZE, async (imageData) => {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'interpret', documentType: type, image: imageData })
      });
      const data = await res.json();
      
      state.isAnalyzingImaging = false;
      
      const p = state.currentPatient;
      if (!p.imaging) p.imaging = [];
      
      p.imaging.push({
        date: new Date().toISOString(),
        type: type,
        summary: data.interpretation?.summary || data.interpretation?.impression || data.interpretation?.conclusion || 'Analysis complete'
      });
      
      saveCloud();
      renderProfileImaging();
      toast('Imaging added!');
    } catch (e) {
      state.isAnalyzingImaging = false;
      toast('Analysis failed', true);
      renderProfileImaging();
    }
  });
}

window.deleteImaging = function(idx) {
  if (!confirm('Delete?')) return;
  state.currentPatient.imaging.splice(idx, 1);
  saveCloud();
  renderProfileImaging();
};

function renderProfileFluids() {
  const p = state.currentPatient;
  const fluids = p.fluids || [];
  const totalIntake = fluids.reduce((s, f) => s + (f.intake || 0), 0);
  const totalOutput = fluids.reduce((s, f) => s + (f.output || 0), 0);
  const balance = totalIntake - totalOutput;
  
  $('profileFluids').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">üíß Fluid Balance</div><button class="btn btn-primary btn-xs" onclick="openAddFluid()">+ Add</button></div>
      <div class="section-body">
        <div class="fluid-summary">
          <div class="fluid-stat"><div class="fluid-stat-value intake">${totalIntake}</div><div class="fluid-stat-label">Intake (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value output">${totalOutput}</div><div class="fluid-stat-label">Output (mL)</div></div>
          <div class="fluid-stat"><div class="fluid-stat-value balance" style="color:${balance >= 0 ? 'var(--emerald)' : 'var(--rose)'}">${balance >= 0 ? '+' : ''}${balance}</div><div class="fluid-stat-label">Balance</div></div>
        </div>
        ${fluids.length ? `<div class="fluid-chart-container"><canvas id="fluidChart"></canvas></div>` : ''}
      </div>
    </div>
  `;
  
  if (fluids.length) setTimeout(() => renderFluidChart(fluids), 100);
}

function renderFluidChart(fluids) {
  const ctx = $('fluidChart');
  if (!ctx) return;
  if (state.fluidChart) state.fluidChart.destroy();
  
  state.fluidChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fluids.map(f => formatDateTime(f.date).split(',')[0]),
      datasets: [
        { label: 'Intake', data: fluids.map(f => f.intake || 0), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 6 },
        { label: 'Output', data: fluids.map(f => f.output || 0), backgroundColor: 'rgba(249,115,22,0.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#9ca3af' } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } }
      }
    }
  });
}

function renderProfilePlans() {
  const p = state.currentPatient;
  const plans = p.plans || [];
  
  $('profilePlans').innerHTML = `
    <div class="section-card">
      <div class="section-header"><div class="section-title">üìù Management Plans</div><button class="btn btn-primary btn-xs" onclick="openAddPlan()">+ Add</button></div>
      <div class="section-body">
        ${plans.length ? plans.slice().reverse().map((plan, idx) => `
          <div class="plan-item">
            <div class="plan-item-header">
              <div class="plan-item-date">${formatDateTime(plan.date)}</div>
              <button class="btn btn-ghost btn-xs" onclick="deletePlan(${plans.length - 1 - idx})">üóëÔ∏è</button>
            </div>
            <div class="plan-item-content">${esc(plan.content)}</div>
          </div>
        `).join('') : '<div style="text-align:center;padding:30px;color:var(--text-muted)">No plans recorded</div>'}
      </div>
    </div>
  `;
}

window.deletePlan = function(idx) {
  if (!confirm('Delete?')) return;
  state.currentPatient.plans.splice(idx, 1);
  saveCloud();
  renderProfilePlans();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.openEditText = function(type, title) {
  $('editTextTitle').textContent = 'Edit ' + title;
  $('editTextType').value = type;
  $('editTextArea').value = state.currentPatient[type] || '';
  openModal('editTextModal');
};

window.saveEditText = function() {
  state.currentPatient[$('editTextType').value] = $('editTextArea').value;
  saveCloud();
  renderPatientProfile();
  closeModal('editTextModal');
  toast('Saved!');
};

window.openAddVitals = function() {
  state.addDataType = 'vitals';
  $('addDataTitle').textContent = 'Update Vitals';
  const v = state.currentPatient.vitals || {};
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Heart Rate</label><input type="text" id="addHR" class="form-input" value="${v.hr || ''}"></div>
      <div class="form-group"><label class="form-label">Blood Pressure</label><input type="text" id="addBP" class="form-input" value="${v.bp || ''}" placeholder="120/80"></div>
      <div class="form-group"><label class="form-label">Temperature</label><input type="text" id="addTemp" class="form-input" value="${v.temp || ''}"></div>
      <div class="form-group"><label class="form-label">Respiratory Rate</label><input type="text" id="addRR" class="form-input" value="${v.rr || ''}"></div>
      <div class="form-group"><label class="form-label">SpO‚ÇÇ</label><input type="text" id="addSpO2" class="form-input" value="${v.spo2 || ''}"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddFluid = function() {
  state.addDataType = 'fluid';
  $('addDataTitle').textContent = 'Add Fluid Entry';
  $('addDataBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="form-group"><label class="form-label">Intake (mL)</label><input type="number" id="addIntake" class="form-input" value="0"></div>
      <div class="form-group"><label class="form-label">Output (mL)</label><input type="number" id="addOutput" class="form-input" value="0"></div>
    </div>
  `;
  openModal('addDataModal');
};

window.openAddPlan = function() {
  state.addDataType = 'plan';
  $('addDataTitle').textContent = 'Add Plan';
  $('addDataBody').innerHTML = '<div class="form-group"><label class="form-label">Plan</label><textarea id="addPlanContent" class="form-textarea" style="min-height:150px"></textarea></div>';
  openModal('addDataModal');
};

window.saveAddData = function() {
  const p = state.currentPatient;
  const type = state.addDataType;
  const now = new Date().toISOString();
  
  if (type === 'vitals') {
    p.vitals = { hr: $('addHR').value, bp: $('addBP').value, temp: $('addTemp').value, rr: $('addRR').value, spo2: $('addSpO2').value };
  } else if (type === 'fluid') {
    if (!p.fluids) p.fluids = [];
    p.fluids.push({ date: now, intake: parseInt($('addIntake').value) || 0, output: parseInt($('addOutput').value) || 0 });
  } else if (type === 'plan') {
    if (!p.plans) p.plans = [];
    p.plans.push({ date: now, content: $('addPlanContent').value });
  }
  
  saveCloud();
  renderPatientProfile();
  closeModal('addDataModal');
  toast('Saved!');
};

window.editCurrentPatient = function() {
  const p = state.currentPatient;
  $('patientModalTitle').textContent = 'Edit Patient';
  $('ptId').value = p.id;
  $('ptName').value = p.name;
  $('ptWard').value = p.ward;
  $('ptRoom').value = p.room || '';
  $('ptDx').value = p.diagnosis || '';
  $('ptDoctor').value = p.doctor || '';
  $('ptStatus').value = p.status;
  openModal('patientModal');
};

window.deleteCurrentPatient = function() {
  if (!confirm('Delete patient?')) return;
  state.patients = state.patients.filter(p => p.id !== state.currentPatient.id);
  saveCloud();
  closePatientProfile();
  toast('Deleted');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNIT ACCESS & AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openUnitAccess(id) {
  const u = getUnit(id);
  if (!u) return;
  state.selectedUnitId = id;
  $('accessIcon').textContent = u.icon;
  $('accessTitle').textContent = u.name;
  $('codeError').classList.remove('show');
  $('userSection').style.display = 'none';
  $('enterBtn').style.display = 'none';
  $('codeInputs').innerHTML = [0,1,2,3].map(i => `<input type="tel" class="code-digit" maxlength="1" data-idx="${i}" inputmode="numeric">`).join('');
  
  const inputs = $$('.code-digit');
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D/g, '');
      if (inp.value && idx < 3) inputs[idx + 1].focus();
      const code = Array.from(inputs).map(i => i.value).join('');
      if (code.length === 4) {
        if (code === u.code) {
          inputs.forEach(i => { i.classList.add('success'); i.disabled = true; });
          $('userSection').style.display = 'block';
          $('enterBtn').style.display = 'flex';
          $('userName').focus();
        } else {
          $('codeError').classList.add('show');
          inputs.forEach(i => i.classList.add('error'));
          setTimeout(() => { inputs.forEach(i => { i.classList.remove('error'); i.value = ''; }); inputs[0].focus(); }, 500);
        }
      }
    });
    inp.addEventListener('keydown', e => { if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus(); });
  });
  
  openModal('accessModal');
  setTimeout(() => inputs[0].focus(), 100);
}

window.enterUnit = function() {
  const n = $('userName').value.trim();
  if (!n) { toast('Enter name', true); return; }
  state.currentUnit = getUnit(state.selectedUnitId);
  state.currentUser = { name: n, role: $('userRole').value };
  closeModal('accessModal');
  showPage('dashboard');
  $('unitBadge').textContent = state.currentUnit.name;
  $('dashAvatar').textContent = initials(state.currentUser.name);
  $('currentDate').textContent = formatDate();
  renderPatients();
  renderRef();
  toast(`Welcome, ${state.currentUser.name}!`);
};

window.logout = function() {
  state.currentUnit = null;
  state.currentUser = null;
  state.currentFilter = 'all';
  showPage('landing');
};

function showTab(tabName) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
  $$('.panel').forEach(p => p.classList.remove('active'));
  $('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

function showProfileTab(tabName) {
  $$('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.profile-tab[data-ptab="${tabName}"]`)?.classList.add('active');
  $$('.profile-panel').forEach(p => p.classList.remove('active'));
  $('profile' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
}

// Admin functions
window.openAdminLogin = function() { $('adminPwd').value = ''; $('adminError').classList.remove('show'); openModal('adminModal'); };
window.loginAdmin = function() { if ($('adminPwd').value === state.settings.adminPassword) { closeModal('adminModal'); showPage('adminPanel'); $('apiUrl').value = state.settings.apiUrl || ''; renderUnitsTable(); loadUnitRequests(); } else $('adminError').classList.add('show'); };
window.exitAdmin = function() { showPage('landing'); };
window.addUnit = function() { state.editingUnitId = null; $('unitModalTitle').textContent = 'Add Unit'; $('uName').value = ''; $('uIcon').value = 'üè•'; $('uCode').value = ''; $('uDesc').value = ''; openModal('unitModal'); };
window.editUnit = function(id) { const u = getUnit(id); if (!u) return; state.editingUnitId = id; $('unitModalTitle').textContent = 'Edit Unit'; $('uName').value = u.name; $('uIcon').value = u.icon; $('uCode').value = u.code; $('uDesc').value = u.desc || ''; openModal('unitModal'); };
window.saveUnit = function() { const name = $('uName').value.trim(), icon = $('uIcon').value.trim() || 'üè•', code = $('uCode').value.trim(), desc = $('uDesc').value.trim(); if (!name || !/^\d{4}$/.test(code)) { toast('Invalid', true); return; } if (state.editingUnitId) { const i = state.units.findIndex(u => u.id === state.editingUnitId); if (i !== -1) state.units[i] = { ...state.units[i], name, icon, code, desc }; } else { state.units.push({ id: 'u' + Date.now(), name, icon, code, desc, color: ['#f59e0b', '#14b8a6', '#3b82f6', '#8b5cf6'][state.units.length % 4] }); } saveCloud(); renderUnitsTable(); renderUnits(); closeModal('unitModal'); toast('Saved!'); };
window.deleteUnit = function(id) { if (!confirm('Delete?')) return; state.units = state.units.filter(u => u.id !== id); saveCloud(); renderUnitsTable(); renderUnits(); };
window.saveSettings = function() { const p = $('newAdminPwd').value.trim(), u = $('apiUrl').value.trim(); if (p) state.settings.adminPassword = p; if (u) state.settings.apiUrl = u; saveCloud(); toast('Saved!'); $('newAdminPwd').value = ''; };

// Admin Tab Navigation
$('adminTabs')?.addEventListener('click', e => {
  const tab = e.target.closest('.admin-tab');
  if (!tab) return;
  $$('.admin-tab').forEach(t => t.classList.remove('active'));
  $$('.admin-tab-panel').forEach(p => p.classList.remove('active'));
  tab.classList.add('active');
  const panelId = 'admin' + tab.dataset.atab.charAt(0).toUpperCase() + tab.dataset.atab.slice(1);
  $(panelId)?.classList.add('active');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNIT REQUEST SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.openRequestUnit = function() {
  // Reset form
  $('reqName').value = '';
  $('reqEmail').value = '';
  $('reqDepartment').value = '';
  $('reqRole').value = '';
  $('reqUnitName').value = '';
  $('reqMessage').value = '';
  state.selectedIcon = 'üè•';
  
  // Reset icon selection
  $$('.request-icon-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector('.request-icon-option[data-icon="üè•"]')?.classList.add('selected');
  
  // Show form, hide success
  $('requestFormSection').style.display = 'block';
  $('requestSuccessSection').style.display = 'none';
  $('requestFormFooter').style.display = 'flex';
  $('requestSuccessFooter').style.display = 'none';
  
  openModal('requestUnitModal');
};

// Icon selection
$('iconGrid')?.addEventListener('click', e => {
  const opt = e.target.closest('.request-icon-option');
  if (!opt) return;
  $$('.request-icon-option').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  state.selectedIcon = opt.dataset.icon;
});

window.submitUnitRequest = async function() {
  const name = $('reqName').value.trim();
  const email = $('reqEmail').value.trim();
  const department = $('reqDepartment').value.trim();
  const role = $('reqRole').value;
  const unitName = $('reqUnitName').value.trim();
  const message = $('reqMessage').value.trim();
  const icon = state.selectedIcon;
  
  // Validation
  if (!name || !email || !department || !role || !unitName) {
    toast('Please fill all required fields', true);
    return;
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    toast('Please enter a valid email', true);
    return;
  }
  
  const requestId = 'REQ-' + Date.now().toString(36).toUpperCase();
  const request = {
    id: requestId,
    timestamp: new Date().toISOString(),
    status: 'pending',
    requesterName: name,
    requesterEmail: email,
    department,
    role,
    unitName,
    icon,
    message
  };
  
  // Try to save to cloud if API is configured
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'submitUnitRequest', request })
      });
    } catch (e) {
      console.error('Failed to save request to cloud:', e);
    }
  }
  
  // Also save locally
  if (!state.unitRequests) state.unitRequests = [];
  state.unitRequests.push(request);
  saveLocal();
  
  // Show success
  $('requestIdDisplay').textContent = 'Request ID: ' + requestId;
  $('requestFormSection').style.display = 'none';
  $('requestSuccessSection').style.display = 'block';
  $('requestFormFooter').style.display = 'none';
  $('requestSuccessFooter').style.display = 'flex';
  
  toast('Request submitted successfully!');
};

async function loadUnitRequests() {
  // Load from cloud if possible
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      const res = await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getUnitRequests' })
      });
      const data = await res.json();
      if (data.success && data.requests) {
        state.unitRequests = data.requests;
      }
    } catch (e) {
      console.error('Failed to load requests:', e);
    }
  }
  
  renderUnitRequests();
}

window.refreshRequests = loadUnitRequests;

function renderUnitRequests() {
  const pending = (state.unitRequests || []).filter(r => r.status === 'pending');
  const processed = (state.unitRequests || []).filter(r => r.status !== 'pending');
  
  // Update badge
  const badge = $('requestsCount');
  if (pending.length > 0) {
    badge.textContent = pending.length;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
  
  if (!state.unitRequests?.length) {
    $('requestsList').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)">
        <div style="font-size:2rem;margin-bottom:12px">üì≠</div>
        <div>No unit requests yet</div>
      </div>
    `;
    return;
  }
  
  const formatDate = iso => new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  
  let html = '';
  
  // Pending first
  pending.forEach(req => {
    html += `
      <div class="request-card" data-id="${req.id}">
        <div class="request-card-time">${formatDate(req.timestamp)}</div>
        <div class="request-card-header">
          <div class="request-card-title">${req.icon || 'üè•'} ${esc(req.unitName)}</div>
          <span class="request-card-status pending">Pending</span>
        </div>
        <div class="request-card-details">
          <div class="request-card-detail">üë§ ${esc(req.requesterName)}</div>
          <div class="request-card-detail">üìß ${esc(req.requesterEmail)}</div>
          <div class="request-card-detail">üè• ${esc(req.department)}</div>
          <div class="request-card-detail">üëî ${roleLabels[req.role] || req.role}</div>
        </div>
        ${req.message ? `<div class="request-card-message">"${esc(req.message)}"</div>` : ''}
        <div class="request-card-actions">
          <button class="btn btn-primary btn-sm" onclick="openApproveRequest('${req.id}')">‚úÖ Review & Approve</button>
          <button class="btn btn-danger btn-sm" onclick="quickRejectRequest('${req.id}')">‚ùå Reject</button>
        </div>
      </div>
    `;
  });
  
  // Processed (collapsed)
  if (processed.length > 0) {
    html += `<div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)"><h4 style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px">üìã Previous Requests (${processed.length})</h4>`;
    processed.slice(0, 10).forEach(req => {
      html += `
        <div class="request-card ${req.status}">
          <div class="request-card-time">${formatDate(req.timestamp)}</div>
          <div class="request-card-header">
            <div class="request-card-title">${req.icon || 'üè•'} ${esc(req.unitName)}</div>
            <span class="request-card-status ${req.status}">${req.status === 'approved' ? 'Approved' : 'Rejected'}</span>
          </div>
          <div class="request-card-details">
            <div class="request-card-detail">üë§ ${esc(req.requesterName)}</div>
            <div class="request-card-detail">üìß ${esc(req.requesterEmail)}</div>
          </div>
          ${req.assignedCode ? `<div style="margin-top:8px;font-size:0.85rem;color:var(--emerald)">Access Code: <code style="background:var(--bg-card);padding:4px 8px;border-radius:4px">${req.assignedCode}</code></div>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }
  
  $('requestsList').innerHTML = html;
}

window.openApproveRequest = function(requestId) {
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  state.selectedRequestId = requestId;
  
  // Pre-fill form
  $('approveUnitName').value = req.unitName;
  $('approveUnitIcon').value = req.icon || 'üè•';
  $('approveUnitCode').value = '';
  $('approveUnitDesc').value = req.department;
  
  // Show request details
  const roleLabels = { attending: 'Attending Physician', consultant: 'Consultant', resident: 'Resident', intern: 'Intern', nurse_manager: 'Nurse Manager', head_nurse: 'Head Nurse', other: 'Other' };
  $('approveRequestDetails').innerHTML = `
    <div style="background:var(--bg);padding:20px;border-radius:var(--radius-sm);margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
        <div style="font-size:2.5rem">${req.icon || 'üè•'}</div>
        <div>
          <div style="font-weight:700;font-size:1.1rem">${esc(req.unitName)}</div>
          <div style="color:var(--text-muted);font-size:0.85rem">Requested ${new Date(req.timestamp).toLocaleDateString()}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem">
        <div><span style="color:var(--text-muted)">Requester:</span> ${esc(req.requesterName)}</div>
        <div><span style="color:var(--text-muted)">Email:</span> ${esc(req.requesterEmail)}</div>
        <div><span style="color:var(--text-muted)">Department:</span> ${esc(req.department)}</div>
        <div><span style="color:var(--text-muted)">Role:</span> ${roleLabels[req.role] || req.role}</div>
      </div>
      ${req.message ? `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:0.9rem"><span style="color:var(--text-muted)">Message:</span><br>"${esc(req.message)}"</div>` : ''}
    </div>
  `;
  
  openModal('approveRequestModal');
};

window.approveRequest = async function() {
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  const unitName = $('approveUnitName').value.trim();
  const icon = $('approveUnitIcon').value.trim() || 'üè•';
  const code = $('approveUnitCode').value.trim();
  const color = $('approveUnitColor').value;
  const desc = $('approveUnitDesc').value.trim();
  
  if (!unitName || !/^\d{4}$/.test(code)) {
    toast('Please enter a valid unit name and 4-digit code', true);
    return;
  }
  
  // Create the unit
  const newUnit = {
    id: 'u' + Date.now(),
    name: unitName,
    icon,
    code,
    desc,
    color
  };
  
  state.units.push(newUnit);
  
  // Update request status
  req.status = 'approved';
  req.assignedCode = code;
  req.approvedAt = new Date().toISOString();
  
  // Save everything
  await saveCloud();
  
  // Also save request update to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitsTable();
  renderUnits();
  renderUnitRequests();
  closeModal('approveRequestModal');
  
  toast(`Unit "${unitName}" created with code ${code}!`);
};

window.rejectRequest = async function() {
  if (!confirm('Are you sure you want to reject this request?')) return;
  
  const requestId = state.selectedRequestId;
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  // Save to cloud
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {
      console.error('Failed to update request:', e);
    }
  }
  
  saveLocal();
  renderUnitRequests();
  closeModal('approveRequestModal');
  toast('Request rejected');
};

window.quickRejectRequest = async function(requestId) {
  if (!confirm('Reject this request?')) return;
  
  const req = state.unitRequests?.find(r => r.id === requestId);
  if (!req) return;
  
  req.status = 'rejected';
  req.rejectedAt = new Date().toISOString();
  
  if (state.settings.apiUrl && state.settings.apiUrl !== 'YOUR_API_URL_HERE') {
    try {
      await fetch(state.settings.apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'updateUnitRequest', request: req })
      });
    } catch (e) {}
  }
  
  saveLocal();
  renderUnitRequests();
  toast('Request rejected');
};

// Patient CRUD
window.openAddPatient = function() { $('patientModalTitle').textContent = 'Add Patient'; $('ptId').value = ''; $('ptName').value = ''; $('ptWard').value = 'Ward 14'; $('ptRoom').value = ''; $('ptDx').value = ''; $('ptDoctor').value = state.currentUser?.name || ''; $('ptStatus').value = 'new'; openModal('patientModal'); };
window.savePatient = function() { const id = $('ptId').value, name = $('ptName').value.trim(); if (!name) { toast('Name required', true); return; } const data = { name, ward: $('ptWard').value, room: $('ptRoom').value.trim() || '‚Äî', diagnosis: $('ptDx').value.trim() || 'Pending', doctor: $('ptDoctor').value.trim() || 'Unassigned', status: $('ptStatus').value }; if (id) { const i = state.patients.findIndex(p => p.id === parseInt(id)); if (i !== -1) { state.patients[i] = { ...state.patients[i], ...data }; if (state.currentPatient?.id === parseInt(id)) { state.currentPatient = state.patients[i]; renderPatientProfile(); } } } else { state.patients.push({ id: Date.now(), ...data, labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {} }); } saveCloud(); renderPatients(); closeModal('patientModal'); toast('Saved!'); };

// Import
window.openImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; openModal('importModal'); };
window.resetImport = function() { state.importImage = null; state.importPatients = []; $('importUpload').style.display = 'block'; $('importPreview').style.display = 'none'; $('importLoading').style.display = 'none'; $('importResults').style.display = 'none'; $('importError').style.display = 'none'; $('importConfirmBtn').disabled = true; };
window.extractPatients = async function() {
  if (!state.importImage) { toast('No image selected', true); return; }
  if (!state.settings.apiUrl || state.settings.apiUrl === 'YOUR_API_URL_HERE') { toast('API URL not configured. Go to Admin settings.', true); return; }
  
  $('importPreview').style.display = 'none';
  $('importLoading').style.display = 'block';
  $('importError').style.display = 'none';
  
  console.log('üîÑ Extracting patients from image...');
  console.log('üì° API:', state.settings.apiUrl.substring(0, 50) + '...');
  console.log('üñºÔ∏è Image size:', Math.round(state.importImage.length / 1024), 'KB');
  
  try {
    const res = await fetch(state.settings.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'extractPatients', image: state.importImage })
    });
    
    console.log('üì• Response status:', res.status);
    
    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
    
    const d = await res.json();
    console.log('üì¶ Response:', d);
    
    $('importLoading').style.display = 'none';
    
    if (!d.success) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = d.error || 'API returned an error';
      console.error('‚ùå API Error:', d.error);
      return;
    }
    
    if (!d.patients?.length) {
      $('importError').style.display = 'block';
      $('importErrorMsg').textContent = 'No patients found in image. Try a clearer screenshot.';
      return;
    }
    
    state.importPatients = d.patients.map((p, i) => ({
      id: Date.now() + i, name: p.name, ward: smartWard(p.ward), room: p.room || '‚Äî',
      diagnosis: p.diagnosis || 'Pending', doctor: p.doctor || state.currentUser?.name || 'Unassigned',
      status: p.status === 'chronic' ? 'chronic' : 'active',
      labData: { dates: [], parameters: [] }, imaging: [], fluids: [], plans: [], history: '', vitals: {}
    }));
    
    $('importResults').style.display = 'block';
    $('importCount').textContent = state.importPatients.length;
    $('importList').innerHTML = state.importPatients.map(p => `<div class="import-item"><div style="flex:1"><b>${esc(p.name)}</b><div style="font-size:0.75rem;color:var(--text-muted)">${esc(p.room)}</div></div><select class="import-ward-select" onchange="state.importPatients.find(x=>x.id===${p.id}).ward=this.value">${CONFIG.VALID_WARDS.map(w => `<option value="${w}" ${w === p.ward ? 'selected' : ''}>${w}</option>`).join('')}</select></div>`).join('');
    $('importConfirmBtn').disabled = false;
    
    console.log('‚úÖ Found', state.importPatients.length, 'patients');
    toast('Found ' + state.importPatients.length + ' patients!');
    
  } catch (e) {
    console.error('‚ùå Extract error:', e);
    $('importLoading').style.display = 'none';
    $('importError').style.display = 'block';
    $('importErrorMsg').textContent = e.message || 'Connection failed';
  }
};
window.confirmImport = function() { if (!state.importPatients.length) return; let added = 0; state.importPatients.forEach(p => { if (!state.patients.some(ep => ep.name.toLowerCase() === p.name.toLowerCase())) { state.patients.push(p); added++; } }); saveCloud(); renderPatients(); closeModal('importModal'); toast(`Imported ${added}!`); };
window.exportPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); const pts = state.currentFilter === 'all' ? [...state.patients] : state.patients.filter(p => p.status === state.currentFilter); if (!pts.length) { toast('No patients', true); return; } doc.setFillColor(245, 158, 11); doc.rect(0, 0, 297, 18, 'F'); doc.setFontSize(16); doc.setTextColor(0); doc.text(state.currentUnit.name + ' - Patient Report', 14, 12); doc.text(formatDate(), 283, 12, 'right'); let y = 28; const wards = {}; pts.forEach(p => { const w = p.ward || 'Unassigned'; if (!wards[w]) wards[w] = []; wards[w].push(p); }); Object.keys(wards).forEach(ward => { if (y > 185) { doc.addPage(); y = 15; } doc.setFillColor(20, 184, 166); doc.rect(14, y, 269, 7, 'F'); doc.setFontSize(9); doc.setTextColor(255); doc.text(ward + ' (' + wards[ward].length + ')', 16, y + 5); y += 10; wards[ward].forEach(p => { if (y > 190) { doc.addPage(); y = 15; } doc.setFillColor(248, 250, 252); doc.rect(14, y, 269, 10, 'F'); doc.setFontSize(8); doc.setTextColor(30); doc.text(p.room || '‚Äî', 16, y + 6); doc.text(p.name, 40, y + 6); doc.text((p.diagnosis || '').substring(0, 60), 100, y + 6); doc.text(p.doctor || '', 220, y + 6); y += 12; }); y += 5; }); doc.save(state.currentUnit.name.replace(/\s+/g, '_') + '_Report.pdf'); toast('PDF exported!'); };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
  loadLocal();
  renderUnits();
  
  $('adminFab').onclick = openAdminLogin;
  $('syncFab').onclick = manualSync;
  $('adminPwd').onkeydown = e => { if (e.key === 'Enter') loginAdmin(); };
  $('userName').onkeydown = e => { if (e.key === 'Enter') enterUnit(); };
  $('mainTabs').onclick = e => { const t = e.target.closest('.tab'); if (t) showTab(t.dataset.tab); };
  $('profileTabs').onclick = e => { const t = e.target.closest('.profile-tab'); if (t) showProfileTab(t.dataset.ptab); };
  $('statsBar').onclick = e => { const s = e.target.closest('.stat-card'); if (s) { state.currentFilter = s.dataset.filter; renderPatients(); } };
  
  $('labFileInput').onchange = function() { if (this.files[0]) handleLabUpload(this.files[0]); this.value = ''; };
  $('imagingFileInput').onchange = function() { if (this.files[0]) handleImagingUpload(this.files[0]); this.value = ''; };
  $('importFile').onchange = function() { if (this.files[0]) { compress(this.files[0], CONFIG.MAX_IMAGE_SIZE, url => { state.importImage = url; $('importImg').src = url; $('importUpload').style.display = 'none'; $('importPreview').style.display = 'block'; }); } };
  
  $$('.modal').forEach(m => m.onclick = e => { if (e.target === m) m.classList.remove('active'); });
  
  // Initial cloud sync
  await syncFromCloud();
  
  // Periodic background sync (every 60 seconds) - only if no pending changes
  setInterval(() => {
    if (!syncState.pendingChanges) {
      syncFromCloud();
    }
  }, 60000);
}

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();

})();
</script>
</body>
</html>
