<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#060a13">
  <title>MedWard | Clinical Intelligence Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-deep:#060a13;--bg-primary:#0a0f1a;--bg-card:#0d1424;--bg-elevated:#111b2e;--bg-input:#0f172a;
      --text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;
      --gold:#d4a437;--gold-light:#fbbf24;--gold-glow:rgba(212,164,55,0.15);
      --teal:#14b8a6;--teal-light:#2dd4bf;
      --blue:#3b82f6;--purple:#8b5cf6;--rose:#f43f5e;--orange:#f97316;--emerald:#10b981;
      --border:rgba(148,163,184,0.1);--border-light:rgba(148,163,184,0.15);
      --shadow-lg:0 12px 40px rgba(0,0,0,0.5);
      --radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px;
    }
    html{font-size:16px;-webkit-font-smoothing:antialiased}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-deep);color:var(--text-primary);line-height:1.5;min-height:100vh}
    .ambient{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(ellipse at 20% 20%,var(--gold-glow),transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(20,184,166,0.08),transparent 50%)}

    /* Header */
    .header{position:fixed;top:0;left:0;right:0;height:64px;background:rgba(10,15,26,0.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-mark{width:40px;height:40px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:12px;display:grid;place-items:center;box-shadow:0 4px 20px rgba(212,164,55,0.25)}
    .logo-mark svg{width:22px;height:22px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
    .logo-text{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .user-btn{display:none;align-items:center;gap:10px;padding:6px 14px 6px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:100px}
    .user-btn.show{display:flex}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:50%;display:grid;place-items:center;font-weight:700;font-size:0.8rem;color:var(--bg-deep)}
    .user-name{font-size:0.85rem;font-weight:500}

    /* Screens */
    .screen{display:none;min-height:100vh;padding:80px 16px 32px}
    .screen.active{display:block}
    #login.active{display:flex;align-items:center;justify-content:center;padding:20px}

    /* Login */
    .login-card{width:100%;max-width:420px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:40px 32px;box-shadow:var(--shadow-lg);position:relative}
    .login-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:var(--radius-xl) var(--radius-xl) 0 0}
    .login-header{text-align:center;margin-bottom:32px}
    .login-logo{width:64px;height:64px;background:linear-gradient(135deg,var(--gold),var(--gold-light));border-radius:16px;display:grid;place-items:center;margin:0 auto 16px;box-shadow:0 8px 32px rgba(212,164,55,0.3)}
    .login-logo svg{width:36px;height:36px;stroke:var(--bg-deep);stroke-width:2.5;fill:none}
    .login-title{font-size:1.5rem;font-weight:700;margin-bottom:4px}
    .login-sub{color:var(--text-muted);font-size:0.9rem}
    
    /* Forms */
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px}
    .form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:inherit;font-size:0.95rem;transition:0.2s;-webkit-appearance:none}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-glow)}
    .form-textarea{min-height:100px;resize:vertical}
    .form-select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
    
    /* Buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-md);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:0.2s;touch-action:manipulation}
    .btn:active{transform:scale(0.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);box-shadow:0 4px 16px rgba(212,164,55,0.3)}
    .btn-secondary{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary)}
    .btn-danger{background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);color:var(--rose)}
    .btn-sm{padding:8px 14px;font-size:0.8rem}
    .btn-full{width:100%}

    /* Layout */
    .container{max-width:1200px;margin:0 auto}
    .page-header{margin-bottom:24px}
    .page-title{font-size:1.4rem;font-weight:700;margin-bottom:2px}
    .page-sub{color:var(--text-muted);font-size:0.9rem}

    /* Tabs */
    .tabs{display:flex;gap:4px;background:var(--bg-card);border:1px solid var(--border);padding:4px;border-radius:var(--radius-md);margin-bottom:24px;overflow-x:auto}
    .tab{flex:1;min-width:80px;padding:10px 16px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:500;cursor:pointer;transition:0.2s;white-space:nowrap}
    .tab.active{background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);font-weight:600}
    .panel{display:none}
    .panel.active{display:block;animation:fadeUp 0.3s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Stats */
    .stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
    .stat{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;text-align:center}
    .stat-value{font-size:1.75rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .stat-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-top:2px}

    /* Card */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .card-title{display:flex;align-items:center;gap:10px;font-size:0.95rem;font-weight:600}
    .card-title svg{width:18px;height:18px;stroke:var(--gold)}
    .card-body{padding:20px}

    /* Patient Grid */
    .patients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
    .patient-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;transition:0.2s;position:relative;overflow:hidden}
    .patient-card:hover{border-color:var(--gold);transform:translateY(-2px)}
    .patient-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--teal)}
    .patient-card.critical::before{background:var(--rose)}
    .patient-card.chronic::before{background:var(--purple)}
    .patient-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    .patient-main{display:flex;align-items:center;gap:14px}
    .patient-avatar{width:48px;height:48px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:12px;display:grid;place-items:center;font-weight:700;font-size:1rem;color:var(--bg-deep)}
    .patient-info h3{font-size:1rem;font-weight:600;margin-bottom:2px}
    .patient-info p{font-size:0.8rem;color:var(--text-muted)}
    .patient-badge{padding:4px 10px;border-radius:100px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
    .badge-active{background:rgba(20,184,166,0.15);color:var(--teal)}
    .badge-critical{background:rgba(244,63,94,0.15);color:var(--rose)}
    .badge-chronic{background:rgba(139,92,246,0.15);color:var(--purple)}
    .patient-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .patient-detail{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px 12px}
    .patient-detail-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px}
    .patient-detail-value{font-size:0.85rem;font-weight:500}
    .patient-diagnosis{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:16px}
    .patient-diagnosis-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px}
    .patient-diagnosis-text{font-size:0.85rem;color:var(--text-secondary)}
    .patient-actions{display:flex;gap:8px}
    .patient-actions .btn{flex:1}

    /* Analysis Section - Enhanced */
    .analysis-hero{background:linear-gradient(135deg,rgba(212,164,55,0.1),rgba(20,184,166,0.1));border:1px solid var(--border);border-radius:var(--radius-lg);padding:32px;margin-bottom:24px;text-align:center}
    .analysis-hero-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--gold),var(--teal));border-radius:20px;display:grid;place-items:center;margin:0 auto 20px;box-shadow:0 8px 32px rgba(212,164,55,0.25)}
    .analysis-hero-icon svg{width:40px;height:40px;stroke:#fff;stroke-width:2}
    .analysis-hero h2{font-size:1.5rem;font-weight:700;margin-bottom:8px}
    .analysis-hero p{color:var(--text-secondary);margin-bottom:24px;max-width:500px;margin-left:auto;margin-right:auto}
    
    .upload-zone{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:48px 24px;text-align:center;cursor:pointer;transition:0.2s;background:var(--bg-card)}
    .upload-zone:hover,.upload-zone.dragover{border-color:var(--gold);background:var(--gold-glow)}
    .upload-zone.has-file{border-style:solid;border-color:var(--teal)}
    .upload-icon{width:64px;height:64px;background:var(--bg-elevated);border-radius:50%;display:grid;place-items:center;margin:0 auto 16px}
    .upload-icon svg{width:32px;height:32px;stroke:var(--gold)}
    .upload-title{font-weight:600;font-size:1.1rem;margin-bottom:4px}
    .upload-sub{font-size:0.85rem;color:var(--text-muted);margin-bottom:16px}
    .upload-formats{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
    .upload-format{padding:4px 12px;background:var(--bg-elevated);border-radius:100px;font-size:0.75rem;color:var(--text-secondary)}
    .upload-input{display:none}

    /* Preview Area */
    .preview-area{margin-top:20px;display:none;padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md)}
    .preview-area.show{display:block}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px;margin-bottom:12px}
    .preview-thumb{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid var(--border);transition:0.2s}
    .preview-thumb img{width:100%;height:100%;object-fit:cover}
    .preview-thumb:hover{border-color:var(--rose)}
    .preview-thumb::after{content:'‚úï';position:absolute;top:2px;right:2px;width:18px;height:18px;background:rgba(239,68,68,0.9);border-radius:50%;display:grid;place-items:center;font-size:10px;color:#fff;opacity:0;transition:0.2s}
    .preview-thumb:hover::after{opacity:1}
    .preview-image{max-width:100%;max-height:300px;border-radius:var(--radius-md);margin-bottom:16px;border:1px solid var(--border)}
    .preview-info{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;margin-bottom:16px}
    .preview-filename{font-weight:600;margin-bottom:4px}
    .preview-meta{font-size:0.8rem;color:var(--text-muted)}

    /* Analysis Types */
    .analysis-types{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
    .analysis-type{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;text-align:center;cursor:pointer;transition:0.2s}
    .analysis-type:hover{border-color:var(--gold)}
    .analysis-type.active{border-color:var(--gold);background:var(--gold-glow)}
    .analysis-type-icon{font-size:1.5rem;margin-bottom:8px}
    .analysis-type-name{font-weight:600;font-size:0.85rem;margin-bottom:2px}
    .analysis-type-desc{font-size:0.7rem;color:var(--text-muted)}

    /* Context Input */
    .context-section{margin-bottom:24px}
    .context-section h4{font-size:0.9rem;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .context-section h4 svg{width:16px;height:16px;stroke:var(--gold)}

    /* Analyze Button */
    .analyze-btn{width:100%;padding:18px 32px;font-size:1.1rem;background:linear-gradient(135deg,var(--gold),var(--gold-light));color:var(--bg-deep);border:none;border-radius:var(--radius-md);font-weight:700;cursor:pointer;transition:0.2s;display:flex;align-items:center;justify-content:center;gap:12px}
    .analyze-btn:hover{box-shadow:0 8px 32px rgba(212,164,55,0.4)}
    .analyze-btn:disabled{opacity:0.5;cursor:not-allowed}
    .analyze-btn svg{width:24px;height:24px}

    /* Progress */
    .analysis-progress{display:none;text-align:center;padding:40px}
    .analysis-progress.show{display:block}
    .progress-spinner{width:64px;height:64px;border:4px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress-text{font-weight:600;margin-bottom:4px}
    .progress-sub{font-size:0.85rem;color:var(--text-muted)}
    .progress-steps{display:flex;justify-content:center;gap:8px;margin-top:20px}
    .progress-step{width:8px;height:8px;background:var(--border);border-radius:50%}
    .progress-step.active{background:var(--gold);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

    /* Results */
    .analysis-results{display:none}
    .analysis-results.show{display:block}
    .result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .result-title{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:10px}
    .result-title svg{width:24px;height:24px;stroke:var(--emerald)}
    .result-badge{padding:6px 14px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:100px;font-size:0.8rem;font-weight:600;color:var(--emerald)}

    .result-section{background:var(--bg-elevated);border-radius:var(--radius-md);padding:20px;margin-bottom:16px}
    .result-section-title{font-size:0.9rem;font-weight:600;color:var(--gold);margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .result-section-title svg{width:18px;height:18px}
    .result-content{font-size:0.9rem;line-height:1.8;color:var(--text-secondary)}
    .result-content p{margin-bottom:12px}
    .result-content ul{margin:12px 0;padding-left:20px}
    .result-content li{margin:8px 0}
    .result-content strong{color:var(--text-primary)}

    .finding-card{background:var(--bg-card);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;border-left:3px solid var(--gold)}
    .finding-card.critical{border-color:var(--rose)}
    .finding-card.normal{border-color:var(--emerald)}
    .finding-title{font-weight:600;margin-bottom:4px}
    .finding-value{font-size:0.85rem;color:var(--text-secondary)}

    /* History */
    .history-list{max-height:400px;overflow-y:auto}
    .history-item{display:flex;align-items:center;gap:14px;padding:14px;background:var(--bg-elevated);border-radius:var(--radius-md);margin-bottom:10px;cursor:pointer;transition:0.2s}
    .history-item:hover{background:var(--bg-card);border:1px solid var(--gold)}
    .history-thumb{width:48px;height:48px;border-radius:var(--radius-sm);object-fit:cover;background:var(--bg-card)}
    .history-info{flex:1;min-width:0}
    .history-type{font-weight:600;font-size:0.85rem;margin-bottom:2px}
    .history-date{font-size:0.75rem;color:var(--text-muted)}
    .history-badge{padding:4px 8px;border-radius:100px;font-size:0.65rem;font-weight:600;background:rgba(20,184,166,0.15);color:var(--teal)}

    /* Scores */
    .scores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .score-tile{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px 16px;text-align:center;cursor:pointer;transition:0.2s}
    .score-tile:hover{border-color:var(--gold)}
    .score-tile.active{border-color:var(--gold);background:var(--gold-glow)}
    .score-icon{font-size:1.75rem;margin-bottom:8px}
    .score-name{font-weight:600;font-size:0.9rem}
    .score-desc{font-size:0.7rem;color:var(--text-muted)}

    .calc-item{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;margin-bottom:12px}
    .calc-item-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .calc-item-num{width:28px;height:28px;background:var(--gold);border-radius:8px;display:grid;place-items:center;font-size:0.75rem;font-weight:700;color:var(--bg-deep)}
    .calc-item-name{font-weight:600;font-size:0.9rem}
    .calc-opts{display:flex;flex-wrap:wrap;gap:8px}
    .calc-opt{flex:1;min-width:70px;padding:12px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:0.15s}
    .calc-opt:hover{border-color:var(--gold)}
    .calc-opt.sel{background:var(--gold-glow);border-color:var(--gold)}
    .calc-opt input{display:none}
    .calc-opt-score{display:block;font-size:1.1rem;font-weight:700;color:var(--gold)}
    .calc-opt-label{font-size:0.7rem;color:var(--text-secondary)}
    .calc-result{background:var(--bg-elevated);border-radius:var(--radius-md);padding:24px;text-align:center;margin-top:16px}
    .calc-result-score{font-size:3rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .calc-result-max{color:var(--text-muted)}
    .severity-pill{display:inline-block;padding:8px 20px;border-radius:100px;font-size:0.85rem;font-weight:600;margin-top:12px}

    /* Reference */
    .ref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .ref-card{background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;border-left:3px solid var(--gold)}
    .ref-card h4{font-size:0.9rem;color:var(--gold);margin-bottom:10px}
    .ref-card p{font-size:0.8rem;color:var(--text-secondary);margin:4px 0}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;padding:16px;z-index:200;overflow-y:auto}
    .modal.active{display:flex}
    .modal-box{width:100%;max-width:500px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow-lg)}
    .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-size:1.1rem;font-weight:600}
    .modal-close{width:36px;height:36px;background:var(--bg-elevated);border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:grid;place-items:center;font-size:1.25rem}
    .modal-body{padding:20px;max-height:70vh;overflow-y:auto}
    .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}

    /* Toast */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 24px;background:var(--bg-elevated);border:1px solid var(--teal);border-radius:var(--radius-md);font-weight:500;opacity:0;transition:0.3s;z-index:300}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.error{border-color:var(--rose)}

    /* Loading */
    .loading{display:flex;flex-direction:column;align-items:center;gap:12px;padding:60px;color:var(--text-muted)}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite}
    .empty-state{text-align:center;padding:60px 20px}
    .empty-icon{width:64px;height:64px;background:var(--bg-elevated);border-radius:50%;display:grid;place-items:center;margin:0 auto 16px}
    .empty-icon svg{width:32px;height:32px;stroke:var(--text-muted)}

    @media(max-width:640px){
      .stats-bar{grid-template-columns:repeat(2,1fr)}
      .patients-grid{grid-template-columns:1fr}
      .patient-details{grid-template-columns:1fr}
      .analysis-types{grid-template-columns:repeat(2,1fr)}
      .scores-grid{grid-template-columns:repeat(2,1fr)}
      .calc-opts{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="ambient"></div>
  
  <header class="header">
    <div class="logo">
      <div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
      <span class="logo-text">MedWard</span>
    </div>
    <div class="user-btn" id="userBtn">
      <div class="user-avatar" id="userAvatar">B</div>
      <span class="user-name" id="userName">User</span>
    </div>
  </header>

  <!-- Login -->
  <main class="screen active" id="login">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
        <h1 class="login-title">MedWard</h1>
        <p class="login-sub">Clinical Intelligence Platform</p>
      </div>
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input type="text" id="loginName" class="form-input" placeholder="Enter your name">
      </div>
      <button class="btn btn-primary btn-full" id="loginBtn">Continue to Dashboard</button>
    </div>
  </main>

  <!-- Dashboard -->
  <main class="screen" id="dashboard">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Clinical Dashboard</h1>
        <p class="page-sub">Welcome back, <span id="greeting">Doctor</span></p>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="patients">Patients</button>
        <button class="tab" data-tab="analysis">AI Analysis</button>
        <button class="tab" data-tab="scores">Scores</button>
        <button class="tab" data-tab="reference">Reference</button>
      </div>

      <!-- Patients Panel -->
      <div class="panel active" id="panelPatients">
        <div class="stats-bar">
          <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
          <div class="stat"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
          <div class="stat"><div class="stat-value" id="statChronic">0</div><div class="stat-label">Chronic</div></div>
          <div class="stat"><div class="stat-value" id="statWards">0</div><div class="stat-label">Wards</div></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Ward Patients</h2>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" id="refreshBtn">Refresh</button>
              <button class="btn btn-primary btn-sm" id="addPatientBtn">+ Add</button>
            </div>
          </div>
          <div class="card-body" id="patientsContainer">
            <div class="loading"><div class="spinner"></div>Loading patients...</div>
          </div>
        </div>
      </div>

      <!-- Analysis Panel - Enhanced -->
      <div class="panel" id="panelAnalysis">
        <div class="analysis-hero">
          <div class="analysis-hero-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
          </div>
          <h2>AI Medical Analysis</h2>
          <p>Upload medical images, lab results, or clinical documents for instant AI-powered analysis</p>
          <div id="neuralStats" style="display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:0.8rem;color:var(--text-secondary)"></div>
        </div>

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload Documents</h2>
          </div>
          <div class="card-body">
            <div class="upload-zone" id="uploadZone">
              <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
              <div class="upload-title">Drop files or tap to upload</div>
              <div class="upload-sub">Select multiple images at once</div>
              <div class="upload-formats">
                <span class="upload-format">PNG</span>
                <span class="upload-format">JPG</span>
                <span class="upload-format">WEBP</span>
              </div>
              <input type="file" class="upload-input" id="uploadInput" accept="image/*" multiple>
            </div>

            <div class="preview-area" id="previewArea">
              <div class="preview-grid" id="previewGrid"></div>
              <div class="preview-info">
                <div class="preview-filename" id="previewFilename">0 files selected</div>
                <div class="preview-meta" id="previewMeta">Tap images to remove</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Type Selection -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Analysis Type</h2>
          </div>
          <div class="card-body">
            <div class="analysis-types">
              <div class="analysis-type active" data-type="lab">
                <div class="analysis-type-icon">üß™</div>
                <div class="analysis-type-name">Lab Results</div>
                <div class="analysis-type-desc">Blood work, panels</div>
              </div>
              <div class="analysis-type" data-type="auto">
                <div class="analysis-type-icon">üîç</div>
                <div class="analysis-type-name">Auto-Detect</div>
                <div class="analysis-type-desc">AI determines type</div>
              </div>
              <div class="analysis-type" data-type="xray">
                <div class="analysis-type-icon">ü©ª</div>
                <div class="analysis-type-name">X-Ray</div>
                <div class="analysis-type-desc">Radiograph analysis</div>
              </div>
              <div class="analysis-type" data-type="ct">
                <div class="analysis-type-icon">üß†</div>
                <div class="analysis-type-name">CT/MRI</div>
                <div class="analysis-type-desc">Cross-sectional imaging</div>
              </div>
              <div class="analysis-type" data-type="ecg">
                <div class="analysis-type-icon">üíì</div>
                <div class="analysis-type-name">ECG/EKG</div>
                <div class="analysis-type-desc">Cardiac rhythm</div>
              </div>
              <div class="analysis-type" data-type="pathology">
                <div class="analysis-type-icon">üî¨</div>
                <div class="analysis-type-name">Pathology</div>
                <div class="analysis-type-desc">Histology, cytology</div>
              </div>
              <div class="analysis-type" data-type="dermatology">
                <div class="analysis-type-icon">ü©π</div>
                <div class="analysis-type-name">Dermatology</div>
                <div class="analysis-type-desc">Skin lesions</div>
              </div>
              <div class="analysis-type" data-type="ophthalmology">
                <div class="analysis-type-icon">üëÅ</div>
                <div class="analysis-type-name">Ophthalmology</div>
                <div class="analysis-type-desc">Fundoscopy, OCT</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analyze Button -->
        <button class="analyze-btn" id="analyzeBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2"/></svg>
          Analyze with Claude AI
        </button>

        <!-- Progress -->
        <div class="analysis-progress" id="analysisProgress">
          <div class="progress-spinner"></div>
          <div class="progress-text">Analyzing...</div>
          <div class="progress-sub" id="progressStatus">Processing image...</div>
          <div class="progress-steps">
            <div class="progress-step active"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
          </div>
        </div>

        <!-- Results -->
        <div class="analysis-results" id="analysisResults">
          <div class="result-header">
            <h3 class="result-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Analysis Complete</h3>
            <span class="result-badge" id="resultBadge">AI Verified</span>
          </div>
          <div id="resultsContent"></div>
          <button class="btn btn-secondary btn-full" id="newAnalysisBtn" style="margin-top:20px">New Analysis</button>
        </div>

        <!-- Analysis History -->
        <div class="card" style="margin-top:24px">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Recent Analyses</h2>
          </div>
          <div class="card-body">
            <div class="history-list" id="historyList">
              <div class="empty-state" style="padding:24px"><p style="color:var(--text-muted)">No analyses yet</p></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scores Panel -->
      <div class="panel" id="panelScores">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Clinical Scores</h2>
          </div>
          <div class="card-body">
            <div class="scores-grid" id="scoresGrid"></div>
          </div>
        </div>
        <div id="calcArea"></div>
      </div>

      <!-- Reference Panel -->
      <div class="panel" id="panelReference">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Quick Reference</h2>
          </div>
          <div class="card-body">
            <div class="ref-grid" id="refGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Patient Modal -->
  <div class="modal" id="patientModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 class="modal-title" id="patientModalTitle">Add Patient</h2>
        <button class="modal-close" id="closePatientModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Patient Name *</label>
          <input type="text" id="patientName" class="form-input" required>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">Ward *</label>
            <input type="text" id="patientWard" class="form-input" placeholder="e.g. Ward 21">
          </div>
          <div class="form-group">
            <label class="form-label">Room/Bed</label>
            <input type="text" id="patientRoom" class="form-input" placeholder="e.g. 5">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Diagnosis</label>
          <textarea id="patientDiagnosis" class="form-textarea" placeholder="Primary diagnosis..."></textarea>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">Assigned Doctor</label>
            <input type="text" id="patientDoctor" class="form-input" placeholder="Dr. Name">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select id="patientStatus" class="form-select">
              <option value="active">Active</option>
              <option value="chronic">Chronic</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </div>
        <input type="hidden" id="patientRowIndex">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelPatient">Cancel</button>
        <button class="btn btn-primary" id="savePatient">Save Patient</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  var API = {
    PATIENT: 'https://script.google.com/macros/s/AKfycbx-l2xdsAHTZu7bcueN83Yz8xbCwtKbHfUSJuhIgtWVR5XyeJYh9TrfMgzznTYX4Z0kww/exec',
    CLAUDE: 'https://script.google.com/macros/s/AKfycbxjp-KDUx_eYvavlEHDciE-fR1V8eFM39vJfAcA7btETL-QUmrwuYU-_92_Pl20gl75kg/exec'
  };

  var state = {
    user: null,
    patients: [],
    editing: null,
    analysisType: 'lab',
    uploadedFiles: [],
    uploadedBase64s: [],
    history: [],
    activeScore: null,
    scores: {}
  };

  var $ = function(id) { return document.getElementById(id); };

  // ========== SCORES ==========
  var SCORES = {
    nihss:{name:'NIHSS',icon:'üß†',desc:'Stroke Severity',max:42,items:[
      {id:'1a',name:'LOC',opts:[{s:0,l:'Alert'},{s:1,l:'Drowsy'},{s:2,l:'Stupor'},{s:3,l:'Coma'}]},
      {id:'1b',name:'LOC Q',opts:[{s:0,l:'Both'},{s:1,l:'One'},{s:2,l:'Neither'}]},
      {id:'1c',name:'LOC C',opts:[{s:0,l:'Both'},{s:1,l:'One'},{s:2,l:'Neither'}]},
      {id:'2',name:'Gaze',opts:[{s:0,l:'Normal'},{s:1,l:'Partial'},{s:2,l:'Forced'}]},
      {id:'3',name:'Visual',opts:[{s:0,l:'Normal'},{s:1,l:'Partial'},{s:2,l:'Complete'},{s:3,l:'Bilateral'}]},
      {id:'4',name:'Facial',opts:[{s:0,l:'Normal'},{s:1,l:'Minor'},{s:2,l:'Partial'},{s:3,l:'Complete'}]},
      {id:'5a',name:'Arm L',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'5b',name:'Arm R',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'6a',name:'Leg L',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'6b',name:'Leg R',opts:[{s:0,l:'None'},{s:1,l:'Drift'},{s:2,l:'Some'},{s:3,l:'No effort'},{s:4,l:'No mvmt'}]},
      {id:'7',name:'Ataxia',opts:[{s:0,l:'Absent'},{s:1,l:'One'},{s:2,l:'Two'}]},
      {id:'8',name:'Sensory',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'}]},
      {id:'9',name:'Language',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'},{s:3,l:'Mute'}]},
      {id:'10',name:'Dysarthria',opts:[{s:0,l:'Normal'},{s:1,l:'Mild'},{s:2,l:'Severe'}]},
      {id:'11',name:'Extinction',opts:[{s:0,l:'Normal'},{s:1,l:'One'},{s:2,l:'Profound'}]}
    ],interpret:function(s){if(s===0)return{t:'No Symptoms',c:'#10b981'};if(s<=4)return{t:'Minor',c:'#6ee7b7'};if(s<=15)return{t:'Moderate',c:'#fbbf24'};if(s<=20)return{t:'Mod-Severe',c:'#f97316'};return{t:'Severe',c:'#ef4444'}}},
    gcs:{name:'GCS',icon:'üëÅ',desc:'Consciousness',max:15,items:[
      {id:'e',name:'Eye',opts:[{s:4,l:'Spontaneous'},{s:3,l:'Voice'},{s:2,l:'Pain'},{s:1,l:'None'}]},
      {id:'v',name:'Verbal',opts:[{s:5,l:'Oriented'},{s:4,l:'Confused'},{s:3,l:'Words'},{s:2,l:'Sounds'},{s:1,l:'None'}]},
      {id:'m',name:'Motor',opts:[{s:6,l:'Obeys'},{s:5,l:'Localizes'},{s:4,l:'Withdraws'},{s:3,l:'Flexion'},{s:2,l:'Extension'},{s:1,l:'None'}]}
    ],interpret:function(s){if(s>=13)return{t:'Mild',c:'#10b981'};if(s>=9)return{t:'Moderate',c:'#fbbf24'};return{t:'Severe',c:'#ef4444'}}},
    sedan:{name:'SEDAN',icon:'ü©∏',desc:'tPA Bleed Risk',max:6,items:[
      {id:'s',name:'Glucose',opts:[{s:0,l:'<145'},{s:1,l:'145-216'},{s:2,l:'>216'}]},
      {id:'e',name:'Early CT',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
      {id:'d',name:'Dense Artery',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},
      {id:'a',name:'Age ‚â•75',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},
      {id:'n',name:'NIHSS ‚â•10',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){var r=['1.4%','2.9%','5.0%','8.5%','12.2%','16.9%','21.5%'],c=['#10b981','#6ee7b7','#84cc16','#fbbf24','#f97316','#ef4444','#dc2626'];return{t:r[Math.min(s,6)]+' sICH',c:c[Math.min(s,6)]}}},
    chads:{name:'CHA‚ÇÇDS‚ÇÇ-VASc',icon:'‚ù§Ô∏è',desc:'AF Stroke',max:9,items:[
      {id:'c',name:'CHF',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'h',name:'HTN',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'a2',name:'Age‚â•75',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},{id:'d',name:'DM',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'s2',name:'Stroke',opts:[{s:0,l:'No'},{s:2,l:'Yes'}]},{id:'v',name:'Vascular',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'a',name:'Age65-74',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'sc',name:'Female',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s===0)return{t:'Low 0.2%/yr',c:'#10b981'};if(s===1)return{t:'Low-Mod',c:'#6ee7b7'};return{t:'Anticoag indicated',c:'#ef4444'}}},
    wells:{name:'Wells PE',icon:'ü´Å',desc:'PE Probability',max:12.5,items:[
      {id:'dv',name:'DVT Signs',opts:[{s:0,l:'No'},{s:3,l:'Yes'}]},{id:'al',name:'PE Likely',opts:[{s:0,l:'No'},{s:3,l:'Yes'}]},{id:'hr',name:'HR>100',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'im',name:'Immobile',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'pr',name:'Prior VTE',opts:[{s:0,l:'No'},{s:1.5,l:'Yes'}]},{id:'he',name:'Hemoptysis',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'ca',name:'Cancer',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s<=4)return{t:'PE Unlikely',c:'#10b981'};return{t:'PE Likely',c:'#ef4444'}}},
    curb:{name:'CURB-65',icon:'ü¶†',desc:'Pneumonia',max:5,items:[
      {id:'c',name:'Confusion',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'u',name:'BUN>19',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'r',name:'RR‚â•30',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'b',name:'BP<90/60',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]},{id:'65',name:'Age‚â•65',opts:[{s:0,l:'No'},{s:1,l:'Yes'}]}
    ],interpret:function(s){if(s<=1)return{t:'Outpatient',c:'#10b981'};if(s===2)return{t:'Admit',c:'#fbbf24'};return{t:'ICU',c:'#ef4444'}}}
  };

  var REFS = [
    {title:'tPA Window',content:'<p><b>IV tPA:</b> ‚â§4.5h</p><p><b>Thrombectomy:</b> ‚â§24h (DAWN)</p>'},
    {title:'tPA Dosing',content:'<p>0.9 mg/kg (max 90mg)</p><p>10% bolus, 90% over 60min</p>'},
    {title:'BP Targets',content:'<p><b>Pre-tPA:</b> <185/110</p><p><b>Post-tPA:</b> <180/105</p>'},
    {title:'GCS Guide',content:'<p>13-15: Mild | 9-12: Mod | ‚â§8: Severe</p>'},
    {title:'Sepsis Bundle',content:'<p>Hour-1: Lactate, cultures, abx, 30ml/kg</p>'},
    {title:'Anticoag Reversal',content:'<p>Warfarin: VitK+PCC | Dabigatran: Idarucizumab</p>'}
  ];

  // ========== UTILS ==========
  function toast(m, err) {
    var t = $('toast');
    t.textContent = m;
    t.className = 'toast show' + (err ? ' error' : '');
    setTimeout(function() { t.className = 'toast'; }, 3000);
  }

  function initials(n) {
    if (!n) return '?';
    var p = n.trim().split(/\s+/);
    return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : n.substring(0,2).toUpperCase();
  }

  function formatBytes(b) {
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
    return (b / 1048576).toFixed(1) + ' MB';
  }

  // ========== AUTH ==========
  function login() {
    var n = $('loginName').value.trim();
    if (!n) { alert('Enter your name'); return; }
    state.user = { name: n, init: n[0].toUpperCase() };
    try { localStorage.setItem('mw_user', JSON.stringify(state.user)); } catch(e) {}
    showDashboard();
  }

  function showDashboard() {
    $('userName').textContent = state.user.name;
    $('userAvatar').textContent = state.user.init;
    $('userBtn').classList.add('show');
    $('greeting').textContent = 'Dr. ' + state.user.name;
    $('login').classList.remove('active');
    $('dashboard').classList.add('active');
    toast('Welcome, Dr. ' + state.user.name + '!');
    loadPatients();
    loadHistory();
  }

  function checkAuth() {
    try {
      var u = localStorage.getItem('mw_user');
      if (u) { state.user = JSON.parse(u); showDashboard(); }
    } catch(e) {}
  }

  // ========== PATIENTS ==========
  function loadPatients() {
    $('patientsContainer').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
    fetch(API.PATIENT, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'getAllData' }) })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.success) {
          state.patients = d.patients || [];
          renderPatients();
          $('statTotal').textContent = d.totalCount || state.patients.length;
          $('statActive').textContent = d.activeCount || 0;
          $('statChronic').textContent = d.chronicCount || 0;
          $('statWards').textContent = d.wards ? d.wards.length : 0;
        } else {
          $('patientsContainer').innerHTML = '<div class="empty-state"><p>Error loading patients</p></div>';
        }
      })
      .catch(function() { $('patientsContainer').innerHTML = '<div class="empty-state"><p>Connection failed</p></div>'; });
  }

  function renderPatients() {
    var c = $('patientsContainer');
    if (!state.patients.length) { c.innerHTML = '<div class="empty-state"><p>No patients</p></div>'; return; }
    var h = '<div class="patients-grid">';
    state.patients.forEach(function(p) {
      var name = p.patientName || p.name || 'Unknown';
      var status = p.section || 'active';
      var sc = status === 'critical' ? 'critical' : status === 'chronic' ? 'chronic' : '';
      var badge = status === 'critical' ? 'badge-critical' : status === 'chronic' ? 'badge-chronic' : 'badge-active';
      h += '<div class="patient-card ' + sc + '" data-row="' + p.rowIndex + '">';
      h += '<div class="patient-top"><div class="patient-main"><div class="patient-avatar">' + initials(name) + '</div><div class="patient-info"><h3>' + name + '</h3><p>Dr. ' + (p.assignedDoctor || 'Unassigned') + '</p></div></div><span class="patient-badge ' + badge + '">' + status + '</span></div>';
      h += '<div class="patient-details"><div class="patient-detail"><div class="patient-detail-label">Ward</div><div class="patient-detail-value">' + (p.ward || '-') + '</div></div><div class="patient-detail"><div class="patient-detail-label">Room</div><div class="patient-detail-value">' + (p.roomBed || '-') + '</div></div></div>';
      h += '<div class="patient-diagnosis"><div class="patient-diagnosis-label">Diagnosis</div><div class="patient-diagnosis-text">' + (p.diagnosis || 'No diagnosis').substring(0, 100) + '</div></div>';
      h += '<div class="patient-actions"><button class="btn btn-secondary btn-sm" onclick="MW.edit(' + p.rowIndex + ')">Edit</button><button class="btn btn-danger btn-sm" onclick="MW.discharge(' + p.rowIndex + ')">Discharge</button></div></div>';
    });
    c.innerHTML = h + '</div>';
  }

  function openPatientModal(p) {
    state.editing = p || null;
    $('patientModalTitle').textContent = p ? 'Edit Patient' : 'Add Patient';
    $('patientName').value = p ? p.patientName || '' : '';
    $('patientWard').value = p ? p.ward || '' : '';
    $('patientRoom').value = p ? p.roomBed || '' : '';
    $('patientDiagnosis').value = p ? p.diagnosis || '' : '';
    $('patientDoctor').value = p ? p.assignedDoctor || '' : '';
    $('patientStatus').value = p ? p.section || 'active' : 'active';
    $('patientModal').classList.add('active');
  }

  function savePatient() {
    var data = {
      patientName: $('patientName').value.trim(),
      ward: $('patientWard').value.trim(),
      roomBed: $('patientRoom').value.trim(),
      diagnosis: $('patientDiagnosis').value.trim(),
      assignedDoctor: $('patientDoctor').value.trim(),
      section: $('patientStatus').value
    };
    if (!data.patientName || !data.ward) { toast('Name and Ward required', true); return; }
    var body = { action: state.editing ? 'updatePatient' : 'addPatient', ...data };
    if (state.editing) { body.rowIndex = state.editing.rowIndex; body.oldWard = state.editing.ward; body.newWard = data.ward; }
    toast('Saving...');
    fetch(API.PATIENT, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(body) })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.success) { toast('Saved!'); $('patientModal').classList.remove('active'); loadPatients(); }
        else { toast('Error: ' + (d.error || 'Unknown'), true); }
      });
  }

  function discharge(row) {
    var p = state.patients.find(function(x) { return x.rowIndex === row; });
    if (!p || !confirm('Discharge ' + p.patientName + '?')) return;
    fetch(API.PATIENT, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'dischargePatient', rowIndex: row }) })
      .then(function(r) { return r.json(); })
      .then(function(d) { if (d.success) { toast('Discharged'); loadPatients(); } });
  }

  // ========== ANALYSIS ==========
  function setupUpload() {
    var zone = $('uploadZone'), input = $('uploadInput');
    zone.onclick = function() { input.click(); };
    zone.ondragover = function(e) { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = function() { zone.classList.remove('dragover'); };
    zone.ondrop = function(e) { 
      e.preventDefault(); 
      zone.classList.remove('dragover'); 
      if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); 
    };
    input.onchange = function() { if (this.files.length) handleFiles(this.files); };

    document.querySelectorAll('.analysis-type').forEach(function(t) {
      t.onclick = function() {
        document.querySelectorAll('.analysis-type').forEach(function(x) { x.classList.remove('active'); });
        this.classList.add('active');
        state.analysisType = this.dataset.type;
      };
    });
  }

  // Multi-file handling
  function handleFiles(files) {
    state.uploadedFiles = state.uploadedFiles || [];
    state.uploadedBase64s = state.uploadedBase64s || [];
    
    Array.from(files).forEach(function(file) {
      if (!file.type.startsWith('image/')) return;
      
      state.uploadedFiles.push(file);
      
      var reader = new FileReader();
      reader.onload = function(e) {
        state.uploadedBase64s.push(e.target.result);
        renderPreviewGrid();
      };
      reader.readAsDataURL(file);
    });
    
    $('previewArea').classList.add('show');
    $('uploadZone').classList.add('has-file');
    $('analyzeBtn').disabled = false;
  }

  function renderPreviewGrid() {
    var grid = $('previewGrid');
    grid.innerHTML = '';
    
    state.uploadedBase64s.forEach(function(base64, idx) {
      var thumb = document.createElement('div');
      thumb.className = 'preview-thumb';
      thumb.innerHTML = '<img src="' + base64 + '">';
      thumb.onclick = function() { removeFile(idx); };
      grid.appendChild(thumb);
    });
    
    $('previewFilename').textContent = state.uploadedFiles.length + ' file(s) selected';
    $('previewMeta').textContent = 'Tap to remove';
    
    if (state.uploadedFiles.length === 0) {
      $('previewArea').classList.remove('show');
      $('uploadZone').classList.remove('has-file');
      $('analyzeBtn').disabled = true;
    }
  }

  function removeFile(idx) {
    state.uploadedFiles.splice(idx, 1);
    state.uploadedBase64s.splice(idx, 1);
    renderPreviewGrid();
  }

  // Analysis with multi-image and Lab Engine
  function runAnalysis() {
    if (!state.uploadedBase64s || state.uploadedBase64s.length === 0) { 
      toast('Upload files first', true); 
      return; 
    }

    var startTime = performance.now();
    var totalImages = state.uploadedBase64s.length;
    var processedImages = 0;
    var allExtractedText = [];
    
    // Show progress
    $('uploadSection').style.display = 'none';
    $('analysisProgress').classList.add('show');
    $('analysisResults').classList.remove('show');
    $('progressStatus').textContent = 'Processing ' + totalImages + ' image(s)...';

    // Process all images in parallel
    var promises = state.uploadedBase64s.map(function(base64, idx) {
      return new Promise(function(resolve) {
        var payload = {
          action: 'interpret',
          documentType: state.analysisType === 'auto' ? 'lab' : state.analysisType,
          image: base64,
          provider: 'claude'
        };

        fetch(API.CLAUDE, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          processedImages++;
          $('progressStatus').textContent = 'Processed ' + processedImages + '/' + totalImages + ' images...';
          
          if (d.success && d.extractedText) {
            allExtractedText.push(d.extractedText);
          }
          resolve(d);
        })
        .catch(function(e) {
          processedImages++;
          resolve({ success: false, error: e.message });
        });
      });
    });

    Promise.all(promises).then(function(results) {
      var totalTime = performance.now() - startTime;
      $('analysisProgress').classList.remove('show');
      
      // Combine all extracted text
      var combinedText = allExtractedText.join('\n\n');
      
      // Use Lab Engine to extract and interpret values
      var labAnalysis = null;
      if (window.LabEngine && combinedText) {
        labAnalysis = window.LabEngine.analyze(combinedText);
      }
      
      // Build final analysis result
      var analysis = {
        summary: '',
        findings: [],
        abnormalities: [],
        normalFindings: [],
        recommendations: [],
        insights: []
      };
      
      // Merge Claude results
      results.forEach(function(d) {
        if (d.success) {
          if (d.interpretation) {
            if (d.interpretation.summary) analysis.summary += d.interpretation.summary + ' ';
            if (d.interpretation.keyFindings) analysis.findings = analysis.findings.concat(d.interpretation.keyFindings);
            if (d.interpretation.abnormalities) analysis.abnormalities = analysis.abnormalities.concat(d.interpretation.abnormalities);
            if (d.interpretation.normalFindings) analysis.normalFindings = analysis.normalFindings.concat(d.interpretation.normalFindings);
          }
          if (d.clinicalPearls) analysis.insights = analysis.insights.concat(d.clinicalPearls);
          if (d.presentation && d.presentation.recommendations) {
            analysis.recommendations = analysis.recommendations.concat(d.presentation.recommendations);
          }
        }
      });
      
      // Enhance with Lab Engine results
      if (labAnalysis) {
        if (labAnalysis.summary) analysis.summary = labAnalysis.summary;
        
        // Add lab-specific findings
        labAnalysis.findings.forEach(function(f) {
          analysis.abnormalities.push({
            name: f.name,
            value: f.value + ' ' + (f.unit || ''),
            flag: f.flag,
            severity: f.severity,
            reference: f.reference,
            interpretation: f.interpretation
          });
        });
        
        if (labAnalysis.normalFindings) {
          analysis.normalFindings = labAnalysis.normalFindings;
        }
        
        if (labAnalysis.insights) {
          analysis.insights = labAnalysis.insights.concat(analysis.insights);
        }
        
        if (labAnalysis.recommendations) {
          analysis.recommendations = labAnalysis.recommendations.concat(analysis.recommendations);
        }
      }
      
      // Remove duplicates
      analysis.findings = [...new Set(analysis.findings)];
      analysis.normalFindings = [...new Set(analysis.normalFindings)];
      analysis.insights = [...new Set(analysis.insights)];
      analysis.recommendations = [...new Set(analysis.recommendations)];
      
      // Learn pattern
      if (window.NeuralEngine && combinedText) {
        window.NeuralEngine.learn(combinedText, state.analysisType, analysis);
      }
      
      showResults(analysis, {
        source: 'claude_api',
        totalTime: totalTime,
        imageCount: totalImages,
        labCount: labAnalysis ? labAnalysis.extractedCount : 0
      });
      
      saveToHistory(analysis);
      updateNeuralStats();
      toast('‚úì Analysis complete!');
    });
  }

  function updateNeuralStats() {
    if (!window.NeuralEngine) return;
    var stats = window.NeuralEngine.getStats();
    var statsEl = $('neuralStats');
    if (statsEl) {
      statsEl.innerHTML = '<span>üß† ' + stats.patterns + ' patterns</span><span>‚ö° ' + stats.hitRate + ' hit rate</span>';
    }
  }

  function showResults(analysis, meta) {
    $('analysisResults').classList.add('show');
    meta = meta || {};
    
    var h = '';
    
    // Source badge
    var badgeText = meta.source === 'neural_cache' 
      ? '‚ö° Neural Cache (' + (meta.confidence * 100).toFixed(0) + '% match)'
      : 'ü§ñ Claude AI';
    var badgeTime = meta.queryTime 
      ? (meta.queryTime).toFixed(0) + 'ms'
      : meta.totalTime 
        ? (meta.totalTime / 1000).toFixed(1) + 's'
        : '';
    
    $('resultBadge').innerHTML = badgeText + (badgeTime ? ' ‚Ä¢ ' + badgeTime : '');

    // Summary
    if (analysis.summary) {
      h += '<div class="result-section"><div class="result-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Summary</div><div class="result-content">' + formatText(analysis.summary) + '</div></div>';
    }

    // Abnormalities (Critical)
    if (analysis.abnormalities && analysis.abnormalities.length) {
      h += '<div class="result-section" style="border-left:3px solid var(--rose)"><div class="result-section-title" style="color:var(--rose)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Abnormal Findings</div><div class="result-content">';
      analysis.abnormalities.forEach(function(a) {
        h += '<div class="finding-card critical"><div class="finding-title">' + (typeof a === 'string' ? a : a.title || a.finding || JSON.stringify(a)) + '</div></div>';
      });
      h += '</div></div>';
    }

    // Key Findings
    if (analysis.findings && analysis.findings.length) {
      h += '<div class="result-section"><div class="result-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Key Findings</div><div class="result-content">';
      analysis.findings.forEach(function(f) {
        h += '<div class="finding-card"><div class="finding-title">' + (typeof f === 'string' ? f : f.title || JSON.stringify(f)) + '</div></div>';
      });
      h += '</div></div>';
    }

    // Normal Findings
    if (analysis.normalFindings && analysis.normalFindings.length) {
      h += '<div class="result-section" style="border-left:3px solid var(--emerald)"><div class="result-section-title" style="color:var(--emerald)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Normal Findings</div><div class="result-content"><ul>';
      analysis.normalFindings.forEach(function(n) { h += '<li>' + n + '</li>'; });
      h += '</ul></div></div>';
    }

    // Extracted Text / Interpretation
    if (analysis.interpretation && analysis.interpretation.length > 50) {
      h += '<div class="result-section"><div class="result-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Extracted Text</div><div class="result-content" style="max-height:300px;overflow-y:auto;font-family:monospace;font-size:0.8rem;white-space:pre-wrap;background:var(--bg-card);padding:12px;border-radius:8px">' + analysis.interpretation + '</div></div>';
    }

    // Clinical Pearls
    if (analysis.clinicalPearls && analysis.clinicalPearls.length) {
      h += '<div class="result-section" style="border-left:3px solid var(--gold)"><div class="result-section-title" style="color:var(--gold)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Clinical Pearls</div><div class="result-content"><ul>';
      analysis.clinicalPearls.forEach(function(p) { h += '<li>' + p + '</li>'; });
      h += '</ul></div></div>';
    }

    // Recommendations
    if (analysis.recommendations && analysis.recommendations.length) {
      h += '<div class="result-section"><div class="result-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Recommendations</div><div class="result-content"><ul>';
      analysis.recommendations.forEach(function(r) { h += '<li>' + r + '</li>'; });
      h += '</ul></div></div>';
    }

    // Patient-Friendly Explanation
    if (analysis.patientFriendly) {
      h += '<div class="result-section" style="border-left:3px solid var(--teal)"><div class="result-section-title" style="color:var(--teal)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Patient-Friendly Explanation</div><div class="result-content">' + formatText(analysis.patientFriendly) + '</div></div>';
    }

    // Potential Questions
    if (analysis.potentialQuestions && analysis.potentialQuestions.length) {
      h += '<div class="result-section"><div class="result-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Questions to Consider</div><div class="result-content"><ul>';
      analysis.potentialQuestions.forEach(function(q) { h += '<li>' + q + '</li>'; });
      h += '</ul></div></div>';
    }

    // Fallback
    if (!h) {
      h = '<div class="result-section"><div class="result-section-title">Analysis Result</div><div class="result-content"><pre style="white-space:pre-wrap;font-size:0.85rem">' + JSON.stringify(analysis, null, 2) + '</pre></div></div>';
    }

    $('resultsContent').innerHTML = h;
  }

  function formatText(text) {
    if (!text) return '';
    return text
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');
  }

  function resetAnalysis() {
    $('uploadSection').style.display = 'block';
    $('analysisResults').classList.remove('show');
    $('previewArea').classList.remove('show');
    $('uploadZone').classList.remove('has-file');
    $('analyzeBtn').disabled = true;
    state.uploadedFiles = [];
    state.uploadedBase64s = [];
    var grid = $('previewGrid');
    if (grid) grid.innerHTML = '';
  }

  function saveToHistory(analysis) {
    var item = {
      id: Date.now(),
      type: state.analysisType,
      filename: state.uploadedFiles && state.uploadedFiles.length ? state.uploadedFiles.length + ' file(s)' : 'Unknown',
      thumb: state.uploadedBase64s && state.uploadedBase64s[0] ? state.uploadedBase64s[0] : null,
      date: new Date().toLocaleString(),
      summary: analysis.summary ? analysis.summary.substring(0, 100) + '...' : 'Analysis complete'
    };
    state.history.unshift(item);
    if (state.history.length > 20) state.history.pop();
    try { localStorage.setItem('mw_history', JSON.stringify(state.history)); } catch(e) {}
    renderHistory();
  }

  function loadHistory() {
    try {
      var h = localStorage.getItem('mw_history');
      if (h) state.history = JSON.parse(h);
    } catch(e) {}
    renderHistory();
  }

  function renderHistory() {
    var c = $('historyList');
    if (!state.history.length) {
      c.innerHTML = '<div class="empty-state" style="padding:24px"><p style="color:var(--text-muted)">No analyses yet</p></div>';
      return;
    }
    var h = '';
    state.history.forEach(function(item) {
      h += '<div class="history-item">';
      h += item.thumb ? '<img src="' + item.thumb + '" class="history-thumb">' : '<div class="history-thumb" style="display:grid;place-items:center;font-size:1.5rem">' + (item.type === 'xray' ? 'ü©ª' : item.type === 'lab' ? 'üß™' : 'üìÑ') + '</div>';
      h += '<div class="history-info"><div class="history-type">' + item.filename + '</div><div class="history-date">' + item.date + '</div></div>';
      h += '<span class="history-badge">' + item.type + '</span></div>';
    });
    c.innerHTML = h;
  }

  // ========== TABS ==========
  function setupTabs() {
    document.querySelectorAll('.tab').forEach(function(t) {
      t.onclick = function() {
        var id = this.dataset.tab;
        document.querySelectorAll('.tab').forEach(function(x) { x.classList.remove('active'); });
        this.classList.add('active');
        document.querySelectorAll('.panel').forEach(function(x) { x.classList.remove('active'); });
        $('panel' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active');
      };
    });
  }

  // ========== SCORES ==========
  function renderScores() {
    var h = '';
    for (var k in SCORES) { var s = SCORES[k]; h += '<div class="score-tile" data-score="' + k + '"><div class="score-icon">' + s.icon + '</div><div class="score-name">' + s.name + '</div><div class="score-desc">' + s.desc + '</div></div>'; }
    $('scoresGrid').innerHTML = h;
    $('scoresGrid').querySelectorAll('.score-tile').forEach(function(t) {
      t.onclick = function() {
        $('scoresGrid').querySelectorAll('.score-tile').forEach(function(x) { x.classList.remove('active'); });
        this.classList.add('active');
        openCalc(this.dataset.score);
      };
    });
  }

  function openCalc(key) {
    var s = SCORES[key]; state.activeScore = key; state.scores[key] = {};
    var h = '<div class="card" style="margin-top:20px"><div class="card-header"><h2 class="card-title">' + s.icon + ' ' + s.name + '</h2><button class="btn btn-secondary btn-sm" onclick="MW.resetCalc()">Reset</button></div><div class="card-body">';
    s.items.forEach(function(item) {
      h += '<div class="calc-item"><div class="calc-item-head"><span class="calc-item-num">' + item.id.toUpperCase() + '</span><span class="calc-item-name">' + item.name + '</span></div><div class="calc-opts">';
      item.opts.forEach(function(o) { h += '<label class="calc-opt" data-item="' + item.id + '" data-score="' + o.s + '"><input type="radio" name="c_' + item.id + '"><span class="calc-opt-score">' + (o.s >= 0 ? '+' : '') + o.s + '</span><span class="calc-opt-label">' + o.l + '</span></label>'; });
      h += '</div></div>';
    });
    h += '<div class="calc-result"><div class="calc-result-score" id="calcTotal">0</div><div class="calc-result-max">/ ' + s.max + '</div><div id="calcInterp"></div></div></div></div>';
    $('calcArea').innerHTML = h;
    $('calcArea').querySelectorAll('.calc-opt').forEach(function(o) {
      o.onclick = function() {
        var id = this.dataset.item, sc = parseFloat(this.dataset.score);
        this.parentElement.querySelectorAll('.calc-opt').forEach(function(x) { x.classList.remove('sel'); });
        this.classList.add('sel'); this.querySelector('input').checked = true;
        state.scores[state.activeScore][id] = sc;
        updateCalc();
      };
    });
  }

  function updateCalc() {
    var k = state.activeScore, s = SCORES[k], t = 0;
    for (var x in state.scores[k]) t += state.scores[k][x];
    $('calcTotal').textContent = t;
    var i = s.interpret(t);
    $('calcInterp').innerHTML = '<span class="severity-pill" style="background:' + i.c + '20;color:' + i.c + '">' + i.t + '</span>';
  }

  // ========== REFERENCE ==========
  function renderRefs() {
    $('refGrid').innerHTML = REFS.map(function(r) { return '<div class="ref-card"><h4>' + r.title + '</h4>' + r.content + '</div>'; }).join('');
  }

  // ========== INIT ==========
  function init() {
    $('loginBtn').onclick = login;
    $('loginName').onkeydown = function(e) { if (e.key === 'Enter') login(); };
    $('refreshBtn').onclick = loadPatients;
    $('addPatientBtn').onclick = function() { openPatientModal(); };
    $('closePatientModal').onclick = function() { $('patientModal').classList.remove('active'); };
    $('cancelPatient').onclick = function() { $('patientModal').classList.remove('active'); };
    $('savePatient').onclick = savePatient;
    $('patientModal').onclick = function(e) { if (e.target === this) this.classList.remove('active'); };
    $('analyzeBtn').onclick = runAnalysis;
    $('newAnalysisBtn').onclick = resetAnalysis;

    setupTabs();
    setupUpload();
    renderScores();
    renderRefs();
    checkAuth();
    
    // Initialize Neural Engine
    if (window.NeuralEngine) {
      window.NeuralEngine.init();
      updateNeuralStats();
    }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  window.MW = {
    edit: function(r) { var p = state.patients.find(function(x) { return x.rowIndex === r; }); if (p) openPatientModal(p); },
    discharge: discharge,
    resetCalc: function() { if (state.activeScore) { state.scores[state.activeScore] = {}; openCalc(state.activeScore); } }
  };
})();

/**
 * MedWard Neural Pattern Engine v2.0
 * Learns from Claude analyses to provide instant results for similar cases
 */
var NeuralEngine = (function() {
  'use strict';

  var CONFIG = {
    SIMILARITY_THRESHOLD: 0.82,
    MAX_PATTERNS: 500,
    PATTERN_EXPIRY_DAYS: 30,
    MIN_CONFIDENCE: 0.75,
    LEARNING_RATE: 0.1,
    STORAGE_KEY: 'medward_neural_v2'
  };

  var patterns = [];
  var hashIndex = new Map();
  var stats = { hits: 0, misses: 0, learned: 0 };

  function init() {
    load();
    console.log('[Neural] Initialized with ' + patterns.length + ' patterns');
    return stats;
  }

  function load() {
    try {
      var data = localStorage.getItem(CONFIG.STORAGE_KEY);
      if (data) {
        var parsed = JSON.parse(data);
        patterns = parsed.patterns || [];
        stats = parsed.stats || stats;
        rebuildIndex();
        pruneExpired();
      }
    } catch (e) {
      console.warn('[Neural] Load failed:', e);
      patterns = [];
    }
  }

  function save() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
        patterns: patterns.slice(0, CONFIG.MAX_PATTERNS),
        stats: stats,
        version: 2,
        updated: Date.now()
      }));
    } catch (e) {
      patterns = patterns.slice(0, Math.floor(CONFIG.MAX_PATTERNS / 2));
      rebuildIndex();
    }
  }

  function extractFeatures(text) {
    if (!text) return null;
    var normalized = text.toLowerCase().replace(/\s+/g, ' ');
    var features = {
      labs: extractLabValues(normalized),
      vitals: extractVitals(normalized),
      keywords: extractKeywords(normalized),
      structure: getStructureSignature(normalized),
      lengthBucket: Math.floor(text.length / 500),
      textHash: simpleHash(normalized)
    };
    features.vector = createFeatureVector(features);
    return features;
  }

  function extractLabValues(text) {
    var labs = {};
    var pattern = /\b(wbc|rbc|hgb|hb|hemoglobin|hct|plt|platelets|na|sodium|k|potassium|cl|chloride|co2|bun|urea|cr|creatinine|glu|glucose|alt|ast|alp|ggt|bili|bilirubin|albumin|protein|ca|calcium|mg|magnesium|phos|phosphate|tsh|t3|t4|inr|pt|ptt|aptt|crp|esr|troponin|bnp|lactate|ph|pco2|po2|hco3|egfr)[:\s=*]+([<>]?\d+\.?\d*)/gi;
    var match;
    while ((match = pattern.exec(text)) !== null) {
      var name = normalizeLabName(match[1]);
      var value = parseFloat(match[2]);
      if (!isNaN(value)) labs[name] = value;
    }
    return labs;
  }

  function normalizeLabName(name) {
    var map = { 'hgb': 'hemoglobin', 'hb': 'hemoglobin', 'plt': 'platelets', 'na': 'sodium', 'k': 'potassium', 'cl': 'chloride', 'cr': 'creatinine', 'glu': 'glucose', 'bili': 'bilirubin', 'ca': 'calcium', 'mg': 'magnesium', 'phos': 'phosphate', 'ptt': 'aptt' };
    return map[name.toLowerCase()] || name.toLowerCase();
  }

  function extractVitals(text) {
    var vitals = {};
    var bp = text.match(/(?:bp|blood pressure)[:\s]*(\d{2,3})[\/\\](\d{2,3})/i);
    if (bp) { vitals.sbp = parseInt(bp[1]); vitals.dbp = parseInt(bp[2]); }
    var hr = text.match(/(?:hr|heart rate|pulse)[:\s]*(\d{2,3})/i);
    if (hr) vitals.hr = parseInt(hr[1]);
    var rr = text.match(/(?:rr|resp|respiratory)[:\s]*(\d{1,2})/i);
    if (rr) vitals.rr = parseInt(rr[1]);
    var temp = text.match(/(?:temp|temperature)[:\s]*(\d{2,3}\.?\d?)/i);
    if (temp) vitals.temp = parseFloat(temp[1]);
    var spo2 = text.match(/(?:spo2|sao2|o2 sat)[:\s]*(\d{2,3})%?/i);
    if (spo2) vitals.spo2 = parseInt(spo2[1]);
    return vitals;
  }

  function extractKeywords(text) {
    var keywords = {};
    var critical = ['critical', 'urgent', 'emergency', 'stat', 'acute', 'severe'];
    var conditions = ['infection', 'sepsis', 'anemia', 'diabetes', 'hypertension', 'renal', 'hepatic', 'cardiac', 'respiratory', 'neurologic'];
    var findings = ['elevated', 'decreased', 'abnormal', 'normal', 'high', 'low'];
    critical.forEach(function(w) { if (text.includes(w)) keywords[w] = 3; });
    conditions.forEach(function(w) { if (text.includes(w)) keywords[w] = 2; });
    findings.forEach(function(w) { if (text.includes(w)) keywords[w] = 1; });
    return keywords;
  }

  function getStructureSignature(text) {
    return {
      hasLabs: /\b(wbc|rbc|hemoglobin|sodium|potassium|creatinine)\b/i.test(text),
      hasVitals: /\b(bp|hr|temp|spo2)\b/i.test(text),
      hasHistory: /\b(hpi|pmh|history|presents|complains)\b/i.test(text),
      hasMeds: /\b(medications?|meds|taking|prescribed)\b/i.test(text),
      hasAssessment: /\b(assessment|diagnosis|impression|plan)\b/i.test(text)
    };
  }

  function createFeatureVector(features) {
    var vector = [];
    var labOrder = ['wbc', 'hemoglobin', 'platelets', 'sodium', 'potassium', 'creatinine', 'glucose', 'alt', 'ast', 'bilirubin'];
    labOrder.forEach(function(lab) {
      var val = features.labs[lab];
      vector.push(val ? normalizeLabValue(lab, val) : -1);
    });
    vector.push(features.vitals.sbp ? features.vitals.sbp / 200 : -1);
    vector.push(features.vitals.dbp ? features.vitals.dbp / 120 : -1);
    vector.push(features.vitals.hr ? features.vitals.hr / 150 : -1);
    vector.push(features.vitals.spo2 ? features.vitals.spo2 / 100 : -1);
    vector.push(features.structure.hasLabs ? 1 : 0);
    vector.push(features.structure.hasVitals ? 1 : 0);
    vector.push(features.structure.hasHistory ? 1 : 0);
    vector.push(features.structure.hasAssessment ? 1 : 0);
    vector.push(Math.min(features.lengthBucket / 20, 1));
    return vector;
  }

  function normalizeLabValue(name, value) {
    var ranges = { wbc: [4, 11], hemoglobin: [12, 17], platelets: [150, 400], sodium: [136, 146], potassium: [3.5, 5.1], creatinine: [0.7, 1.3], glucose: [70, 100], alt: [7, 56], ast: [10, 40], bilirubin: [0.1, 1.2] };
    var range = ranges[name] || [0, 100];
    return Math.max(0, Math.min(1, (value - range[0]) / (range[1] - range[0])));
  }

  function calculateSimilarity(f1, f2) {
    if (!f1 || !f2) return 0;
    var score = 0, weights = 0;
    if (f1.vector && f2.vector) {
      var vecSim = vectorSimilarity(f1.vector, f2.vector);
      score += vecSim * 0.5;
      weights += 0.5;
    }
    var labSim = objectSimilarity(f1.labs, f2.labs);
    score += labSim * 0.3;
    weights += 0.3;
    var kwSim = objectSimilarity(f1.keywords, f2.keywords);
    score += kwSim * 0.2;
    weights += 0.2;
    return weights > 0 ? score / weights : 0;
  }

  function vectorSimilarity(v1, v2) {
    var sum = 0, count = 0;
    for (var i = 0; i < Math.min(v1.length, v2.length); i++) {
      if (v1[i] >= 0 && v2[i] >= 0) {
        sum += 1 - Math.abs(v1[i] - v2[i]);
        count++;
      }
    }
    return count > 0 ? sum / count : 0;
  }

  function objectSimilarity(o1, o2) {
    var keys1 = Object.keys(o1 || {});
    var keys2 = Object.keys(o2 || {});
    if (keys1.length === 0 && keys2.length === 0) return 1;
    if (keys1.length === 0 || keys2.length === 0) return 0;
    var intersection = keys1.filter(function(k) { return keys2.includes(k); });
    var union = new Set(keys1.concat(keys2));
    return intersection.length / union.size;
  }

  function getLSHBuckets(features) {
    var buckets = [];
    if (features.vector) {
      for (var i = 0; i < 4; i++) {
        var bucket = 'v' + i + '_';
        for (var j = i * 4; j < Math.min((i + 1) * 4, features.vector.length); j++) {
          bucket += features.vector[j] >= 0 ? Math.floor(features.vector[j] * 4) : 'x';
        }
        buckets.push(bucket);
      }
    }
    buckets.push('len_' + features.lengthBucket);
    Object.keys(features.structure).forEach(function(k) {
      if (features.structure[k]) buckets.push('s_' + k);
    });
    return buckets;
  }

  function rebuildIndex() {
    hashIndex.clear();
    patterns.forEach(function(p, idx) {
      if (p.buckets) {
        p.buckets.forEach(function(bucket) {
          if (!hashIndex.has(bucket)) hashIndex.set(bucket, []);
          hashIndex.get(bucket).push(idx);
        });
      }
    });
  }

  function findCandidates(buckets) {
    var candidateSet = new Set();
    buckets.forEach(function(bucket) {
      var indices = hashIndex.get(bucket) || [];
      indices.forEach(function(idx) { candidateSet.add(idx); });
    });
    return Array.from(candidateSet);
  }

  function query(text, docType) {
    docType = docType || 'general';
    var startTime = performance.now();
    var features = extractFeatures(text);
    if (!features) {
      stats.misses++;
      return { match: false, reason: 'no_features' };
    }
    var buckets = getLSHBuckets(features);
    var candidates = findCandidates(buckets);
    if (candidates.length === 0) {
      stats.misses++;
      return { match: false, reason: 'no_candidates' };
    }
    var bestMatch = null, bestScore = 0;
    for (var i = 0; i < candidates.length; i++) {
      var pattern = patterns[candidates[i]];
      if (pattern.docType && pattern.docType !== docType) continue;
      var similarity = calculateSimilarity(features, pattern.features);
      var adjustedScore = similarity * (0.8 + 0.2 * Math.min(pattern.strength || 1, 5));
      if (adjustedScore > bestScore) {
        bestScore = adjustedScore;
        bestMatch = pattern;
      }
    }
    var queryTime = performance.now() - startTime;
    if (bestMatch && bestScore >= CONFIG.SIMILARITY_THRESHOLD) {
      stats.hits++;
      bestMatch.strength = (bestMatch.strength || 1) + CONFIG.LEARNING_RATE;
      bestMatch.lastUsed = Date.now();
      bestMatch.useCount = (bestMatch.useCount || 0) + 1;
      return { match: true, result: bestMatch.result, confidence: bestScore, queryTime: queryTime, source: 'neural_cache' };
    }
    stats.misses++;
    return { match: false, reason: 'below_threshold', bestScore: bestScore, queryTime: queryTime };
  }

  function learn(text, docType, result) {
    var features = extractFeatures(text);
    if (!features) return false;
    var buckets = getLSHBuckets(features);
    var candidates = findCandidates(buckets);
    for (var i = 0; i < candidates.length; i++) {
      var existing = patterns[candidates[i]];
      var similarity = calculateSimilarity(features, existing.features);
      if (similarity > 0.95) {
        existing.strength = (existing.strength || 1) + CONFIG.LEARNING_RATE * 2;
        existing.lastUsed = Date.now();
        save();
        return false;
      }
    }
    var pattern = {
      features: features,
      buckets: buckets,
      docType: docType,
      result: compressResult(result),
      strength: 1,
      created: Date.now(),
      lastUsed: Date.now(),
      useCount: 0
    };
    patterns.unshift(pattern);
    stats.learned++;
    buckets.forEach(function(bucket) {
      if (!hashIndex.has(bucket)) hashIndex.set(bucket, []);
      hashIndex.get(bucket).unshift(0);
    });
    if (patterns.length > CONFIG.MAX_PATTERNS) {
      pruneWeakest();
    }
    save();
    return true;
  }

  function compressResult(result) {
    return {
      summary: result.summary,
      findings: result.findings ? result.findings.slice(0, 5) : [],
      abnormalities: result.abnormalities ? result.abnormalities.slice(0, 5) : [],
      normalFindings: result.normalFindings ? result.normalFindings.slice(0, 5) : [],
      clinicalPearls: result.clinicalPearls ? result.clinicalPearls.slice(0, 3) : [],
      recommendations: result.recommendations ? result.recommendations.slice(0, 5) : []
    };
  }

  function pruneExpired() {
    var cutoff = Date.now() - (CONFIG.PATTERN_EXPIRY_DAYS * 24 * 60 * 60 * 1000);
    var before = patterns.length;
    patterns = patterns.filter(function(p) { return p.created > cutoff || p.useCount > 5; });
    if (patterns.length < before) {
      rebuildIndex();
      console.log('[Neural] Pruned ' + (before - patterns.length) + ' expired patterns');
    }
  }

  function pruneWeakest() {
    patterns.sort(function(a, b) {
      var scoreA = (a.strength || 1) * (1 / (Date.now() - a.lastUsed + 1));
      var scoreB = (b.strength || 1) * (1 / (Date.now() - b.lastUsed + 1));
      return scoreB - scoreA;
    });
    patterns = patterns.slice(0, CONFIG.MAX_PATTERNS);
    rebuildIndex();
  }

  function simpleHash(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash + str.charCodeAt(i)) & 0xFFFFFFFF;
    }
    return hash;
  }

  function getStats() {
    var hitRate = stats.hits + stats.misses > 0 ? (stats.hits / (stats.hits + stats.misses) * 100).toFixed(1) : 0;
    return {
      patterns: patterns.length,
      hits: stats.hits,
      misses: stats.misses,
      hitRate: hitRate + '%',
      learned: stats.learned
    };
  }

  function clear() {
    patterns = [];
    hashIndex.clear();
    stats = { hits: 0, misses: 0, learned: 0 };
    localStorage.removeItem(CONFIG.STORAGE_KEY);
    console.log('[Neural] Cleared all patterns');
  }

  return { init: init, query: query, learn: learn, getStats: getStats, clear: clear, extractFeatures: extractFeatures };
})();

// Auto-initialize Neural Engine
if (typeof window !== 'undefined') {
  window.NeuralEngine = NeuralEngine;
}
</script>
<script src="lab-engine.js"></script>
</body>
</html>
